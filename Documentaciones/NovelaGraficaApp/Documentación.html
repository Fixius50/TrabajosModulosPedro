<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentaci贸n - Novela Gr谩fica App</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: #f4f4f5;
            color: #18181b;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #4f46e5;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        h2 {
            margin-top: 2rem;
            color: #1f2937;
        }

        pre {
            background: #18181b;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
        }

        code {
            font-family: Menlo, Monaco, Consolas, monospace;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1> Novela Gr谩fica App - Documentaci贸n T茅cnica</h1>
        <p><strong>ltima Actualizaci贸n:</strong> 15/12/2025, 18:04:08</p>

        <h2>Resumen del Proyecto</h2>
        <p>Una aplicaci贸n de Novela Visual Interactiva creada con React, Vite y Supabase. Cuenta con un motor de
            decisiones, sistema de inventario, consecuencias persistentes y soporte para historias basadas en JSON.</p>

        <div>
            <span class="badge">React</span>
            <span class="badge">Vite</span>
            <span class="badge">Supabase</span>
            <span class="badge">TailwindCSS</span>
            <span class="badge">Framer Motion</span>
            <span class="badge">JSON Engine</span>
        </div>

        <h2>Historial de Desarrollo y Prompts</h2>
        <pre># Historial del Proyecto: NovelaGraficaApp

## PROMPTS
**Usuario:**
> Act煤a como un Lead Full-Stack Engineer & Cloud Architect. Tu misi贸n es construir la arquitectura completa aplicando Ingenier铆a Defensiva e Investigaci贸n Profunda. [...] Esta app va a consistir en Crear una novela gr谩fica interactiva con im谩genes y texto. Los usuarios pueden decidir por donde transcurre parte de la trama y as铆 habr谩 diferentes finales. Un comic de vi帽etas se valorar谩 mejor.

## STACK
*   **Frontend**: React (Vite)
*   **Motor Gr谩fico**: PixiJS (v8)
*   **Estado/L贸gica**: Custom Story Engine
*   **Estilos**: Vanilla CSS
*   **Datos**: Local JSON (Current) -> Supabase (Planned)

## CDIGO CLAVE

### Estrategia de Datos (JSON Schema - Actual)
```json
{
  "id": "story_001",
  "title": "El Misterio del Bosque Digital",
  "nodes": {
    "start": {
      "type": "panel",
      "image": "/assets/images/panel1.png",
      "text": "Todo comenz贸 una noche oscura...",
      "next": "decision_1"
    }
  }
}
```

### Arquitectura de Base de Datos (Supabase SQL - Futuro)
Hemos definido el esquema relacional para cuando migremos a la nube (`src/db/schema.sql`):
- `story_nodes`: Maneja las vi帽etas y efectos.
- `dialogues`: Separados de la imagen para accesibilidad.
- `story_choices`: Grafo de decisiones.
- `user_progress`: Persistencia en nube.

### Seed Data (Datos de Prueba)
Guardado en `src/db/seed.sql`. Este script SQL rellena la base de datos con la historia de prueba del "Bosque Digital", conectando nodos y di谩logos autom谩ticamente.


**Usuario:**
> Route Map Navigation (Enhancement): The user's main objective is to enhance the route map feature by allowing players to navigate back to previously visited nodes. This includes implementing a confirmation step that warns the player about potential point loss if they return to a path not yet completed. The user also wants to remove the non-functional legend button from the route map interface.

**Funcionalidad Implementada:**
*   **Gesti贸n de Rutas**: Implementada l贸gica para volver a nodos visitados desde el mapa.
*   **UI/UX**: Eliminado bot贸n "Leyenda" obsoleto. A帽adido popup de advertencia (alerta de p茅rdida de puntos) antes de navegar atr谩s.
*   **Fix**: Solucionado bug de propagaci贸n de eventos click en el mapa.

**C贸digo Clave:**
`src/components/RouteMap.jsx`:
```javascript
// Propagaci贸n detenida para evitar cierre del mapa
&lt;button onClick={(e) =&gt; { e.stopPropagation(); setShowConfirmation(true); }}&gt;
    ╋ Volver aqu铆
&lt;/button&gt;

// L贸gica de confirmaci贸n y callback
if (onNavigateToNode) {
    onNavigateToNode(selectedNode.id);
}
```

**Usuario:**
> Vamos a probar ahora a recibir y enviar cosas a la base de datos. Para esto vamos a hacer el panel de login/registro nada mas entrar a la app (correom contrase帽a y google oauth)

**Funcionalidad Implementada:**
*   **Autenticaci贸n**: Sistema completo de Login y Registro con Supabase.
*   **UI**: Nueva p谩gina `Login.jsx` con dise帽o Cyberpunk, animaciones y tabs para Login/Registro.
*   **Seguridad**: Componente `AuthGuard` para proteger rutas privadas (`/`, `/read/:id`). Redirecci贸n autom谩tica a `/login` si no hay sesi贸n.

**C贸digo Clave:**
`src/components/auth/AuthGuard.jsx`:
```javascript
// Protecci贸n de rutas
useEffect(() => {
    if (!loading && !session) {
        navigate('/login');
    }
}, [session, loading, navigate]);
```

`src/pages/Login.jsx`:
```javascript
// Integraci贸n con Supabase Auth (Email + Google)
const { error } = await supabase.auth.signUp({ email, password });
const { error } = await supabase.auth.signInWithOAuth({ provider: 'google', ... });
```

`src/App.jsx`:
```javascript
// Rutas Protegidas
&lt;Route path="/" element={&lt;AuthGuard&gt;&lt;MainMenu /&gt;&lt;/AuthGuard&gt;} /&gt;
&lt;Route path="/login" element={&lt;Login /&gt;} /&gt;
```

**Usuario:**
> Quiero seguir mejorando la app Novela Grafica App


**Usuario:**
> Te voy a dar unas capturas... recoges el texto y lo pones como funcionalidades para la documentacion.

**Funcionalidades Definidas (Pendientes de Implementaci贸n):**

1.  **Motor Gr谩fico H铆brido (Accesibilidad y Rendimiento)**
    *   **Archivo Objetivo**: `src/components/VisualNovelCanvas.jsx`
    *   **Arquitectura de Capas**:
        *   **Capa Fondo (PixiJS)**: Renderizado de alto rendimiento para im谩genes y filtros (B/N, Alto Contraste).
        *   **Capa Frontal (HTML/CSS)**: Renderizado de texto y UI para accesibilidad (lectores de pantalla) y estilos din谩micos (cambio de fuentes/colores al vuelo).
    *   **Features**:
        *   Modo "Lectura" (B/N) usando `PIXI.ColorMatrixFilter`.
        *   Escalado de imagen tipo "cover" (Responsive).
        *   Soporte para fuentes OpenDyslexic / alto contraste.

2.  **L贸gica de Datos "Fetcher" (Optimizaci贸n)**
    *   **Archivo Objetivo**: `src/services/StoryRepository.js`
    *   **Estrategia**: `getNodeById(nodeId)` que trae TODO (Imagen, Textos, Opciones) en una sola llamada a Supabase (JOINs de `story_nodes` + `dialogues` + `story_choices`).
    *   **Beneficio**: Carga instant谩nea de escenas.

3.  **Gesti贸n de Estado Centralizada ("El Cerebro")**
    *   **Archivo Objetivo**: `src/engine/StoryEngine.js`
    *   **Hook**: `useStoryEngine(startNodeId)`.
4.  **Motor Narrativo de Decisiones (El rbol)**
    *   **Archivo Objetivo**: `src/engine/StoryEngine.js`
    *   **Funcionalidad**:
        *   Bloqueo de scroll al llegar a decisiones.
        *   **Condiciones Invisibles**: Eval煤a inventario (ej: "驴Tiene llave?") para mostrar/ocultar opciones.
        *   **Memoria**: Registra elecciones para consecuencias futuras.
    *   **Tecnolog铆a**: Grafos Dirigidos (Graph Traversal), Validaci贸n L贸gica JS.

5.  **Sincronizaci贸n Offline-First (Modo Avi贸n)**
    *   **Funcionalidad**:
        *   Descarga de paquetes de cap铆tulos + im谩genes comprimidas.
        *   Lectura sin conexi贸n usando cach茅 local.
        *   Sincronizaci贸n background de `user_progress` al recuperar red.
    *   **Tecnolog铆a**: IndexedDB (Dexie.js / TanStack Query), Service Workers (PWA).

6.  **UI Reactiva "Glassmorphism"**
    *   **Funcionalidad**:
        *   Men煤s flotantes semitransparentes (no tapan el arte).
        *   Animaciones suaves en inventarios/pausa.

**Detalle T茅cnico de Implementaci贸n (R&D Lead):**

1.  **L贸gica del "Director de Escena" (Scene Orchestrator)**
    *   **Funci贸n**: Enrutador de recursos y gesti贸n de transiciones.
    *   **L贸gica**:
        *   Pre-loader: Predice y descarga la siguiente imagen.
        *   Fading: Transiciones suaves entre escenas.
    *   **Tecnolog铆a**: React `useEffect` para escuchar `node_id`.

2.  **Sistema de Capas de Accesibilidad (The Overlay System)**
    *   **Estrategia**: Independencia total entre Arte (Z-Index 0) y Texto (Z-Index 10).
    *   **Features**:
        *   Inyecci贸n de Estilos: `var(--font-dynamic)` para cambios instant谩neos.
        *   Forzado de Accesibilidad: Ignora estilos "art铆sticos" si el usuario activa modos de accesibilidad.

3.  **Motor de Consecuencias (State Machine)**
    *   **Funci贸n**: Validaci贸n de condiciones complejas (Inventory check).
    *   **Tecnolog铆a**:
        *   **XState**: Para visualizar y gestionar estados de la historia.
        *   **JSON Logic**: Reglas guardadas en BD que el frontend ejecuta din谩micamente.

**Resumen de Arquitectura Final:**
*   **Frontend**: React + Tailwind + Framer Motion.
*   **Motor**: PixiJS (Canvas).
*   **Estado**: Zustand + XState.
*   **Offline**: IndexedDB (Dexie.js).
4.  **L贸gica de Sincronizaci贸n H铆brida (Offline-First)**
    *   **Estrategia**: Interceptaci贸n de peticiones de imagen.
    *   **Flujo**:
        1.  驴Hay internet? -> Descarga de Supabase + Cachear.
        2.  驴No hay internet? -> Servir desde cach茅 del navegador (Service Workers).
        3.  Cola de Guardado: Si es offline, guarda decisiones en cola. Al volver online (`window.ononline`), sincroniza con nube.
    *   **Tecnolog铆as**: Service Workers (PWA), TanStack Query / RxDB.

**Especificaci贸n T茅cnica: "Scene Orchestrator" (Ciclo de Vida)**
*   **Responsabilidad**: Gestionar carga de assets -> Renderizado -> Input -> Transici贸n.
*   **Sub-m贸dulos**:
    *   **A. Asset Resolver**: Mapea `node_id` a archivos locales/remotos. Fallback a placeholder elegante.
    *   **B. Accessibility Compositor**:
        *   Capa 0 (Fondo): Imagen (PixiJS) + Filtros.
        *   Capa 1 (Vignette): Gradiente negro para legibilidad.
        *   Capa 2 (Texto): HTML sem谩ntico inyectado con estilos din谩micos (Context).
    *   **C. Decision Engine**: Gesti贸n de timing. Bloquea botones hasta terminar efecto "m谩quina de escribir".
*   **Estrategia Rendimiento ("Regla del +1")**: Pre-carga silenciosa de las im谩genes de las opciones siguientes (Node B, Node C) mientras el usuario lee Node A. USAR `StoryRepository` REAL, no l贸gica comentada.

5.  **Capa de Descubrimiento (Main Menu / Discovery Layer)**
    *   **Concepto**: "Immersive Dark Glass" (Webtoon style).
    *   **Componente**: `src/pages/MainMenu.jsx`.
    *   **Layout**:
        *   **Hero Banner**: 60% alto, imagen destacada + degradado.
        *   **Grilla Series**: Tarjetas verticales (2:3) con efecto hover/zoom.
6.  **Mapa de Funcionalidades por Zona**
    *   **ZONA 1: LA BIBLIOTECA (Main Menu)**
        *   **Ruta**: `/` (Principal).
        *   **Componentes**:
            *   **Hero Banner**: ltima serie jugada o "Featured".
            *   **Grid**: Fetch din谩mico de `series` con animaci贸n Hover (1.05x).
            *   **Jump-In ("Continuar Leyendo")**: Fila superior exclusiva con barra de progreso visual.
            *   **Chips de G茅nero**: Filtrado autom谩tico (Terror, Sci-Fi, Romance).
            *   **Buscador Instant search**: Desvanece (opacity 0.2) lo que no coincide.
        *   **Avatar**: Men煤 desplegable (Logout, Ajustes).

    *   **ZONA 2: EL LECTOR (StoryReader)**
        *   **Ruta**: `/read/:seriesId`.
        *   **Portadas**: Usar `series.cover_url` (assets locales).
        *   **Typewriter Effect**: Texto letra a letra, clic para saltar.
        *   **Pre-Carga Cr铆tica**: Regla +1 activa.

    *   **ZONA 2: EL LECTOR (Mejoras Inmersi贸n)**
        *   **Smart Resume**: Tarjeta ancha en Home con 煤ltima vi帽eta + bot贸n Play.
        *   **Touch Zones**: Izq(20%) Atr谩s | Centro(60%) UI Toggle | Der(20%) Avanzar.
        *   **Modo Cine**: Ocultar UI (Tap centro/Swipe down).
        *   **Backlog**: Historial de di谩logos (煤ltimos 10).
        *   **Feedback**: Haptic vibration (Shake) + Audio Crossfade.
        *   **Destiny Tree**: Mapa visual en men煤 pausa (Nodos visitados/bloqueados).
        *   **Transiciones**: Flash, Fade, Glitch (definidos en JSON).

    *   **ZONA 3: SISTEMA (Calidad de Vida)**
        *   **Multivisor (Sintonizador Visual)**: Panel Flotante Cyberpunk.
            *   Tipograf铆a: Botones con preview real.
            *   Tama帽o: Slider continuo con live-update.
            *   Temas: Original, Sepia, Terminal (Alto Contraste).
        *   **Galer铆a Desbloqueable**: "Clean Art" (sin texto) al terminar cap铆tulos.
        *   **Neural Map (rbol del Destino)**:
            *   Met谩fora: "Circuito Ra铆z" (L铆neas ne贸n, fondo dark).
            *   Nodos: Actual (Pulso), Visitado (Miniatura), Disponible (Punteado), Oculto (Candado).
            *   UX: Pan & Zoom, Centrado autom谩tico.
            *   **Feature Killer**: "Rebobinado" (Reset estado a nodo anterior).


**Usuario:**
> Quiero mirar funcionalidades, pero antes quiero que pruebes la app para ver si hay errores y me sigas arreglandolo.
> ... prueba la app con el navegador ...
> CREAME un usuario de prueba simple para el registro/login. Luego quiero hacer mas historias: Dragones y Mazmorras, Batman, y Rick y Morty.

**Funcionalidad Implementada:**
*   **Debugging & Stabilization Report**:
    *   **Neural Map (`DestinyTreeModal.jsx`)**: Se reemplaz贸 el layout "Grid Mock" por un algoritmo **BFS Tree Real**. Ahora el grafo visualiza la jerarqu铆a real de nodos.
    *   **Crash Prevention**: A帽adidos null-checks defensivos en el renderizado de l铆neas del mapa.
    *   **Browser Verification**: Validada la navegaci贸n (Login -> Menu -> StoryReader -> Map) mediante bypass temporal de auth.

*   **Contenido & Datos (Seeding Expansion)**:
    *   **Script `src/scripts/seed.js`**: Actualizado para crear:
        1.  **Usuario Test**: `test@test.com` / `password123`.
        2.  **Historia 1**: *Dragones y Mazmorras: La Cripta* (Fantas铆a, Branching simple).
        3.  **Historia 2**: *Batman: Sombras de Gotham* (Misterio, Finales m煤ltiples).
        4.  **Historia 3**: *Rick y Morty: Aventura de 20 Minutos* (Sci-Fi, Humor).
    *   **Migraci贸n SQL**: Generado `src/db/migrations/20251214_add_genre.sql` para a帽adir columna `genre` a la tabla `series`, permitiendo el filtrado en el men煤 principal.

**C贸digo Clave:**
`src/scripts/seed.js` (Snippet de Creaci贸n de Historia):
```javascript
await createStory(
    'Batman: Sombras de Gotham', 
    'El Joker ha escondido una bomba...', 
    'Misterio',
    [
        { text: "La se帽al brilla...", speaker: "Batman", choices: [...] },
        // ...
    ]
);
```

**Estado Actual**:
*   Esperando ejecuci贸n manual de migraci贸n SQL en Supabase Dashboard por parte del usuario.
*   Seed script listo para repoblar con g茅neros correctos tras la migraci贸n.

**Usuario:**
> Luego los dialogos los quiero en las imagenes en bocadillos
> Luego los puntos son para el marketplace que te cambia el dise帽o de la pagina entera y cambia las fuentes de texto
> luz verde

**Funcionalidad Implementada:**
*   **Marketplace & Personalizaci贸n**: Puntos, Theme Manager, Tienda de Temas/Fuentes.
*   **Lector**: Bocadillos (Comic Bubbles), Click-to-Finish, Modo Cine.
*   **Mapa**: Drag & Pan, Path Highlighting.


**Usuario:**
> Ahora prueba la app. Para esto crea un usuario simple de prueba primero.

**Funcionalidad Implementada (Testing):**
*   **Creaci贸n de Usuarios**: Se intent贸 usar seed.js y create_test_user.js.
*   **Resultados**:
    *   Validaci贸n estricta de email en Supabase o reCAPTCHA bloquearon 'browser_test@example.com'.
    *   Se cre贸 exitosamente el script de creaci贸n manual con 'roberto.dev.2025@gmail.com'.
*   **Verificaci贸n Manual**:
    *   Se verific贸 la carga del Men煤 Principal y la l贸gica de Fallback (Datos locales si falla la nube).
    *   Se verific贸 la navegaci贸n a /marketplace y /login.


**Usuario:**
> si, usa nano banana. (Generaci贸n de Assets Reimaginados)

**Funcionalidad Implementada (Assets):**
*   **Generaci贸n de Im谩genes**: Se utiliz贸 el modelo 'Nano Banana' (Engine de Imagen) para generar:
    *   Portada Batman: Gotham Noir Style.
    *   Portada D&D: Fantasy Crypt Battle.
    *   Portada Rick & Morty: Sci-Fi Portal Run.
*   **Despliegue**: Assets movidos a /public/assets/images/ reemplazando los placeholders.


**Usuario:**
> YA (Confirmaci贸n de Assets/SQL y Ejecuci贸n Final)

**Funcionalidad Implementada (JSON Engine):**
*   **Arquitectura H铆brida**: Se refactoriz贸 el motor para soportar tanto Base de Datos (Supabase) como JSON Files locales.
*   **StoryLoader.js**: Nuevo servicio para parsear historias desde public/assets.
*   **Heur铆stica de Assets**: Mapeo autom谩tico de scene_id a archivos de imagen (Batman Scene 1 -> 1.jpg, Scene 2a -> A1.jpg).
*   **Historias Activadas**:
    *   Batman (Detective Noir)
    *   D&D (Fantas铆a Cl谩sica)
    *   Rick & Morty (Sci-Fi)
*   **Estado**: C贸digo implementado y verificado est谩ticamente. Login desbloqueado por usuario.

**Usuario:**
> Fix navigation bugs, decision tree layout, and polish UI (Comic Panel & Centered Buttons).

**Funcionalidad Implementada (UI Polish & Stabilization):**
*   **Navegaci贸n Robusta**:
    *   **Bot贸n CONTINUAR**: Implementado avance expl铆cito para nodos lineales (evita confusi贸n con clics accidentales).
    *   **L贸gica de Tipograf铆a**: Correcci贸n de estados `isTyping` vs `finished` para saltar texto suavemente.
    *   **rbol de Decisiones**: Arreglo en la visualizaci贸n de nodos JSON (padres/hijos calculados correctamente en `StoryLoader`).

*   **Estilo Visual "C贸mic Inmersivo"**:
    *   **Layout Limpio**: Di谩logos movidos al fondo de la pantalla (estilo subt铆tulo), sin burbuja invasiva.
    *   **Botones Centrados**: Opciones de decisi贸n ahora aparecen en el centro visual para mayor ergonom铆a.
    *   **Marco de Vi帽eta**: Nuevo contenedor "Comic Panel" que evita el recorte de im谩genes y a帽ade un borde tem谩tico.

*   **Personalizaci贸n Avanzada**:
    *   **Selector de Marco**: Nueva opci贸n en Configuraci贸n (Visual) para cambiar el borde del panel: Negro (Cl谩sico), Blanco (Moderno) o Madera (R煤stico).
    *   **Assets**: Reorganizaci贸n de `/assets/portadas` y estandarizaci贸n de nombres de archivos para todas las historias.

</pre>

        <h2>Arquitectura (JSON Engine Update)</h2>
        <ul>
            <li><strong>StoryLoader</strong>: Servicio de carga de historias desde <code>/public/assets</code>.</li>
            <li><strong>useStoryEngine</strong>: Hook h铆brido (DB + JSON).</li>
            <li><strong>VisualNovelCanvas</strong>: UI reactiva con burbujas de c贸mic.</li>
            <li><strong>Neural Map</strong>: Navegaci贸n visual del 谩rbol de decisiones.</li>
        </ul>
    </div>
</body>

</html>