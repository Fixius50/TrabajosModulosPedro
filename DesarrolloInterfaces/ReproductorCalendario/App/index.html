<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Productividad (Web Style)</title>
    
    <!-- Fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Variables de Color (Tema Oscuro por defecto) --- */
        :root {
            --primary-color: #0A84FF;
            --primary-color-translucent: rgba(10, 132, 255, 0.3);
            --background-color: #000000;
            --container-rgb: 28, 28, 30; /* --container-color: #1C1C1E; */
            --text-color: #FFFFFF;
            --secondary-text-color: #8D8D93;
            --border-color: #38383A;
            --button-background-color: #2C2C2E;
            --danger-color: #FF453A;
            
            /* Usamos rem para accesibilidad y escalado */
            font-size: 16px; /* Base para rem */
        }

        html.light-theme {
            --primary-color: #007AFF;
            --primary-color-translucent: rgba(0, 122, 255, 0.3);
            --background-color: #F2F2F7;
            --container-rgb: 255, 255, 255; /* --container-color: #FFFFFF; */
            --text-color: #000000;
            --secondary-text-color: #8A8A8E;
            --border-color: #E5E5EA;
            --button-background-color: #EFEFF4;
            --danger-color: #FF3B30;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex; /* Cambiado a flex para layout de sidebar */
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Evitar scroll en el body */
            transition: background-color 0.3s, color 0.3s;
            position: relative;
            z-index: 1;
        }
        
        /* Fondo dinámico */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background-position: center;
            background-size: cover;
            filter: blur(10px) brightness(0.7);
            transition: background-image 0.5s ease-in-out;
            background-color: var(--background-color); /* Fondo sólido si no hay imagen */
        }
        
        /* Hoja de estilos dinámica para el fondo */
        #dynamic-bg-style {
            display: none;
        }

        /* --- Barra Lateral de Navegación --- */
        #sidebar-nav {
            width: 15rem; /* Ancho fijo para la barra lateral */
            height: 100vh;
            background-color: rgba(var(--container-rgb), 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* Distribuir botones equitativamente */
            flex-shrink: 0;
            transition: background-color 0.3s, border-color 0.3s;
            z-index: 10;
        }

        .nav-btn {
            background-color: transparent;
            border: none;
            border-radius: 0.5rem; /* 8px */
            padding: 0.75rem; /* 12px */
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            font-size: 1rem; /* 16px */
            font-weight: 500;
            color: var(--secondary-text-color);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            text-align: left;
            width: 100%;
        }
        
        .nav-btn svg {
            width: 1.5rem; /* 24px */
            height: 1.5rem; /* 24px */
            fill: currentColor;
            flex-shrink: 0;
        }

        .nav-btn:hover {
            background-color: var(--button-background-color);
            color: var(--text-color);
        }

        .nav-btn.active {
            background-color: var(--primary-color);
            color: white; /* El color de acento se aplica al fondo */
        }

        /* --- Contenido Principal --- */
        .main-content {
            flex-grow: 1; /* Ocupa el resto del espacio */
            height: 100vh;
            overflow-y: auto; /* Scroll solo en esta área */
            position: relative;
        }

        .app-page {
            width: 100%;
            min-height: 100%;
            padding: 2rem;
            display: none; /* Oculto por defecto */
        }
        
        .app-page.active {
            display: block; /* Visible */
        }

        .content-box {
            background-color: rgba(var(--container-rgb), 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 0.75rem; /* 12px */
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            transition: background-color 0.3s, border-color 0.3s;
            overflow: hidden;
            max-width: 60rem; /* 960px */
            margin-left: auto;
            margin-right: auto;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        /* --- Calendario --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        /* Añadido cursor pointer al h2 */
        .calendar-header h2 { font-weight: 600; color: var(--text-color); margin: 0 1rem; font-size: 1.25rem; cursor: pointer; transition: color 0.2s; }
        .calendar-header h2:hover { color: var(--primary-color); }
        .calendar-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary-color); width: 2.75rem; height: 2.75rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; flex-shrink: 0; }
        .calendar-header button:hover { background-color: var(--button-background-color); }
        .calendar-grid, .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; /* 8px */ }
        .calendar-weekdays div { font-weight: 500; text-align: center; color: var(--secondary-text-color); font-size: 0.8rem; }
        .calendar-day { display: flex; justify-content: center; align-items: center; flex-direction: column; aspect-ratio: 1 / 1; border-radius: 50%; transition: all 0.2s; position: relative; cursor: pointer; }
        .calendar-day.empty { pointer-events: none; opacity: 0.5; }
        .calendar-day.has-task::before { content: ''; width: 0.375rem; height: 0.375rem; background-color: var(--primary-color); border-radius: 50%; position: absolute; bottom: 0.5rem; left: calc(50% - 0.1875rem); z-index: 3; }
        .day-number { width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s ease-in-out; position: relative; z-index: 2; }
        .calendar-day:hover .day-number { background-color: var(--button-background-color); }
        .calendar-day.today .day-number { background-color: var(--danger-color); color: white; font-weight: 700; }
        .calendar-day::after { content: '+'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: 300; color: var(--primary-color); opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 3; }
        .calendar-day:not(.empty):hover .day-number { opacity: 0; }
        .calendar-day:not(.empty):hover::after { opacity: 1; }

        /* Estilos para el selector de meses */
        .calendar-month-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columnas */
            gap: 1rem;
            padding: 1rem 0; /* Espaciado vertical */
        }
        .calendar-month-item {
            padding: 1rem;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .calendar-month-item:hover {
            background-color: var(--button-background-color);
        }
        .calendar-month-item.current { /* Estilo para el mes actual */
             background-color: var(--primary-color-translucent);
             font-weight: 700;
             color: var(--primary-color);
        }


        /* --- Tareas y Reproductor --- */
        .task-date-group { margin-bottom: 1.5rem; }
        .task-date-group h3 { font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .task-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); }
        .task-item:last-child { border-bottom: none; }
        .task-item-content { flex-grow: 1; display: flex; align-items: center; gap: 0.8rem; }
        .task-item input[type="checkbox"] { width: 1.25rem; height: 1.25rem; cursor: pointer; accent-color: var(--primary-color); flex-shrink: 0; }
        .task-item .task-title.completed { text-decoration: line-through; color: var(--secondary-text-color); }
        .task-item .action-btn { background: none; border: none; cursor: pointer; padding: 0.2rem; display: flex; align-items: center; justify-content: center; color: var(--secondary-text-color); /* Color base para SVG */ }
        .task-item .action-btn svg { width: 1.25rem; height: 1.25rem; fill: currentColor; /* Usa color del botón */ transition: color 0.2s; }
        .task-item .action-btn:hover { color: var(--primary-color); /* Cambia color en hover */ }
        .task-item .delete-btn { color: var(--danger-color); font-size: 1.5rem; line-height: 1; }
        .task-item .delete-btn:hover { color: var(--danger-color); /* Mantiene color rojo */}
        
        .settings-card { background-color: rgba(var(--container-rgb), 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 1.5rem; border-radius: 0.75rem; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); }
        .settings-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .player-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        #player-track-title { font-weight: 500; font-size: 1.1rem; text-align: center;}
        
        .time-display { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--secondary-text-color); font-family: 'SF Mono', monospace; width: 100%; max-width: 25rem; margin-top: 0.3rem;}
        .player-controls { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; }
        .player-controls button { background: none; border: none; cursor: pointer; color: var(--text-color); display: flex; align-items: center; justify-content: center; padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s; }
        .player-controls button:hover:not(:disabled) { background-color: var(--button-background-color); }
        .player-controls button svg { fill: currentColor; width: 1.5rem; height: 1.5rem; }
        .player-controls button.active { color: var(--primary-color); } /* Indicador activo para shuffle/repeat */
        .player-controls button:disabled { opacity: 0.4; cursor: not-allowed; background-color: transparent !important; }
        #player-play-pause-btn { background-color: var(--primary-color); color: white; width: 3.75rem; height: 3.75rem; border-radius: 50%; }
        #player-play-pause-btn:hover { background-color: var(--primary-color); filter: brightness(1.1); } /* Ligero brillo */
        #player-play-pause-btn svg { width: 1.875rem; height: 1.875rem; }

        .search-controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; width: 100%; }
        .search-controls input, .search-controls select {
            background-color: var(--button-background-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem; /* 16px */
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--text-color);
            transition: box-shadow 0.2s, border-color 0.2s;
            outline: none;
        }
        .search-controls input:focus, .search-controls select:focus {
            border-color: var(--primary-color);
            /* Usamos la variable --primary-color-translucent para el shadow */
            box-shadow: 0 0 0 2px var(--primary-color-translucent);
        }
        .search-controls input { flex-grow: 1; }
        .search-controls select { flex-shrink: 0; width: 30%; max-width: 9.375rem; /* 150px */ }
        
        #player-playlist { max-height: 15.625rem; /* 250px */ overflow-y: auto; width: 100%; }
        .playlist-item { padding: 0.8rem; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .playlist-item:hover { background-color: var(--button-background-color); }
        .playlist-item.playing { background-color: var(--primary-color); color: white; }
        .playlist-item.playing .track-meta { color: rgba(255,255,255,0.8); }
        .track-meta { font-size: 0.9rem; color: var(--secondary-text-color); }
        
        /* --- Modal (Custom for tasks/sound selector/theme/library) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: rgba(var(--container-rgb), 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 1.5rem; border-radius: 0.75rem; width: 90%; max-width: 37.5rem; /* 600px */ animation: slideIn 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .modal-actions { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.625rem; /* 10px */ }
        .modal-close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--secondary-text-color); line-height: 1; }
        .modal-button { padding: 0.6rem 1rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .modal-button.primary { background-color: var(--primary-color); color: white; }
        .modal-button.danger { background-color: var(--danger-color); color: white; } /* Para botón Descartar */
        .modal-button.secondary { background-color: var(--button-background-color); color: var(--text-color); border: 1px solid var(--border-color); }


        .new-task-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }
        #new-task-input { flex-grow: 1; padding: 0.7rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--button-background-color); font-size: 1rem; color: var(--text-color); }
        #attach-audio-btn svg { width: 1.5rem; height: 1.5rem; fill: var(--primary-color); }
        
        /* Theme modal specific styles (used in custom modal now) */
        .theme-control-group { margin-bottom: 1.5rem; text-align: left;}
        .theme-control-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .theme-control-group input[type="text"], .theme-control-group input[type="color"] { width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--button-background-color); color: var(--text-color); }
        .theme-control-group input[type="color"] { padding: 0; height: 2.5rem; /* 40px */ border: none; cursor: pointer; }
        .theme-control-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .theme-control-group input[type="color"]::-webkit-color-swatch { border-radius: 0.5rem; border: 1px solid var(--border-color); }
        .theme-toggle-btns { display: flex; gap: 0.5rem; }
        .theme-toggle-btns button { flex-grow: 1; padding: 0.7rem; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); border-radius: 0.5rem; cursor: pointer; }
        .theme-toggle-btns button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #bg-image-controls { display: flex; gap: 0.5rem; align-items: center; }
        #bg-image-controls input { flex-grow: 1; }
        #bg-image-controls button { padding: 0.5rem; background-color: var(--button-background-color); border: 1px solid var(--border-color); border-radius: 0.5rem; cursor: pointer; color: var(--text-color); }
        
        /* Library modal styles */
        #library-list-container { max-height: 40vh; overflow-y: auto; text-align: left; }
        .library-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .library-item:last-child { border-bottom: none; }
        .library-item-info { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; }
        .library-item-info input { width: 100%; background: var(--button-background-color); border: 1px solid var(--border-color); border-radius: 0.25rem; padding: 0.3rem; color: var(--text-color); }
        .library-item-title { grid-column: 1 / -1; font-weight: 500; }
        .library-item-duration { justify-self: end; font-family: 'SF Mono', monospace; }
        #library-placeholder { text-align: center; padding: 2rem; color: var(--secondary-text-color); }

        /* Estilos para la página de estadísticas con SVG */
        #stats-chart-container {
            width: 100%;
            max-width: 60rem; 
            margin: 0 auto;
            height: 25rem; 
            /* Quitamos borde y padding, el SVG manejará su espacio */
            position: relative; 
        }
        #stats-svg {
            width: 100%;
            height: 100%;
            overflow: visible; /* Para ver etiquetas fuera del viewbox */
        }
        .stats-area {
            fill: var(--primary-color-translucent);
            stroke: none;
            opacity: 0.8;
        }
        .stats-line {
            fill: none;
            stroke: var(--primary-color);
            stroke-width: 2.5px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .stats-point {
            fill: var(--primary-color);
            stroke: var(--background-color);
            stroke-width: 2px;
            cursor: pointer;
            transition: r 0.2s;
        }
        .stats-point:hover {
            r: 6px; /* Agrandar punto en hover */
        }
        .svg-tooltip {
            position: absolute;
            background: var(--button-background-color);
            color: var(--text-color);
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
            /* Se posicionará con JS */
        }
        .stats-axis {
            stroke: var(--border-color);
            stroke-width: 1px;
            stroke-dasharray: 2 3; /* Línea punteada */
        }
        .stats-label {
            fill: var(--secondary-text-color);
            font-size: 0.75rem; /* 12px */
            font-family: 'Inter', sans-serif;
        }


        @keyframes slideIn { from { transform: translateY(1.25rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Media query para pantallas más pequeñas (móviles) */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            #sidebar-nav { width: 100%; height: auto; padding: 0.5rem; flex-direction: row; justify-content: space-around; border-right: none; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
            .nav-btn { flex-direction: column; gap: 0.2rem; font-size: 0.75rem; padding: 0.5rem; flex-grow: 1; }
            .nav-btn span { display: block; }
            .main-content { height: auto; overflow-y: visible; flex-grow: 1; }
            .app-page { padding: 1rem; }
            .page-title { font-size: 1.75rem; margin-bottom: 1rem; }
            .search-controls { flex-direction: column; }
            .search-controls select { width: 100%; max-width: none; }
            .modal-content { width: 95%; max-height: 85vh; }
            #stats-chart-container { height: 20rem; }
            .stats-label { font-size: 0.65rem; }
        }
    </style>
</head>
<body class="dark-theme"> <!-- Default to dark -->

    <style id="dynamic-bg-style"></style>

    <nav id="sidebar-nav">
        <button class="nav-btn active" data-index="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,3V13.55C11.41,13.21 10.73,13 10,13C7.79,13 6,14.79 6,17C6,19.21 7.79,21 10,21C12.21,21 14,19.21 14,17V7H18V3H12Z" /></svg><span>Música</span></button>
        <button class="nav-btn" data-index="1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z" /></svg><span>Calendario</span></button>
        <button class="nav-btn" data-index="2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.54,5.23C20.83,5.57 21,6 21,6.5C21,7.28 20.5,8.14 19.83,8.71L18.71,7.59C19.05,7.25 19.23,6.9 19.23,6.5C19.23,6.3 19.16,6.11 19.04,5.96L17.5,3.54C17.21,3 16.68,2.65 16,2.5C15.32,2.35 14.63,2.5 14.11,3L12,4.4L9.89,3C9.37,2.5 8.68,2.35 8,2.5C7.32,2.65 6.79,3 6.5,3.54L5,5.96C4.84,6.11 4.77,6.3 4.77,6.5C4.77,6.9 4.95,7.25 5.29,7.59L4.17,8.71C3.5,8.14 3,7.28 3,6.5C3,6 3.17,5.57 3.46,5.23L5.34,2.77C5.8,2.16 6.5,1.74 7.28,1.58C8.06,1.42 8.88,1.58 9.54,2.11L12,4L14.46,2.11C15.12,1.58 15.94,1.42 16.72,1.58C17.5,1.74 18.2,2.16 18.66,2.77L20.54,5.23M19.83,15.29L18.71,16.41C19.05,16.75 19.23,17.1 19.23,17.5C19.23,17.7 19.16,17.89 19.04,18.04L17.5,20.46C17.21,21 16.68,21.35 16,21.5C15.32,21.65 14.63,21.5 14.11,21L12,19.6L9.89,21C9.37,21.5 8.68,21.65 8,21.5C7.32,21.35 6.79,21 6.5,20.46L5,18.04C4.84,17.89 4.77,17.7 4.77,17.5C4.77,17.1 4.95,16.75 5.29,16.41L4.17,15.29C3.5,15.86 3,16.72 3,17.5C3,18 3.17,18.43 3.46,18.77L5.34,21.23C5.8,21.84 6.5,22.26 7.28,22.42C8.06,22.58 8.88,22.42 9.54,21.89L12,20L14.46,21.89C15.12,22.42 15.94,22.58 16.72,22.42C17.5,22.26 18.2,21.84 18.66,21.23L20.54,18.77C20.83,18.43 21,18 21,17.5C21,16.72 20.5,15.86 19.83,15.29M12,8C10.9,8 10,8.9 10,10C10,11.1 10.9,12 12,12C13.1,12 14,11.1 14,10C14,8.9 13.1,8 12,8Z" /></svg><span>Tareas</span></button>
        <button class="nav-btn" data-index="3"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.5,20.5L9.5,14.5L13.5,18.5L19.5,12.5L20.91,13.91L13.5,21.31L9.5,17.31L3.5,23.31L2.09,21.9L3.5,20.5M3.5,12.5L9.5,6.5L13.5,10.5L20.91,3.09L19.5,1.68L13.5,7.68L9.5,3.68L3.5,9.68L2.09,8.27L3.5,6.86L3.5,12.5Z" /></svg><span>Estadísticas</span></button>
        <button class="nav-btn" data-index="4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14,12.94C19.03,11.93 18.69,10.96 18.13,10.06C17.56,9.15 16.74,8.4 15.77,7.85L16.7,6.93C17.09,6.54 17.09,5.91 16.7,5.5L15.28,4.09C14.89,3.7 14.26,3.7 13.87,4.09L12.95,5.02C12.04,4.5 11.07,4.2 10.06,4.1C9.04,4 8,4.16 7.03,4.6L6.11,3.68C5.72,3.29 5.09,3.29 4.7,3.68L3.28,5.09C2.89,5.48 2.89,6.11 3.28,6.5L4.2,7.42C3.66,8.39 3.31,9.45 3.19,10.56C3.07,11.67 3.25,12.8 3.7,13.82L2.78,14.74C2.39,15.13 2.39,15.76 2.78,16.15L4.2,17.56C4.59,17.95 5.22,17.95 5.61,17.56L6.53,16.64C7.44,17.16 8.4,17.47 9.4,17.57C10.4,17.67 11.42,17.5 12.37,17.07L13.29,18C13.68,18.39 14.31,18.39 14.7,18L16.12,16.59C16.5,16.2 16.5,15.57 16.12,15.18L15.2,14.26C15.73,13.35 16.03,12.38 16.04,11.37C16.05,10.36 15.8,9.35 15.3,8.46L17.75,6C18.69,6.94 19.38,8.12 19.75,9.45C20.11,10.78 20.12,12.17 19.77,13.5C19.42,14.82 18.73,16.03 17.79,16.97L19.21,18.38C19.6,18.77 20.23,18.77 20.62,18.38L22,17C22.39,16.61 22.39,15.97 22,15.58C21.39,14.64 20.47,13.9 19.34,13.42C19.24,13.26 19.16,13.1 19.14,12.94M12,9.5A2.5,2.5 0 0,1 14.5,12A2.5,2.5 0 0,1 12,14.5A2.5,2.5 0 0,1 9.5,12A2.5,2.5 0 0,1 12,9.5Z" /></svg><span>Ajustes</span></button>
    </nav>

    <main class="main-content">
        <div class="app-page active" data-title="Reproductor">
            <h1 class="page-title">Música</h1>
            <div class="content-box player-container">
                <p id="player-track-title">Ningún sonido seleccionado</p>
                <div class="time-display"><span id="player-current-time">0:00</span><span id="player-total-time">0:00</span></div>
                <div class="player-controls">
                    <button id="player-shuffle-btn" aria-label="Aleatorio"></button>
                    <button id="player-prev-btn" aria-label="Anterior"></button>
                    <button id="player-play-pause-btn" aria-label="Reproducir/Pausar"></button>
                    <button id="player-next-btn" aria-label="Siguiente"></button>
                    <button id="player-repeat-btn" aria-label="Repetir"></button>
                </div>
            </div>
            <div class="content-box">
                <div class="search-controls"><input type="search" id="search-bar" placeholder="Buscar en la biblioteca..."><select id="artist-filter"></select><select id="genre-filter"></select></div>
                <div id="player-playlist"></div>
            </div>
        </div>
        <div class="app-page" data-title="Calendario">
            <h1 class="page-title">Calendario</h1>
            <div id="calendar-container" class="content-box">
                <div class="calendar-header"><button id="prev-month-btn" aria-label="Mes anterior">&lt;</button><h2 id="month-year-display"></h2><button id="next-month-btn" aria-label="Mes siguiente">&gt;</button></div>
                <div id="calendar-grid-wrapper"><div class="calendar-weekdays"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div><div id="calendar-grid" class="calendar-grid"></div></div>
                 <!-- Contenedor para selector de mes (oculto inicialmente si se necesita) -->
                 <div id="month-selector-wrapper" style="display: none;"></div>
            </div>
        </div>
        <div class="app-page" data-title="Tareas">
            <h1 class="page-title">Tareas</h1>
            <div id="tasks-list-container" class="content-box"></div>
        </div>
        <div class="app-page" data-title="Estadísticas">
            <h1 class="page-title">Estadísticas</h1>
            <div class="content-box">
                <!-- Contenedor relativo para el tooltip del SVG -->
                <div id="stats-chart-container" style="position: relative;">
                    <!-- El SVG se creará aquí -->
                     <div class="svg-tooltip" style="display: none;"></div>
                </div>
            </div>
        </div>
        <div class="app-page" data-title="Ajustes">
            <h1 class="page-title">Ajustes</h1>
            <div style="display: grid; gap: 1rem; max-width: 60rem; margin: 0 auto;">
                <div id="theme-settings-card" class="settings-card"><h3>Tema de la Aplicación</h3><p>Personaliza la apariencia.</p></div>
                <div id="library-settings-card" class="settings-card"><h3>Biblioteca de Sonidos</h3><p>Gestiona tus archivos de audio.</p></div>
            </div>
        </div>
    </main>

    <input type="file" id="audio-file-input" multiple accept="audio/*" style="display: none;">
    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title"></h3><button class="modal-close-btn" aria-label="Cerrar">&times;</button></div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-actions" class="modal-actions"></div>
        </div>
    </div>
     <!-- Modal de Confirmación (oculto) -->
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 25rem;"> <!-- Más pequeño -->
            <div class="modal-header">
                <h3 id="confirm-modal-title">Descartar Cambios</h3>
                <!-- Sin botón X aquí -->
            </div>
            <div id="confirm-modal-body" class="modal-body">
                <p>¿Seguro que quieres cerrar sin guardar los cambios en el tema?</p>
            </div>
            <div id="confirm-modal-actions" class="modal-actions" style="justify-content: space-between;">
                 <button id="confirm-discard-btn" class="modal-button danger">Descartar</button>
                 <button id="confirm-cancel-btn" class="modal-button secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Librerías Externas -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.core.min.js"></script>
    <!-- ELIMINADAS LIBRERÍAS DE CHART.JS -->

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- Setup Day.js ---
        dayjs.extend(window.dayjs_plugin_isSameOrAfter);
        dayjs.locale('es');
        
        // --- ICONS ---
        const ICONS = { /* ... */ 
            play: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`,
            pause: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`,
            prev: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path></svg>`,
            next: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM8 18l8.5-6L8 6z"></path></svg>`,
            shuffle: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.59,9.17L5.41,4L4,5.41L9.17,10.59L10.59,9.17M14.83,13.41L13.41,14.83L18.59,20L20,18.59L14.83,13.41M14.83,9.17L9.17,3.5L4,8.67V4H2V10H8L3,15L4.41,16.41L10.59,10.24L11.76,11.41L10.21,12.96L11.62,14.38L13.41,12.59L14.83,9.17Z" /></svg>`,
            repeat: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17,17H7V14L3,18L7,22V19H19V13H17M7,7H17V10L21,6L17,2V5H5V11H7V7Z" /></svg>`,
            repeatOne: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13,15V9H12L10,10V11H11.5V15M17,17H7V14L3,18L7,22V19H19V13H17M7,7H17V10L21,6L17,2V5H5V11H7V7Z" /></svg>`,
            attach: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16,12A2,2 0 0,0 18,10A2,2 0 0,0 16,8A2,2 0 0,0 14,10A2,2 0 0,0 16,12M16,4.05C18.37,4.05 20.44,5.38 21.32,7.34L22.21,9.23L19.75,10.15L19.34,9.31C18.78,8.16 17.5,7.39 16,7.39C14.5,7.39 13.22,8.16 12.66,9.31L12.25,10.15L9.79,9.23L10.68,7.34C11.56,5.38 13.63,4.05 16,4.05M8,12A2,2 0 0,0 10,10A2,2 0 0,0 8,8A2,2 0 0,0 6,10A2,2 0 0,0 8,12M8,4.05C10.37,4.05 12.44,5.38 13.32,7.34L14.21,9.23L11.75,10.15L11.34,9.31C10.78,8.16 9.5,7.39 8,7.39C6.5,7.39 5.22,8.16 4.66,9.31L4.25,10.15L1.79,9.23L2.68,7.34C3.56,5.38 5.63,4.05 8,4.05M16,14C13.63,14 11.56,15.33 10.68,17.28L9.79,19.17L12.25,18.25L12.66,17.41C13.22,16.26 14.5,15.5 16,15.5C17.5,15.5 18.78,16.26 19.34,17.41L19.75,18.25L22.21,19.17L21.32,17.28C20.44,15.33 18.37,14 16,14M8,14C5.63,14 3.56,15.33 2.68,17.28L1.79,19.17L4.25,18.25L4.66,17.41C5.22,16.26 6.5,15.5 8,15.5C9.5,15.5 10.78,16.26 11.34,17.41L11.75,18.25L14.21,19.17L13.32,17.28C12.44,15.33 10.37,14 8,14Z" /></svg>`,
            play_task: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M10,16.5L16,12L10,7.5V16.5Z" /></svg>`
        };

        // --- Utils --- Moved Up ---
        // (Funciones de utilidad movidas aquí para asegurar que estén definidas)
        function hexToRgb(hex) { var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
        function openModal(title, bodyEl, actionsEl = null) { if (!dom.modal.overlay) return; dom.modal.title.textContent = title; dom.modal.body.innerHTML = ''; dom.modal.body.appendChild(bodyEl); dom.modal.actions.innerHTML = ''; if (actionsEl) dom.modal.actions.appendChild(actionsEl); dom.modal.overlay.classList.add('visible'); }
        function closeModal(force = false) { 
            if (!force && dom.modal.title.textContent === 'Personalizar Tema' && state.modal.themeChangesMade) {
                openConfirmModal(); 
            } else {
                forceCloseModal(); 
            }
        }
        async function forceCloseModal() { 
            await applyTheme(state.modal.initialThemeSettings); 
            if (dom.modal.overlay) dom.modal.overlay.classList.remove('visible'); 
            state.modal.themeChangesMade = false; 
            state.modal.initialThemeSettings = null; 
             const urlInput = document.getElementById('bg-image-url');
             if(urlInput?.dataset.imageDataUrl) {
                 delete urlInput.dataset.imageDataUrl;
             }
        } 
        function openConfirmModal() { if (dom.confirmModal.overlay) dom.confirmModal.overlay.classList.add('visible'); }
        function closeConfirmModal() { if (dom.confirmModal.overlay) dom.confirmModal.overlay.classList.remove('visible'); }
        function createElement(tag, attrs = {}, ...children) { const el = document.createElement(tag); Object.entries(attrs).forEach(([k, v]) => { if (k === 'class') el.className = v; else if (k.startsWith('data-')) el.dataset[k.substring(5)] = v; else if (typeof v === 'boolean') el[k] = v; else if (v != null) el.setAttribute(k, v); }); children.forEach(c => c != null && el.append(typeof c === 'string' ? document.createTextNode(c) : c)); return el; }
        // Se necesita crear el namespace de SVG
        function createElementNS(ns, tag, attrs = {}, ...children) { const el = document.createElementNS(ns, tag); Object.entries(attrs).forEach(([k, v]) => { if (v != null) el.setAttribute(k, v); }); children.forEach(c => c != null && el.append(typeof c === 'string' ? document.createTextNode(c) : c)); return el; }
        function formatTime(secs) { if(isNaN(secs)||secs<0)return '0:00'; const m=Math.floor(secs/60); const s=Math.floor(secs%60).toString().padStart(2,'0'); return `${m}:${s}`; }
        function debounce(fn, wait) { let t; return function(...a){ const later=()=>{clearTimeout(t); fn.apply(this,a);}; clearTimeout(t); t=setTimeout(later, wait);}; }
        function shuffleArray(a) { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
        function showAppAlert(title, message) { console.warn(`Alert suppressed: ${title} - ${message}`); }

        // --- DOM Elements ---
        const dom = { /* ... dom elements ... */ 
            body: document.body,
            sidebar: document.getElementById('sidebar-nav'),
            navButtons: document.querySelectorAll('.nav-btn'),
            appPages: document.querySelectorAll('.app-page'),
            calendar: { container: document.getElementById('calendar-container'), gridWrapper: document.getElementById('calendar-grid-wrapper'), monthSelectorWrapper: document.getElementById('month-selector-wrapper'), monthYearDisplay: document.getElementById('month-year-display'), prevMonthBtn: document.getElementById('prev-month-btn'), nextMonthBtn: document.getElementById('next-month-btn'), grid: document.getElementById('calendar-grid') },
            player: { trackTitle: document.getElementById('player-track-title'), currentTime: document.getElementById('player-current-time'), totalTime: document.getElementById('player-total-time'), playPauseBtn: document.getElementById('player-play-pause-btn'), prevBtn: document.getElementById('player-prev-btn'), nextBtn: document.getElementById('player-next-btn'), shuffleBtn: document.getElementById('player-shuffle-btn'), repeatBtn: document.getElementById('player-repeat-btn'), playlist: document.getElementById('player-playlist'), searchBar: document.getElementById('search-bar'), artistFilter: document.getElementById('artist-filter'), genreFilter: document.getElementById('genre-filter') },
            tasks: { container: document.getElementById('tasks-list-container') },
            stats: { chartContainer: document.getElementById('stats-chart-container') }, // Actualizado
            settings: { themeCard: document.getElementById('theme-settings-card'), libraryCard: document.getElementById('library-settings-card') },
            modal: { overlay: document.getElementById('modal-overlay'), title: document.getElementById('modal-title'), body: document.getElementById('modal-body'), actions: document.getElementById('modal-actions'), closeBtn: document.querySelector('#modal-overlay .modal-close-btn') }, // Target specific close button
            confirmModal: { overlay: document.getElementById('confirm-modal-overlay'), discardBtn: document.getElementById('confirm-discard-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') }, // Añadido
            audioFileInput: document.getElementById('audio-file-input'),
            bgImageInput: document.getElementById('bg-image-input'),
        };

        // --- Application State ---
        const state = { /* ... state ... */ 
            db: null, dayDataMap: {}, soundLibrary: [], currentTrackId: null, currentHowl: null, currentPlaylist: [], currentTrackIndexInPlaylist: -1, isShuffling: false, repeatMode: 'none', currentDate: dayjs(), calendarViewMode: 'days', calendarYearInView: dayjs().year(), currentPageIndex: 0, 
            modal: { selectedAudioId: null, themeChangesMade: false, initialThemeSettings: null }, 
            playback: { rafId: null },
            stats: { listeningLog: {}, sessionStartTime: 0 } // Eliminado chartInstance
        };
        
        // --- App Initialization ---
        async function init() { /* ... init logic ... */ 
             try { state.db = await initDB(); if (!state.db) throw new Error("DB init failed."); await Promise.all([ loadTasksFromDB(), loadListeningLogFromDB(), loadSoundsFromDB() ]); const settings = await loadSettingsFromDB(); state.modal.initialThemeSettings = settings || {}; // Guardar estado inicial o vacío
                await applyTheme(settings); setupEventListeners(); setupPlayerIcons(); goToPage(state.currentPageIndex, true); renderAllTabs(); } 
             catch (error) { console.error("Error fatal:", error); }
        }
        
        // Renderiza el contenido de todas las pestañas
        function renderAllTabs() { /* ... renderAllTabs logic ... */ renderCalendar(); renderTasks(); renderStatsPage(); populateFilterDropdowns(); renderPlayerPlaylist(); updatePlayerUI(); }
        
        // --- IndexedDB ---
        function initDB() { /* ... initDB logic ... */ return new Promise((resolve, reject) => { if (!window.indexedDB) return reject(new Error("IndexedDB not supported")); const DB_NAME = 'AudioAppDB', DB_VERSION = 3; const request = indexedDB.open(DB_NAME, DB_VERSION); request.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains('sounds')) db.createObjectStore('sounds', { keyPath: 'id', autoIncrement: true }); if (!db.objectStoreNames.contains('tasks')) db.createObjectStore('tasks', { keyPath: 'date' }); if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' }); if (!db.objectStoreNames.contains('listeningLog')) db.createObjectStore('listeningLog', { keyPath: 'date' }); }; request.onsuccess = e => resolve(e.target.result); request.onerror = e => { console.error("DB error:", e.target.error); reject(e.target.error); }; }); }

        // --- Persistencia Tareas (IndexedDB) ---
        async function saveTasksToDB(dateStr, tasksArray) { /* ... saveTasksToDB logic ... */ if (!state.db) return; return new Promise((resolve, reject) => { const tx = state.db.transaction(['tasks'], 'readwrite'); const store = tx.objectStore('tasks'); let req; if (tasksArray?.length > 0) { req = store.put({ date: dateStr, tasks: tasksArray }); } else { req = store.delete(dateStr); } req.onsuccess = resolve; req.onerror = e => { console.error("Error saving tasks:", e.target.error); reject(e.target.error); }; }); }
        async function loadTasksFromDB() { /* ... loadTasksFromDB logic ... */ if (!state.db) return; return new Promise((resolve, reject) => { state.dayDataMap = {}; const tx = state.db.transaction(['tasks'], 'readonly'); const store = tx.objectStore('tasks'); const req = store.getAll(); req.onsuccess = e => { e.target.result?.forEach(item => { state.dayDataMap[item.date] = { tasks: item.tasks }; }); resolve(); }; req.onerror = e => { console.error("Error loading tasks:", e.target.error); state.dayDataMap = {}; reject(e.target.error); }; }); }

        // --- Persistencia Ajustes (IndexedDB) ---
        async function saveSettingsToDB(settings) { /* ... saveSettingsToDB logic ... */ if (!state.db) return; return new Promise((resolve, reject) => { const tx = state.db.transaction(['settings'], 'readwrite'); const store = tx.objectStore('settings'); const data = { id: 'userSettings', ...settings }; const req = store.put(data); req.onsuccess = resolve; req.onerror = e => { console.error("Error saving settings:", e.target.error); reject(e.target.error); }; }); }
        async function loadSettingsFromDB() { /* ... loadSettingsFromDB logic ... */ if (!state.db) return null; return new Promise(resolve => { const tx = state.db.transaction(['settings'], 'readonly'); const store = tx.objectStore('settings'); const req = store.get('userSettings'); req.onsuccess = e => resolve(e.target.result || null); req.onerror = e => { console.error("Error loading settings:", e.target.error); resolve(null); }; }); }

        // --- Persistencia Estadísticas (IndexedDB) ---
        async function saveListeningLogToDB() { /* ... saveListeningLogToDB logic ... */ if (!state.db) return; return new Promise(async (resolve, reject) => { const tx = state.db.transaction(['listeningLog'], 'readwrite'); const store = tx.objectStore('listeningLog'); const entries = Object.entries(state.stats.listeningLog); if (entries.length === 0) { resolve(); return; } try { await Promise.all(entries.map(([date, seconds]) => new Promise((res, rej) => { const req = store.put({ date, seconds }); req.onsuccess = res; req.onerror = e => { console.error(`Error log save ${date}:`, e.target.error); rej(e.target.error); }; }) )); resolve(); } catch (err) { reject(err); } }); }
       async function loadListeningLogFromDB() { /* ... loadListeningLogFromDB logic ... */ if (!state.db) return; return new Promise(async (resolve, reject) => { state.stats.listeningLog = {}; const tx = state.db.transaction(['listeningLog'], 'readonly'); const store = tx.objectStore('listeningLog'); const req = store.getAll(); req.onsuccess = async (e) => { const results = e.target.result; if (results?.length > 0) { results.forEach(item => { state.stats.listeningLog[item.date] = item.seconds; }); resolve(); } else { console.log("No log, simulating..."); simulateListeningData(); try { await saveListeningLogToDB(); console.log("Simulated saved."); resolve(); } catch (err) { console.error("Failed save simulated log:", err); reject(err); } } }; req.onerror = e => { console.error("Error loading log:", e.target.error); state.stats.listeningLog = {}; reject(e.target.error); }; }); }
       function simulateListeningData() { /* ... simulateListeningData con patron semanal ... */ 
            state.stats.listeningLog = {}; const today = dayjs(); const days = 30; 
            for (let i = days; i > 0; i--) {
                const date = today.subtract(i, 'day'); const ds = date.format('YYYY-MM-DD'); const dow = date.day(); 
                let min = (dow === 0 || dow === 6) ? 30 : 5; let max = (dow === 0 || dow === 6) ? 180 : 90;
                const mins = Math.floor(Math.random() * (max - min + 1)) + min; state.stats.listeningLog[ds] = mins * 60; 
            }
             const ts = today.format('YYYY-MM-DD'); if (!state.stats.listeningLog[ts]) { state.stats.listeningLog[ts] = 0; }
        }
        
        // --- Registro de Estadísticas ---
         function stopAndLogListeningSession() { /* ... stopAndLogListeningSession logic ... */ if (state.sessionStartTime > 0) { const elapsed = Math.floor((Date.now() - state.sessionStartTime) / 1000); if (elapsed > 1) { const today = dayjs().format('YYYY-MM-DD'); const current = state.stats.listeningLog[today] || 0; state.stats.listeningLog[today] = current + elapsed; saveListeningLogToDB(); if (state.currentPageIndex === 3) { renderStatsPage(); } } state.sessionStartTime = 0; } }
        
        // --- Sound Library ---
        async function loadSoundsFromDB() { /* ... loadSoundsFromDB logic ... */ return new Promise((resolve, reject) => { if (!state.db) return reject("DB missing"); const tx = state.db.transaction('sounds', 'readonly'); const store = tx.objectStore('sounds'); const req = store.getAll(); req.onsuccess = () => { state.soundLibrary = req.result || []; resolve(); }; req.onerror = e => { console.error("Error loading sounds:", e.target.error); reject(e.target.error); }; }); }
        async function handleFileSelection(e) { /* ... handleFileSelection logic ... */ closeModal(); openModal('Cargando...', createElement('p', {}, 'Espera...')); try { for (const f of e.target.files) { if (f.type.startsWith('audio/')) await saveSoundToDB(f); } await loadSoundsFromDB(); closeModal(); openLibraryModal(); renderAllTabs(); } catch (err) { closeModal(); console.error('Error carga archivos', err); } finally { e.target.value = null; } }
        function saveSoundToDB(file) { /* ... saveSoundToDB logic ... */ return new Promise(async (resolve, reject) => { if (!state.db) return reject("DB missing"); try { const duration = await getAudioDuration(file); if (file.size > 50*1024*1024) throw new Error(`${file.name} > 50MB`); const sound = { name: file.name.replace(/\.[^/.]+$/, ""), artist: 'Desconocido', genre: 'Desconocido', duration, file }; const tx = state.db.transaction('sounds', 'readwrite'); const store = tx.objectStore('sounds'); const req = store.add(sound); req.onsuccess = resolve; req.onerror = e => reject(e.target.error); } catch (err) { console.error(err.message); reject(err); } }); }
        function updateSoundInDB(soundData) { /* ... updateSoundInDB logic ... */ if (!state.db) return; const tx = state.db.transaction('sounds', 'readwrite'); tx.objectStore('sounds').put(soundData); }
        function getAudioDuration(file) { /* ... getAudioDuration logic ... */ return new Promise((resolve, reject) => { const audio = document.createElement('audio'); audio.preload = 'metadata'; audio.onloadedmetadata = () => { URL.revokeObjectURL(audio.src); resolve(audio.duration); }; audio.onerror = () => { URL.revokeObjectURL(audio.src); reject(new Error(`Duración no leída ${file.name}`)); }; audio.src = URL.createObjectURL(file); }); }

        // --- Event Listeners Setup ---
        function setupEventListeners() { /* ... setupEventListeners logic ... */ dom.sidebar.addEventListener('click', e => { const btn = e.target.closest('.nav-btn'); if (btn) goToPage(parseInt(btn.dataset.index, 10)); }); if (dom.calendar.monthYearDisplay) dom.calendar.monthYearDisplay.addEventListener('click', toggleCalendarView); if (dom.calendar.prevMonthBtn) dom.calendar.prevMonthBtn.onclick = handlePrevClick; if (dom.calendar.nextMonthBtn) dom.calendar.nextMonthBtn.onclick = handleNextClick; if (dom.calendar.grid) dom.calendar.grid.onclick = handleCalendarGridClick; if (dom.calendar.monthSelectorWrapper) dom.calendar.monthSelectorWrapper.addEventListener('click', handleMonthSelectorClick); if (dom.tasks.container) dom.tasks.container.onclick = handleTaskClick; if (dom.settings.themeCard) dom.settings.themeCard.onclick = openThemeModal; if (dom.settings.libraryCard) dom.settings.libraryCard.onclick = openLibraryModal; if (dom.modal.closeBtn) dom.modal.closeBtn.addEventListener('click', () => closeModal()); if (dom.modal.overlay) dom.modal.overlay.addEventListener('click', e => { if (e.target === dom.modal.overlay) closeModal(); }); if (dom.confirmModal.discardBtn) dom.confirmModal.discardBtn.addEventListener('click', () => { closeConfirmModal(); forceCloseModal(); }); if (dom.confirmModal.cancelBtn) dom.confirmModal.cancelBtn.addEventListener('click', closeConfirmModal); if (dom.audioFileInput) dom.audioFileInput.onchange = handleFileSelection; if (dom.bgImageInput) dom.bgImageInput.onchange = handleBgImageSelection; const debouncedRender = debounce(renderPlayerPlaylist, 300); if (dom.player.searchBar) dom.player.searchBar.oninput = debouncedRender; if (dom.player.artistFilter) dom.player.artistFilter.onchange = renderPlayerPlaylist; if (dom.player.genreFilter) dom.player.genreFilter.onchange = renderPlayerPlaylist; if (dom.player.playlist) dom.player.playlist.onclick = handlePlaylistClick; if (dom.player.playPauseBtn) dom.player.playPauseBtn.onclick = togglePlayPause; if (dom.player.prevBtn) dom.player.prevBtn.onclick = playPrevTrack; if (dom.player.nextBtn) dom.player.nextBtn.onclick = playNextTrack; if (dom.player.shuffleBtn) dom.player.shuffleBtn.onclick = toggleShuffle; if (dom.player.repeatBtn) dom.player.repeatBtn.onclick = cycleRepeatMode; }
        
        // --- Navegación de Página ---
        function goToPage(index, isInitialLoad = false) { /* ... goToPage logic ... */ if (index === state.currentPageIndex && !isInitialLoad) return; state.currentPageIndex = index; dom.navButtons.forEach((btn, i) => btn.classList.toggle('active', i === index)); dom.appPages.forEach((page, i) => page.classList.toggle('active', i === index)); if (index === 2) renderTasks(); if (index === 3) renderStatsPage(); }

        // --- Calendar & Task ---
        function toggleCalendarView() { /* ... toggleCalendarView logic ... */ state.calendarViewMode = (state.calendarViewMode === 'days') ? 'months' : 'days'; if (state.calendarViewMode === 'months') state.calendarYearInView = state.currentDate.year(); renderCalendar(); }
        function handlePrevClick() { /* ... handlePrevClick logic ... */ if (state.calendarViewMode === 'days') state.currentDate = state.currentDate.subtract(1, 'month'); else state.calendarYearInView--; renderCalendar(); }
        function handleNextClick() { /* ... handleNextClick logic ... */ if (state.calendarViewMode === 'days') state.currentDate = state.currentDate.add(1, 'month'); else state.calendarYearInView++; renderCalendar(); }
        function handleCalendarGridClick(e) { /* ... handleCalendarGridClick logic ... */ if (state.calendarViewMode !== 'days') return; const dayEl = e.target.closest('.calendar-day:not(.empty)'); if (dayEl) openDayModal(dayEl.dataset.date); }
        function handleMonthSelectorClick(e) { /* ... handleMonthSelectorClick logic ... */ if (state.calendarViewMode !== 'months') return; const monthItem = e.target.closest('.calendar-month-item'); if (monthItem) { const monthIdx = parseInt(monthItem.dataset.month, 10); state.currentDate = dayjs().year(state.calendarYearInView).month(monthIdx); state.calendarViewMode = 'days'; renderCalendar(); } }
        async function handleTaskClick(e) { /* ... handleTaskClick logic ... */ const target = e.target; const taskItem = target.closest('.task-item'); if (!taskItem) return; const { date, index } = taskItem.dataset; const taskIndex = parseInt(index, 10); if (!state.dayDataMap[date]?.tasks?.[taskIndex]) { console.error("Task data missing:", date, index); return; } const task = state.dayDataMap[date].tasks[taskIndex]; let needsSave = false; if (target.type === 'checkbox') { task.completed = target.checked; needsSave = true; } else if (target.closest('.play-task-btn')) { playAudioClip(task.audioId); } else if (target.closest('.delete-btn')) { state.dayDataMap[date].tasks.splice(taskIndex, 1); needsSave = true; } if (needsSave) { try { await saveTasksToDB(date, state.dayDataMap[date].tasks); renderTasks(); renderCalendar(); } catch (err) { console.error("Failed task save:", err); } } }
        
        // --- Theme & Modal ---
        // showAppAlert ya definida arriba
        
        async function openThemeModal() { 
            state.modal.initialThemeSettings = await loadSettingsFromDB() || {}; state.modal.themeChangesMade = false; 
            const savedTheme = state.modal.initialThemeSettings.themeClass || 'dark-theme'; const defaultColor = savedTheme === 'dark-theme' ? '#0A84FF' : '#007AFF'; const savedColor = state.modal.initialThemeSettings.primaryColor || defaultColor; const savedBg = state.modal.initialThemeSettings.backgroundImage || ''; const isLocalFile = savedBg.startsWith('data:');
            const body = createElement('div'); const themeToggleGroup = createElement('div', { class: 'theme-control-group' }, createElement('label', {}, 'Modo')); const themeBtns = createElement('div', { class: 'theme-toggle-btns' }, createElement('button', { 'data-theme': 'light-theme', class: savedTheme === 'light-theme' ? 'active' : '' }, 'Claro'), createElement('button', { 'data-theme': 'dark-theme', class: savedTheme === 'dark-theme' ? 'active' : '' }, 'Oscuro') ); themeToggleGroup.appendChild(themeBtns); body.appendChild(themeToggleGroup); const colorPickerGroup = createElement('div', { class: 'theme-control-group' }, createElement('label', { for: 'color-picker' }, 'Acento')); const colorPicker = createElement('input', { type: 'color', id: 'color-picker', value: savedColor }); colorPickerGroup.appendChild(colorPicker); body.appendChild(colorPickerGroup); const bgImageGroup = createElement('div', { class: 'theme-control-group' }, createElement('label', { for: 'bg-image-url' }, 'Fondo (URL)')); const bgImageControls = createElement('div', { id: 'bg-image-controls' }, createElement('input', { type: 'text', id: 'bg-image-url', placeholder: 'URL o subir...', value: savedBg.startsWith('http') ? savedBg : (isLocalFile ? 'Local' : '') }), createElement('button', { id: 'upload-bg-btn' }, 'Subir'), createElement('button', { id: 'clear-bg-btn' }, 'Quitar') ); bgImageGroup.appendChild(bgImageControls); body.appendChild(bgImageGroup); const actions = createElement('button', { class: 'modal-button primary' }, 'Guardar'); 
            openModal('Personalizar Tema', body, actions);
            
            // Listener para aplicar TEMA dinámicamente (solo visual)
            themeBtns.onclick = e => { if (e.target.tagName !== 'BUTTON') return; themeBtns.querySelector('.active')?.classList.remove('active'); e.target.classList.add('active'); state.modal.themeChangesMade = true; applyThemePreview(); }; // Llama a preview
            // Listener para aplicar COLOR dinámicamente (solo visual)
            colorPicker.oninput = () => { state.modal.themeChangesMade = true; applyThemePreview(); }; // Llama a preview

            body.querySelector('#upload-bg-btn').onclick = () => dom.bgImageInput.click(); 
            body.querySelector('#clear-bg-btn').onclick = () => { body.querySelector('#bg-image-url').value = ''; state.modal.themeChangesMade = true; }; 
            
            // Botón GUARDAR - Guarda TODO y aplica
            actions.onclick = async () => { 
                const urlInputEl = body.querySelector('#bg-image-url');
                const imageUrlInput = urlInputEl.value.trim(); 
                let finalBg = ''; 

                if (imageUrlInput === '') { finalBg = ''; } 
                else if (imageUrlInput === 'Local') {
                    // Si dice 'Local', intentar obtener dataUrl del dataset (si se subió uno nuevo)
                    // Si no hay, usar el que ya estaba guardado (initialThemeSettings)
                    finalBg = urlInputEl.dataset.imageDataUrl || state.modal.initialThemeSettings.backgroundImage || ''; 
                }
                else if (/^https?:\/\//i.test(imageUrlInput)) { finalBg = imageUrlInput; } 
                else if (/^www\./i.test(imageUrlInput)) { finalBg = 'https://' + imageUrlInput; } 
                else { console.error("URL Inválida..."); return; }
                
                const settings = { 
                    themeClass: themeBtns.querySelector('.active').dataset.theme, 
                    primaryColor: colorPicker.value, 
                    backgroundImage: finalBg, 
                }; 
                await saveSettingsToDB(settings); 
                state.modal.initialThemeSettings = settings; // Actualizar estado inicial guardado
                state.modal.themeChangesMade = false; // Resetear flag
                await applyTheme(settings); // Aplicar tema FINAL
                forceCloseModal(); 
            }; 
        }

        // Función para aplicar tema temporalmente (preview)
        function applyThemePreview() {
             const themeBtns = document.querySelector('.theme-toggle-btns');
             const colorPicker = document.getElementById('color-picker');
             if (!themeBtns || !colorPicker) return; // Salir si los elementos no están

             const tempSettings = {
                 themeClass: themeBtns.querySelector('.active')?.dataset.theme || state.modal.initialThemeSettings.themeClass || 'dark-theme',
                 primaryColor: colorPicker.value,
                 // Usar la imagen de fondo guardada (la inicial) para la preview, no intentar previsualizar cambios de imagen
                 backgroundImage: state.modal.initialThemeSettings.backgroundImage || '' 
             };
             applyTheme(tempSettings); // Llama a applyTheme con los valores TEMPORALES
        }
       
       async function handleBgImageSelection(e) { 
            const file = e.target.files[0]; 
            if (file?.type.startsWith('image/')) { 
                const reader = new FileReader(); 
                reader.onload = async (event) => { 
                    const dataUrl = event.target.result; 
                    if (dataUrl.length > 2*1024*1024) { console.error("Imagen > 2MB"); return; } 
                    const urlInput = document.getElementById('bg-image-url'); 
                    if(urlInput) {
                        urlInput.value = 'Local'; // Update visual cue
                        urlInput.dataset.imageDataUrl = dataUrl; // Guardar dataUrl temporalmente en el dataset del input
                    }
                    state.modal.themeChangesMade = true; 
                    // NO aplicar tema aquí
                }; 
                e.target.value = null; 
                reader.onerror = () => console.error("Error carga imagen.");
                reader.readAsDataURL(file); 
            } 
        }

       async function applyTheme(settings = null) { /* ... applyTheme logic (igual que antes) ... */ if (!settings) settings = await loadSettingsFromDB(); settings = settings || {}; const themeClass = settings.themeClass || 'dark-theme'; const defaultColor = themeClass === 'dark-theme' ? '#0A84FF' : '#007AFF'; const primaryColor = settings.primaryColor || defaultColor; const bgImg = settings.backgroundImage || ''; document.documentElement.className = themeClass; const rgb = hexToRgb(primaryColor); const transl = rgb ? `rgba(${rgb.r},${rgb.g},${rgb.b},0.3)` : 'rgba(0,122,255,0.3)'; document.documentElement.style.setProperty('--primary-color', primaryColor); document.documentElement.style.setProperty('--primary-color-translucent', transl); document.getElementById('dynamic-bg-style').textContent = `body::before{background-image:${bgImg?`url('${bgImg}')`:'none'};}`; if (state.currentPageIndex === 3) renderStatsPage(); }
       
        // --- Modales ---
       async function openDayModal(dateStr) { /* ... openDayModal logic ... */ 
            state.modal.selectedAudioId = null; const date = dayjs(dateStr); const dayData = state.dayDataMap[dateStr] || { tasks: [] }; const taskList = createElement('div', { id: 'task-list-modal' }); 
            if (dayData.tasks.length > 0) { dayData.tasks.forEach((t, i) => { const taskEl = createElement('div', { class: 'task-item', 'data-date': dateStr, 'data-index': i }, createElement('input', { type: 'checkbox', id: `m-${i}`, checked: t.completed }), createElement('label', { for: `m-${i}`, class: `task-title ${t.completed?'completed':''}` }, t.text) ); taskEl.querySelector('input').onchange = async (e) => { const idx = parseInt(e.target.closest('.task-item').dataset.index, 10); state.dayDataMap[dateStr].tasks[idx].completed = e.target.checked; e.target.nextElementSibling.classList.toggle('completed', e.target.checked); try { await saveTasksToDB(dateStr, state.dayDataMap[dateStr].tasks); renderTasks(); renderCalendar(); } catch (err) { console.error("Failed task save:", err); e.target.checked = !e.target.checked; e.target.nextElementSibling.classList.toggle('completed', e.target.checked); } }; taskList.appendChild(taskEl); }); } 
            else { taskList.appendChild(createElement('p', {}, 'No hay tareas.')); }
            const input = createElement('input', { id: 'new-task-input', type: 'text', placeholder: 'Nueva tarea...' }); const attachBtn = createElement('button', { id: 'attach-audio-btn', class: 'action-btn' }, ICONS.attach); const audioInfo = createElement('div', { id: 'attached-audio-info' }); 
            if(state.modal.selectedAudioId) { const sound = state.soundLibrary.find(s => s.id === state.modal.selectedAudioId); if(sound) audioInfo.textContent = `Audio: ${sound.name}`; }
            const controls = createElement('div', { class: 'new-task-controls' }, input, attachBtn); const body = createElement('div', {}, taskList, controls, audioInfo); const actions = createElement('button', { id: 'add-task-btn', class: 'modal-button primary' }, 'Añadir'); 
            openModal(date.format('dddd, D [de] MMMM'), body, actions); attachBtn.onclick = () => openSoundSelectorModal(dateStr); 
            actions.onclick = async () => { if (!input.value.trim()) return; if (!state.dayDataMap[dateStr]) state.dayDataMap[dateStr] = { tasks: [] }; state.dayDataMap[dateStr].tasks.push({ text: input.value, completed: false, audioId: state.modal.selectedAudioId }); try { await saveTasksToDB(dateStr, state.dayDataMap[dateStr].tasks); openDayModal(dateStr); renderCalendar(); renderTasks(); } catch (err) { console.error("Failed new task save:", err); state.dayDataMap[dateStr].tasks.pop(); } }; 
        }
        function openSoundSelectorModal(dateStr) { /* ... openSoundSelectorModal logic ... */ 
            const body = createElement('div', { style: 'max-height: 300px; overflow-y: auto; text-align: left;' }); 
            if (state.soundLibrary.length > 0) { state.soundLibrary.forEach(s => { const item = createElement('div', { class: 'playlist-item' }, `${s.name} (${s.artist})`); item.onclick = () => { state.modal.selectedAudioId = s.id; closeModal(true); openDayModal(dateStr); requestAnimationFrame(() => { const el = document.getElementById('attached-audio-info'); if (el) el.textContent = `Audio: ${s.name}`; }); }; body.appendChild(item); }); } 
            else { body.textContent = "Biblioteca vacía."; } openModal("Seleccionar Sonido", body); 
        }
        function openLibraryModal() { /* ... openLibraryModal logic ... */ const body = createElement('div', {id: 'library-list-container'}); const actions = createElement('button', {class: 'modal-button primary'}, 'Añadir'); actions.onclick = () => dom.audioFileInput.click(); openModal('Biblioteca', body, actions); renderLibraryModalContent(); }
        function renderLibraryModalContent() { /* ... renderLibraryModalContent logic ... */ 
             const container = document.getElementById('library-list-container'); if (!container) return; container.innerHTML = ''; if (state.soundLibrary.length === 0) { container.appendChild(createElement('div', {id: 'library-placeholder'}, 'Vacía.')); return; } 
            state.soundLibrary.forEach(s => { const artistInput = createElement('input', { type: 'text', value: s.artist, 'data-field': 'artist', placeholder: 'Artista' }); const genreInput = createElement('input', { type: 'text', value: s.genre, 'data-field': 'genre', placeholder: 'Género' }); const item = createElement('div', { class: 'library-item', 'data-id': s.id }, createElement('div', {class: 'library-item-info'}, createElement('div', { class: 'library-item-title' }, s.name), artistInput, genreInput ), createElement('div', { class: 'library-item-duration' }, formatTime(s.duration)) ); item.onchange = e => { if (e.target.tagName !== 'INPUT') return; const soundId = parseInt(item.dataset.id); const sound = state.soundLibrary.find(s => s.id === soundId); if (sound) { sound[e.target.dataset.field] = e.target.value; updateSoundInDB(sound); populateFilterDropdowns(); renderPlayerPlaylist(); } }; container.appendChild(item); }); 
        }
        function populateFilterDropdowns() { /* ... populateFilterDropdowns logic ... */ const genres = ['Todos Géneros', ...[...new Set(state.soundLibrary.map(s => s.genre))].filter(Boolean).sort()]; const artists = ['Todos Artistas', ...[...new Set(state.soundLibrary.map(s => s.artist))].filter(Boolean).sort()]; const curGenre = dom.player.genreFilter.value; const curArtist = dom.player.artistFilter.value; dom.player.genreFilter.innerHTML = genres.map(g => `<option value="${g}">${g}</option>`).join(''); dom.player.artistFilter.innerHTML = artists.map(a => `<option value="${a}">${a}</option>`).join(''); dom.player.genreFilter.value = genres.includes(curGenre) ? curGenre : genres[0]; dom.player.artistFilter.value = artists.includes(curArtist) ? curArtist : artists[0]; }
        
        // --- Player Logic ---
        function renderPlayerPlaylist() { /* ... */ dom.player.playlist.innerHTML = ''; const st = dom.player.searchBar.value.toLowerCase(); const sg = dom.player.genreFilter.value; const sa = dom.player.artistFilter.value; const filtLib = state.soundLibrary.filter(s => (st === '' || s.name?.toLowerCase().includes(st) || s.artist?.toLowerCase().includes(st) || s.genre?.toLowerCase().includes(st)) && (sg === 'Todos Géneros' || s.genre === sg) && (sa === 'Todos Artistas' || s.artist === sa) ); state.currentPlaylist = state.isShuffling ? shuffleArray([...filtLib]) : filtLib; state.currentTrackIndexInPlaylist = state.currentPlaylist.findIndex(t => t.id === state.currentTrackId); if (state.currentPlaylist.length === 0) { dom.player.playlist.appendChild(createElement('p', {style: 'text-align:center; padding: 1rem; color: var(--secondary-text-color)'}, state.soundLibrary.length === 0 ? 'Vacía.' : 'No resultados.')); return; } state.currentPlaylist.forEach(s => { const item = createElement('div', { class: 'playlist-item', 'data-id': s.id }, createElement('div', {}, createElement('div', {}, s.name), createElement('div', {class:'track-meta'}, `${s.artist||'N/A'} - ${s.genre||'N/A'}`) ), createElement('div', {}, formatTime(s.duration)) ); if (s.id === state.currentTrackId) item.classList.add('playing'); dom.player.playlist.appendChild(item); }); }
        function handlePlaylistClick(e) { /* ... */ const item = e.target.closest('.playlist-item'); if (!item) return; const id = parseInt(item.dataset.id, 10); const idx = state.currentPlaylist.findIndex(t => t.id === id); if (idx !== -1) playTrackByIndex(idx); else { const sound = state.soundLibrary.find(s => s.id === id); if (sound) playTrack(sound); } }
        function playTrackByIndex(idx) { /* ... */ if (idx < 0 || idx >= state.currentPlaylist.length) { if (state.repeatMode === 'all' && state.currentPlaylist.length > 0) idx = (idx < 0) ? state.currentPlaylist.length - 1 : 0; else { stopPlayback(); return; } } state.currentTrackIndexInPlaylist = idx; playTrack(state.currentPlaylist[idx]); }
        function playTrack(sound) { /* ... */ if (!sound?.file) { console.error("Error: Archivo missing."); return; } if (state.currentHowl) { state.currentHowl.stop(); state.currentHowl.unload(); cancelAnimationFrame(state.playback.rafId); if(state.currentHowl._src?.startsWith('blob:')) URL.revokeObjectURL(state.currentHowl._src); } try { const url = URL.createObjectURL(sound.file); state.currentTrackId = sound.id; state.currentHowl = new Howl({ src: [url], html5: true, format: [sound.file.type.split('/')[1] || 'mp3'], loop: state.repeatMode === 'one', onplay: () => { updatePlayerUI(); requestAnimationFrame(step); startListeningSession(); }, onpause: () => { updatePlayerUI(); cancelAnimationFrame(state.playback.rafId); stopAndLogListeningSession(); }, onstop: () => { updatePlayerUI(); cancelAnimationFrame(state.playback.rafId); stopAndLogListeningSession(); }, onend: () => { cancelAnimationFrame(state.playback.rafId); stopAndLogListeningSession(); handleTrackEnd(); URL.revokeObjectURL(url); }, onload: updatePlayerProgress, onloaderror: (id, err) => { console.error("Load err:", err); URL.revokeObjectURL(url); }, onplayerror: (id, err) => { console.error("Play err:", err); URL.revokeObjectURL(url); }, onseek: () => requestAnimationFrame(step) }); state.currentHowl.play(); dom.player.trackTitle.textContent = `${sound.name} - ${sound.artist}`; renderPlayerPlaylist(); } catch (err) { console.error("Howl setup err:", err); } }
        function playAudioClip(id, secs = 10) { /* ... */ if (!id) return; const sound = state.soundLibrary.find(s => s.id === id); if (!sound?.file) return; let url = null; let clipHowl = null; let isRevoked = false; const cleanup = () => { if (isRevoked) return; isRevoked = true; if (clipHowl) clipHowl.unload(); if (url) URL.revokeObjectURL(url); }; try { url = URL.createObjectURL(sound.file); clipHowl = new Howl({ src: [url], html5: true, format: [sound.file.type.split('/')[1] || 'mp3'], onend: cleanup, onloaderror: cleanup, onplayerror: cleanup }); if (state.currentHowl?.playing()) state.currentHowl.pause(); clipHowl.play(); setTimeout(() => { if (clipHowl?.playing()) clipHowl.stop(); cleanup(); }, secs * 1000); } catch(err) { console.error("Clip err:", err); cleanup(); } }
        function setupPlayerIcons() { /* ... */ dom.player.playPauseBtn.innerHTML=ICONS.play;dom.player.prevBtn.innerHTML=ICONS.prev;dom.player.nextBtn.innerHTML=ICONS.next;dom.player.shuffleBtn.innerHTML=ICONS.shuffle;dom.player.repeatBtn.innerHTML=ICONS.repeat; }
        function togglePlayPause() { /* ... */ if(!state.currentHowl){if(state.currentPlaylist.length>0)playTrackByIndex(0);return;}state.currentHowl.playing()?state.currentHowl.pause():state.currentHowl.play(); }
        function updatePlayerUI() { /* ... */ const isPlaying=state.currentHowl?.playing();if(dom.player.playPauseBtn)dom.player.playPauseBtn.innerHTML=isPlaying?ICONS.pause:ICONS.play;if(dom.player.shuffleBtn)dom.player.shuffleBtn.classList.toggle('active',state.isShuffling);if(dom.player.repeatBtn){dom.player.repeatBtn.classList.toggle('active',state.repeatMode!=='none');dom.player.repeatBtn.innerHTML=state.repeatMode==='one'?ICONS.repeatOne:ICONS.repeat;}const canPrev=state.repeatMode!=='none'||state.currentTrackIndexInPlaylist>0;const canNext=state.repeatMode!=='none'||state.currentTrackIndexInPlaylist<state.currentPlaylist.length-1;if(dom.player.prevBtn)dom.player.prevBtn.disabled=!(state.currentPlaylist.length>0&&canPrev);if(dom.player.nextBtn)dom.player.nextBtn.disabled=!(state.currentPlaylist.length>0&&canNext); }
        function step() { /* ... */ if(state.currentHowl?.playing()){const seek=state.currentHowl.seek()||0;const duration=state.currentHowl.duration()||0;dom.player.currentTime.textContent=formatTime(seek);if(dom.player.totalTime.textContent==='0:00'&&duration>0){dom.player.totalTime.textContent=formatTime(duration);}state.playback.rafId=requestAnimationFrame(step);}else{cancelAnimationFrame(state.playback.rafId);} }
        function updatePlayerProgress() { /* ... */ const duration=state.currentHowl?.duration()||0;const currentTime=state.currentHowl?.seek()||0;if(!isNaN(duration))dom.player.totalTime.textContent=formatTime(duration);if(!isNaN(currentTime))dom.player.currentTime.textContent=formatTime(currentTime); }
        function playNextTrack() { /* ... */ playTrackByIndex(state.currentTrackIndexInPlaylist+1); }
        function playPrevTrack() { /* ... */ if(!state.currentHowl)return;state.currentHowl.seek()>3?state.currentHowl.seek(0):playTrackByIndex(state.currentTrackIndexInPlaylist-1); }
        function toggleShuffle() { /* ... */ state.isShuffling=!state.isShuffling;renderPlayerPlaylist();updatePlayerUI(); }
        function cycleRepeatMode() { /* ... */ if(state.repeatMode==='none')state.repeatMode='all';else if(state.repeatMode==='all')state.repeatMode='one';else state.repeatMode='none';if(state.currentHowl)state.currentHowl.loop(state.repeatMode==='one');updatePlayerUI(); }
        function handleTrackEnd() { /* ... */ cancelAnimationFrame(state.playback.rafId);if(state.repeatMode!=='one')playNextTrack();else{if(state.currentHowl&&!state.currentHowl.playing())state.currentHowl.play();} }
        function stopPlayback() { /* ... */ if(state.currentHowl){state.currentHowl.stop();state.currentHowl.unload();if(state.currentHowl._src?.startsWith('blob:'))URL.revokeObjectURL(state.currentHowl._src);}cancelAnimationFrame(state.playback.rafId);stopAndLogListeningSession();state.currentTrackId=null;state.currentTrackIndexInPlaylist=-1;dom.player.trackTitle.textContent="Nada seleccionado";dom.player.currentTime.textContent="0:00";dom.player.totalTime.textContent="0:00";renderPlayerPlaylist();updatePlayerUI(); }
        
       

        // --- Render Views ---
        function renderCalendar() { /* ... */ if (state.calendarViewMode === 'days') renderDayGrid(); else renderMonthSelector(); }
        function renderDayGrid() { /* ... */ if (dom.calendar.gridWrapper) dom.calendar.gridWrapper.style.display = 'block'; if (dom.calendar.monthSelectorWrapper) dom.calendar.monthSelectorWrapper.style.display = 'none'; if (!dom.calendar.grid) return; dom.calendar.grid.innerHTML = ''; const today = dayjs().startOf('day'); if (!state.currentDate) state.currentDate = dayjs(); if (dom.calendar.monthYearDisplay) dom.calendar.monthYearDisplay.textContent = state.currentDate.format('MMMM YYYY'); const firstDay = state.currentDate.startOf('month').day(); const days = state.currentDate.daysInMonth(); const offset = (firstDay === 0) ? 6 : firstDay - 1; for (let i = 0; i < offset; i++) dom.calendar.grid.appendChild(createElement('div', { class: 'calendar-day empty' })); for (let d = 1; d <= days; d++) { const dayObj = state.currentDate.date(d); const ds = dayObj.format('YYYY-MM-DD'); const classes = ['calendar-day']; if (dayObj.isSame(today, 'day')) classes.push('today'); if (state.dayDataMap[ds]?.tasks?.some(t => !t.completed)) classes.push('has-task'); const dayEl = createElement('div', { class: classes.join(' '), 'data-date': ds }, createElement('span', { class: 'day-number' }, d.toString())); dom.calendar.grid.appendChild(dayEl); } }
        function renderMonthSelector() { /* ... */ if (dom.calendar.gridWrapper) dom.calendar.gridWrapper.style.display = 'none'; if (dom.calendar.monthSelectorWrapper) dom.calendar.monthSelectorWrapper.style.display = 'block'; if (!dom.calendar.monthSelectorWrapper) return; dom.calendar.monthSelectorWrapper.innerHTML = ''; if (dom.calendar.monthYearDisplay) dom.calendar.monthYearDisplay.textContent = state.calendarYearInView; const monthGrid = createElement('div', { class: 'calendar-month-selector' }); const currentMonth = dayjs().year() === state.calendarYearInView ? dayjs().month() : -1; dayjs.months().forEach((name, idx) => { const classes = ['calendar-month-item']; if (idx === currentMonth) classes.push('current'); const item = createElement('div', { class: classes.join(' '), 'data-month': idx }, name); monthGrid.appendChild(item); }); dom.calendar.monthSelectorWrapper.appendChild(monthGrid); dom.calendar.monthSelectorWrapper.removeEventListener('click', handleMonthSelectorClick); dom.calendar.monthSelectorWrapper.addEventListener('click', handleMonthSelectorClick); }
        function renderTasks() { /* ... */ if (!dom.tasks.container) return; dom.tasks.container.innerHTML = ''; const today = dayjs().startOf('day'); const entries = Object.entries(state.dayDataMap); const upcoming = entries.filter(([ds, d]) => d?.tasks?.length > 0 && dayjs(ds).isSameOrAfter(today, 'day')).sort(([dA], [dB]) => dayjs(dA).unix() - dayjs(dB).unix()); if (upcoming.length === 0) { dom.tasks.container.appendChild(createElement('p', {style:"text-align:center;color:var(--secondary-text-color);padding:1rem;"}, 'No hay tareas.')); return; } upcoming.forEach(([ds, d]) => { const date = dayjs(ds); const title = date.isSame(today, 'day') ? 'Hoy' : date.format('dddd, D [de] MMMM'); const group = createElement('div', { class: 'task-date-group' }, createElement('h3', {}, title)); d.tasks.forEach((t, i) => { const pb = t.audioId ? createElement('button', { class: 'action-btn play-task-btn' }, ICONS.play_task) : null; const el = createElement('div', { class:'task-item', 'data-date':ds, 'data-index':i }, createElement('div', {class:'task-item-content'}, createElement('input', { type:'checkbox', id:`ot-${ds}-${i}`, checked:t.completed }), createElement('label', { for:`ot-${ds}-${i}`, class:`task-title ${t.completed?'completed':''}` }, t.text)), pb, createElement('button', { class:'delete-btn action-btn' }, '×')); group.appendChild(el); }); dom.tasks.container.appendChild(group); }); }

        // --- Página de Estadísticas (Vanilla JS SVG) ---
        function renderStatsPage() {
            const container = dom.stats.chartContainer;
            if (!container) return;
            container.innerHTML = ''; // Limpiar contenedor

            // Crear tooltip
            const tooltip = createElement('div', { class: 'svg-tooltip', style: 'display: none;' });
            container.appendChild(tooltip);

            // Filtrar datos: solo días con escucha
            const logEntries = Object.entries(state.stats.listeningLog)
                                     .filter(([_, seconds]) => seconds > 0);

            if (logEntries.length < 2) { // Necesitamos al menos 2 puntos para una línea
                container.appendChild(createElement('p', { style: "text-align: center; color: var(--secondary-text-color); padding: 1rem;" }, 'No hay suficientes datos de escucha para mostrar una curva.'));
                return;
            }

            logEntries.sort(([dateA], [dateB]) => dayjs(dateA).unix() - dayjs(dateB).unix());

            const maxMinutes = Math.ceil(Math.max(1, ...logEntries.map(([_, s]) => s / 60))); // Max minutos, al menos 1
            const minTimestamp = dayjs(logEntries[0][0]).valueOf();
            const maxTimestamp = dayjs(logEntries[logEntries.length - 1][0]).valueOf();
            
            const svgWidth = 500; // Ancho base del viewBox
            const svgHeight = 250; // Alto base del viewBox
            const padding = { top: 20, right: 20, bottom: 40, left: 40 }; // Padding para etiquetas

            const mapX = (timestamp) => {
                const range = maxTimestamp - minTimestamp;
                if (range === 0) return padding.left; // Solo un punto
                return padding.left + ((timestamp - minTimestamp) / range) * (svgWidth - padding.left - padding.right);
            };
            const mapY = (minutes) => {
                return (svgHeight - padding.bottom) - ((minutes / maxMinutes) * (svgHeight - padding.top - padding.bottom));
            };

            const svgNS = "http://www.w3.org/2000/svg";
            const svg = createElementNS(svgNS, 'svg', {
                id: 'stats-svg',
                viewBox: `0 0 ${svgWidth} ${svgHeight}`,
                preserveAspectRatio: 'xMidYMid meet'
            });

            // --- 1. Ejes (Líneas simples) ---
            const xAxis = createElementNS(svgNS, 'line', { class: 'stats-axis', x1: padding.left, y1: svgHeight - padding.bottom, x2: svgWidth - padding.right, y2: svgHeight - padding.bottom });
            const yAxis = createElementNS(svgNS, 'line', { class: 'stats-axis', x1: padding.left, y1: padding.top, x2: padding.left, y2: svgHeight - padding.bottom });
            svg.appendChild(xAxis);
            svg.appendChild(yAxis);

            // --- 2. Etiquetas de Ejes ---
            const yLabelMax = createElementNS(svgNS, 'text', { class: 'stats-label', x: padding.left - 8, y: padding.top + 4, 'text-anchor': 'end' }, `${maxMinutes} min`);
            const yLabelMin = createElementNS(svgNS, 'text', { class: 'stats-label', x: padding.left - 8, y: svgHeight - padding.bottom, 'text-anchor': 'end' }, '0 min');
            const xLabelStart = createElementNS(svgNS, 'text', { class: 'stats-label', x: padding.left, y: svgHeight - padding.bottom + 15, 'text-anchor': 'start' }, dayjs(minTimestamp).format('MMM D'));
            const xLabelEnd = createElementNS(svgNS, 'text', { class: 'stats-label', x: svgWidth - padding.right, y: svgHeight - padding.bottom + 15, 'text-anchor': 'end' }, dayjs(maxTimestamp).format('MMM D'));
            svg.appendChild(yLabelMax); svg.appendChild(yLabelMin); svg.appendChild(xLabelStart); svg.appendChild(xLabelEnd);


            const points = [];
            logEntries.forEach(([dateStr, seconds]) => {
                const minutes = Math.round(seconds / 60);
                const timestamp = dayjs(dateStr).valueOf();
                points.push({ x: mapX(timestamp), y: mapY(minutes), minutes, date: dayjs(dateStr).format('ll') });
            });

            const pointsString = points.map(p => `${p.x},${p.y}`).join(' ');

            // --- 3. Área de Relleno ---
            const areaPathData = `M ${padding.left},${svgHeight - padding.bottom} L ${pointsString} L ${points[points.length - 1].x},${svgHeight - padding.bottom} Z`;
            const areaPath = createElementNS(svgNS, 'path', { class: 'stats-area', d: areaPathData });
            svg.appendChild(areaPath);

            // --- 4. Línea (Curva) ---
            const line = createElementNS(svgNS, 'polyline', { class: 'stats-line', points: pointsString });
            svg.appendChild(line);

            // --- 5. Puntos (Círculos con Tooltip) ---
            points.forEach(p => {
                const circle = createElementNS(svgNS, 'circle', {
                    class: 'stats-point',
                    cx: p.x,
                    cy: p.y,
                    r: 4
                });

                circle.addEventListener('mouseover', (e) => {
                    tooltip.innerHTML = `<strong>${p.date}</strong><br>${p.minutes} min`;
                    tooltip.style.display = 'block';
                    // Posicionar tooltip - se necesita calcular relativo al contenedor
                    const containerRect = container.getBoundingClientRect();
                    const svgRect = svg.getBoundingClientRect(); // Coords del SVG relativas al viewport
                    // Calcular la escala del SVG
                    const scaleX = svgRect.width / svgWidth;
                    const scaleY = svgRect.height / svgHeight;

                    // Posición del punto (cx, cy) escalada y relativa al contenedor del gráfico
                    const tipX = (p.x * scaleX) + svgRect.left - containerRect.left;
                    const tipY = (p.y * scaleY) + svgRect.top - containerRect.top;
                    
                    tooltip.style.left = `${tipX}px`;
                    tooltip.style.top = `${tipY}px`;
                    // Centrar tooltip sobre el punto
                    tooltip.style.transform = 'translate(-50%, -120%)'; 
                    tooltip.style.opacity = '1';
                });
                circle.addEventListener('mouseout', () => {
                    tooltip.style.opacity = '0';
                    tooltip.style.display = 'none';
                });

                svg.appendChild(circle);
            });

            container.appendChild(svg); // Añadir el SVG al contenedor
        }
        
        init(); // Start the app
    });
    </script>
</body>
</html>