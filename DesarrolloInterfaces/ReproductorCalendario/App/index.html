<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio con Calendario (Refactorizado)</title>
    
    <style>
        /* --- Diseño Minimalista: Variables de Color --- */
        :root {
            --primary-color: #007AFF; /* Valor por defecto, se sobrescribe con JS */
            --accent-color: #34C759;
            --danger-color: #FF3B30;
            --background-color: #F2F2F7;
            --container-rgb: 255, 255, 255;
            --text-color: #000000;
            --secondary-text-color: #8A8A8E;
            --border-color: #E5E5EA;
            --button-background-color: #EFEFF4;
        }

        body.dark-theme {
            --primary-color: #0A84FF; /* Valor por defecto oscuro, se sobrescribe con JS */
            --accent-color: #30D158;
            --danger-color: #FF453A;
            --background-color: #000000;
            --container-rgb: 28, 28, 30;
            --text-color: #FFFFFF;
            --secondary-text-color: #8D8D93;
            --border-color: #38383A;
            --button-background-color: #2C2C2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            justify-content: flex-start;
            align-items: center;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background-position: center;
            background-size: cover;
            filter: blur(10px) brightness(0.7);
            transition: background-image 0.5s ease-in-out;
            background-color: var(--background-color); /* Fondo sólido si no hay imagen */
        }
        
        #app-wrapper {
            width: 100%;
            max-width: none;
            margin: 0;
            z-index: 1;
            padding-bottom: 1rem; /* Espacio al final */
        }

        /* --- Barra de Navegación Superior --- */
        .top-nav {
            background-color: rgba(var(--container-rgb), 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            width: 100%;
            transition: background-color 0.3s, color 0.3s, border-bottom 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; /* Fija la barra arriba */
            top: 0;
            z-index: 10;
        }
        
        #main-page-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
            text-align: center;
            flex-grow: 1;
        }

        .top-nav-btn {
            background: none;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--primary-color); /* Usa color de acento */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, opacity 0.2s;
            flex-shrink: 0;
        }
        .top-nav-btn:hover {
            background-color: var(--button-background-color);
        }
        .top-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: transparent !important;
        }

        /* --- Contenido Principal y Carrusel --- */
        .main-content { width: 100%; position: relative; padding-top: 1rem; } /* Padding para compensar barra fija */
        .carousel-container { overflow: hidden; width: 100%; cursor: grab; }
        .carousel-container:active { cursor: grabbing; }
        .carousel-track { display: flex; }
        .carousel-slide {
            flex: 0 0 100%;
            width: 100%;
            padding: 1rem;
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0.4;
            transform: scale(0.85);
            min-height: calc(100vh - 100px); /* Ajusta altura mínima */
        }
        .carousel-slide.is-active { opacity: 1; transform: scale(1); }
        
        .content-box {
            background-color: rgba(var(--container-rgb), 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            transition: background-color 0.3s, border-color 0.3s;
            overflow: hidden;
            max-width: 900px; 
            margin-left: auto;
            margin-right: auto;
        }
        
        /* --- Calendario --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header h2 { font-weight: 600; color: var(--text-color); margin: 0 1rem; }
        .calendar-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary-color); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; flex-shrink: 0; }
        .calendar-header button:hover { background-color: var(--button-background-color); }
        .calendar-grid, .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-weekdays div { font-weight: 500; text-align: center; color: var(--secondary-text-color); font-size: 0.8rem; }
        .calendar-day { display: flex; justify-content: center; align-items: center; flex-direction: column; aspect-ratio: 1 / 1; border-radius: 50%; transition: all 0.2s; position: relative; cursor: pointer; }
        .calendar-day.empty { pointer-events: none; opacity: 0.5; }
        .calendar-day.has-task::before { content: ''; width: 6px; height: 6px; background-color: var(--primary-color); border-radius: 50%; position: absolute; bottom: 8px; left: calc(50% - 3px); z-index: 3; }
        .day-number { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s ease-in-out; position: relative; z-index: 2; }
        .calendar-day:hover .day-number { background-color: var(--button-background-color); }
        .calendar-day.today .day-number { background-color: var(--accent-color); color: white; font-weight: 700; }
        .calendar-day::after { content: '+'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: 300; color: var(--primary-color); opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 3; }
        .calendar-day:not(.empty):hover .day-number { opacity: 0; }
        .calendar-day:not(.empty):hover::after { opacity: 1; }

        /* --- Tareas y Reproductor --- */
        .task-date-group { margin-bottom: 1.5rem; }
        .task-date-group h3 { font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .task-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); }
        .task-item:last-child { border-bottom: none; }
        .task-item-content { flex-grow: 1; display: flex; align-items: center; gap: 0.8rem; }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color); flex-shrink: 0; }
        .task-item .task-title.completed { text-decoration: line-through; color: var(--secondary-text-color); }
        .task-item .action-btn { background: none; border: none; cursor: pointer; padding: 0.2rem; display: flex; align-items: center; justify-content: center; }
        .task-item .action-btn svg { width: 20px; height: 20px; fill: var(--secondary-text-color); transition: fill 0.2s; }
        .task-item .action-btn:hover svg { fill: var(--primary-color); }
        .task-item .delete-btn { color: var(--danger-color); font-size: 1.5rem; line-height: 1; }
        
        .settings-card { background-color: rgba(var(--container-rgb), 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 1.5rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        
        .player-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        
        .search-controls { display: flex; gap: 0.75rem; margin-bottom: 1rem; width: 100%; }
        .search-controls input, .search-controls select {
            background-color: var(--button-background-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--text-color);
            transition: box-shadow 0.2s, border-color 0.2s;
            outline: none;
        }
        .search-controls input:focus, .search-controls select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color-translucent, rgba(0, 122, 255, 0.3)); /* Ajustar transparencia */
        }
        .search-controls input { flex-grow: 1; }
        .search-controls select { flex-shrink: 0; width: 30%; max-width: 150px; }
        
        #player-playlist { max-height: 250px; overflow-y: auto; width: 100%; }
        .playlist-item { padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .playlist-item:hover { background-color: var(--button-background-color); }
        .playlist-item.playing { background-color: var(--primary-color); color: white; }
        .playlist-item.playing .track-meta { color: rgba(255,255,255,0.8); }
        
        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: rgba(var(--container-rgb), 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 600px; animation: slideIn 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-body { overflow-y: auto; flex-grow: 1; }
        .modal-actions { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--secondary-text-color); line-height: 1; }
        .modal-button { padding: 0.6rem 1rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .modal-button.primary { background-color: var(--primary-color); color: white; }

        .new-task-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }
        #new-task-input { flex-grow: 1; padding: 0.7rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--button-background-color); font-size: 1rem; }
        #attach-audio-btn svg { width: 24px; height: 24px; fill: var(--primary-color); }
        
        .theme-control-group { margin-bottom: 1.5rem; }
        .theme-control-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .theme-control-group input[type="text"], .theme-control-group input[type="color"] { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--button-background-color); color: var(--text-color); }
        /* Style specifically for color input */
        .theme-control-group input[type="color"] { padding: 0; height: 40px; border: none; cursor: pointer; }
        .theme-control-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .theme-control-group input[type="color"]::-webkit-color-swatch { border-radius: 8px; border: 1px solid var(--border-color); }
        .theme-toggle-btns { display: flex; gap: 0.5rem; }
        .theme-toggle-btns button { flex-grow: 1; padding: 0.7rem; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); border-radius: 8px; cursor: pointer; }
        .theme-toggle-btns button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #bg-image-controls { display: flex; gap: 0.5rem; align-items: center; }
        #bg-image-controls input { flex-grow: 1; }
        #bg-image-controls button { padding: 0.5rem; background-color: var(--button-background-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }

        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="dark-theme"> <!-- Default to dark -->

<div id="app-wrapper">
    <div class="top-nav">
        <button id="prev-page-btn" class="top-nav-btn">&lt;</button>
        <h1 id="main-page-title">Calendario</h1>
        <button id="next-page-btn" class="top-nav-btn">&gt;</button>
    </div>

    <main class="main-content">
        <div class="carousel-container">
            <div class="carousel-track">
                <div class="carousel-slide is-active" data-title="Calendario">
                    <div id="calendar-container" class="content-box">
                        <div class="calendar-header">
                            <button id="prev-month-btn" aria-label="Mes anterior">&lt;</button>
                            <h2 id="month-year-display"></h2>
                            <button id="next-month-btn" aria-label="Mes siguiente">&gt;</button>
                        </div>
                        <div id="calendar-grid-wrapper" class="calendar-grid-wrapper">
                             <div class="calendar-weekdays">
                                 <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
                            </div>
                            <div id="calendar-grid" class="calendar-grid"></div>
                        </div>
                    </div>
                </div>

                <div class="carousel-slide" data-title="Reproductor">
                     <div class="content-box player-container">
                         <p id="player-track-title">Ningún sonido seleccionado</p>
                         <input type="range" id="player-progress-bar" value="0" step="1" style="width: 100%; max-width: 400px;">
                         <div class="player-controls">
                             <button id="player-play-pause-btn"></button>
                         </div>
                     </div>
                     <div class="content-box">
                        <div class="search-controls">
                            <input type="search" id="search-bar" placeholder="Buscar en la biblioteca...">
                            <select id="artist-filter"></select>
                            <select id="genre-filter"></select>
                        </div>
                        <div id="player-playlist"></div>
                     </div>
                </div>
                
                <div class="carousel-slide" data-title="Tareas">
                    <div id="tasks-list-container" class="content-box"></div>
                </div>

                <div class="carousel-slide" data-title="Configuración">
                     <div style="display: grid; gap: 1rem;">
                         <div id="theme-settings-card" class="settings-card">
                             <h3>Tema de la Aplicación</h3><p>Personaliza la apariencia.</p>
                         </div>
                         <div id="library-settings-card" class="settings-card">
                             <h3>Biblioteca de Sonidos</h3><p>Gestiona tus archivos de audio.</p>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </main>
</div>

    <audio id="audio-element"></audio>
    <input type="file" id="audio-file-input" multiple accept="audio/*" style="display: none;">
    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button class="modal-close-btn" aria-label="Cerrar">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-actions" class="modal-actions"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- ICONS ---
        const ICONS = {
            play: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30px" height="30px"><path d="M8 5v14l11-7z"></path></svg>`,
            pause: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30px" height="30px"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`,
            attach: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px"><path d="M16,12A2,2 0 0,0 18,10A2,2 0 0,0 16,8A2,2 0 0,0 14,10A2,2 0 0,0 16,12M16,4.05C18.37,4.05 20.44,5.38 21.32,7.34L22.21,9.23L19.75,10.15L19.34,9.31C18.78,8.16 17.5,7.39 16,7.39C14.5,7.39 13.22,8.16 12.66,9.31L12.25,10.15L9.79,9.23L10.68,7.34C11.56,5.38 13.63,4.05 16,4.05M8,12A2,2 0 0,0 10,10A2,2 0 0,0 8,8A2,2 0 0,0 6,10A2,2 0 0,0 8,12M8,4.05C10.37,4.05 12.44,5.38 13.32,7.34L14.21,9.23L11.75,10.15L11.34,9.31C10.78,8.16 9.5,7.39 8,7.39C6.5,7.39 5.22,8.16 4.66,9.31L4.25,10.15L1.79,9.23L2.68,7.34C3.56,5.38 5.63,4.05 8,4.05M16,14C13.63,14 11.56,15.33 10.68,17.28L9.79,19.17L12.25,18.25L12.66,17.41C13.22,16.26 14.5,15.5 16,15.5C17.5,15.5 18.78,16.26 19.34,17.41L19.75,18.25L22.21,19.17L21.32,17.28C20.44,15.33 18.37,14 16,14M8,14C5.63,14 3.56,15.33 2.68,17.28L1.79,19.17L4.25,18.25L4.66,17.41C5.22,16.26 6.5,15.5 8,15.5C9.5,15.5 10.78,16.26 11.34,17.41L11.75,18.25L14.21,19.17L13.32,17.28C12.44,15.33 10.37,14 8,14Z" /></svg>`,
            play_task: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M10,16.5L16,12L10,7.5V16.5Z" /></svg>`
        };
        
        // --- DOM Elements ---
        const dom = {
            body: document.body,
            mainPageTitle: document.getElementById('main-page-title'),
            carousel: {
                container: document.querySelector('.carousel-container'),
                track: document.querySelector('.carousel-track'),
                slides: Array.from(document.querySelector('.carousel-track').children),
                prevBtn: document.getElementById('prev-page-btn'),
                nextBtn: document.getElementById('next-page-btn'),
            },
            calendar: {
                monthYearDisplay: document.getElementById('month-year-display'),
                prevMonthBtn: document.getElementById('prev-month-btn'),
                nextMonthBtn: document.getElementById('next-month-btn'),
                grid: document.getElementById('calendar-grid'),
            },
            player: {
                audioElement: document.getElementById('audio-element'),
                trackTitle: document.getElementById('player-track-title'),
                playPauseBtn: document.getElementById('player-play-pause-btn'),
                playlist: document.getElementById('player-playlist'),
                searchBar: document.getElementById('search-bar'),
                artistFilter: document.getElementById('artist-filter'),
                genreFilter: document.getElementById('genre-filter'),
            },
            tasks: { container: document.getElementById('tasks-list-container') },
            settings: {
                themeCard: document.getElementById('theme-settings-card'),
                libraryCard: document.getElementById('library-settings-card'),
            },
            modal: {
                overlay: document.getElementById('modal-overlay'),
                title: document.getElementById('modal-title'),
                body: document.getElementById('modal-body'),
                actions: document.getElementById('modal-actions'),
                closeBtn: document.querySelector('.modal-close-btn'),
            },
            audioFileInput: document.getElementById('audio-file-input'),
            bgImageInput: document.getElementById('bg-image-input'),
        };

        // --- Application State ---
        const state = {
            db: null,
            dayDataMap: {},
            soundLibrary: [],
            currentTrackId: null,
            currentDate: new Date(),
            carousel: { currentSlideIndex: 0, isDragging: false, startX: 0, currentTranslate: 0, prevTranslate: 0 },
            modal: { selectedAudioId: null }
        };
        
        // --- App Initialization ---
        async function init() {
            try {
                loadStateFromLocalStorage();
                applyTheme(); // Apply saved theme on load
                state.db = await initDB();
                if (!state.db) throw new Error("Failed to initialize database.");
                await loadSoundsFromDB();
                setupEventListeners();
                setupPlayerIcons();
                setupResizeObserver();
                renderAll();
            } catch (error) {
                console.error("Error fatal al inicializar la aplicación:", error);
                // Optionally display a user-friendly error message here
            }
        }
        
        function renderAll() {
            renderCalendar();
            renderTasks();
            populateFilterDropdowns();
            renderPlayerPlaylist();
            updatePlayerUI();
            updateCarouselUI(false);
        }
        
        // --- Persistence (LocalStorage & IndexedDB) ---
        function saveThemeSettings(settings) {
            localStorage.setItem('themeClass', settings.themeClass);
            localStorage.setItem('customPrimaryColor', settings.primaryColor);
            localStorage.setItem('customBackgroundImage', settings.backgroundImage); // Can be URL or Data URL
        }

        function loadStateFromLocalStorage() {
            const savedData = localStorage.getItem('dayDataMap');
            if (savedData) {
                 try {
                     state.dayDataMap = JSON.parse(savedData);
                 } catch (e) {
                     console.error("Error parsing dayDataMap from localStorage:", e);
                     state.dayDataMap = {}; // Reset if invalid
                 }
            } else {
                 state.dayDataMap = {};
            }
        }
        
        function initDB() {
             return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    console.warn("IndexedDB no soportado por este navegador.");
                    return reject(new Error("IndexedDB no soportado"));
                }
                const request = indexedDB.open('AudioAppDB', 2);
                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('sounds')) {
                        db.createObjectStore('sounds', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => {
                     console.error("IndexedDB error:", e.target.error);
                     reject(e.target.error);
                };
            });
        }
        
        // --- Event Listeners Setup ---
        function setupEventListeners() {
             if (!dom.carousel.prevBtn || !dom.carousel.nextBtn) {
                console.error("Error: Buttons prev/next carousel no encontrados.");
                // Decide how to handle this - maybe disable carousel features or stop init?
                 // For now, let's just log and potentially skip carousel listeners
            } else {
                dom.carousel.prevBtn.addEventListener('click', handlePrevSlide);
                dom.carousel.nextBtn.addEventListener('click', handleNextSlide);
                dom.carousel.container.addEventListener('touchstart', touchStart, { passive: true });
                dom.carousel.container.addEventListener('touchmove', touchMove, { passive: true });
                dom.carousel.container.addEventListener('touchend', touchEnd);
                dom.carousel.container.addEventListener('mousedown', touchStart);
                dom.carousel.container.addEventListener('mousemove', touchMove);
                dom.carousel.container.addEventListener('mouseup', touchEnd);
                dom.carousel.container.addEventListener('mouseleave', touchEnd);
                dom.carousel.container.addEventListener('dragstart', (e) => e.preventDefault());
            }

            // Ensure other elements exist too before adding listeners
            if (dom.calendar.prevMonthBtn) dom.calendar.prevMonthBtn.addEventListener('click', handlePrevClick);
            if (dom.calendar.nextMonthBtn) dom.calendar.nextMonthBtn.addEventListener('click', handleNextClick);
            if (dom.calendar.grid) dom.calendar.grid.addEventListener('click', e => {
                const dayElement = e.target.closest('.calendar-day:not(.empty)');
                if (dayElement) openDayModal(dayElement.dataset.date);
            });
            if (dom.tasks.container) dom.tasks.container.addEventListener('click', handleTaskClick);
            if (dom.settings.themeCard) dom.settings.themeCard.addEventListener('click', openThemeModal);
            if (dom.modal.closeBtn) dom.modal.closeBtn.addEventListener('click', closeModal);
            if (dom.modal.overlay) dom.modal.overlay.addEventListener('click', e => { if (e.target === dom.modal.overlay) closeModal(); });
            if (dom.settings.libraryCard) dom.settings.libraryCard.addEventListener('click', openLibraryModal);
            if (dom.audioFileInput) dom.audioFileInput.addEventListener('change', handleFileSelection);
            if (dom.bgImageInput) dom.bgImageInput.addEventListener('change', handleBgImageSelection);
            
            if (dom.player.searchBar) dom.player.searchBar.addEventListener('input', renderPlayerPlaylist);
            if (dom.player.artistFilter) dom.player.artistFilter.addEventListener('change', renderPlayerPlaylist);
            if (dom.player.genreFilter) dom.player.genreFilter.addEventListener('change', renderPlayerPlaylist);
            if (dom.player.playlist) dom.player.playlist.addEventListener('click', handlePlaylistClick);
            if (dom.player.playPauseBtn) dom.player.playPauseBtn.addEventListener('click', togglePlayPause);
            if (dom.player.audioElement) {
                dom.player.audioElement.addEventListener('ended', updatePlayerUI);
                dom.player.audioElement.addEventListener('pause', updatePlayerUI);
                dom.player.audioElement.addEventListener('play', updatePlayerUI);
            }
        }
        
        // --- Carousel & Navigation ---
        function setupResizeObserver() {
             const observer = new ResizeObserver(() => { updateCarouselUI(false); });
            observer.observe(dom.carousel.container);
        }

        function handleNextSlide() {
            state.carousel.currentSlideIndex = Math.min(state.carousel.currentSlideIndex + 1, dom.carousel.slides.length - 1);
            updateCarouselUI();
        }

        function handlePrevSlide() {
            state.carousel.currentSlideIndex = Math.max(state.carousel.currentSlideIndex - 1, 0);
            updateCarouselUI();
        }

        function touchStart(event) {
            state.carousel.isDragging = true;
            state.carousel.startX = getPositionX(event);
            dom.carousel.track.style.transition = 'none';
        }

        function touchMove(event) {
            if (state.carousel.isDragging) {
                const currentPosition = getPositionX(event);
                state.carousel.currentTranslate = state.carousel.prevTranslate + currentPosition - state.carousel.startX;
                setSliderPosition();
            }
        }

        function touchEnd() {
            if (!state.carousel.isDragging) return;
            state.carousel.isDragging = false;
            const movedBy = state.carousel.currentTranslate - state.carousel.prevTranslate;
            if (movedBy < -100 && state.carousel.currentSlideIndex < dom.carousel.slides.length - 1) {
                state.carousel.currentSlideIndex += 1;
            }
            if (movedBy > 100 && state.carousel.currentSlideIndex > 0) {
                state.carousel.currentSlideIndex -= 1;
            }
            updateCarouselUI();
        }

        function getPositionX(event) { return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX; }
        function setSliderPosition() { dom.carousel.track.style.transform = `translateX(${state.carousel.currentTranslate}px)`; }

        function updateCarouselUI(animate = true) {
            if (!dom.carousel.slides || dom.carousel.slides.length === 0) return; // Guard against empty slides
            if (animate) { dom.carousel.track.style.transition = `transform 0.5s ease-out`; }
            else { dom.carousel.track.style.transition = 'none'; }
            const slideWidth = dom.carousel.slides[0].clientWidth;
            if (slideWidth === 0) return;
            const targetTranslate = state.carousel.currentSlideIndex * -slideWidth;
            dom.carousel.track.style.transform = `translateX(${targetTranslate}px)`;
            state.carousel.prevTranslate = targetTranslate;
            state.carousel.currentTranslate = targetTranslate;
            dom.carousel.slides.forEach((slide, index) => {
                slide.classList.toggle('is-active', index === state.carousel.currentSlideIndex);
            });
            dom.mainPageTitle.textContent = dom.carousel.slides[state.carousel.currentSlideIndex].dataset.title || 'Calendario';
            // Check if buttons exist before accessing disabled property
            if (dom.carousel.prevBtn) dom.carousel.prevBtn.disabled = state.carousel.currentSlideIndex === 0;
            if (dom.carousel.nextBtn) dom.carousel.nextBtn.disabled = state.carousel.currentSlideIndex === dom.carousel.slides.length - 1;
            // Conditional rendering based on active slide title
            const activeSlideTitle = dom.carousel.slides[state.carousel.currentSlideIndex]?.dataset.title;
             if (activeSlideTitle === "Tareas") renderTasks();
             if (activeSlideTitle === "Reproductor") renderPlayerPlaylist();
        }

        // --- Calendar & Task ---
        function handlePrevClick() { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderAll(); }
        function handleNextClick() { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderAll(); }
        
        function handleTaskClick(e) {
             const target = e.target;
            const taskItem = target.closest('.task-item');
            if (!taskItem) return;
            const { date, index } = taskItem.dataset;
            const taskIndex = parseInt(index, 10);
            
            // Ensure date exists and has tasks
            if (!state.dayDataMap[date] || !state.dayDataMap[date].tasks || taskIndex >= state.dayDataMap[date].tasks.length) {
                 console.error("Task data mismatch:", date, index);
                 return;
            }
            const task = state.dayDataMap[date].tasks[taskIndex];

            if (target.type === 'checkbox') {
                task.completed = target.checked;
            } else if (target.closest('.play-task-btn')) {
                playTaskAudio(task.audioId);
            } else if (target.closest('.delete-btn')) {
                state.dayDataMap[date].tasks.splice(taskIndex, 1);
                if (state.dayDataMap[date].tasks.length === 0) {
                    delete state.dayDataMap[date];
                }
            }
            saveStateToLocalStorage();
            renderAll();
        }
        
        // --- Theme & Modal ---
        function openThemeModal() {
            const savedTheme = localStorage.getItem('themeClass') || 'dark-theme';
            const savedColor = localStorage.getItem('customPrimaryColor') || (savedTheme === 'dark-theme' ? '#0A84FF' : '#007AFF');
            const savedBg = localStorage.getItem('customBackgroundImage') || '';

            const body = createElement('div', {},
                createElement('div', { class: 'theme-control-group' },
                    createElement('label', {}, 'Modo de Interfaz'),
                    createElement('div', { class: 'theme-toggle-btns' },
                        createElement('button', { 'data-theme': '', class: savedTheme === '' ? 'active' : '' }, 'Claro'),
                        createElement('button', { 'data-theme': 'dark-theme', class: savedTheme === 'dark-theme' ? 'active' : '' }, 'Oscuro')
                    )
                ),
                createElement('div', { class: 'theme-control-group' },
                    createElement('label', { for: 'color-picker' }, 'Color de Acento'),
                    createElement('input', { type: 'color', id: 'color-picker', value: savedColor })
                ),
                createElement('div', { class: 'theme-control-group' },
                    createElement('label', { for: 'bg-image-url' }, 'Imagen de Fondo'),
                    createElement('div', {id: 'bg-image-controls'},
                         createElement('input', { type: 'text', id: 'bg-image-url', placeholder: 'Pegar URL o subir archivo...', value: savedBg.startsWith('http') ? savedBg : (savedBg ? 'Archivo local cargado' : '') }),
                         createElement('button', {id: 'upload-bg-btn'}, 'Subir'),
                         createElement('button', {id: 'clear-bg-btn'}, 'Quitar')
                    )
                )
            );
            
            const actions = createElement('button', { class: 'modal-button primary' }, 'Guardar Cambios');
            
            openModal('Personalizar Tema', body, actions);

            const themeBtns = body.querySelector('.theme-toggle-btns');
            themeBtns.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    themeBtns.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                }
            });

            body.querySelector('#upload-bg-btn').onclick = () => dom.bgImageInput.click();
            body.querySelector('#clear-bg-btn').onclick = () => {
                 body.querySelector('#bg-image-url').value = '';
                 saveThemeSettings({
                    themeClass: themeBtns.querySelector('.active').dataset.theme,
                    primaryColor: body.querySelector('#color-picker').value,
                    backgroundImage: '',
                 });
                 applyTheme();
            };

            actions.onclick = () => {
                const imageUrlInput = body.querySelector('#bg-image-url').value.trim();
                const currentBg = localStorage.getItem('customBackgroundImage') || '';
                let finalBg = '';

                if (imageUrlInput.startsWith('http')) {
                    finalBg = imageUrlInput; // Use the new URL
                } else if (imageUrlInput === 'Archivo local cargado' && currentBg.startsWith('data:')) {
                    finalBg = currentBg; // Keep the existing local file data URL
                } else if (imageUrlInput === '') {
                     finalBg = ''; // Clear background
                } else {
                    // If input is neither URL nor "Archivo local cargado", assume it's cleared or invalid, clear bg
                    finalBg = ''; 
                }
                
                const settings = {
                    themeClass: themeBtns.querySelector('.active').dataset.theme,
                    primaryColor: body.querySelector('#color-picker').value,
                    backgroundImage: finalBg,
                };
                saveThemeSettings(settings);
                applyTheme();
                closeModal();
            };
        }

        function handleBgImageSelection(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataUrl = event.target.result;
                    // Limit size to prevent localStorage issues (e.g., 2MB)
                    if (dataUrl.length > 2 * 1024 * 1024) {
                         alert("La imagen es demasiado grande. Por favor, elige una más pequeña (máx 2MB).");
                         return;
                    }
                    localStorage.setItem('customBackgroundImage', dataUrl); 
                    applyTheme();
                    const urlInput = document.getElementById('bg-image-url');
                    if(urlInput) {
                        urlInput.value = 'Archivo local cargado';
                    }
                };
                 // Reset input value so the same file can be selected again
                e.target.value = null;
                 reader.onerror = () => {
                     console.error("Error reading image file.");
                     alert("Error al cargar la imagen.");
                 };
                reader.readAsDataURL(file);
            }
        }
        
        function applyTheme() {
             const themeClass = localStorage.getItem('themeClass') || 'dark-theme';
             const primaryColor = localStorage.getItem('customPrimaryColor') || (themeClass === 'dark-theme' ? '#0A84FF' : '#007AFF');
            const backgroundImage = localStorage.getItem('customBackgroundImage') || ''; // Could be URL or Data URL
            
            dom.body.className = themeClass; // Use dom.body
             document.documentElement.style.setProperty('--primary-color', primaryColor);
            
            // Use a more robust way to manage the dynamic style
            let styleSheet = document.getElementById('dynamic-bg-style');
            if (!styleSheet) {
                styleSheet = document.createElement('style');
                styleSheet.id = 'dynamic-bg-style';
                document.head.appendChild(styleSheet);
            }
            
            styleSheet.textContent = `
                body::before {
                    background-image: ${backgroundImage ? `url('${backgroundImage}')` : 'none'};
                 }
                 /* Add rules for primary color application */
                 .top-nav-btn, 
                 .calendar-header button, 
                 .calendar-day.has-task::before, 
                 .calendar-day::after,
                 .task-item input[type="checkbox"]:checked,
                 .modal-button.primary,
                 .theme-toggle-btns button.active,
                 .playlist-item.playing,
                 #attach-audio-btn svg,
                 .task-item .action-btn:hover svg {
                     color: var(--primary-color);
                     /* Use fill for SVG where appropriate */
                     fill: var(--primary-color); 
                 }
                 .playlist-item.playing,
                 .theme-toggle-btns button.active,
                 .modal-button.primary {
                     background-color: var(--primary-color);
                     border-color: var(--primary-color); /* Ensure border color matches */
                     color: white; /* Ensure text contrast */
                 }
                 /* Specific background color needed */
                 .task-item input[type="checkbox"] { accent-color: var(--primary-color); } 
                  /* Focus styles */
                 .search-controls input:focus, .search-controls select:focus {
                     border-color: var(--primary-color);
                     /* Calculate translucent color based on primary */
                     /* This is complex, simplified for now */
                     box-shadow: 0 0 0 2px ${primaryColor}4D; /* Add alpha hex */
                 }

            `;
        }

        function openModal(title, bodyElement, actionsElement = null) {
             dom.modal.title.textContent = title;
            dom.modal.body.innerHTML = ''; // Clear previous content
             dom.modal.body.appendChild(bodyElement);
            dom.modal.actions.innerHTML = ''; // Clear previous actions
             if (actionsElement) dom.modal.actions.appendChild(actionsElement);
             dom.modal.overlay.classList.add('visible');
        }
        function closeModal() {
             dom.modal.overlay.classList.remove('visible');
        }
        
        function openDayModal(dateStr) {
            state.modal.selectedAudioId = null; // Reset selection
            const date = new Date(dateStr + 'T00:00:00');
            const dayData = state.dayDataMap[dateStr] || { tasks: [] };
            
            const taskList = createElement('div', { id: 'task-list-modal' });
            if (dayData.tasks.length > 0) {
                dayData.tasks.forEach((task, index) => {
                    const taskEl = createElement('div', { class: 'task-item', 'data-date': dateStr, 'data-index': index },
                        createElement('input', { type: 'checkbox', id: `modal-task-${index}`, checked: task.completed }),
                        createElement('label', { for: `modal-task-${index}`, class: `task-title ${task.completed ? 'completed' : ''}` }, task.text)
                    );
                    taskList.appendChild(taskEl);
                });
            } else {
                taskList.appendChild(createElement('p', {}, 'No hay tareas para este día.'));
            }

            const input = createElement('input', { id: 'new-task-input', type: 'text', placeholder: 'Añadir nueva tarea...' });
            const attachBtn = createElement('button', { id: 'attach-audio-btn', class: 'action-btn' });
            attachBtn.innerHTML = ICONS.attach;
            const audioInfo = createElement('div', { id: 'attached-audio-info' });
            const controls = createElement('div', { class: 'new-task-controls' }, input, attachBtn);
            
            const body = createElement('div', {}, taskList, controls, audioInfo);
            const actions = createElement('button', { id: 'add-task-btn', class: 'modal-button primary' }, 'Añadir Tarea');
            
            openModal(date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }), body, actions);
            
            attachBtn.onclick = () => openSoundSelectorModal(dateStr);

            actions.onclick = () => {
                if (input.value.trim()) {
                    if (!state.dayDataMap[dateStr]) state.dayDataMap[dateStr] = { tasks: [] };
                    state.dayDataMap[dateStr].tasks.push({ 
                        text: input.value, 
                        completed: false,
                        audioId: state.modal.selectedAudioId
                    });
                    saveStateToLocalStorage();
                    openDayModal(dateStr); // Refresh modal
                    renderCalendar();
                }
            };
             taskList.addEventListener('change', (e) => { // Added listener for checkboxes inside modal
                if(e.target.type === 'checkbox') {
                    const taskItem = e.target.closest('.task-item');
                     if (!taskItem) return;
                    const { index } = taskItem.dataset;
                     // Ensure date exists and has tasks
                    if (!state.dayDataMap[dateStr] || !state.dayDataMap[dateStr].tasks || index >= state.dayDataMap[dateStr].tasks.length) {
                         console.error("Task data mismatch in modal:", dateStr, index);
                         return;
                    }
                    state.dayDataMap[dateStr].tasks[parseInt(index, 10)].completed = e.target.checked;
                    taskItem.querySelector('.task-title').classList.toggle('completed', e.target.checked);
                    saveStateToLocalStorage();
                    renderTasks(); // Update main task list
                    renderCalendar(); // Update calendar indicator
                }
            });
        }
        
        function openSoundSelectorModal(dateStr) {
            const body = createElement('div');
            if (state.soundLibrary.length > 0) {
                 state.soundLibrary.forEach(sound => {
                    const item = createElement('div', { class: 'sound-selector-item' }, `${sound.name} (${sound.artist})`);
                    item.onclick = () => {
                        state.modal.selectedAudioId = sound.id;
                        closeModal();
                        openDayModal(dateStr); // Re-open day modal
                        const audioInfoEl = document.getElementById('attached-audio-info');
                         if(audioInfoEl) audioInfoEl.textContent = `Audio: ${sound.name}`;
                    };
                    body.appendChild(item);
                });
            } else {
                 body.textContent = "Tu biblioteca de sonidos está vacía.";
            }
            openModal("Seleccionar Sonido", body);
        }
        
        // --- Sound Library & Player ---
        async function loadSoundsFromDB() {
             return new Promise((resolve, reject) => {
                 if (!state.db) return reject("Database not initialized");
                const transaction = state.db.transaction('sounds', 'readonly');
                const store = transaction.objectStore('sounds');
                const request = store.getAll();
                request.onsuccess = () => { state.soundLibrary = request.result || []; resolve(); };
                request.onerror = (e) => { console.error("Error loading sounds:", e.target.error); reject(e.target.error); };
            });
        }

        async function handleFileSelection(e) {
            closeModal();
            for (const file of e.target.files) { if (file.type.startsWith('audio/')) await saveSoundToDB(file); }
            await loadSoundsFromDB();
            openLibraryModal();
            renderAll();
        }

        function saveSoundToDB(file) {
            return new Promise(async (resolve, reject) => {
                if (!state.db) return reject("Database not initialized");
                try {
                    const duration = await getAudioDuration(file);
                    const newSound = { name: file.name.replace(/\.[^/.]+$/, ""), artist: 'Artista Desconocido', genre: 'Desconocido', duration, file };
                    const transaction = state.db.transaction('sounds', 'readwrite');
                    const store = transaction.objectStore('sounds');
                    const request = store.add(newSound);
                    request.onsuccess = resolve;
                    request.onerror = (e) => { console.error("Error saving sound:", e.target.error); reject(e.target.error); };
                } catch (error) {
                    console.error("Error processing audio file:", error);
                    reject(error);
                }
            });
        }
        
        function updateSoundInDB(soundData) {
             if (!state.db) return;
            const transaction = state.db.transaction('sounds', 'readwrite');
            const store = transaction.objectStore('sounds');
             try {
                 store.put(soundData);
             } catch (error) {
                 console.error("Error updating sound in DB:", error);
             }
        }

        function getAudioDuration(file) {
            return new Promise((resolve, reject) => {
                const audio = document.createElement('audio');
                audio.preload = 'metadata';
                audio.onloadedmetadata = () => { window.URL.revokeObjectURL(audio.src); resolve(audio.duration); };
                 audio.onerror = (e) => { 
                     console.error("Error loading audio metadata:", e);
                     window.URL.revokeObjectURL(audio.src);
                     reject(new Error("Could not read audio duration")); 
                 };
                audio.src = window.URL.createObjectURL(file);
            });
        }

        function openLibraryModal() {
            const body = createElement('div', {id: 'library-list-container'});
            const actions = createElement('button', {class: 'modal-button primary'}, 'Añadir Sonidos');
            actions.onclick = () => dom.audioFileInput.click();
            openModal('Biblioteca de Sonidos', body, actions);
            renderLibraryModalContent();
        }

        function renderLibraryModalContent() {
            const container = document.getElementById('library-list-container');
            if (!container) return;
            container.innerHTML = '';
            if (state.soundLibrary.length === 0) {
                container.appendChild(createElement('div', {id: 'library-placeholder'}, 'Tu biblioteca está vacía. Añade algunos sonidos para empezar.'));
                return;
            }
            state.soundLibrary.forEach(sound => {
                const artistInput = createElement('input', { type: 'text', value: sound.artist, 'data-field': 'artist' });
                const genreInput = createElement('input', { type: 'text', value: sound.genre, 'data-field': 'genre' });
                const item = createElement('div', { class: 'library-item', 'data-id': sound.id },
                    createElement('div', {class: 'library-item-info'},
                        createElement('div', { class: 'library-item-title' }, sound.name),
                        artistInput, genreInput
                    ),
                    createElement('div', { class: 'library-item-duration' }, formatTime(sound.duration))
                );
                item.addEventListener('change', (e) => {
                    if(e.target.tagName === 'INPUT') {
                        const soundId = parseInt(item.dataset.id);
                        const soundToUpdate = state.soundLibrary.find(s => s.id === soundId); 
                        if (soundToUpdate) {
                            const field = e.target.dataset.field;
                            soundToUpdate[field] = e.target.value;
                            updateSoundInDB(soundToUpdate);
                            populateFilterDropdowns();
                            renderPlayerPlaylist();
                        } else {
                            console.error("Sound not found in state for update:", soundId);
                        }
                    }
                });
                container.appendChild(item);
            });
        }
        
        function populateFilterDropdowns() {
            const genres = ['Todos los Géneros', ...new Set(state.soundLibrary.map(s => s.genre))].filter(Boolean); // Filter out potential undefined/null
            const artists = ['Todos los Artistas', ...new Set(state.soundLibrary.map(s => s.artist))].filter(Boolean);
            const currentGenre = dom.player.genreFilter.value;
            const currentArtist = dom.player.artistFilter.value;
            dom.player.genreFilter.innerHTML = genres.map(g => `<option value="${g}">${g}</option>`).join('');
            dom.player.artistFilter.innerHTML = artists.map(a => `<option value="${a}">${a}</option>`).join('');
            dom.player.genreFilter.value = genres.includes(currentGenre) ? currentGenre : genres[0];
            dom.player.artistFilter.value = artists.includes(currentArtist) ? currentArtist : artists[0];
        }
        
        function renderPlayerPlaylist() {
            dom.player.playlist.innerHTML = '';
            const searchTerm = dom.player.searchBar.value.toLowerCase();
            const selectedGenre = dom.player.genreFilter.value;
            const selectedArtist = dom.player.artistFilter.value;

            const filteredLibrary = state.soundLibrary.filter(sound => {
                const nameMatch = sound.name?.toLowerCase().includes(searchTerm) ?? false;
                const artistMatch = sound.artist?.toLowerCase().includes(searchTerm) ?? false;
                const genreMatch = sound.genre?.toLowerCase().includes(searchTerm) ?? false;
                const matchesSearch = searchTerm === '' || nameMatch || artistMatch || genreMatch;

                const matchesGenre = selectedGenre === 'Todos los Géneros' || sound.genre === selectedGenre;
                const matchesArtist = selectedArtist === 'Todos los Artistas' || sound.artist === selectedArtist;
                return matchesSearch && matchesGenre && matchesArtist;
            });

            if (filteredLibrary.length === 0) {
                 if (state.soundLibrary.length === 0) {
                    dom.player.playlist.appendChild(createElement('p', {style: 'text-align:center; padding: 1rem; color: var(--secondary-text-color)'}, 'Tu biblioteca está vacía. Ve a Configuración para añadir sonidos.'));
                } else {
                    dom.player.playlist.appendChild(createElement('p', {style: 'text-align:center; padding: 1rem;'}, 'No se encontraron resultados.'));
                }
                return;
            }

            filteredLibrary.forEach(sound => {
                const item = createElement('div', { class: 'playlist-item', 'data-id': sound.id },
                    createElement('div', {class: 'track-info-main'},
                        createElement('div', {class: 'track-title'}, sound.name),
                        createElement('div', {class: 'track-meta'}, `${sound.artist} - ${sound.genre}`)
                    ),
                    createElement('div', {class: 'track-duration'}, formatTime(sound.duration))
                );
                if (sound.id === state.currentTrackId) item.classList.add('playing');
                dom.player.playlist.appendChild(item);
            });
        }
        
        function handlePlaylistClick(e) {
            const item = e.target.closest('.playlist-item');
            if (item) {
                const trackId = parseInt(item.dataset.id, 10);
                const sound = state.soundLibrary.find(s => s.id === trackId);
                if (sound && sound.file) { // Check if file exists
                     playTrack(sound);
                 } else {
                     console.error("Sound file not found for track:", trackId);
                     alert("Error: No se pudo encontrar el archivo de audio para esta pista.");
                 }
            }
        }

        function playTrack(sound) {
            try {
                 const url = URL.createObjectURL(sound.file);
                 state.currentTrackId = sound.id;
                dom.player.audioElement.src = url;
                dom.player.audioElement.play().catch(e => console.error("Error playing audio:", e)); // Catch potential play errors
                dom.player.trackTitle.textContent = `${sound.name} - ${sound.artist}`;
                renderPlayerPlaylist();
                 // Revoke previous object URL if any to free memory
                 // Ideally, manage this more carefully, maybe on 'ended' or when changing tracks
            } catch (error) {
                 console.error("Error creating object URL:", error);
                 alert("Error al intentar reproducir el archivo.");
            }
        }

        function playTaskAudio(audioId) {
            if (!audioId) return;
            const sound = state.soundLibrary.find(s => s.id === audioId);
            if (!sound || !sound.file) {
                 console.error("Task audio file not found:", audioId);
                 return;
            }

             try {
                 const url = URL.createObjectURL(sound.file);
                 const taskAudio = new Audio(url);
                
                if (!dom.player.audioElement.paused) {
                    dom.player.audioElement.pause();
                }
                
                taskAudio.play().catch(e => console.error("Error playing task audio:", e));

                 const timeoutId = setTimeout(() => {
                     taskAudio.pause();
                     taskAudio.currentTime = 0;
                     URL.revokeObjectURL(url); // Clean up object URL
                }, 10000); 

                taskAudio.onended = () => {
                     clearTimeout(timeoutId);
                     URL.revokeObjectURL(url); // Clean up object URL
                 };
                 taskAudio.onerror = () => { // Handle potential loading errors
                     clearTimeout(timeoutId);
                     URL.revokeObjectURL(url);
                     console.error("Error loading/playing task audio");
                 }
            } catch (error) {
                 console.error("Error creating object URL for task audio:", error);
            }
        }

        function setupPlayerIcons() {
            dom.player.playPauseBtn.innerHTML = ICONS.play;
        }

        function togglePlayPause() {
            if (!state.currentTrackId || !dom.player.audioElement.src) return; // Check if src is set
            if (dom.player.audioElement.paused) dom.player.audioElement.play().catch(e => console.error("Play error:", e)); 
            else dom.player.audioElement.pause();
        }

        function updatePlayerUI() {
            const isPlaying = state.currentTrackId && !dom.player.audioElement.paused;
            dom.player.playPauseBtn.innerHTML = isPlaying ? ICONS.pause : ICONS.play;
        }
        
        // --- Utils ---
        function createElement(tag, attributes = {}, ...children) {
             const element = document.createElement(tag);
             for (const [key, value] of Object.entries(attributes)) {
                 if (key === 'class') element.className = value;
                 else if (key.startsWith('data-')) element.dataset[key.substring(5)] = value;
                 else if (typeof value === 'boolean') element[key] = value;
                 // Handle null/undefined values safely
                 else if (value !== null && value !== undefined) element.setAttribute(key, value);
             }
             for (const child of children) {
                 if (child !== null && child !== undefined) { // Check for null/undefined children
                     element.append(typeof child === 'string' ? document.createTextNode(child) : child);
                 }
             }
             return element;
        }
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00'; // Added check for negative
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        // --- Render Views ---
        function renderCalendar() {
             if (!dom.calendar.grid) return; // Guard clause
            dom.calendar.grid.innerHTML = '';
            const today = new Date();
            today.setHours(0,0,0,0);
             if (!state.currentDate) state.currentDate = new Date(); // Ensure currentDate exists
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
             if (dom.calendar.monthYearDisplay) dom.calendar.monthYearDisplay.textContent = `${state.currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            for (let i = 0; i < startOffset; i++) {
                dom.calendar.grid.appendChild(createElement('div', { class: 'calendar-day empty' }));
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayDate = new Date(dateStr + 'T00:00:00');
                const classes = ['calendar-day'];
                if (dayDate.getTime() === today.getTime()) classes.push('today');
                if (state.dayDataMap[dateStr] && state.dayDataMap[dateStr].tasks?.some(t => !t.completed)) classes.push('has-task'); // Added optional chaining
                const dayEl = createElement('div', { class: classes.join(' '), 'data-date': dateStr },
                    createElement('span', { class: 'day-number' }, day.toString())
                );
                dom.calendar.grid.appendChild(dayEl);
            }
        }
        
        function renderTasks() {
             if (!dom.tasks.container) return; // Guard clause
            dom.tasks.container.innerHTML = '';
            dom.tasks.container.appendChild(createElement('h2', {}, 'Próximas Tareas'));
            const today = new Date();
            today.setHours(0, 0, 0, 0);
             // Ensure dayDataMap is an object
             const taskEntries = typeof state.dayDataMap === 'object' && state.dayDataMap !== null ? Object.entries(state.dayDataMap) : [];
            const upcomingTasks = taskEntries
                .filter(([dateStr, data]) => {
                     // Add checks for data and tasks array
                    return data && Array.isArray(data.tasks) && data.tasks.length > 0 && new Date(dateStr + 'T00:00:00') >= today;
                 })
                .sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));
            if (upcomingTasks.length === 0) {
                dom.tasks.container.appendChild(createElement('p', {}, 'No tienes tareas pendientes.'));
                return;
            }
            upcomingTasks.forEach(([dateStr, data]) => {
                const date = new Date(dateStr + 'T00:00:00');
                const dateTitle = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const group = createElement('div', { class: 'task-date-group' });
                group.appendChild(createElement('h3', {}, dateTitle));
                data.tasks.forEach((task, index) => {
                    const playBtn = task.audioId ? createElement('button', { class: 'action-btn play-task-btn' }) : null; // Use null for clarity
                    if(playBtn) playBtn.innerHTML = ICONS.play_task;

                    const taskEl = createElement('div', { class: 'task-item', 'data-date': dateStr, 'data-index': index },
                       createElement('div', {class: 'task-item-content'},
                            createElement('input', { type: 'checkbox', id: `overview-task-${dateStr}-${index}`, checked: task.completed }),
                            createElement('label', { for: `overview-task-${dateStr}-${index}`, class: `task-title ${task.completed ? 'completed' : ''}` }, task.text)
                       ),
                       playBtn, // createElement handles null children correctly
                       createElement('button', { class: 'delete-btn action-btn' }, '×')
                    );
                    group.appendChild(taskEl);
                });
                dom.tasks.container.appendChild(group);
            });
        }
        init();
    });
    </script>
</body>
</html>