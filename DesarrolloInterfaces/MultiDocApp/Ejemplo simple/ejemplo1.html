<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Workstation v19.7 (Stable & Clean)</title>

    <!-- STACK -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- THREE.JS -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400&display=swap');

        :root {
            --bg-space: #0f172a;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-space);
            color: #e2e8f0;
            overflow: hidden;
            margin: 0;
            overscroll-behavior: none;
        }

        /* THEME UTILS */
        .text-accent {
            color: var(--accent);
        }

        .border-accent {
            border-color: var(--accent);
        }

        .bg-accent {
            background-color: var(--accent);
        }

        /* UI TRIGGERS */
        .planet-trigger {
            position: fixed;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            z-index: 150;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }

        .planet-trigger:active {
            transform: scale(0.95);
        }

        .planet-trigger i {
            color: var(--accent);
        }

        .planet-tl {
            top: 1.5rem;
            left: 1.5rem;
        }

        .planet-tr {
            top: 1.5rem;
            right: 1.5rem;
        }

        /* CONTAINERS */
        #three-container,
        #two-container {
            position: fixed;
            inset: 0;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        #three-container {
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }

        #two-container {
            background: #0f172a;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow-y: auto;
            padding: 6rem 2rem;
        }

        .hidden-render {
            opacity: 0;
            pointer-events: none;
            z-index: 0 !important;
        }

        /* MENU */
        #main-menu {
            position: fixed;
            top: 5.5rem;
            right: 1.5rem;
            width: 280px;
            max-height: 75vh;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 0.5rem;
            transform-origin: top right;
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 160;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }

        #main-menu.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        #main-menu::-webkit-scrollbar {
            width: 4px;
        }

        #main-menu::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            color: #cbd5e1;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            color: white;
        }

        .menu-icon-box {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .theme-row {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .theme-dot:hover {
            transform: scale(1.2);
        }

        .theme-dot.active {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--accent);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
        }

        .theme-card {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .theme-card:hover,
        .theme-card.active {
            border-color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .theme-card i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            display: block;
        }

        .theme-card span {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* SEARCH & 2D CONTROLS */
        #search-container {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(-150px);
            width: 90%;
            max-width: 600px;
            z-index: 170;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        #search-container.active {
            transform: translateX(-50%) translateY(0);
        }

        #search-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--accent);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 99px;
            outline: none;
            font-family: 'JetBrains Mono';
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        #search-filters {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .controls-2d {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
        }

        .view-btn {
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--accent);
            color: white;
        }

        /* GRID/LIST LAYOUTS */
        .grid-section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #94a3b8;
            margin: 2rem 0 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
        }

        .grid-layout .item-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            aspect-ratio: 1/1;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }

        .grid-layout .item-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .thumb-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .grid-layout .item-card:hover .thumb-preview {
            opacity: 1;
        }

        .item-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem;
            font-size: 0.75rem;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .list-layout {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .list-layout .item-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            height: 60px;
            position: relative;
        }

        .list-layout .item-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
        }

        .list-layout .thumb-preview {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 4px;
        }

        .list-layout .item-name {
            flex: 1;
            font-weight: 500;
            color: #e2e8f0;
        }

        .list-layout .item-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-right: 1rem;
        }

        .item-card.pinned {
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
        }

        .pin-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 20;
            color: #64748b;
            opacity: 0;
            transition: all 0.2s;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-card:hover .pin-btn {
            opacity: 1;
        }

        .item-card.pinned .pin-btn {
            opacity: 1;
            color: #fbbf24;
            background: rgba(0, 0, 0, 0.8);
        }

        .list-layout .pin-btn {
            position: static;
            opacity: 0.3;
        }

        .list-layout .item-card:hover .pin-btn {
            opacity: 1;
        }

        .item-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--accent);
        }

        /* VIEWER & EDITOR */
        #viewer-container {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            transform: translateY(100%);
            transition: transform 0.4s;
            display: flex;
            flex-direction: column;
        }

        #viewer-container.active {
            transform: translateY(0);
        }

        #editor-container {
            position: fixed;
            inset: 0;
            z-index: 250;
            background: #0f172a;
            transform: translateY(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        #editor-container.active {
            transform: translateY(0);
        }

        .viewer-toolbar {
            position: absolute;
            top: 1.5rem;
            right: 5rem;
            display: flex;
            gap: 1rem;
            z-index: 210;
            background: rgba(15, 23, 42, 0.8);
            padding: 0.5rem;
            border-radius: 99px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .viewer-btn {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 99px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            transition: background 0.2s;
            font-size: 0.875rem;
        }

        .viewer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 210;
            color: white;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .media-box {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        audio,
        video {
            width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .data-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent);
            font-weight: 600;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .pdf-page {
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 100%;
        }

        /* CONTENT ZOOM CONTAINER */
        #content-wrapper {
            transform-origin: top center;
            transition: transform 0.2s;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* TRUNCATION */
        .truncated-content {
            max-height: 60vh;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }

        .expand-btn {
            background: var(--accent);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 99px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            margin: 2rem auto;
            display: block;
        }

        /* EDITOR STYLES */
        .editor-textarea {
            flex: 1;
            width: 100%;
            background: #0f1218;
            color: #e2e8f0;
            font-family: 'JetBrains Mono';
            padding: 2rem;
            border: none;
            outline: none;
            resize: none;
            font-size: 14px;
        }

        .editor-toolbar {
            padding: 1rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .media-editor-controls {
            padding: 1rem;
            background: #1e293b;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
            border-top: 1px solid #334155;
        }

        .range-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 120px;
        }

        .range-group input {
            accent-color: var(--accent);
        }

        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 300;
            pointer-events: none;
        }

        #toast.visible {
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- UI -->
    <div id="btn-home" class="planet-trigger planet-tl hidden" title="Volver"><i class="ph ph-house text-2xl"></i></div>
    <div id="btn-menu" class="planet-trigger planet-tr" onclick="App.toggleMenu(event)"><i
            class="ph ph-list text-2xl text-white"></i></div>

    <div id="main-menu">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest px-4 py-2">Sistema</h3>
        <div class="menu-item" onclick="App.toggleSearch(event)">
            <div class="menu-icon-box"><i class="ph ph-magnifying-glass text-accent"></i></div>
            <div class="flex flex-col"><span class="font-bold text-sm text-white">Buscar</span></div>
        </div>
        <div class="menu-item" onclick="App.importFromCloud(event)">
            <div class="menu-icon-box"><i class="ph ph-cloud-arrow-down text-accent"></i></div>
            <div class="flex flex-col"><span class="font-bold text-sm text-white">Importar Nube</span></div>
        </div>
        <div class="menu-item" onclick="App.toggleRenderMode(event)">
            <div class="menu-icon-box"><i class="ph ph-cube-transparent text-green-400"></i></div>
            <div class="flex flex-col"><span class="font-bold text-sm text-white">Alternar Render</span></div>
        </div>
        <div class="menu-item" onclick="App.deleteAll(event)">
            <div class="menu-icon-box"><i class="ph ph-trash text-red-400"></i></div>
            <div class="flex flex-col"><span class="font-bold text-sm text-white">Borrar todo</span></div>
        </div>

        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest px-4 py-2 mt-4">Temas</h3>
        <div class="theme-row">
            <div class="theme-dot active" style="background: #3b82f6;" onclick="App.setTheme('#3b82f6', this, event)">
            </div>
            <div class="theme-dot" style="background: #8b5cf6;" onclick="App.setTheme('#8b5cf6', this, event)"></div>
            <div class="theme-dot" style="background: #10b981;" onclick="App.setTheme('#10b981', this, event)"></div>
            <div class="theme-dot" style="background: #f59e0b;" onclick="App.setTheme('#f59e0b', this, event)"></div>
        </div>

        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest px-4 py-2 mt-4">Estilos</h3>
        <div class="theme-grid">
            <div class="theme-card active" onclick="App.setTheme('cyber', this, event)"><i
                    class="ph ph-rectangle text-blue-500"></i><span>Cyber</span></div>
            <div class="theme-card" onclick="App.setTheme('orbital', this, event)"><i
                    class="ph ph-planet text-purple-500"></i><span>Orbital</span></div>
            <div class="theme-card" onclick="App.setTheme('voxel', this, event)"><i
                    class="ph ph-cube text-green-500"></i><span>Voxel</span></div>
            <div class="theme-card" onclick="App.setTheme('prism', this, event)"><i
                    class="ph ph-triangle text-orange-500"></i><span>Prism</span></div>
        </div>
    </div>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Filtrar por nombre..." autocomplete="off">
        <div id="search-filters">
            <div class="filter-chip active" onclick="App.setFilter('all', this)">Todos</div>
            <div class="filter-chip" onclick="App.setFilter('size_desc', this)">Tamaño Desc</div>
            <div class="filter-chip" onclick="App.setFilter('size_asc', this)">Tamaño Asc</div>
            <div class="filter-chip" onclick="App.setFilter('pdf', this)">PDF</div>
            <div class="filter-chip" onclick="App.setFilter('image', this)">Img</div>
            <div class="filter-chip" onclick="App.setFilter('video', this)">Vid</div>
        </div>
    </div>

    <div id="three-container">
        <div id="instructions"
            class="absolute bottom-12 w-full px-4 text-center text-white/40 text-xs pointer-events-none transition-opacity duration-500">
            Haz clic en el NÚCLEO para subir • Haz clic en CARPETA para entrar</div>
    </div>

    <div id="two-container" class="hidden-render">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 id="two-title" class="text-3xl font-bold text-white text-accent">MI UNIVERSO</h2>
                <div class="controls-2d">
                    <div class="view-btn active" id="btn-grid" onclick="App.setViewMode('grid')" title="Cuadrícula"><i
                            class="ph ph-squares-four text-xl"></i></div>
                    <div class="view-btn" id="btn-list" onclick="App.setViewMode('list')" title="Lista"><i
                            class="ph ph-list-dashes text-xl"></i></div>
                </div>
            </div>
            <div id="two-content" class="min-h-[50vh]"></div>
        </div>
    </div>

    <!-- VIEWER & EDITOR -->
    <main id="viewer-container">
        <div class="viewer-toolbar">
            <div class="flex gap-2 items-center border-r border-white/10 pr-4 mr-2">
                <button onclick="App.zoomContent(-0.1)"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700 text-white"><i
                        class="ph ph-minus"></i></button>
                <button onclick="App.zoomContent(0.1)"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700 text-white"><i
                        class="ph ph-plus"></i></button>
            </div>
            <div class="viewer-btn" onclick="App.toggleEdit()"><i
                    class="ph ph-pencil-simple text-lg text-blue-400"></i><span class="hidden md:inline">Editar</span>
            </div>
            <div class="viewer-btn" onclick="App.trashFile()"><i class="ph ph-trash text-lg text-red-400"></i><span
                    class="hidden md:inline" id="trash-btn-text">Eliminar</span></div>
            <div class="viewer-btn" onclick="App.downloadCurrent()"><i
                    class="ph ph-download-simple text-lg text-green-400"></i><span
                    class="hidden md:inline">Descargar</span></div>
        </div>
        <div class="close-btn" onclick="App.closeViewer()"><i class="ph ph-x text-xl"></i></div>
        <div id="content-view" class="h-full w-full overflow-auto p-4 md:p-8 pt-24 custom-scroll">
            <div id="content-wrapper"></div>
        </div>
    </main>

    <div id="editor-container">
        <div class="editor-toolbar">
            <h3 class="text-white font-bold">Estudio Multimedia</h3>
            <div class="flex gap-2">
                <button id="save-btn" onclick="App.saveEdit()"
                    class="px-4 py-2 bg-blue-600 rounded-lg text-sm text-white hover:bg-blue-500">Guardar</button>
                <button onclick="App.closeEdit()"
                    class="px-4 py-2 bg-slate-700 rounded-lg text-sm text-white hover:bg-slate-600">Cerrar</button>
            </div>
        </div>
        <div id="editor-workspace"
            class="flex-1 overflow-hidden relative flex flex-col items-center justify-center bg-slate-900"></div>
        <div id="editor-controls" class="media-editor-controls hidden"></div>
    </div>

    <input type="file" id="file-input" class="hidden" multiple accept="*/*" />
    <div id="toast"><i class="ph ph-check-circle text-green-400 text-xl"></i><span id="toast-text"
            class="text-white text-sm">OK</span></div>

    <!-- LOGIC -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- HELPERS (TextureGen) ---
        const TextureGen = {
            fromFile: async (f) => {
                if (f.type === 'image') return new THREE.TextureLoader().load(f.blob ? URL.createObjectURL(f.blob) : f.content);
                if (f.type === 'video') { const v = document.createElement('video'); v.src = f.blob ? URL.createObjectURL(f.blob) : f.content; v.muted = true; v.preload = "metadata"; try { await new Promise(r => { v.onloadeddata = () => { v.currentTime = 1; r(); } }); } catch (e) { } const t = new THREE.VideoTexture(v); t.colorSpace = THREE.SRGBColorSpace; return t; }
                if (['code', 'text', 'markdown', 'csv', 'html', 'json'].includes(f.type)) { let t = f.content; if (!t && f.blob) t = await f.blob.text(); f.content = t; const c = document.createElement('canvas'); c.width = 256; c.height = 256; const x = c.getContext('2d'); x.fillStyle = '#0f172a'; x.fillRect(0, 0, 256, 256); x.font = '10px "JetBrains Mono"'; x.fillStyle = '#38bdf8'; (t || "").split('\n').slice(0, 25).forEach((l, i) => x.fillText(l.substring(0, 35), 5, 20 + i * 10)); return new THREE.CanvasTexture(c); }
                if (f.type === 'audio') { const c = document.createElement('canvas'); c.width = 256; c.height = 256; const x = c.getContext('2d'); x.fillStyle = '#1e1b4b'; x.fillRect(0, 0, 256, 256); x.strokeStyle = '#f472b6'; x.lineWidth = 3; x.beginPath(); x.arc(128, 128, 50, 0, Math.PI * 2); x.stroke(); x.beginPath(); x.arc(128, 128, 80, 0, Math.PI * 2); x.stroke(); return new THREE.CanvasTexture(c); }
                return TextureGen.createGenericCard(f.name, '#3b82f6');
            },
            getCanvasOrImage: async (f) => {
                if (f.type === 'image') { const i = new Image(); i.src = f.blob ? URL.createObjectURL(f.blob) : f.content; await new Promise(r => i.onload = r); return i; }
                if (f.type === 'video') { const v = document.createElement('video'); v.src = f.blob ? URL.createObjectURL(f.blob) : f.content; v.currentTime = 1; await new Promise(r => { v.onloadeddata = () => r(); v.onerror = () => r() }); return v; }
                if (f.type === 'pdf') { const t = pdfjsLib.getDocument(f.blob ? URL.createObjectURL(f.blob) : f.content); const p = await t.promise; const page = await p.getPage(1); const v = page.getViewport({ scale: 0.5 }); const c = document.createElement('canvas'); c.height = v.height; c.width = v.width; await page.render({ canvasContext: c.getContext('2d'), viewport: v }).promise; return c; }
                const t = await TextureGen.fromFile(f); return t.image;
            },
            createLabel: (t) => { const c = document.createElement('canvas'); c.width = 1024; c.height = 256; const x = c.getContext('2d'); x.fillStyle = '#fff'; x.font = 'bold 80px "Inter"'; x.textAlign = 'center'; x.textBaseline = 'middle'; x.shadowColor = 'rgba(0,0,0,0.8)'; x.shadowBlur = 10; x.fillText(t, 512, 128); return new THREE.CanvasTexture(c); },
            createGenericCard: (name, color) => { const c = document.createElement('canvas'); c.width = 256; c.height = 256; const x = c.getContext('2d'); x.fillStyle = '#1e293b'; x.fillRect(0, 0, 256, 256); x.strokeStyle = '#475569'; x.lineWidth = 2; x.strokeRect(10, 10, 236, 236); x.fillStyle = color; x.font = 'bold 24px "Inter"'; x.textAlign = 'center'; x.textBaseline = 'middle'; const ext = name.split('.').pop().toUpperCase().substring(0, 4); x.font = 'bold 50px "Inter"'; x.fillText(ext, 128, 100); x.font = '14px "Inter"'; x.fillStyle = '#cbd5e1'; x.fillText(name.substring(0, 20), 128, 160); return new THREE.CanvasTexture(c); }
        };

        const GeometryGen = {
            create: (type, name, color, mode) => {
                const group = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.3, metalness: 0.2 });
                let mesh;
                if (mode === 'orbital') {
                    const geo = type === 'folder' ? new THREE.SphereGeometry(2.5, 32, 32) : new THREE.SphereGeometry(0.8, 32, 32);
                    mesh = new THREE.Mesh(geo, mat);
                } else if (mode === 'voxel') {
                    const geo = type === 'folder' ? new THREE.BoxGeometry(4, 4, 4) : new THREE.BoxGeometry(1.5, 1.5, 1.5);
                    mesh = new THREE.Mesh(geo, mat);
                } else if (mode === 'prism') {
                    const geo = type === 'folder' ? new THREE.ConeGeometry(3, 4, 4) : new THREE.ConeGeometry(1, 1.5, 4);
                    mesh = new THREE.Mesh(geo, mat);
                } else {
                    if (type === 'folder') { group.add(new THREE.Mesh(new THREE.BoxGeometry(6, 4.4, 0.8), mat)); const t = new THREE.Mesh(new THREE.BoxGeometry(2, 0.8, 0.8), mat); t.position.set(-2, 2.6, 0); group.add(t); mesh = group; }
                    else {
                        const f = new THREE.MeshBasicMaterial({ map: null, color: 0xffffff });
                        mesh = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 0.1), [mat, mat, mat, mat, f, mat]);
                    }
                }
                if (type === 'folder') {
                    const l = new THREE.Mesh(new THREE.PlaneGeometry(5.5, 1.4), new THREE.MeshBasicMaterial({ map: TextureGen.createLabel(name), transparent: true, side: THREE.DoubleSide }));
                    l.position.set(0, mode === 'prism' ? 0 : 0, mode === 'cyber' ? 0.41 : 3);
                    if (mode !== 'cyber') l.lookAt(new THREE.Vector3(0, 100, 0));
                    if (mode === 'cyber') group.add(l); else mesh.add(l);
                }
                if (mode === 'cyber' && type === 'folder') return group;
                return mesh;
            }
        };

        const Visualizer = (() => {
            let scene, camera, renderer, controls, raycaster, mouse;
            const objects = []; let coreMesh = null, currentHover = null;
            const container = document.getElementById('three-container');

            function init() {
                try {
                    const c = document.createElement('canvas'); let ctx = c.getContext('webgl2', { alpha: true }) || c.getContext('webgl', { alpha: true });
                    if (!ctx) throw new Error("WebGL Error");
                    container.innerHTML = ''; container.appendChild(c);
                    scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050505, 0.02);
                    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.set(0, 20, 45);
                    renderer = new THREE.WebGLRenderer({ canvas: c, context: ctx, antialias: true, alpha: true });
                    renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.5;
                    scene.add(new THREE.AmbientLight(0xffffff, 0.5)); const p = new THREE.PointLight(0xffffff, 2, 100); p.position.set(10, 10, 10); scene.add(p);
                    const sg = new THREE.BufferGeometry(); const sp = []; for (let i = 0; i < 3000; i++) sp.push((Math.random() - 0.5) * 400, (Math.random() - 0.5) * 400, (Math.random() - 0.5) * 400); sg.setAttribute('position', new THREE.Float32BufferAttribute(sp, 3)); scene.add(new THREE.Points(sg, new THREE.PointsMaterial({ size: 0.2, color: 0xffffff })));
                    raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();
                    window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
                    renderer.domElement.addEventListener('pointermove', e => { if (e.isPrimary === false) return; mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; });
                    renderer.domElement.addEventListener('click', onClick);
                    animate();
                    buildSystem([], 'root', { name: 'SUBIR ARCHIVOS' });
                } catch (e) { if (window.App) window.App.force2D("Error 3D"); }
            }

            function clear() { objects.forEach(o => scene.remove(o)); objects.length = 0; if (coreMesh) { scene.remove(coreMesh); coreMesh = null; } currentHover = null; }

            async function buildSystem(data, level, meta = {}) {
                if (!renderer) return; clear(); controls.autoRotate = true;

                const themeMap = { 'cyber': 0x3b82f6, 'orbital': 0x8b5cf6, 'voxel': 0x10b981, 'prism': 0xf59e0b };
                const mode = window.App ? window.App.getThemeMode() : 'cyber';
                const color = themeMap[mode] || 0x3b82f6;

                if (level === 'root') {
                    coreMesh = GeometryGen.create('folder', 'ROOT', 0xffd700, mode);
                    if (mode === 'cyber') coreMesh = new THREE.Mesh(new THREE.SphereGeometry(4, 64, 64), new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffa500, emissiveIntensity: 0.5 }));
                    coreMesh.userData = { action: () => document.getElementById('file-input').click(), isCore: true, label: 'ROOT' };
                } else {
                    const isTrash = meta.name === 'PAPELERA';
                    coreMesh = GeometryGen.create('folder', meta.name, isTrash ? 0xef4444 : color, mode);
                    coreMesh.scale.set(2, 2, 2); coreMesh.lookAt(camera.position);
                    coreMesh.userData = { action: meta.backAction, isCore: true, label: 'BACK' };
                }
                scene.add(coreMesh);
                if (data.length > 0) {
                    const rad = 18; const ring = new THREE.Mesh(new THREE.RingGeometry(rad - 0.1, rad + 0.1, 128), new THREE.MeshBasicMaterial({ color: 0xffffff, opacity: 0.1, transparent: true, side: THREE.DoubleSide }));
                    ring.rotation.x = Math.PI / 2; scene.add(ring); objects.push(ring);
                    for (let i = 0; i < data.length; i++) {
                        const d = data[i]; const th = (i / data.length) * Math.PI * 2; const x = rad * Math.cos(th); const z = rad * Math.sin(th);
                        let m;
                        if (d.isFolder) m = GeometryGen.create('folder', d.label, d.label === 'PAPELERA' ? 0xef4444 : color, mode);
                        else {
                            let t = await TextureGen.fromFile(d.fileRef);
                            m = GeometryGen.create('token', d.label, color, mode);
                            if (mode === 'cyber') m.material[4].map = t;
                            else if (m.material) m.material.map = t;
                        }
                        m.position.set(x, 0, z); m.lookAt(x * 2, 0, z * 2); m.userData = { action: d.action, label: d.label.toLowerCase() };
                        scene.add(m); objects.push(m);
                    }
                }
            }

            function onClick() { if (!raycaster) return; raycaster.setFromCamera(mouse, camera); const c = [...objects]; if (coreMesh) c.push(coreMesh); const h = raycaster.intersectObjects(c, true); if (h.length > 0) { let t = h[0].object; while (t && !t.userData.action) t = t.parent; if (t && t.userData.action) t.userData.action(); } }

            function animate() {
                if (!renderer) return; requestAnimationFrame(animate); controls.update(); const t = Date.now() * 0.001;
                objects.forEach((o, i) => { if (o.userData.action) o.position.y = Math.sin(t + i) * 0.5; });
                if (coreMesh && coreMesh.userData.isCore) coreMesh.rotation.y -= 0.002;
                raycaster.setFromCamera(mouse, camera); const c = [...objects.filter(o => o.visible)]; if (coreMesh) c.push(coreMesh); const h = raycaster.intersectObjects(c, true);
                let hit = null; if (h.length > 0) { let t = h[0].object; while (t && !t.userData.action && t.parent !== scene) t = t.parent; if (t && t.userData.action) hit = t; }
                if (hit) {
                    container.style.cursor = 'pointer'; controls.autoRotate = false;
                    if (currentHover !== hit) {
                        if (currentHover && currentHover.userData.outline) { if (currentHover.type === 'Group') currentHover.children[0].remove(currentHover.userData.outline); else currentHover.remove(currentHover.userData.outline); currentHover.userData.outline = null; }
                        currentHover = hit; let g = hit.geometry; if (!g && hit.children.length) { const b = hit.children[0]; if (b) g = b.geometry; }

                        // FIX: SAFE COLOR ACCESS
                        const outlineColor = window.App && window.App.getThemeColor ? window.App.getThemeColor() : '#3b82f6';
                        if (g) { const l = new THREE.LineSegments(new THREE.EdgesGeometry(g), new THREE.LineBasicMaterial({ color: outlineColor })); if (hit.type === 'Group') { hit.children[0].add(l) } else { hit.add(l) }; hit.userData.outline = l; }
                    }
                } else { container.style.cursor = 'default'; controls.autoRotate = true; if (currentHover) { if (currentHover.userData.outline) { if (currentHover.type === 'Group') currentHover.children[0].remove(currentHover.userData.outline); else currentHover.remove(currentHover.userData.outline); } currentHover = null; } }
                renderer.render(scene, camera);
            }
            return { init, renderRoot: (g) => buildSystem(g, 'root'), renderFolder: (f, n, b) => buildSystem(f, 'folder', { name: n, backAction: b }), filter: (term) => objects.forEach(o => { if (o.userData.action) o.visible = o.userData.label && o.userData.label.includes(term.toLowerCase()); }), show: () => container.classList.remove('hidden'), hide: () => container.classList.add('hidden') };
        })();

        // --- APP LOGIC ---
        const App = (() => {
            const state = { groups: [], trash: [], view: 'root', gid: null, file: null, renderMode: '3d', theme: 'cyber', view2dMode: 'grid', draggedItem: null, filterType: 'all', sortType: 'none', zoomLevel: 1 };
            const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
            const SUPABASE_KEY = 'YOUR_SUPABASE_KEY_HERE';

            const els = { view3d: document.getElementById('three-container'), view2d: document.getElementById('two-container'), menu: document.getElementById('main-menu'), search: document.getElementById('search-container'), sInput: document.getElementById('search-input'), grid: document.getElementById('two-content'), title2d: document.getElementById('two-title'), viewer: document.getElementById('viewer-container'), content: document.getElementById('content-wrapper'), home: document.getElementById('btn-home'), editor: document.getElementById('editor-container'), editorSpace: document.getElementById('editor-workspace'), editControls: document.getElementById('editor-controls'), saveBtn: document.getElementById('save-btn'), pdfControls: document.getElementById('pdf-zoom-controls'), menuBtn: document.getElementById('btn-menu'), trashBtnText: document.getElementById('trash-btn-text') };
            const genId = () => Math.random().toString(36).substr(2, 9);
            const showToast = (m) => { const t = document.getElementById('toast'); document.getElementById('toast-text').innerText = m; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000) };
            const detect = (n) => { const x = n.split('.').pop().toLowerCase(); if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(x)) return 'image'; if (['mp4', 'webm'].includes(x)) return 'video'; if (['mp3', 'wav'].includes(x)) return 'audio'; if (['pdf'].includes(x)) return 'pdf'; if (['xls', 'xlsx'].includes(x)) return 'excel'; if (['html', 'htm'].includes(x)) return 'html'; if (['csv'].includes(x)) return 'csv'; if (['md', 'markdown'].includes(x)) return 'markdown'; if (['json'].includes(x)) return 'json'; if (['js', 'css', 'py', 'txt', 'sql'].includes(x)) return 'code'; return 'text' };

            const force2D = (reason) => { state.renderMode = '2d'; showToast(`Modo 2D: ${reason}`); refresh(); };
            const toggleMenu = (e) => { if (e) e.stopPropagation(); els.menu.classList.toggle('active'); };
            const toggleSearch = (e) => { if (e) e.stopPropagation(); els.menu.classList.remove('active'); els.search.classList.toggle('active'); if (els.search.classList.contains('active')) els.sInput.focus(); };
            const deleteAll = (e) => { if (e) e.stopPropagation(); state.groups = []; state.trash = []; state.view = 'root'; state.gid = null; els.menu.classList.remove('active'); refresh(); showToast('Borrado'); };
            const toggleRenderMode = (e) => { if (e) e.stopPropagation(); state.renderMode = state.renderMode === '3d' ? '2d' : '3d'; els.menu.classList.remove('active'); refresh(); };

            const setTheme = (mode, el, e) => {
                if (e) e.stopPropagation();
                state.theme = mode;
                const colors = { 'cyber': '#3b82f6', 'orbital': '#8b5cf6', 'voxel': '#10b981', 'prism': '#f59e0b' };
                const color = colors[mode] || '#3b82f6';
                if (mode.startsWith('#')) { document.documentElement.style.setProperty('--accent', mode); state.theme = 'cyber'; }
                else { document.documentElement.style.setProperty('--accent', color); }
                document.querySelectorAll('.theme-card, .theme-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
                refresh();
            };

            const setViewMode = (mode) => { state.view2dMode = mode; document.getElementById('btn-grid').classList.toggle('active', mode === 'grid'); document.getElementById('btn-list').classList.toggle('active', mode === 'list'); refresh(); };
            const togglePin = (e, fid) => { e.stopPropagation(); let list = state.view === 'trash' ? state.trash : (state.view === 'root' ? state.groups : state.groups.find(x => x.id === state.gid).files); const item = list.find(x => x.id === fid); if (item) { item.pinned = !item.pinned; refresh(); } };
            const handleDragStart = (e, index) => { state.draggedIndex = index; e.dataTransfer.effectAllowed = 'move'; };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
            const handleDrop = (e, targetIndex) => { e.preventDefault(); let list = state.view === 'trash' ? state.trash : (state.view === 'root' ? state.groups : state.groups.find(x => x.id === state.gid).files); if (state.draggedIndex === null || state.draggedIndex === targetIndex) return; const item = list.splice(state.draggedIndex, 1)[0]; list.splice(targetIndex, 0, item); state.draggedIndex = null; refresh(); };

            const refresh = () => {
                let rootData = state.groups.map(g => ({ label: g.name, isFolder: true, action: () => enterFolder(g.id), moons: g.files.length }));
                rootData.push({ label: 'PAPELERA', isFolder: true, action: () => enterTrash(), moons: state.trash.length });

                if (state.renderMode === '3d') {
                    els.view3d.classList.remove('hidden-render'); els.view2d.classList.add('hidden-render');
                    if (state.view === 'root') { els.home.classList.add('hidden'); Visualizer.renderRoot(rootData); }
                    else if (state.view === 'trash') { els.home.classList.remove('hidden'); Visualizer.renderFolder(state.trash.map(f => ({ label: f.name, type: f.type, isFolder: false, fileRef: f, action: () => openViewer(f) })), "PAPELERA", goToRoot); }
                    else { const g = state.groups.find(x => x.id === state.gid); if (g) { els.home.classList.remove('hidden'); Visualizer.renderFolder(g.files.map(f => ({ label: f.name, type: f.type, isFolder: false, fileRef: f, action: () => openViewer(f) })), g.name, goToRoot); } }
                } else {
                    els.view3d.classList.add('hidden-render'); els.view2d.classList.remove('hidden-render');
                    const contentDiv = document.getElementById('two-content'); contentDiv.innerHTML = '';

                    let items = [];
                    if (state.view === 'root') {
                        els.title2d.innerText = "MI UNIVERSO"; els.home.classList.add('hidden');
                        items = [...state.groups.map(g => ({ ...g, isFolder: true })), { id: 'trash', name: 'PAPELERA', isFolder: true, isTrash: true, files: state.trash }];
                    } else {
                        const isTrash = state.view === 'trash';
                        items = isTrash ? state.trash : state.groups.find(x => x.id === state.gid).files;
                        els.title2d.innerText = isTrash ? "PAPELERA" : state.groups.find(x => x.id === state.gid).name;
                        els.home.classList.remove('hidden');
                    }

                    items.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

                    // CLASSIFY FOR 2D
                    if (state.view !== 'root' && items.length > 0) {
                        const categories = { 'Imágenes': items.filter(f => f.type === 'image'), 'Multimedia': items.filter(f => ['video', 'audio'].includes(f.type)), 'Docs': items.filter(f => ['pdf', 'excel'].includes(f.type)), 'Code/Data': items.filter(f => ['code', 'json', 'csv', 'html'].includes(f.type)), 'Otros': items.filter(f => ['text', 'markdown'].includes(f.type)) };
                        for (const [cat, files] of Object.entries(categories)) {
                            if (files.length === 0) continue;
                            const sec = document.createElement('div'); sec.innerHTML = `<div class="grid-section-title"><i class="ph ph-circles-three-plus"></i> ${cat}</div>`;
                            const grid = document.createElement('div'); grid.className = state.view2dMode === 'grid' ? "grid-layout" : "list-layout";
                            files.forEach((item, idx) => renderItem(item, idx, grid)); sec.appendChild(grid); contentDiv.appendChild(sec);
                        }
                    } else {
                        const container = document.createElement('div'); container.className = state.view2dMode === 'grid' ? "grid-layout" : "list-layout";
                        if (state.view === 'root') { const upBtn = document.createElement('div'); upBtn.className = state.view2dMode === 'grid' ? "item-card flex-col justify-center items-center border-dashed border-slate-500" : "item-card border-dashed border-slate-500"; upBtn.onclick = () => document.getElementById('file-input').click(); upBtn.innerHTML = `<i class="ph ph-upload-simple text-3xl text-slate-500"></i><span class="text-slate-400 text-xs ${state.view2dMode === 'list' ? 'ml-4' : ''}">SUBIR</span>`; container.appendChild(upBtn); }
                        items.forEach((item, index) => renderItem(item, index, container));
                        contentDiv.appendChild(container);
                    }
                }
            };

            const renderItem = (item, index, container) => {
                const div = document.createElement('div');
                div.className = `item-card group ${item.pinned ? 'pinned' : ''}`;
                div.draggable = true; div.ondragstart = (e) => handleDragStart(e, index); div.ondragover = (e) => e.preventDefault(); div.ondrop = (e) => handleDrop(e, index);
                div.onclick = () => { if (item.isFolder) { if (item.isTrash) enterTrash(); else enterFolder(item.id); } else window.tempOpen(item.id); };
                const pin = `<div class="pin-btn" onclick="App.togglePin(event, '${item.id}')"><i class="ph ${item.pinned ? 'ph-push-pin-fill' : 'ph-push-pin-simple'}"></i></div>`;
                let visual = '';
                if (state.view2dMode === 'grid') {
                    if (item.isFolder) visual = `<div class="flex-1 flex items-center justify-center"><i class="ph ${item.isTrash ? 'ph-trash' : 'ph-folder-notch-open'} text-6xl text-accent"></i></div>${pin}<div class="item-info-overlay"><span class="block truncate font-bold text-white">${item.name}</span><span class="text-xs text-slate-400">${item.files ? item.files.length : 0} items</span></div>`;
                    else visual = `${pin}<div class="absolute inset-0 flex items-center justify-center bg-slate-900/50" id="thumb-${item.id}"><i class="ph ph-spinner animate-spin text-2xl text-slate-500"></i></div><div class="item-info-overlay"><span class="block truncate font-bold text-white">${item.name}</span><span class="text-xs text-slate-400">${(item.blob.size / 1024).toFixed(1)} KB</span></div>`;
                } else {
                    if (item.isFolder) visual = `<i class="ph ${item.isTrash ? 'ph-trash' : 'ph-folder-notch-open'} text-2xl text-accent"></i><span class="item-name">${item.name}</span><span class="item-meta">${item.files ? item.files.length : 0} items</span>${pin}`;
                    else visual = `<div id="thumb-${item.id}" class="w-10 h-10 bg-slate-800 rounded flex items-center justify-center mr-2 overflow-hidden"><i class="ph ph-file text-slate-500"></i></div><span class="item-name">${item.name}</span>${pin}`;
                }
                div.innerHTML = visual; container.appendChild(div);
                if (!item.isFolder) TextureGen.getCanvasOrImage(item).then(s => { const c = document.getElementById(`thumb-${item.id}`); if (c) { c.innerHTML = ''; s.className = "thumb-preview"; if (s instanceof HTMLVideoElement) { s.muted = true; s.onmouseover = () => s.play().catch(() => { }); s.onmouseout = () => s.pause(); } c.appendChild(s); } });
            };

            const goToRoot = () => { state.view = 'root'; state.gid = null; refresh(); };
            const enterFolder = (gid) => { state.view = 'folder'; state.gid = gid; refresh(); };
            const enterTrash = () => { state.view = 'trash'; state.gid = 'trash'; refresh(); };

            // RECURSIVE FOLDER DROP
            const scanFiles = async (entry) => {
                if (entry.isFile) return new Promise(resolve => entry.file(f => resolve([{ file: f, path: entry.fullPath }])));
                if (entry.isDirectory) { const r = entry.createReader(); const e = await new Promise(resolve => r.readEntries(resolve)); return (await Promise.all(e.map(scanFiles))).flat(); }
                return [];
            };
            const handleFileDrop = async (e) => {
                e.preventDefault(); const items = e.dataTransfer.items;
                const rootFiles = [], folders = {};
                for (let i = 0; i < items.length; i++) {
                    const entry = items[i].webkitGetAsEntry();
                    if (entry) {
                        if (entry.isFile) rootFiles.push(await new Promise(r => entry.file(r)));
                        else if (entry.isDirectory) { folders[entry.name] = (await scanFiles(entry)).map(x => x.file); }
                    }
                }
                for (const [name, files] of Object.entries(folders)) {
                    const g = { id: genId(), name: name, files: [] };
                    files.forEach(f => g.files.push({ id: genId(), blob: f, name: f.name, type: detect(f.name), ext: f.name.split('.').pop(), content: null, pinned: false }));
                    state.groups.push(g);
                }
                if (rootFiles.length > 0) addFile(rootFiles); else { refresh(); showToast('Carpetas Procesadas'); }
            };

            const addFile = async (files) => {
                const list = Array.from(files); const zips = list.filter(f => f.name.endsWith('.zip')); const others = list.filter(f => !f.name.endsWith('.zip'));
                for (const z of zips) { try { const zip = await JSZip.loadAsync(z); const g = { id: genId(), name: z.name.replace('.zip', ''), files: [] }; for (const k of Object.keys(zip.files)) { if (!zip.files[k].dir && !k.includes('__MACOSX')) { const b = await zip.files[k].async('blob'); g.files.push({ id: genId(), blob: new File([b], k), name: k.split('/').pop(), type: detect(k), ext: k.split('.').pop(), content: null, pinned: false }); } } if (g.files.length) state.groups.push(g); } catch (e) { } }
                if (others.length > 0) { let target = state.groups.find(g => g.name === 'Mis Archivos'); if (!target) { target = { id: genId(), name: 'Mis Archivos', files: [] }; state.groups.push(target); } others.forEach(f => target.files.push({ id: genId(), blob: f, name: f.name, type: detect(f.name), ext: f.name.split('.').pop(), content: null, pinned: false })); }
                showToast('Archivos Procesados'); refresh();
            };
            const importFromCloud = async (e) => { if (e) e.stopPropagation(); showToast("Simulando Nube..."); };
            const trashFile = () => {
                const f = state.currentFile; if (!f) return;
                const inTrash = state.view === 'trash';
                if (inTrash) { if (confirm("¿Eliminar definitivamente?")) { state.trash = state.trash.filter(x => x.id !== f.id); showToast("Eliminado"); } else { let target = state.groups.find(g => g.name === 'Mis Archivos'); if (!target) { target = { id: genId(), name: 'Mis Archivos', files: [] }; state.groups.push(target); } target.files.push(f); state.trash = state.trash.filter(x => x.id !== f.id); showToast("Restaurado"); } }
                else { const g = state.groups.find(x => x.id === state.gid); if (g) { g.files = g.files.filter(x => x.id !== f.id); state.trash.push(f); showToast("A Papelera"); } }
                els.viewer.classList.remove('active'); refresh();
            };

            const openViewer = async (f) => {
                state.currentFile = f; state.zoomLevel = 1; els.viewer.classList.add('active');
                if (state.view === 'trash') els.trashBtnText.innerText = "Acciones"; else els.trashBtnText.innerText = "Eliminar";

                // Clear Content
                els.content.innerHTML = '';
                els.content.style.transform = `scale(1)`;

                let content = f.content;
                let u = f.blob ? URL.createObjectURL(f.blob) : null;

                if (!content && f.blob && !['image', 'video', 'pdf', 'audio'].includes(f.type)) content = await f.blob.text();
                f.content = content;

                if (f.type === 'image') {
                    els.content.innerHTML = `<img src="${u || content}" class="max-h-[80vh] shadow-2xl rounded" style="max-width: 100%;">`;
                }
                else if (f.type === 'video') {
                    els.content.innerHTML = `<video controls src="${u}" style="max-height: 80vh; max-width: 100%;"></video>`;
                }
                else if (f.type === 'pdf') {
                    renderPDF(u);
                }
                else if (f.type === 'excel') {
                    const wb = XLSX.read(await f.blob.arrayBuffer());
                    els.content.innerHTML = `<div class="data-table-wrapper">${XLSX.utils.sheet_to_html(wb.Sheets[wb.SheetNames[0]])}</div>`;
                }
                else if (f.type === 'csv') {
                    const p = Papa.parse(content, { header: true, skipEmptyLines: true });
                    if (p.data.length) els.content.innerHTML = `<div class="data-table-wrapper"><table class="data-table"><thead><tr>${Object.keys(p.data[0]).map(k => `<th>${k}</th>`).join('')}</tr></thead><tbody>${p.data.slice(0, 100).map(r => `<tr>${Object.values(r).map(v => `<td>${v}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
                }
                else if (f.type === 'markdown') {
                    els.content.innerHTML = `<div class="markdown-body p-8 bg-slate-900 rounded-xl">${marked.parse(content)}</div>`;
                }
                else {
                    // Default Code/Text
                    els.content.innerHTML = `<pre class="!bg-slate-900 !rounded-xl !p-6 border border-white/10 overflow-auto" style="max-width:100%"><code class="language-js">${(content || "").replace(/</g, '&lt;')}</code></pre>`;
                    if (f.type === 'code') Prism.highlightAllUnder(els.content);
                }

                // Add truncate button for text
                if (['code', 'text', 'csv', 'json'].includes(f.type) && content.length > 3000) {
                    els.content.children[0].classList.add('truncated-content');
                    const btn = document.createElement('button');
                    btn.className = 'expand-btn';
                    btn.innerHTML = 'Ver todo';
                    btn.onclick = () => { els.content.children[0].classList.remove('truncated-content'); btn.remove(); };
                    els.content.appendChild(btn);
                }
            };

            const renderPDF = async (u) => {
                els.content.innerHTML = ''; // Clear for canvas
                const task = pdfjsLib.getDocument(u); const p = await task.promise;
                for (let i = 1; i <= Math.min(p.numPages, 5); i++) {
                    const page = await p.getPage(i);
                    const v = page.getViewport({ scale: 1.5 });
                    const cnv = document.createElement('canvas');
                    cnv.className = "pdf-page rounded shadow";
                    cnv.height = v.height; cnv.width = v.width;
                    await page.render({ canvasContext: cnv.getContext('2d'), viewport: v }).promise;
                    els.content.appendChild(cnv);
                }
            };

            const zoomContent = (delta) => { state.zoomLevel = Math.max(0.2, Math.min(5.0, state.zoomLevel + delta)); els.content.style.transform = `scale(${state.zoomLevel})`; };

            const downloadCurrent = () => { const f = state.currentFile; const a = document.createElement('a'); a.href = f.blob ? URL.createObjectURL(f.blob) : URL.createObjectURL(new Blob([f.content])); a.download = f.name; a.click(); };

            // EDITOR
            let editCanvas = null;
            const toggleEdit = () => {
                const f = state.currentFile; if (!f) return;
                els.editorSpace.innerHTML = ''; els.editControls.innerHTML = ''; els.editControls.classList.add('hidden'); els.editor.classList.add('active');
                if (f.type === 'image' || f.type === 'video') {
                    const isVideo = f.type === 'video';
                    const el = document.createElement(isVideo ? 'video' : 'img');
                    el.src = f.blob ? URL.createObjectURL(f.blob) : f.content;
                    el.style.maxWidth = '100%'; el.style.maxHeight = '70vh'; el.style.objectFit = 'contain';
                    el.id = "edit-target-media";
                    if (isVideo) { el.muted = true; el.loop = true; el.play(); }
                    els.editorSpace.appendChild(el);
                    els.editControls.innerHTML = `<div class="range-group"><label>Brillo</label><input type="range" id="f-bri" min="0" max="200" value="100"></div><div class="range-group"><label>Contraste</label><input type="range" id="f-con" min="0" max="200" value="100"></div><div class="range-group"><label>Saturación</label><input type="range" id="f-sat" min="0" max="200" value="100"></div><div class="range-group"><label>Rotación</label><input type="range" id="f-rot" min="0" max="360" value="0"></div>`;
                    els.editControls.classList.remove('hidden');
                    const inputs = els.editControls.querySelectorAll('input');
                    inputs.forEach(i => i.addEventListener('input', () => {
                        const b = document.getElementById('f-bri').value, c = document.getElementById('f-con').value, s = document.getElementById('f-sat').value, r = document.getElementById('f-rot').value;
                        el.style.filter = `brightness(${b}%) contrast(${c}%) saturate(${s}%)`;
                        el.style.transform = `rotate(${r}deg)`;
                    }));
                } else if (f.type === 'audio') {
                    const el = document.createElement('audio'); el.src = f.blob ? URL.createObjectURL(f.blob) : f.content; el.controls = true; els.editorSpace.appendChild(el);
                } else {
                    const ta = document.createElement('textarea'); ta.className = 'editor-textarea'; ta.value = f.content || ""; ta.id = 'active-edit-text'; els.editorSpace.appendChild(ta);
                }
            };
            const saveEdit = async () => {
                const f = state.currentFile;
                if (f.type === 'image' || f.type === 'video') {
                    const el = document.getElementById('edit-target-media');
                    const b = document.getElementById('f-bri').value, c = document.getElementById('f-con').value, s = document.getElementById('f-sat').value, r = document.getElementById('f-rot').value;
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const w = (f.type === 'video' ? el.videoWidth : el.naturalWidth), h = (f.type === 'video' ? el.videoHeight : el.naturalHeight);
                    cvs.width = w; cvs.height = h;
                    ctx.filter = `brightness(${b}%) contrast(${c}%) saturate(${s}%)`;
                    ctx.translate(w / 2, h / 2); ctx.rotate(r * Math.PI / 180); ctx.drawImage(el, -w / 2, -h / 2);
                    const url = cvs.toDataURL('image/png');
                    f.content = url; f.blob = await (await fetch(url)).blob();
                } else if (f.type !== 'audio') {
                    const txt = document.getElementById('active-edit-text').value; f.content = txt; f.blob = new Blob([txt], { type: 'text/plain' });
                }
                showToast("Guardado"); closeEdit(); openViewer(f);
            };
            const closeEdit = () => els.editor.classList.remove('active');

            const setFilter = (type, el) => { if (type.startsWith('size')) state.sortType = type; else state.filterType = type; document.querySelectorAll('.filter-chip').forEach(c => { if (!c.innerText.includes('Tamaño')) c.classList.remove('active'); }); el.classList.add('active'); if (state.renderMode === '2d') refresh(); else Visualizer.filter(els.sInput.value); };
            const filterFiles = (files) => { let res = files; if (state.filterType !== 'all') res = res.filter(f => f.type === state.filterType); const term = els.sInput.value.toLowerCase(); if (term) res = res.filter(f => f.name.toLowerCase().includes(term)); if (state.sortType === 'size_asc') res.sort((a, b) => a.blob.size - b.blob.size); if (state.sortType === 'size_desc') res.sort((a, b) => b.blob.size - a.blob.size); return res; };

            window.tempOpen = (fid) => { if (state.view === 'trash') { const f = state.trash.find(x => x.id === fid); if (f) openViewer(f); } else { const g = state.groups.find(x => x.id === state.gid); const f = g.files.find(x => x.id === fid); if (f) openViewer(f); } };

            document.addEventListener('click', e => {
                const search = document.getElementById('search-container');
                const menu = document.getElementById('main-menu');
                const menuBtn = document.getElementById('btn-menu');
                if (menu && menuBtn && !menu.contains(e.target) && !menuBtn.contains(e.target)) menu.classList.remove('active');
                if (search && search.classList.contains('active') && !search.contains(e.target)) search.classList.remove('active');
            });
            document.addEventListener('dragover', e => e.preventDefault());
            // Use the recursive handler
            document.addEventListener('drop', handleFileDrop);

            document.getElementById('file-input').addEventListener('change', e => { addFile(e.target.files); e.target.value = ''; });
            els.home.addEventListener('click', goToRoot); els.sInput.addEventListener('input', e => filterAll(e.target.value));

            setTimeout(() => { Visualizer.init(); }, 50);

            return { toggleMenu, toggleSearch, deleteAll, toggleRenderMode, force2D, enterFolder, enterTrash, openViewer, downloadCurrent, closeViewer: () => els.viewer.classList.remove('active'), toggleEdit, saveEdit, closeEdit, trashFile, importFromCloud, setTheme, getThemeMode: () => state.theme, getThemeColor: () => getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(), setViewMode, togglePin, setFilter, zoomContent };
        })();
        window.App = App;
    </script>
</body>
</html>