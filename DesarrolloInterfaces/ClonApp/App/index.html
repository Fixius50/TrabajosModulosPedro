<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Clone V52 - Media Upload</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes('fetch') || message.includes('401')) return;
            const errorBox = document.getElementById('error-box');
            if (errorBox) {
                errorBox.style.display = 'block';
                document.getElementById('error-msg').textContent = `Error: ${message}`;
            }
        };
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap');
        body { background-color: #FBFBFA; color: #37352f; }
        .fancy-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .fancy-scroll::-webkit-scrollbar-track { background: transparent; }
        .fancy-scroll::-webkit-scrollbar-thumb { background: #D3D1CB; border-radius: 4px; }
        .fancy-scroll::-webkit-scrollbar-thumb:hover { background: #AEACA6; }
        [contenteditable]:empty:before { content: attr(placeholder); color: #9B9A97; pointer-events: none; display: block; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; padding: 20px; background: #fee2e2; border-bottom: 2px solid #ef4444; color: #991b1b; z-index: 9999; font-family: monospace; white-space: pre-wrap; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "@octokit/rest": "https://esm.sh/@octokit/rest@19.0.13" 
        }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="error-box"><h3 class="font-bold">‚ö†Ô∏è Error</h3><p id="error-msg">Cargando...</p></div>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef, useLayoutEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence } from 'framer-motion';
        import { 
            List, Plus, Trash, Image as ImageIcon, FileText, 
            MoreHorizontal, Search, Settings, GripVertical, 
            ArrowRight, CheckSquare, Sparkles, Sidebar as SidebarIcon,
            X, Github, Palette, Type, Globe, Lock, ChevronDown, Check,
            Users, Inbox, ArrowLeft, SlidersHorizontal, User, Briefcase, Plane, Music,
            Wand2, Loader2, LayoutTemplate, Bell, ChevronsLeft, CreditCard, LogOut,
            ChevronRight, UploadCloud, ImagePlus
        } from 'lucide-react';

        // --- ENDPOINTS ---
        const API_MARKET = "/api/market";
        const API_AI = "/api/generar-pagina";
        const API_UPLOAD = "/api/upload";

        // Datos iniciales
        const GITHUB_TOKEN_DEFAULT = ""; 
        const GITHUB_OWNER = "Fixius50";
        const GITHUB_REPO = "TrabajosModulosPedro";
        const GITHUB_PATH = "DesarrolloInterfaces/ClonApp/App";
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const ICONS_LIST = ['üìÑ', 'üéµ', 'üöÄ', 'üíº', 'üí°', 'üé®', 'üèà', 'ü™ê', 'üçé', 'üçï', '‚öΩ', 'üöó', 'üê∂', 'üê±', 'üéâ', 'üìö', 'üí∏', 'üè†', '‚ù§Ô∏è', 'üíÄ', 'üî•', '‚ú®'];
        const MOCK_COVERS = {
            'ABSTRACTOS': ['https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&w=1200&q=80', 'https://images.unsplash.com/photo-1541701494587-cb58502866ab?auto=format&fit=crop&w=1200&q=80'],
            'NASA': ['https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=1200&q=80', 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=1200&q=80']
        };
        const INITIAL_WORKSPACES = [{ id: 'ws-demo', name: 'Fixius Workspace', initial: 'F', color: 'from-indigo-500 to-purple-500', email: 'user@example.com', pages: [] }];

        // --- COMPONENTES ---
        const NotificationPopup = ({ message, onClose, isVisible }) => (
            <AnimatePresence>
                {isVisible && (
                    <motion.div initial={{ opacity: 0, x: 50 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: 50 }} className="fixed bottom-6 right-6 bg-zinc-800 text-white p-4 rounded-lg shadow-xl flex items-center gap-3 z-[100] max-w-sm cursor-pointer border border-zinc-700" onClick={onClose}>
                        <div className="bg-blue-500 p-1.5 rounded-md"><Check size={16} className="text-white" /></div>
                        <div className="flex-1"><h4 className="font-bold text-sm">Hecho</h4><p className="text-xs text-zinc-300">{message}</p></div>
                    </motion.div>
                )}
            </AnimatePresence>
        );

        const FancyEditable = ({ tagName: Tag, html, className, onChange, onKeyDown, placeholder, disabled, autoFocus }) => {
            const contentEditableRef = useRef(null);
            useEffect(() => { if (autoFocus && contentEditableRef.current) contentEditableRef.current.focus(); }, [autoFocus]);
            useLayoutEffect(() => { if (contentEditableRef.current && contentEditableRef.current.innerText !== html) contentEditableRef.current.innerText = html; }, [html]);
            const handleInput = (e) => { if (onChange && e.currentTarget.innerText !== html) onChange(e.currentTarget.innerText); };
            return <Tag ref={contentEditableRef} className={`${className} empty:before:content-[attr(placeholder)] empty:before:text-zinc-300 outline-none`} contentEditable={!disabled} suppressContentEditableWarning onInput={handleInput} onKeyDown={onKeyDown} placeholder={placeholder} />;
        };

        const Modal = ({ isOpen, onClose, children, title, size = "max-w-2xl", transparent = false }) => (
            <AnimatePresence>
                {isOpen && (
                    <>
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose} className="fixed inset-0 bg-black/20 backdrop-blur-[2px] z-50" />
                        <motion.div initial={{ opacity: 0, scale: 0.95, y: 10 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 10 }} className={`fixed inset-0 m-auto ${size} h-fit max-h-[85vh] ${transparent ? 'bg-transparent shadow-none' : 'bg-white shadow-xl border border-zinc-200'} rounded-xl z-50 overflow-hidden flex flex-col text-zinc-800`}>
                            {title !== null && !transparent && (<div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0"><h2 className="text-sm font-semibold text-zinc-700">{title}</h2><button onClick={onClose} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18}/></button></div>)}
                            <div className="flex-1 overflow-y-auto">{children}</div>
                        </motion.div>
                    </>
                )}
            </AnimatePresence>
        );

        const EditorBlock = ({ block, index, updateBlock, addBlock, deleteBlock }) => {
            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); addBlock(index + 1); } else if (e.key === 'Backspace' && (!block.content)) { e.preventDefault(); deleteBlock(index); } };
            const handleChange = (val) => {
                if (block.type === 'p') {
                    if (val === '# ') { updateBlock(block.id, { type: 'h1', content: '' }); return; }
                    if (val === '## ') { updateBlock(block.id, { type: 'h2', content: '' }); return; }
                    if (val === '- ') { updateBlock(block.id, { type: 'bullet', content: '' }); return; }
                    if (val === '[] ') { updateBlock(block.id, { type: 'todo', content: '' }); return; }
                }
                updateBlock(block.id, { content: val });
            };
            return (
                <motion.div layout className="group relative flex items-start pl-2 md:pl-6 mb-1 py-0.5">
                    <div className="absolute left-0 top-1.5 p-0.5 text-zinc-300 opacity-0 group-hover:opacity-100 cursor-grab active:cursor-grabbing hover:text-zinc-500 transition-opacity"><GripVertical size={14} /></div>
                    <div className="w-full">
                        {block.type === 'h1' && <FancyEditable tagName="h1" html={block.content} className="text-3xl font-bold text-zinc-800 mb-2 mt-4" placeholder="Encabezado 1" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h2' && <FancyEditable tagName="h2" html={block.content} className="text-2xl font-semibold text-zinc-800 mb-1 mt-3" placeholder="Encabezado 2" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'p' && <FancyEditable tagName="p" html={block.content} className="text-base text-zinc-700 leading-relaxed min-h-[24px]" placeholder='Escribe "/" para comandos...' onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'bullet' && <div className="flex items-start gap-2"><div className="mt-2.5 w-1.5 h-1.5 rounded-full bg-zinc-800 shrink-0"/><FancyEditable tagName="p" html={block.content} className="flex-1 text-base text-zinc-700 leading-relaxed" placeholder="Lista" onKeyDown={handleKeyDown} onChange={(val) => updateBlock(block.id, { content: val })} autoFocus /></div>}
                        {block.type === 'todo' && <div className="flex items-start gap-3"><div onClick={() => updateBlock(block.id, { checked: !block.checked })} className={`mt-1 w-4 h-4 rounded-[3px] border cursor-pointer flex items-center justify-center transition-colors ${block.checked ? 'bg-blue-500 border-blue-500' : 'border-zinc-400 hover:bg-zinc-100'}`}>{block.checked && <Check size={12} className="text-white" />}</div><FancyEditable tagName="p" html={block.content} className={`flex-1 text-base min-h-[24px] transition-opacity ${block.checked ? 'line-through text-zinc-400 opacity-50' : 'text-zinc-700'}`} placeholder="Tarea por hacer" onKeyDown={handleKeyDown} onChange={(val) => updateBlock(block.id, { content: val })} autoFocus /></div>}
                    </div>
                </motion.div>
            );
        };

        const SpotlightCard = ({ children, className = "", onClick }) => {
            const divRef = useRef(null);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [opacity, setOpacity] = useState(0);
            const handleMouseMove = (e) => { if (!divRef.current) return; const rect = divRef.current.getBoundingClientRect(); setPosition({ x: e.clientX - rect.left, y: e.clientY - rect.top }); };
            return (
                <motion.div ref={divRef} onMouseMove={handleMouseMove} onMouseEnter={() => setOpacity(1)} onMouseLeave={() => setOpacity(0)} onClick={onClick} className={`relative rounded-xl border border-zinc-200 bg-white shadow-sm overflow-hidden cursor-pointer group ${className}`} whileHover={{ y: -2 }} whileTap={{ scale: 0.99 }}>
                    <div className="pointer-events-none absolute -inset-px opacity-0 transition duration-300 z-10" style={{ opacity, background: `radial-gradient(600px circle at ${position.x}px ${position.y}px, rgba(0,0,0,0.05), transparent 40%)` }} />
                    <div className="relative h-full z-0">{children}</div>
                </motion.div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [workspaces, setWorkspaces] = useState(() => { const saved = localStorage.getItem('notion_v50_workspaces'); return saved ? JSON.parse(saved) : INITIAL_WORKSPACES; });
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [currentView, setCurrentView] = useState('home'); 
            const [settingsTab, setSettingsTab] = useState('menu'); 
            const [activeWorkspaceId, setActiveWorkspaceId] = useState('ws-demo');
            const [activePageId, setActivePageId] = useState(null);
            const [importedResources, setImportedResources] = useState({ styles: [], fonts: [] });
            const [notification, setNotification] = useState({ show: false, message: '' });
            const [showSearch, setShowSearch] = useState(false);
            const [showMarket, setShowMarket] = useState(false);
            const [marketTab, setMarketTab] = useState('gallery');
            const [showWorkspaceMenu, setShowWorkspaceMenu] = useState(false);
            const [showIconPicker, setShowIconPicker] = useState(false);
            const [showPageOptions, setShowPageOptions] = useState(false);
            const [showAI, setShowAI] = useState(false); 
            const [aiPrompt, setAiPrompt] = useState("");
            const [isAiGeneratingBackground, setIsAiGeneratingBackground] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [marketData, setMarketData] = useState({ styles: [], fonts: [], covers: MOCK_COVERS });
            const [isLoadingMarket, setIsLoadingMarket] = useState(false);
            const [isUploading, setIsUploading] = useState(false); // Nuevo estado de subida

            const workspace = workspaces.find(w => w.id === activeWorkspaceId) || workspaces[0];
            const activePage = workspace?.pages.find(p => p.id === activePageId);
            const filteredPages = useMemo(() => {
                if (!searchQuery.trim()) return workspace.pages;
                return workspace.pages.filter(p => p.title.toLowerCase().includes(searchQuery.toLowerCase()));
            }, [searchQuery, workspace]);

            useEffect(() => { localStorage.setItem('notion_v50_workspaces', JSON.stringify(workspaces)); }, [workspaces]);
            useEffect(() => { if (notification.show) { const timer = setTimeout(() => setNotification({ ...notification, show: false }), 4000); return () => clearTimeout(timer); } }, [notification.show]);

            // FETCH MARKET
            const fetchMarketData = async () => {
                setIsLoadingMarket(true);
                try {
                    const response = await fetch(API_MARKET); 
                    if (!response.ok) throw new Error('Error API Market');
                    const data = await response.json();
                    setMarketData(prev => ({ ...prev, styles: data.styles || [], fonts: data.fonts || prev.fonts }));
                } catch (e) { 
                    setMarketData({ styles: [{id: 's1', name: 'Dark Dracula', author: 'Fixius50', color: 'bg-purple-900'}], fonts: [{id: 'f1', name: 'JetBrains Mono'}], covers: MOCK_COVERS });
                } finally { setIsLoadingMarket(false); }
            };

            const importResource = (resource, type) => {
                if (type === 'style') {
                    setImportedResources(prev => ({ ...prev, styles: [...prev.styles, resource] }));
                    setNotification({ show: true, message: `Estilo importado` });
                } else if (type === 'font') {
                    setImportedResources(prev => ({ ...prev, fonts: [...prev.fonts, resource] }));
                    setNotification({ show: true, message: `Fuente importada` });
                }
            };

            // SUBIDA DE ARCHIVOS
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsUploading(true);
                
                try {
                    let fileUrl;
                    // Intentamos subir a Vercel Blob
                    const response = await fetch(`${API_UPLOAD}?filename=${encodeURIComponent(file.name)}`, {
                        method: 'POST',
                        body: file,
                    });

                    if (response.ok) {
                        const blob = await response.json();
                        fileUrl = blob.url;
                    } else {
                        // Fallback para entorno Local/Canvas (Vista Previa)
                        console.warn("Usando vista previa local (Upload API fall√≥)");
                        fileUrl = URL.createObjectURL(file);
                    }

                    updatePage(activePageId, { cover: fileUrl });
                    setNotification({ show: true, message: "Portada actualizada" });
                    setShowMarket(false); // Cerrar modal

                } catch (error) {
                    console.error("Error subiendo:", error);
                    // Fallback emergencia
                    const localUrl = URL.createObjectURL(file);
                    updatePage(activePageId, { cover: localUrl });
                    setNotification({ show: true, message: "Portada subida (Local)" });
                    setShowMarket(false);
                } finally {
                    setIsUploading(false);
                }
            };

            const generatePageWithAI = async () => {
                if (!aiPrompt.trim()) return;
                setShowAI(false);
                setAiPrompt("");
                setIsAiGeneratingBackground(true);
                try {
                    const response = await fetch(API_AI, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: `Notion page for: ${aiPrompt}` })
                    });
                    let parsed = response.ok ? await response.json() : { title: aiPrompt, icon: "ü§ñ", cover_keyword: "tech", blocks: [{type: "p", content: "Contenido generado..."}] };
                    const keyword = parsed.cover_keyword || "abstract";
                    const dynamicCover = `https://image.pollinations.ai/prompt/${encodeURIComponent(keyword)}?width=1200&height=400&nologo=true`;
                    const newPage = { id: generateId(), title: parsed.title, icon: parsed.icon || '‚ú®', cover: dynamicCover, updatedAt: new Date().toISOString(), isPrivate: true, blocks: parsed.blocks?.map(b => ({ ...b, id: generateId() })) || [] };
                    const updated = workspaces.map(ws => ws.id === activeWorkspaceId ? { ...ws, pages: [...ws.pages, newPage] } : ws);
                    setWorkspaces(updated);
                    setNotification({ show: true, message: "P√°gina creada con IA" });
                } catch (e) { 
                    setIsAiGeneratingBackground(false);
                } finally { setIsAiGeneratingBackground(false); }
            };

            useEffect(() => { if(showMarket) fetchMarketData(); }, [showMarket]);

            const updatePage = (pid, u) => setWorkspaces(workspaces.map(ws => ws.id === activeWorkspaceId ? { ...ws, pages: ws.pages.map(p => p.id === pid ? { ...p, ...u } : p) } : ws));
            const createPage = () => { const id = generateId(); const np = { id, title: '', icon: null, cover: null, isPrivate: true, updatedAt: new Date().toISOString(), blocks: [{ id: generateId(), type: 'p', content: '' }] }; setWorkspaces(workspaces.map(ws => ws.id === activeWorkspaceId ? { ...ws, pages: [...ws.pages, np] } : ws)); setActivePageId(id); setCurrentView('page'); };
            const deletePage = (id) => { if(confirm("¬øEliminar?")) { setWorkspaces(workspaces.map(ws => ws.id === activeWorkspaceId ? { ...ws, pages: ws.pages.filter(p => p.id !== id) } : ws)); if(activePageId === id) { setActivePageId(null); setCurrentView('home'); } } };
            const updateBlock = (bid, u) => updatePage(activePageId, { blocks: activePage.blocks.map(b => b.id === bid ? { ...b, ...u } : b) });
            const addBlock = (idx) => { const bs = [...activePage.blocks]; bs.splice(idx, 0, { id: generateId(), type: 'p', content: '' }); updatePage(activePageId, { blocks: bs }); };
            const deleteBlock = (idx) => { const bs = [...activePage.blocks]; bs.splice(idx, 1); updatePage(activePageId, { blocks: bs }); };

            return (
                <div className="flex h-screen w-full bg-[#FBFBFA] text-[#37352f] font-sans selection:bg-[#cce9ff] relative">
                    <NotificationPopup message={notification.message} isVisible={notification.show} onClose={() => setNotification({ ...notification, show: false })} />

                    <motion.aside initial={false} animate={{ width: sidebarOpen ? 240 : 56 }} className="h-full bg-[#F7F7F5] flex flex-col z-20 relative border-r border-[#E9E9E8] overflow-hidden transition-all duration-300 group/sidebar">
                        <div className="p-3 relative shrink-0">
                            <div onClick={() => setShowWorkspaceMenu(!showWorkspaceMenu)} className={`flex items-center gap-2 p-1.5 rounded-md hover:bg-[#EFEFEE] transition-colors cursor-pointer ${!sidebarOpen ? 'justify-start pl-1' : ''}`}>
                                <div className={`w-5 h-5 rounded-[3px] bg-gradient-to-br ${workspace.color} flex items-center justify-center text-white text-[10px] font-bold shadow-sm shrink-0`}>{workspace.initial}</div>
                                {sidebarOpen && <><div className="flex-1 overflow-hidden text-sm font-medium truncate text-[#37352f]">{workspace.name}</div><ChevronDown size={12} className="text-zinc-400"/></>}
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-2 space-y-0.5 fancy-scroll">
                            {[{ icon: Search, label: 'Buscar', action: () => setShowSearch(true) }, { icon: SidebarIcon, label: 'Inicio', action: () => { setCurrentView('home'); setActivePageId(null); } }, { icon: Inbox, label: 'Bandeja', action: () => {} }].map((item, i) => (
                                <div key={i} onClick={item.action} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] text-zinc-600 cursor-pointer ${!sidebarOpen ? 'justify-start pl-1' : ''}`}><item.icon size={18} className="shrink-0" />{sidebarOpen && <span className="text-sm font-medium">{item.label}</span>}</div>
                            ))}
                            <div onClick={() => setShowAI(true)} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] text-zinc-600 cursor-pointer ${!sidebarOpen ? 'justify-start pl-1' : ''}`}><Sparkles size={18} className="shrink-0 text-yellow-600" /> {sidebarOpen && <span className="text-sm font-medium">IA Notion</span>}</div>
                            {isAiGeneratingBackground && <div className="mx-2 mt-2 mb-2 p-2 bg-white border border-zinc-200 rounded-md shadow-sm flex items-center gap-3 animate-pulse"><Loader2 size={16} className="animate-spin text-indigo-500"/>{sidebarOpen && <span className="text-xs text-zinc-500 font-medium">Generando...</span>}</div>}
                            <div className="mt-6 mb-1 px-2 flex justify-between items-center group/header">{sidebarOpen && <span className="text-xs font-semibold text-zinc-500">PRIVADO</span>}{sidebarOpen && <button onClick={(e) => { e.stopPropagation(); createPage(); }} className="text-zinc-400 hover:text-zinc-600 opacity-0 group-hover/header:opacity-100 transition-opacity"><Plus size={14}/></button>}</div>
                            {workspace.pages.map(page => (
                                <div key={page.id} onClick={() => { setActivePageId(page.id); setCurrentView('page'); }} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] cursor-pointer group ${!sidebarOpen ? 'justify-start pl-1' : ''} ${activePageId === page.id ? 'bg-[#EFEFEE] font-medium text-zinc-900' : 'text-zinc-600'}`}><span className="text-lg leading-none w-4 text-center shrink-0">{page.icon || <FileText size={16} />}</span>{sidebarOpen && <span className="text-sm truncate opacity-90">{page.title || 'Sin t√≠tulo'}</span>}</div>
                            ))}
                        </div>
                        <div className="p-2 border-t border-[#E9E9E8] space-y-0.5">
                            <div onClick={() => { setCurrentView('settings'); setSettingsTab('menu'); }} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] text-zinc-600 cursor-pointer ${!sidebarOpen ? 'justify-start pl-1' : ''}`}><Settings size={18} className="shrink-0" /> {sidebarOpen && <span className="text-sm">Configuraci√≥n</span>}</div>
                            <div onClick={() => { setShowMarket(true); setMarketTab('galer√≠a'); }} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] text-zinc-600 cursor-pointer ${!sidebarOpen ? 'justify-start pl-1' : ''}`}><Palette size={18} className="shrink-0" /> {sidebarOpen && <span className="text-sm">Marketplace</span>}</div>
                            <div onClick={() => setCurrentView('trash')} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] text-zinc-600 cursor-pointer ${!sidebarOpen ? 'justify-start pl-1' : ''}`}><Trash size={18} className="shrink-0" /> {sidebarOpen && <span className="text-sm">Papelera</span>}</div>
                            <div onClick={() => setSidebarOpen(!sidebarOpen)} className={`flex items-center gap-3 p-1.5 rounded-md hover:bg-[#EFEFEE] text-zinc-500 cursor-pointer mt-2 ${!sidebarOpen ? 'justify-start pl-1' : ''}`}><ChevronsLeft size={18} className={`shrink-0 transition-transform ${!sidebarOpen ? "rotate-180" : ""}`} /> {sidebarOpen && <span className="text-sm">Cerrar barra</span>}</div>
                        </div>
                    </motion.aside>

                    <main className="flex-1 h-full overflow-hidden relative flex flex-col bg-white">
                        <header className="h-12 flex items-center justify-between px-4 shrink-0 hover:bg-[#FBFBFA] transition-colors z-10 sticky top-0 bg-white/80 backdrop-blur-sm">
                            <div className="flex items-center gap-2 text-sm text-zinc-600 overflow-hidden w-full">
                                {!sidebarOpen && <button onClick={() => setSidebarOpen(true)} className="p-1 hover:bg-zinc-100 rounded mr-2"><List size={18}/></button>}
                                {currentView === 'home' ? <div className="flex items-center gap-2"><Briefcase size={16}/><span>Inicio</span></div> : currentView === 'settings' ? <div className="flex items-center gap-2"><Settings size={16}/><span>Configuraci√≥n</span></div> : currentView === 'trash' ? <span>Papelera</span> : <div className="flex items-center gap-2 overflow-hidden w-full"><span className="text-lg">{activePage?.icon || <FileText size={16} />}</span><span className="text-zinc-800 truncate font-medium">{activePage?.title || 'Sin t√≠tulo'}</span></div>}
                            </div>
                            {currentView === 'page' && <div className="relative ml-2"><button onClick={() => setShowPageOptions(!showPageOptions)} className="p-1 text-zinc-500 hover:bg-zinc-100 rounded transition-colors"><MoreHorizontal size={20} /></button><AnimatePresence>{showPageOptions && <motion.div initial={{opacity:0, scale:0.95}} animate={{opacity:1, scale:1}} exit={{opacity:0, scale:0.95}} className="absolute right-0 top-8 w-56 bg-white border border-zinc-200 rounded-lg shadow-xl z-50 overflow-hidden py-1"><button onClick={() => { deletePage(activePageId); setShowPageOptions(false); }} className="w-full text-left flex items-center gap-2 px-3 py-1.5 text-red-600 hover:bg-red-50 cursor-pointer text-sm"><Trash size={14}/> Eliminar</button></motion.div>}</AnimatePresence></div>}
                        </header>

                        <div className="flex-1 overflow-y-auto p-0 relative fancy-scroll">
                            {currentView === 'home' && <div className="max-w-4xl mx-auto h-full flex flex-col p-8 md:p-12 text-center"><h1 className="text-3xl font-bold mb-4">Bienvenido, {workspace.name}</h1></div>}
                            
                            {currentView === 'settings' && <div className="max-w-3xl mx-auto py-12 px-6"><h1 className="text-2xl font-bold mb-8">Configuraci√≥n</h1>{/* ... (Settings Code) ... */}</div>}

                            {currentView === 'page' && activePage && (
                                <motion.div key={activePage.id} initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="max-w-3xl mx-auto pb-48">
                                    <div className="group/cover relative w-full h-48 md:h-72 bg-zinc-50 border-b border-zinc-100">
                                        {activePage.cover ? (<img src={activePage.cover} className="w-full h-full object-cover"/>) : (<div className="w-full h-full opacity-0 group-hover/cover:opacity-100 transition-opacity flex items-center justify-center text-sm text-zinc-400 cursor-pointer" onClick={() => { setMarketTab('galer√≠a'); setShowMarket(true); }}>A√±adir portada</div>)}
                                        <button onClick={() => { setMarketTab('galer√≠a'); setShowMarket(true); }} className="absolute bottom-4 right-4 bg-white/80 hover:bg-white text-xs px-2 py-1 rounded shadow-sm text-zinc-600 border border-zinc-200 opacity-0 group-hover/cover:opacity-100 transition-opacity">Cambiar portada</button>
                                    </div>
                                    <div className="px-8 md:px-24">
                                        <div className="relative -mt-10 mb-8 z-10 group/icon"><div onClick={() => setShowIconPicker(!showIconPicker)} className="text-7xl cursor-pointer hover:scale-105 transition-transform inline-block relative">{activePage.icon || 'üìÑ'}</div>{showIconPicker && (<div className="absolute top-full left-0 z-50 bg-white border border-zinc-200 p-3 rounded-xl shadow-xl w-64 grid grid-cols-6 gap-2 h-48 overflow-y-auto mt-2">{ICONS_LIST.map(icon => <div key={icon} onClick={() => { updatePage(activePageId, { icon }); setShowIconPicker(false); }} className="text-xl p-1 hover:bg-zinc-100 rounded cursor-pointer text-center">{icon}</div>)}</div>)}</div>
                                        <input value={activePage.title} onChange={(e) => updatePage(activePage.id, { title: e.target.value })} placeholder="T√≠tulo de la p√°gina" className="w-full text-4xl font-bold text-[#37352f] placeholder:text-zinc-300 border-none outline-none bg-transparent mb-8" />
                                        <div className="space-y-0.5 min-h-[300px]">{activePage.blocks.map((block, index) => (<EditorBlock key={block.id} block={block} index={index} updateBlock={updateBlock} addBlock={addBlock} deleteBlock={deleteBlock} />))}</div>
                                        <div className="h-32 -mx-4 cursor-text mt-4 opacity-0 hover:opacity-100 transition-opacity flex items-start pt-2 px-4 text-zinc-300 text-sm" onClick={() => addBlock(activePage.blocks.length)}>Haz clic para escribir...</div>
                                    </div>
                                </motion.div>
                            )}
                        </div>
                    </main>

                    {/* MODAL MARKETPLACE CON UPLOAD */}
                    <Modal isOpen={showMarket} onClose={() => setShowMarket(false)} title={null} size="max-w-4xl">
                        <div className="flex flex-col h-full bg-[#FBFBFA]">
                            <div className="flex justify-between items-center px-6 pt-6 pb-2">
                                <div className="flex gap-6 text-sm font-medium">
                                    {['Galer√≠a', 'Subir', 'Estilos', 'Fuentes'].map(tab => (
                                        <button key={tab} onClick={() => setMarketTab(tab.toLowerCase())} className={`pb-2 px-1 transition-colors relative ${marketTab === tab.toLowerCase() ? 'text-zinc-900 border-b-2 border-zinc-900' : 'text-zinc-500 hover:text-zinc-800'}`}>{tab}</button>
                                    ))}
                                </div>
                                <button onClick={() => setShowMarket(false)} className="text-zinc-400 hover:text-zinc-600"><X size={20}/></button>
                            </div>
                            <div className="h-px bg-zinc-200 mx-6 mb-6"/>
                            <div className="flex-1 overflow-y-auto px-6 pb-6 min-h-[400px]">
                                {isLoadingMarket ? (<div className="flex flex-col items-center justify-center h-full text-zinc-400 gap-3"><Loader2 className="animate-spin text-zinc-300" size={32}/><span>Conectando...</span></div>) : (
                                    <>
                                        {marketTab === 'galer√≠a' && (<div className="grid grid-cols-2 md:grid-cols-4 gap-4">{Object.values(marketData.covers).flat().map((url, i) => (<div key={i} onClick={() => { updatePage(activePageId, { cover: url }); setShowMarket(false); }} className="h-28 rounded-lg overflow-hidden cursor-pointer hover:ring-2 ring-indigo-500 transition-all shadow-sm group relative"><img src={url} className="w-full h-full object-cover"/><div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-xs font-bold">Usar</div></div>))}</div>)}
                                        
                                        {/* PESTA√ëA SUBIR */}
                                        {marketTab === 'subir' && (
                                            <div className="flex flex-col items-center justify-center h-64 border-2 border-dashed border-zinc-300 rounded-xl bg-zinc-50 hover:bg-zinc-100 transition-colors relative">
                                                {isUploading ? (
                                                    <div className="text-center"><Loader2 className="animate-spin text-indigo-500 mb-2 mx-auto" size={32}/><p className="text-sm text-zinc-500">Subiendo a la nube...</p></div>
                                                ) : (
                                                    <>
                                                        <UploadCloud size={48} className="text-zinc-300 mb-4"/>
                                                        <p className="text-sm font-medium text-zinc-600">Haz clic para subir una imagen</p>
                                                        <p className="text-xs text-zinc-400 mt-1">PNG, JPG, GIF hasta 5MB</p>
                                                        <input type="file" accept="image/*" onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                    </>
                                                )}
                                            </div>
                                        )}

                                        {marketTab === 'estilos' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4">{marketData.styles.map(s => (<div key={s.id} className="bg-white rounded-xl border border-zinc-200 p-4 flex gap-4 hover:shadow-md transition-shadow"><div className={`w-16 h-16 rounded-lg ${s.color || 'bg-zinc-100'} flex items-center justify-center text-2xl font-bold opacity-50`}>Aa</div><div className="flex-1"><div className="font-bold text-zinc-800">{s.name}</div><div className="text-xs text-zinc-500 mb-3">Por {s.author}</div><button onClick={() => importResource(s, 'style')} className="bg-zinc-900 text-white px-3 py-1.5 rounded-md text-xs font-medium hover:bg-black w-full">Obtener</button></div></div>))}</div>)}
                                        {marketTab === 'fuentes' && (<div className="space-y-2">{marketData.fonts.map(f => (<div key={f.id} className="flex justify-between items-center p-3 bg-white border border-zinc-200 rounded-lg"><div><div className="font-bold text-zinc-800">{f.name}</div><div className="text-xs text-zinc-400">Open Source License</div></div><button onClick={() => importResource(f, 'font')} className="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-3 py-1.5 rounded">Instalar</button></div>))}</div>)}
                                    </>
                                )}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>