<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notion Clone V69 - Feature Complete</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { 
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        notion: { hover: '#EFEFEE', select: '#E8F3FF', text: '#37352f', dim: '#9B9A97' }
                    },
                    spacing: { 'sidebar': '15rem', 'sidebar-collapsed': '3.5rem' },
                    boxShadow: {
                        'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>
    
    <!-- Import Maps -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "clsx": "https://esm.sh/clsx@2.0.0",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap');
        
        /* CSS Variables Din√°micas para Temas */
        :root {
            --bg-color: #ffffff;
            --text-color: #37352f;
            --sidebar-bg: #F7F7F5;
            --item-hover: #EFEFEE;
        }
        
        body { background-color: var(--bg-color); color: var(--text-color); -webkit-font-smoothing: antialiased; transition: background-color 0.3s ease, color 0.3s ease; }
        
        .fancy-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .fancy-scroll::-webkit-scrollbar-track { background: transparent; }
        .fancy-scroll::-webkit-scrollbar-thumb { background: rgba(200, 200, 200, 0.4); border-radius: 4px; }
        .fancy-scroll::-webkit-scrollbar-thumb:hover { background: rgba(180, 180, 180, 0.6); }
        
        [contenteditable]:empty:before { content: attr(placeholder); color: #9B9A97; pointer-events: none; display: block; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        
        /* Utility to remove focus rings completely */
        *:focus { outline: none !important; ring: 0 !important; box-shadow: none !important; }
        
        /* Modal Backdrop Blur */
        .modal-backdrop { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(2px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef, useLayoutEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence, useMotionTemplate, useMotionValue } from 'framer-motion';
        import { 
            List, Plus, Trash, Image as ImageIcon, FileText, 
            MoreHorizontal, Search, Settings, GripVertical, 
            ArrowRight, CheckSquare, Sparkles, Sidebar as SidebarIcon,
            X, Github, Palette, Type, Globe, Lock, ChevronDown, Check,
            Users, Inbox, ArrowLeft, SlidersHorizontal, User, Briefcase, Plane, Music,
            Wand2, Loader2, LayoutTemplate, Bell, ChevronsLeft, CreditCard, LogOut,
            ChevronRight, UploadCloud, Command, FolderOpen, Camera, PlusCircle, Download, FileJson,
            Smile, MessageSquare, ImagePlus, Archive, RefreshCcw, CornerDownLeft, Clock
        } from 'lucide-react';
        import { clsx } from 'clsx';
        import { formatDistanceToNow } from 'date-fns';

        // ==========================================
        // 0. GLOBAL CONSTANTS & CONFIG
        // ==========================================
        
        const USE_MOCK_API = true; 

        const API_ENDPOINTS = {
            MARKET: "/api/market",
            AI: "/api/generar-pagina",
            UPLOAD: "/api/upload"
        };

        const ICONS_LIST = ['üìÑ', 'üéµ', 'üöÄ', 'üíº', 'üí°', 'üé®', 'üèà', 'ü™ê', 'üçé', 'üçï', '‚öΩ', 'üöó', 'üê∂', 'üê±', 'üéâ', 'üìö', 'üí∏', 'üè†', '‚ù§Ô∏è', 'üíÄ', 'üî•', '‚ú®'];
        
        const DEFAULT_THEME = {
            id: 'default',
            name: 'Notion Classic',
            author: 'System',
            colors: {
                bg: '#ffffff',
                text: '#37352f',
                sidebar: '#F7F7F5'
            }
        };

        const INITIAL_STATE = {
            workspaces: [{ id: 'ws-demo', name: 'Fixius Workspace', initial: 'F', color: 'from-indigo-500 to-purple-500', email: 'user@example.com', pages: [] }],
            profile: { name: "Usuario Fixius", email: "usuario@ejemplo.com", bio: "Productivity enthusiast.", avatar: null },
            themes: [DEFAULT_THEME]
        };

        // UTILS GLOBALES
        const utils = {
            generateId: () => Math.random().toString(36).substr(2, 9),
            getRandomColor: () => {
                const colors = [
                    'from-indigo-500 to-purple-500', 'from-pink-500 to-rose-500',
                    'from-emerald-500 to-teal-500', 'from-blue-500 to-cyan-500',
                    'from-orange-500 to-amber-500'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            },
            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms))
        };

        // ==========================================
        // 1. FANCY COMPONENTS
        // ==========================================
        function SpotlightCard({ children, className = "", onClick }) {
            const mouseX = useMotionValue(0);
            const mouseY = useMotionValue(0);
            function handleMouseMove({ currentTarget, clientX, clientY }) {
                const { left, top } = currentTarget.getBoundingClientRect();
                mouseX.set(clientX - left);
                mouseY.set(clientY - top);
            }
            return (
                <div className={clsx("group relative border border-zinc-200 bg-white overflow-hidden rounded-xl", className)} onMouseMove={handleMouseMove} onClick={onClick}>
                    <motion.div className="pointer-events-none absolute -inset-px rounded-xl opacity-0 transition duration-300 group-hover:opacity-100" style={{ background: useMotionTemplate`radial-gradient(650px circle at ${mouseX}px ${mouseY}px, rgba(79, 70, 229, 0.1), transparent 80%)` }} />
                    <div className="relative h-full">{children}</div>
                </div>
            );
        }

        const FancyText = ({ text, className }) => {
            const words = text.split(" ");
            return (
                <div className={className}>
                    {words.map((word, i) => (
                        <motion.span key={i} initial={{ opacity: 0, y: 10, filter: "blur(5px)" }} animate={{ opacity: 1, y: 0, filter: "blur(0px)" }} transition={{ duration: 0.4, delay: i * 0.1 }} className="inline-block mr-2">{word}</motion.span>
                    ))}
                </div>
            );
        };

        const FancyTabs = ({ tabs, activeTab, onTabChange }) => (
            <div className="flex space-x-1 border-b border-zinc-200 px-6 pt-2">
                {tabs.map((tab) => (
                    <button key={tab.id} onClick={() => onTabChange(tab.id)} className={clsx("relative px-4 py-2 text-sm font-medium transition-colors outline-none", activeTab === tab.id ? "text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>
                        {activeTab === tab.id && <motion.div layoutId="active-pill" className="absolute inset-0 border-b-2 border-zinc-900" transition={{ type: "spring", bounce: 0.2, duration: 0.6 }} />}
                        <span className="relative z-10">{tab.label}</span>
                    </button>
                ))}
            </div>
        );

        // ==========================================
        // 2. PAGE COMPONENTS (Comments & Controls)
        // ==========================================
        const PageHeaderControls = ({ page, onUpdate, onToggleComments }) => {
            return (
                <div className="flex items-center gap-1 text-xs text-zinc-400 font-medium mb-4 select-none animate-in fade-in duration-300">
                    {!page.icon && (
                        <button onClick={() => onUpdate({ icon: 'üìÑ' })} className="flex items-center gap-1.5 hover:bg-zinc-100 px-2 py-1 rounded transition-colors hover:text-zinc-600">
                            <Smile size={14}/> Agregar icono
                        </button>
                    )}
                    {!page.cover && (
                        <button onClick={() => onUpdate({ cover: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=900&q=80' })} className="flex items-center gap-1.5 hover:bg-zinc-100 px-2 py-1 rounded transition-colors hover:text-zinc-600">
                            <ImagePlus size={14}/> Agregar portada
                        </button>
                    )}
                    <button onClick={onToggleComments} className="flex items-center gap-1.5 hover:bg-zinc-100 px-2 py-1 rounded transition-colors hover:text-zinc-600">
                        <MessageSquare size={14}/> {page.comments?.length > 0 ? `Comentarios (${page.comments.length})` : 'Agregar comentario'}
                    </button>
                </div>
            );
        };

        const CommentSection = ({ comments, onAddComment, userAvatar, userName }) => {
            const [text, setText] = useState("");
            const handleSubmit = (e) => {
                if (e.key === 'Enter' && !e.shiftKey && text.trim()) { e.preventDefault(); onAddComment(text); setText(""); }
            };
            return (
                <div className="mb-8 border-t border-zinc-100 pt-4 animate-in slide-in-from-top-2 fade-in">
                    {comments && comments.length > 0 && (
                        <div className="space-y-4 mb-4">
                            {comments.map(c => (
                                <div key={c.id} className="flex gap-3 text-sm group">
                                    <div className="w-8 h-8 rounded-full bg-zinc-100 flex-shrink-0 overflow-hidden">
                                        {c.avatar ? <img src={c.avatar} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-xs font-bold text-zinc-400">{c.author ? c.author[0] : 'U'}</div>}
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-0.5">
                                            <span className="font-semibold text-zinc-800">{c.author}</span>
                                            <span className="text-xs text-zinc-400">{c.createdAt ? formatDistanceToNow(new Date(c.createdAt)) : 'just now'} ago</span>
                                        </div>
                                        <div className="text-zinc-700">{c.text}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    <div className="flex gap-3 items-center">
                        <div className="w-6 h-6 rounded-full bg-zinc-100 flex-shrink-0 overflow-hidden">
                            {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover"/> : <User size={14} className="m-1 text-zinc-400"/>}
                        </div>
                        <div className="flex-1 relative">
                            <input value={text} onChange={e => setText(e.target.value)} onKeyDown={handleSubmit} placeholder="A√±adir un comentario..." className="w-full bg-transparent text-sm placeholder:text-zinc-400 outline-none py-1" />
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 3. BASE COMPONENTS (Modal, Toast, Editor)
        // ==========================================
        const Modal = ({ isOpen, onClose, children, title, size = "max-w-2xl", transparent = false }) => (
            <AnimatePresence>
                {isOpen && (
                    <>
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose} className="fixed inset-0 modal-backdrop z-[60]" />
                        <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} transition={{ type: "spring", bounce: 0.3, duration: 0.5 }} className={clsx("fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] overflow-hidden flex flex-col text-zinc-800 rounded-xl shadow-modal bg-white border border-zinc-200", size, transparent ? '!bg-transparent !shadow-none !border-none' : '')}>
                            {title !== null && !transparent && (<div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0 bg-white"><h2 className="text-sm font-semibold text-zinc-700">{title}</h2><button onClick={onClose} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18}/></button></div>)}
                            <div className={clsx("flex-1 overflow-y-auto", !transparent && "bg-white/50")}>{children}</div>
                        </motion.div>
                    </>
                )}
            </AnimatePresence>
        );

        const Notification = ({ message, isVisible, onClose }) => (
            <AnimatePresence>
                {isVisible && (
                    <motion.div initial={{ opacity: 0, y: 20, scale: 0.9 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: 20, scale: 0.9 }} className="fixed bottom-6 right-6 bg-zinc-900 text-white py-3 px-4 rounded-lg shadow-2xl flex items-center gap-3 z-[100] max-w-xs md:max-w-sm cursor-pointer border border-white/10 hover:bg-black transition-all" onClick={onClose}>
                        <div className="bg-green-500/20 p-1 rounded-full text-green-400"><Check size={14}/></div>
                        <div className="flex-1 text-sm font-medium">{message}</div>
                    </motion.div>
                )}
            </AnimatePresence>
        );

        const FancyEditable = ({ tagName: Tag, html, className, onChange, onKeyDown, placeholder, disabled, autoFocus }) => {
            const contentEditableRef = useRef(null);
            useEffect(() => { if (autoFocus && contentEditableRef.current) contentEditableRef.current.focus(); }, [autoFocus]);
            useLayoutEffect(() => { if (contentEditableRef.current && contentEditableRef.current.innerText !== html) contentEditableRef.current.innerText = html; }, [html]);
            return <Tag ref={contentEditableRef} className={clsx(className, "empty:before:content-[attr(placeholder)] empty:before:text-zinc-300 outline-none")} contentEditable={!disabled} suppressContentEditableWarning onInput={(e) => onChange && onChange(e.currentTarget.innerText)} onKeyDown={onKeyDown} placeholder={placeholder} />;
        };

        const EditorBlock = ({ block, index, actions }) => {
            const handleKeyDown = (e) => { 
                if (e.key === 'Enter') { e.preventDefault(); actions.addBlock(index + 1); } 
                else if (e.key === 'Backspace' && (!block.content)) { e.preventDefault(); actions.deleteBlock(index); } 
            };
            const handleChange = (val) => {
                if (block.type === 'p') {
                    const shortcuts = { '# ': 'h1', '## ': 'h2', '### ': 'h3', '- ': 'bullet', '[] ': 'todo' };
                    if (shortcuts[val]) { actions.updateBlock(block.id, { type: shortcuts[val], content: '' }); return; }
                }
                actions.updateBlock(block.id, { content: val });
            };
            return (
                <motion.div layout initial={{opacity: 0, x: -10}} animate={{opacity: 1, x: 0}} className="group relative flex items-start pl-2 md:pl-6 mb-1 py-0.5">
                    <div className="absolute left-0 top-1.5 p-0.5 text-zinc-300 opacity-0 group-hover:opacity-100 cursor-grab active:cursor-grabbing hover:text-zinc-500 transition-opacity touch-none"><GripVertical size={16} /></div>
                    <div className="w-full">
                        {block.type === 'h1' && <FancyEditable tagName="h1" html={block.content} className="text-3xl font-bold text-zinc-800 mb-2 mt-6" placeholder="Encabezado 1" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h2' && <FancyEditable tagName="h2" html={block.content} className="text-2xl font-semibold text-zinc-800 mb-1 mt-4" placeholder="Encabezado 2" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h3' && <FancyEditable tagName="h3" html={block.content} className="text-xl font-semibold text-zinc-800 mb-1 mt-3" placeholder="Encabezado 3" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'p' && <FancyEditable tagName="p" html={block.content} className="text-base text-zinc-700 leading-relaxed min-h-[1.5rem]" placeholder='Escribe "/" para comandos...' onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'bullet' && (<div className="flex items-start gap-2"><div className="mt-2.5 w-1.5 h-1.5 rounded-full bg-zinc-800 shrink-0"/><FancyEditable tagName="p" html={block.content} className="flex-1 text-base text-zinc-700 leading-relaxed" placeholder="Lista" onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus /></div>)}
                        {block.type === 'todo' && (<div className="flex items-start gap-3"><div onClick={() => actions.updateBlock(block.id, { checked: !block.checked })} className={clsx("mt-1 w-4 h-4 rounded-[3px] border cursor-pointer flex items-center justify-center transition-colors", block.checked ? 'bg-[#2EAADC] border-[#2EAADC]' : 'border-zinc-400 hover:bg-zinc-100')}>{block.checked && <Check size={12} className="text-white" />}</div><FancyEditable tagName="p" html={block.content} className={clsx("flex-1 text-base min-h-[1.5rem] transition-opacity", block.checked ? 'line-through text-zinc-400 opacity-50' : 'text-zinc-700')} placeholder="Tarea por hacer" onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus /></div>)}
                    </div>
                </motion.div>
            );
        };

        // ==========================================
        // 4. STORE & LOGIC
        // ==========================================
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => { try { return JSON.parse(window.localStorage.getItem(key)) || initialValue; } catch { return initialValue; } });
            const setValue = (value) => { const valueToStore = value instanceof Function ? value(storedValue) : value; setStoredValue(valueToStore); window.localStorage.setItem(key, JSON.stringify(valueToStore)); };
            return [storedValue, setValue];
        };

        const useAppStore = () => {
            const [workspaces, setWorkspaces] = useLocalStorage('notion_v69_ws', INITIAL_STATE.workspaces);
            const [userProfile, setUserProfile] = useLocalStorage('notion_v69_profile', INITIAL_STATE.profile);
            const [themes, setThemes] = useLocalStorage('notion_v69_themes', INITIAL_STATE.themes);
            const [activeWorkspaceId, setActiveWorkspaceId] = useLocalStorage('notion_v69_active_id', 'ws-demo');
            const [activePageId, setActivePageId] = useState(null);
            const [activeThemeId, setActiveThemeId] = useLocalStorage('notion_v69_active_theme', 'default');

            const activeWorkspace = useMemo(() => workspaces.find(w => w.id === activeWorkspaceId) || workspaces[0], [workspaces, activeWorkspaceId]);
            const activePage = useMemo(() => activeWorkspace?.pages.find(p => p.id === activePageId), [activeWorkspace, activePageId]);
            
            const activeTheme = useMemo(() => {
                const found = themes.find(t => t.id === activeThemeId);
                return found || DEFAULT_THEME;
            }, [themes, activeThemeId]);

            const actions = {
                setActiveWorkspaceId, setActivePageId, setUserProfile, setActiveThemeId,
                addWorkspace: (name) => { const newWs = { id: utils.generateId(), name, initial: name[0].toUpperCase(), color: utils.getRandomColor(), email: userProfile.email, pages: [] }; setWorkspaces(p => [...p, newWs]); setActiveWorkspaceId(newWs.id); },
                addPage: (data={}) => { 
                    const id = utils.generateId(); 
                    const newPage = { 
                        id, 
                        title: '', 
                        icon: null, 
                        cover: null, 
                        comments: [], 
                        inInbox: data.inInbox || false, 
                        updatedAt: new Date().toISOString(), 
                        blocks: [{id: utils.generateId(), type:'p', content:''}], 
                        ...data 
                    }; 
                    setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: [...w.pages, newPage] } : w)); setActivePageId(id); return id; 
                },
                updatePage: (pid, u) => setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.map(pg => pg.id === pid ? { ...pg, ...u } : pg) } : w)),
                deletePage: (pid) => { setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.filter(pg => pg.id !== pid) } : w)); if(activePageId === pid) setActivePageId(null); },
                updateBlock: (bid, u) => activePage && actions.updatePage(activePageId, { blocks: activePage.blocks.map(b => b.id === bid ? { ...b, ...u } : b) }),
                addBlock: (idx) => activePage && actions.updatePage(activePageId, { blocks: [...activePage.blocks.slice(0,idx), {id: utils.generateId(), type:'p', content:''}, ...activePage.blocks.slice(idx)] }),
                deleteBlock: (idx) => activePage && actions.updatePage(activePageId, { blocks: [...activePage.blocks.slice(0,idx), ...activePage.blocks.slice(idx+1)] }),
                addTheme: (t) => { if(!t.name) return; setThemes(p => { const exists = p.find(ex => ex.id === t.id); return exists ? p.map(ex => ex.id === t.id ? t : ex) : [...p, t]; }); },
                addComment: (text) => {
                    if (!activePage) return;
                    const newComment = { id: utils.generateId(), author: userProfile.name, avatar: userProfile.avatar, text, createdAt: new Date().toISOString() };
                    const currentComments = activePage.comments || [];
                    actions.updatePage(activePageId, { comments: [...currentComments, newComment] });
                }
            };

            // EXPORTAR TODO (incluyendo activeThemeId y utils)
            return { workspaces, userProfile, activeWorkspace, activePage, activePageId, themes, activeTheme, activeThemeId, actions, utils };
        };

        // ==========================================
        // 5. MAIN APP COMPONENT
        // ==========================================
        function App() {
            const { workspaces, userProfile, activeWorkspace, activePage, activePageId, themes, activeTheme, activeThemeId, actions, utils } = useAppStore();
            const [ui, setUi] = useState({ sidebarOpen: true, currentView: 'home', settingsSection: 'account', modals: { search: false, market: false, ai: false, workspaceMenu: false, iconPicker: false, pageOptions: false }, marketTab: 'gallery', notification: { show: false, message: '' } });
            const [showComments, setShowComments] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [aiPrompt, setAiPrompt] = useState("");
            const [isAiGenerating, setIsAiGenerating] = useState(false);
            const [marketData, setMarketData] = useState({ styles: [], fonts: [], covers: [] });
            const [loadingMarket, setLoadingMarket] = useState(false);
            const fileInputRef = useRef(null);
            const [uploadContext, setUploadContext] = useState(null);

            const filteredPages = useMemo(() => {
                if (!activeWorkspace) return [];
                if (!searchQuery.trim()) return activeWorkspace.pages;
                return activeWorkspace.pages.filter(p => p.title.toLowerCase().includes(searchQuery.toLowerCase()));
            }, [searchQuery, activeWorkspace]);

            const inboxPages = useMemo(() => {
                if (!activeWorkspace) return [];
                return activeWorkspace.pages.filter(p => p.inInbox === true);
            }, [activeWorkspace]);

            const showNotify = (msg) => { setUi(p => ({ ...p, notification: { show: true, message: msg } })); setTimeout(() => setUi(p => ({ ...p, notification: { show: false, message: '' } })), 3000); };
            const toggleModal = (n, v) => { setUi(p => ({ ...p, modals: { ...p.modals, [n]: v } })); if(n === 'market' && v && marketData.styles.length === 0) fetchMarketData(); };
            
            // --- ROBUST API FUNCTIONS ---
            const generatePageWithAI = async () => {
                if (!aiPrompt.trim()) return;
                setIsAiGenerating(true);
                const strictPrompt = `Genera un JSON para Notion sobre: "${aiPrompt}". Estructura: {"title": "Str", "icon": "Emoji", "cover": "URL", "blocks": [{"type": "h1|p|h2|bullet|todo", "content": "Str"}]}. Solo JSON.`;
                
                try {
                    let data;
                    if (USE_MOCK_API || window.location.hostname.includes("goog")) {
                        await utils.delay(2000);
                        data = {
                            title: `P√°gina: ${aiPrompt}`,
                            icon: "ü§ñ",
                            cover: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=900",
                            blocks: [
                                {type: "h1", content: `Resultado para: ${aiPrompt}`},
                                {type: "p", content: "Contenido generado en modo local (Mock)."},
                                {type: "todo", content: "Validar respuesta"},
                                {type: "todo", content: "Editar bloques"}
                            ]
                        };
                    } else {
                        const res = await fetch(API_ENDPOINTS.AI, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: strictPrompt }) });
                        if (!res.ok) throw new Error("API Error");
                        data = await res.json();
                    }

                    actions.addPage({ 
                        title: data.title || "IA Page", 
                        icon: data.icon || "‚ú®", 
                        cover: data.cover, 
                        inInbox: true,
                        blocks: data.blocks?.map(b => ({ ...b, id: utils.generateId() })) || [] 
                    });
                    
                    toggleModal('ai', false);
                    showNotify("P√°gina creada en Bandeja üì•");
                } catch (e) { 
                    console.error("AI Error:", e);
                    showNotify("Error generando p√°gina");
                } finally { 
                    setIsAiGenerating(false); 
                    setAiPrompt(""); 
                }
            };

            const fetchMarketData = async () => {
                setLoadingMarket(true);
                try {
                    if (USE_MOCK_API || window.location.hostname.includes("goog")) {
                        await utils.delay(1000);
                        setMarketData({
                            styles: [{id: 'local-dark', name: 'Dark Mode Pro', author: 'Mock Dev', colors: { bg: '#1f1f22', text: '#ffffff', sidebar: '#18181b' }}, {id: 'local-sepia', name: 'Sepia Reading', author: 'Mock Dev', colors: { bg: '#f4ecd8', text: '#5b4636', sidebar: '#e9e0c9' }}],
                            fonts: [],
                            covers: ["https://images.unsplash.com/photo-1497436072909-60f360e1d4b0?w=600", "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=600"]
                        });
                    } else {
                        const res = await fetch(API_ENDPOINTS.MARKET);
                        if (!res.ok) throw new Error("Market Error");
                        const data = await res.json();
                        setMarketData(data || { styles: [], fonts: [], covers: [] });
                    }
                } catch (e) { 
                    console.error(e);
                    setMarketData({ styles: [], fonts: [], covers: [] }); 
                }
                finally { setLoadingMarket(false); }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (uploadContext === 'style-json') {
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        try { 
                            const json = JSON.parse(e.target.result);
                            actions.addTheme({ ...json, id: utils.generateId(), source: 'local' }); 
                            showNotify("Tema importado"); 
                            toggleModal('market', false); 
                        } catch { showNotify("JSON inv√°lido"); } 
                    };
                    reader.readAsText(file); 
                    setUploadContext(null); 
                    return;
                }

                showNotify("Subiendo...");
                try {
                    await utils.delay(800);
                    const url = URL.createObjectURL(file);
                    
                    if(uploadContext === 'cover') { actions.updatePage(activePageId, { cover: url }); toggleModal('market', false); }
                    else if(uploadContext === 'avatar') actions.setUserProfile(p => ({ ...p, avatar: url }));
                    
                    showNotify("Subida completada");
                } catch { showNotify("Error al subir"); }
                setUploadContext(null);
            };

            const triggerUpload = (ctx) => { setUploadContext(ctx); if (fileInputRef.current) { fileInputRef.current.value = ''; fileInputRef.current.click(); } };

            const activeThemeStyle = activeTheme ? {
                '--bg-color': activeTheme.colors?.bg || '#ffffff',
                '--text-color': activeTheme.colors?.text || '#37352f',
                '--sidebar-bg': activeTheme.colors?.sidebar || '#F7F7F5'
            } : {};

            if (!activeWorkspace) return null;

            return (
                <div className="flex h-screen w-full font-sans selection:bg-[#cce9ff] relative overflow-hidden transition-colors duration-300" style={activeThemeStyle}>
                    <Notification message={ui.notification.message} isVisible={ui.notification.show} onClose={() => setUi(p => ({...p, notification: {show: false}}))} />
                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept={uploadContext === 'style-json' ? '.json' : 'image/*'} />

                    {/* SIDEBAR */}
                    <motion.aside initial={false} animate={{ width: ui.sidebarOpen ? 240 : 56 }} style={{backgroundColor: 'var(--sidebar-bg)'}} className="h-full flex flex-col z-20 relative border-r border-[#E9E9E8] transition-all duration-300 group/sidebar">
                        <div className="p-3 relative shrink-0">
                            <div onClick={() => toggleModal('workspaceMenu', !ui.modals.workspaceMenu)} className={clsx("flex items-center gap-2 p-1.5 rounded-md hover:bg-[var(--item-hover)] transition-colors cursor-pointer relative z-20 min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}>
                                <div className={`w-5 h-5 rounded-[3px] bg-gradient-to-br ${activeWorkspace.color} flex items-center justify-center text-white text-[10px] font-bold shadow-sm shrink-0`}>{activeWorkspace.initial}</div>
                                {ui.sidebarOpen && <><div className="flex-1 overflow-hidden text-sm font-medium truncate opacity-90">{activeWorkspace.name}</div><ChevronDown size={12} className="opacity-50"/></>}
                            </div>
                            <AnimatePresence>
                                {ui.modals.workspaceMenu && ui.sidebarOpen && (
                                    <>
                                        <div className="fixed inset-0 z-10" onClick={() => toggleModal('workspaceMenu', false)}/>
                                        <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="absolute top-12 left-2 right-2 bg-white border border-zinc-200 rounded-lg shadow-xl z-20 overflow-hidden text-zinc-800">
                                            <div className="p-2 border-b border-zinc-100 bg-zinc-50/50"><span className="text-[10px] font-bold text-zinc-400 uppercase px-2">Espacios</span></div>
                                            <div className="max-h-48 overflow-y-auto">
                                                {workspaces.map(ws => (
                                                    <div key={ws.id} onClick={() => { actions.setActiveWorkspaceId(ws.id); toggleModal('workspaceMenu', false); setUi(p => ({...p, currentView: 'home'})); }} className="flex items-center gap-2 p-2 hover:bg-zinc-100 cursor-pointer text-sm group/ws">
                                                        <div className={`w-5 h-5 rounded-[3px] bg-gradient-to-br ${ws.color} text-white flex items-center justify-center text-[10px]`}>{ws.initial}</div>
                                                        <span className={`flex-1 truncate ${ws.id === activeWorkspaceId ? 'font-medium' : ''}`}>{ws.name}</span>
                                                        {ws.id === activeWorkspaceId && <Check size={14} className="text-indigo-600"/>}
                                                    </div>
                                                ))}
                                            </div>
                                            <div onClick={() => { const n = prompt("Nombre:"); if(n) actions.addWorkspace(n); toggleModal('workspaceMenu', false); }} className="p-2 border-t border-zinc-100 hover:bg-zinc-50 cursor-pointer flex items-center gap-2 text-sm text-zinc-600"><PlusCircle size={14}/> <span>Crear Nuevo</span></div>
                                        </motion.div>
                                    </>
                                )}
                            </AnimatePresence>
                        </div>

                        <div className="flex-1 overflow-y-auto px-2 space-y-0.5 fancy-scroll">
                            {[
                                { icon: Search, label: 'Buscar', action: () => toggleModal('search', true) },
                                { icon: SidebarIcon, label: 'Inicio', action: () => { setUi(p => ({...p, currentView: 'home'})); actions.setActivePageId(null); } },
                                { icon: Inbox, label: 'Bandeja', action: () => { setUi(p => ({...p, currentView: 'inbox'})); actions.setActivePageId(null); } },
                                { icon: Sparkles, label: 'IA Notion', action: () => toggleModal('ai', true), color: 'text-yellow-600' }
                            ].map((item, i) => (
                                <div key={i} onClick={item.action} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}>
                                    <item.icon size={18} className={clsx("shrink-0 opacity-70", item.color)} />
                                    {ui.sidebarOpen && <span className="text-sm font-medium opacity-80">{item.label}</span>}
                                    {item.label === 'Bandeja' && inboxPages.length > 0 && ui.sidebarOpen && (
                                        <div className="bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full ml-auto">{inboxPages.length}</div>
                                    )}
                                </div>
                            ))}
                            <div className="mt-6 mb-1 px-2 flex justify-between items-center group/header">
                                {ui.sidebarOpen && <span className="text-xs font-semibold opacity-50">P√ÅGINAS</span>}
                                {ui.sidebarOpen && <button onClick={(e) => { e.stopPropagation(); const id = actions.addPage(); setUi(p=>({...p, currentView:'page'})); actions.setActivePageId(id); }} className="opacity-0 group-hover/header:opacity-100 transition-opacity p-1 hover:bg-[rgba(0,0,0,0.05)] rounded"><Plus size={14}/></button>}
                            </div>
                            {activeWorkspace.pages.filter(p => !p.inInbox).map(page => (
                                <div key={page.id} onClick={() => { actions.setActivePageId(page.id); setUi(p => ({...p, currentView: 'page'})); }} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer group min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1', activePageId === page.id ? 'bg-[rgba(0,0,0,0.05)] font-medium' : 'opacity-80')}>
                                    <span className="text-lg leading-none w-4 text-center shrink-0">{page.icon || <FileText size={16} />}</span>
                                    {ui.sidebarOpen && <span className="text-sm truncate">{page.title || 'Sin t√≠tulo'}</span>}
                                </div>
                            ))}
                        </div>
                        <div className="p-2 border-t border-[#E9E9E8] space-y-0.5">
                             <div onClick={() => toggleModal('market', true)} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><Palette size={18} className="shrink-0 opacity-70" /> {ui.sidebarOpen && <span className="text-sm opacity-80">Marketplace</span>}</div>
                             <div onClick={() => setUi(p => ({...p, currentView: 'settings'}))} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><Settings size={18} className="shrink-0 opacity-70" /> {ui.sidebarOpen && <span className="text-sm opacity-80">Configuraci√≥n</span>}</div>
                             <div onClick={() => setUi(p => ({...p, sidebarOpen: !p.sidebarOpen}))} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer mt-2 min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><ChevronsLeft size={18} className={`shrink-0 transition-transform opacity-50 ${!ui.sidebarOpen ? "rotate-180" : ""}`} /> {ui.sidebarOpen && <span className="text-sm opacity-60">Cerrar barra</span>}</div>
                        </div>
                    </motion.aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 h-full overflow-hidden relative flex flex-col transition-colors duration-300" style={{ backgroundColor: 'var(--bg-color)', color: 'var(--text-color)' }}>
                        <header className="h-12 flex items-center justify-between px-4 shrink-0 transition-colors z-10 sticky top-0 backdrop-blur-sm" style={{ backgroundColor: 'rgba(255,255,255,0.0)' }}>
                            <div className="flex items-center gap-2 text-sm opacity-60 overflow-hidden w-full">
                                {!ui.sidebarOpen && <button onClick={() => setUi(p => ({...p, sidebarOpen: true}))} className="p-1 hover:bg-[rgba(0,0,0,0.05)] rounded mr-2"><List size={18}/></button>}
                                {ui.currentView === 'home' && <div className="flex items-center gap-2"><Briefcase size={16}/><span>Inicio</span></div>}
                                {ui.currentView === 'inbox' && <div className="flex items-center gap-2"><Inbox size={16}/><span>Bandeja de Entrada</span></div>}
                                {ui.currentView === 'settings' && <div className="flex items-center gap-2"><Settings size={16}/><span>Configuraci√≥n</span></div>}
                                {ui.currentView === 'page' && <div className="flex items-center gap-2 overflow-hidden w-full"><span className="text-lg">{activePage?.icon || <FileText size={16} />}</span><span className="truncate font-medium">{activePage?.title || 'Sin t√≠tulo'}</span></div>}
                            </div>
                            {ui.currentView === 'page' && (
                                <div className="relative ml-2">
                                    <button onClick={() => toggleModal('pageOptions', !ui.modals.pageOptions)} className="p-1 opacity-60 hover:opacity-100 hover:bg-[rgba(0,0,0,0.05)] rounded transition-colors"><MoreHorizontal size={20} /></button>
                                    <AnimatePresence>{ui.modals.pageOptions && <motion.div initial={{opacity:0, scale:0.95}} animate={{opacity:1, scale:1}} exit={{opacity:0, scale:0.95}} className="absolute right-0 top-8 w-56 bg-white border border-zinc-200 rounded-lg shadow-xl z-50 overflow-hidden py-1"><button onClick={() => { actions.deletePage(activePageId); toggleModal('pageOptions', false); setUi(p => ({...p, currentView: 'home'})); }} className="w-full text-left flex items-center gap-2 px-3 py-1.5 text-red-600 hover:bg-red-50 cursor-pointer text-sm"><Trash size={14}/> Eliminar</button></motion.div>}</AnimatePresence>
                                </div>
                            )}
                        </header>

                        <div className="flex-1 overflow-y-auto p-0 relative fancy-scroll">
                            
                            {/* HOME VIEW */}
                            {ui.currentView === 'home' && (
                                <div className="max-w-4xl mx-auto h-full flex flex-col p-8 md:p-12 text-center">
                                    <motion.div initial={{ scale: 0.5, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} transition={{ type: "spring", duration: 0.8 }} className="mb-8 flex justify-center">
                                        <div className="w-24 h-24 rounded-full overflow-hidden border-2 border-zinc-200 shadow-md bg-zinc-100">
                                            {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-3xl font-bold text-zinc-300">{activeWorkspace.initial}</div>}
                                        </div>
                                    </motion.div>
                                    <FancyText text={`Hola, ${userProfile.name}`} className="text-4xl font-bold mb-2 text-current" />
                                    <motion.p initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 }} className="opacity-70">Est√°s en <strong>{activeWorkspace.name}</strong>.</motion.p>
                                </div>
                            )}

                            {/* INBOX VIEW */}
                            {ui.currentView === 'inbox' && (
                                <div className="max-w-3xl mx-auto py-12 px-6">
                                    <h1 className="text-2xl font-bold mb-8 text-current flex items-center gap-2"><Inbox size={24}/> Bandeja de Entrada</h1>
                                    {inboxPages.length === 0 ? (
                                        <div className="text-center py-12 opacity-50">
                                            <div className="mb-2 text-4xl">üì≠</div>
                                            No tienes p√°ginas nuevas.
                                        </div>
                                    ) : (
                                        <div className="grid gap-4">
                                            {inboxPages.map(page => (
                                                <SpotlightCard key={page.id} className="p-4 flex items-center justify-between cursor-pointer" onClick={() => { actions.setActivePageId(page.id); setUi(p => ({...p, currentView: 'page'})); }}>
                                                    <div className="flex items-center gap-4">
                                                        <div className="text-2xl">{page.icon}</div>
                                                        <div>
                                                            <div className="font-bold text-zinc-800">{page.title}</div>
                                                            <div className="text-xs text-zinc-500">Generado {formatDistanceToNow(new Date(page.updatedAt))} ago</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={(e) => { e.stopPropagation(); actions.updatePage(page.id, { inInbox: false }); showNotify("Movido a p√°ginas"); }} className="p-2 hover:bg-zinc-100 rounded-full text-zinc-400 hover:text-zinc-600" title="Mover a p√°ginas"><Archive size={16}/></button>
                                                    </div>
                                                </SpotlightCard>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* SETTINGS VIEW */}
                            {ui.currentView === 'settings' && (
                                <div className="flex h-full">
                                    {/* Sidebar de Configuraci√≥n */}
                                    <div className="w-48 bg-[var(--sidebar-bg)] border-r border-[rgba(0,0,0,0.05)] pt-8 px-2 space-y-1">
                                        <div className="px-3 py-2 text-xs font-bold opacity-50 uppercase mb-2">Cuenta</div>
                                        <button onClick={() => setUi(p => ({...p, settingsSection: 'account'}))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'account' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Mi Perfil</button>
                                        <button onClick={() => setUi(p => ({...p, settingsSection: 'themes'}))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'themes' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Temas & Apariencia</button>
                                    </div>

                                    {/* Contenido de Configuraci√≥n */}
                                    <div className="flex-1 overflow-y-auto px-12 py-12">
                                        {ui.settingsSection === 'account' && (
                                            <div className="max-w-2xl animate-in fade-in duration-300">
                                                <h1 className="text-xl font-bold mb-6 pb-2 border-b border-[rgba(0,0,0,0.1)]">Mi Perfil</h1>
                                                <div className="flex items-start gap-6 mb-8">
                                                    <div onClick={() => triggerUpload('avatar')} className="w-24 h-24 bg-zinc-100 rounded-full flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity overflow-hidden border border-zinc-200 shrink-0">
                                                        {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover"/> : <Camera size={32} className="text-zinc-300"/>}
                                                    </div>
                                                    <div className="flex-1 space-y-4">
                                                        <div>
                                                            <label className="text-xs font-bold opacity-50 uppercase block mb-1">Nombre preferido</label>
                                                            <input value={userProfile.name} onChange={e => actions.setUserProfile(p => ({...p, name: e.target.value}))} className="w-full p-2 border border-zinc-200 rounded text-sm outline-none focus:border-zinc-400 bg-transparent transition-colors"/>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold opacity-50 uppercase block mb-1">Correo electr√≥nico</label>
                                                            <input value={userProfile.email} disabled className="w-full p-2 border border-zinc-200 rounded text-sm bg-[rgba(0,0,0,0.02)] opacity-60 cursor-not-allowed"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {ui.settingsSection === 'themes' && (
                                            <div className="max-w-2xl animate-in fade-in duration-300">
                                                <h1 className="text-xl font-bold mb-6 pb-2 border-b border-[rgba(0,0,0,0.1)]">Apariencia</h1>
                                                <p className="text-sm opacity-60 mb-6">Personaliza la est√©tica de tu espacio de trabajo. Los temas instalados desde el Marketplace aparecer√°n aqu√≠.</p>
                                                
                                                <div className="space-y-3">
                                                    {/* DEFAULT THEME */}
                                                    <div className="p-4 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-12 h-12 bg-white border border-zinc-200 rounded-md flex items-center justify-center text-lg font-serif">Aa</div>
                                                            <div>
                                                                <div className="font-bold text-sm text-zinc-900">Notion Classic</div>
                                                                <div className="text-xs text-zinc-500">Tema original (Claro)</div>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => actions.setActiveThemeId('default')} 
                                                            disabled={activeThemeId === 'default'}
                                                            className={clsx("px-3 py-1.5 rounded text-xs transition-colors", activeThemeId === 'default' ? "bg-green-100 text-green-700 cursor-default font-medium" : "bg-zinc-900 text-white hover:bg-black")}
                                                        >
                                                            {activeThemeId === 'default' ? "Activo" : "Aplicar"}
                                                        </button>
                                                    </div>

                                                    {/* INSTALLED THEMES */}
                                                    {themes.filter(t => t.id !== 'default').map(t => (
                                                        <div key={t.id} className="p-4 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-12 h-12 rounded-md flex items-center justify-center text-lg font-bold text-white shadow-inner" style={{backgroundColor: t.colors?.bg || '#333', color: t.colors?.text || '#fff'}}>Aa</div>
                                                                <div>
                                                                    <div className="font-bold text-sm text-zinc-900">{t.name}</div>
                                                                    <div className="text-xs text-zinc-500">Por {t.author}</div>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={() => { setThemes(prev => prev.filter(item => item.id !== t.id)); if(activeThemeId === t.id) actions.setActiveThemeId('default'); }} className="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash size={14}/></button>
                                                                <button 
                                                                    onClick={() => actions.setActiveThemeId(t.id)} 
                                                                    disabled={activeThemeId === t.id}
                                                                    className={clsx("px-3 py-1.5 rounded text-xs transition-colors", activeThemeId === t.id ? "bg-green-100 text-green-700 cursor-default font-medium" : "bg-zinc-900 text-white hover:bg-black")}
                                                                >
                                                                    {activeThemeId === t.id ? "Activo" : "Aplicar"}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* EDITOR */}
                            {ui.currentView === 'page' && activePage && (
                                <motion.div key={activePage.id} initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="max-w-3xl mx-auto pb-48">
                                    <div className={clsx("group/cover relative w-full border-b border-zinc-100 transition-all", activePage.cover ? "h-48 md:h-72" : "h-0")}>
                                        {activePage.cover && <img src={activePage.cover} className="w-full h-full object-cover"/>}
                                        {activePage.cover && <button onClick={() => toggleModal('market', true)} className="absolute bottom-4 right-4 bg-white/80 hover:bg-white text-xs px-2 py-1 rounded shadow-sm text-zinc-600 border border-zinc-200 opacity-0 group-hover/cover:opacity-100 transition-opacity">Cambiar portada</button>}
                                    </div>

                                    <div className="px-8 md:px-24 pt-8">
                                        {activePage.icon && (
                                            <div className="relative -mt-16 mb-4 z-10 group/icon">
                                                <div onClick={() => toggleModal('iconPicker', !ui.modals.iconPicker)} className="text-7xl cursor-pointer hover:scale-105 transition-transform inline-block relative drop-shadow-sm">{activePage.icon}</div>
                                                {ui.modals.iconPicker && (<div className="absolute top-full left-0 z-50 bg-white border border-zinc-200 p-3 rounded-xl shadow-xl w-64 grid grid-cols-6 gap-2 h-48 overflow-y-auto mt-2">{ICONS_LIST.map(icon => (<div key={icon} onClick={() => { actions.updatePage(activePageId, { icon }); toggleModal('iconPicker', false); }} className="text-xl p-1 hover:bg-zinc-100 rounded cursor-pointer text-center">{icon}</div>))}</div>)}
                                            </div>
                                        )}

                                        <PageHeaderControls page={activePage} onUpdate={(u) => actions.updatePage(activePageId, u)} onToggleComments={() => setShowComments(!showComments)} />

                                        {showComments && (
                                            <CommentSection comments={activePage.comments} onAddComment={(text) => actions.addComment(text)} userAvatar={userProfile.avatar} userName={userProfile.name} />
                                        )}

                                        <input value={activePage.title} onChange={(e) => actions.updatePage(activePage.id, { title: e.target.value })} placeholder="T√≠tulo de la p√°gina" className="w-full text-4xl font-bold placeholder:opacity-50 border-none outline-none bg-transparent mb-8 text-current" />
                                        
                                        <div className="space-y-0.5 min-h-[300px]">{activePage.blocks.map((block, index) => (<EditorBlock key={block.id} block={block} index={index} actions={actions}/>))}</div>
                                        <div className="h-32 -mx-4 cursor-text mt-4 opacity-0 hover:opacity-100 transition-opacity flex items-start pt-2 px-4 text-zinc-300 text-sm" onClick={() => actions.addBlock(activePage.blocks.length)}>Haz clic para escribir...</div>
                                    </div>
                                </motion.div>
                            )}
                        </div>
                    </main>

                    {/* MODALS */}
                    <Modal isOpen={ui.modals.search} onClose={() => toggleModal('search', false)} title={null}>
                        <div className="p-4 border-b border-zinc-100 bg-[#FBFBFA]">
                            <div className="flex items-center gap-3 bg-white px-3 py-3 rounded-lg border border-zinc-200 shadow-sm"><Search className="text-zinc-400" size={18} /><input autoFocus value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Busca en tus p√°ginas..." className="bg-transparent w-full outline-none text-base placeholder:text-zinc-400 text-zinc-700" /></div>
                        </div>
                        <div className="p-2 min-h-[300px]">
                            {filteredPages.length > 0 ? filteredPages.map(p => (<div key={p.id} onClick={() => { actions.setActivePageId(p.id); setUi(prev => ({...prev, currentView: 'page', modals: {...prev.modals, search: false}})); }} className="flex items-center gap-3 p-2 hover:bg-zinc-100 rounded cursor-pointer group"><div className="text-xl">{p.icon || 'üìÑ'}</div><div className="flex-1"><div className="text-sm font-medium text-zinc-800">{p.title || 'Sin t√≠tulo'}</div><div className="text-xs text-zinc-400">En {activeWorkspace.name}</div></div><ArrowRight size={14} className="text-zinc-300 opacity-0 group-hover:opacity-100"/></div>)) : <div className="text-center text-zinc-400 mt-12 text-sm">No se encontraron resultados</div>}
                        </div>
                    </Modal>

                    {/* AI MODAL */}
                    <Modal isOpen={ui.modals.ai} onClose={() => toggleModal('ai', false)} title={null} transparent={true}>
                        <div className="flex items-center justify-center h-full p-4">
                            <motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-zinc-200">
                                <div className="p-6 bg-gradient-to-br from-indigo-50 to-white">
                                    <h2 className="text-lg font-bold text-zinc-800 mb-2 flex items-center gap-2"><Sparkles size={18} className="text-indigo-500"/> Notion AI</h2>
                                    <p className="text-sm text-zinc-500 mb-4">Describe lo que necesitas. La p√°gina se generar√° en segundo plano.</p>
                                    <textarea autoFocus value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Ej: Rutina de gimnasio para 3 d√≠as..." className="w-full bg-white border border-zinc-200 rounded-xl p-4 h-32 resize-none no-ring focus:border-zinc-400 transition-colors mb-4 text-zinc-700 text-sm"/>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => toggleModal('ai', false)} className="px-4 py-2 rounded-lg text-zinc-500 hover:bg-zinc-100 text-sm font-medium">Cancelar</button>
                                        <button onClick={generatePageWithAI} disabled={isAiGenerating} className="px-4 py-2 rounded-lg bg-zinc-900 text-white font-medium text-sm hover:bg-black transition-colors disabled:opacity-50 flex items-center gap-2">
                                            {isAiGenerating ? <Loader2 className="animate-spin" size={16}/> : <Wand2 size={16}/>} Generar
                                        </button>
                                    </div>
                                </div>
                            </motion.div>
                        </div>
                    </Modal>

                    <Modal isOpen={ui.modals.market} onClose={() => toggleModal('market', false)} title="Marketplace">
                         <FancyTabs tabs={[{id: 'gallery', label: 'Galer√≠a'}, {id: 'styles', label: 'Estilos & Temas'}, {id: 'fonts', label: 'Fuentes'}]} activeTab={ui.marketTab} onTabChange={(id) => setUi(p=>({...p, marketTab: id}))} />
                         <div className="p-6 min-h-[400px]">
                            {loadingMarket ? <div className="flex items-center justify-center h-48"><Loader2 className="animate-spin text-zinc-400"/></div> : (
                                <>
                                    {ui.marketTab === 'gallery' && (
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            <SpotlightCard onClick={() => triggerUpload('cover')} className="h-28 flex flex-col items-center justify-center text-zinc-400 bg-zinc-50 gap-2 cursor-pointer">
                                                <UploadCloud size={20}/> <span className="text-xs font-bold">Subir Propia</span>
                                            </SpotlightCard>
                                            {(marketData.covers.length > 0 ? marketData.covers : ["https://images.unsplash.com/photo-1497436072909-60f360e1d4b0?w=600", "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=600"]).map((url, i) => (
                                                <SpotlightCard key={i} onClick={() => { actions.updatePage(activePageId, { cover: url }); toggleModal('market', false); }} className="h-28 cursor-pointer">
                                                    <img src={url} className="w-full h-full object-cover"/>
                                                    <div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-xs font-bold">Usar</div>
                                                </SpotlightCard>
                                            ))}
                                        </div>
                                    )}
                                    {ui.marketTab === 'styles' && (
                                        <div className="space-y-4">
                                            <div className="flex justify-end">
                                                <button onClick={() => triggerUpload('style-json')} className="flex items-center gap-2 text-xs bg-zinc-100 hover:bg-zinc-200 px-3 py-2 rounded-md font-medium text-zinc-700"><FileJson size={14}/> Cargar JSON Local</button>
                                            </div>
                                            {marketData.styles.length === 0 ? <div className="text-center text-zinc-400 py-10">No se encontraron estilos en el repositorio remoto.</div> : (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    {marketData.styles.map(style => {
                                                        const isInstalled = themes.some(t => t.id === style.id || t.name === style.name);
                                                        return (
                                                            <SpotlightCard key={style.id} className="p-4 flex justify-between items-center bg-white">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-10 h-10 rounded bg-gradient-to-br from-zinc-100 to-zinc-200 flex items-center justify-center font-serif font-bold text-zinc-400">Aa</div>
                                                                    <div><div className="font-bold text-sm text-zinc-800">{style.name}</div><div className="text-xs text-zinc-500">Remoto</div></div>
                                                                </div>
                                                                {isInstalled ? (
                                                                    <span className="text-xs font-bold text-zinc-300 bg-zinc-50 px-3 py-1.5 rounded cursor-default border border-zinc-100">Instalado</span>
                                                                ) : (
                                                                    <button onClick={() => { actions.addTheme({ ...style }); showNotify("Tema instalado"); }} className="flex items-center gap-1 bg-zinc-900 text-white text-xs px-3 py-1.5 rounded hover:bg-black"><Download size={12}/> Obtener</button>
                                                                )}
                                                            </SpotlightCard>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                         </div>
                    </Modal>

                </div>
            );
        }

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>