<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notion Clone V78 - External CSS</title>

    <!-- ENLACE AL TEMA POR DEFECTO (SOLICITADO) -->
    <link rel="stylesheet" href="stylessApp/default-theme.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        notion: { hover: '#EFEFEE', select: '#E8F3FF', text: '#37352f', dim: '#9B9A97' }
                    },
                    spacing: { 'sidebar': '15rem', 'sidebar-collapsed': '3.5rem' },
                    boxShadow: {
                        'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>

    <!-- Import Maps -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "clsx": "https://esm.sh/clsx@2.0.0",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef, useLayoutEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence, useMotionTemplate, useMotionValue } from 'framer-motion';
        import {
            List, Plus, Trash, Image as ImageIcon, FileText,
            MoreHorizontal, Search, Settings, GripVertical,
            ArrowRight, CheckSquare, Sparkles, Sidebar as SidebarIcon,
            X, Github, Palette, Type, Globe, Lock, ChevronDown, Check,
            Users, Inbox, ArrowLeft, SlidersHorizontal, User, Briefcase, Plane, Music,
            Wand2, Loader2, LayoutTemplate, Bell, ChevronsLeft, CreditCard, LogOut,
            ChevronRight, UploadCloud, Command, FolderOpen, Camera, PlusCircle, Download, FileJson,
            Smile, MessageSquare, ImagePlus, Archive, RefreshCcw, CornerDownLeft, Clock,
            LayoutGrid, Package, Undo2, Filter, Quote, Minus, Info, ListOrdered
        } from 'lucide-react';
        import { clsx } from 'clsx';
        import { formatDistanceToNow } from 'date-fns';

        // ==========================================
        // 0. GLOBAL CONSTANTS & CONFIG
        // ==========================================

        const USE_MOCK_API = false;

        const API_ENDPOINTS = {
            MARKET: "/api/market",
            AI: "/api/generar-pagina",
            UPLOAD: "/api/upload"
        };

        const ICONS_LIST = ['üìÑ', 'üéµ', 'üöÄ', 'üíº', 'üí°', 'üé®', 'üèà', 'ü™ê', 'üçé', 'üçï', '‚öΩ', 'üöó', 'üê∂', 'üê±', 'üéâ', 'üìö', 'üí∏', 'üè†', '‚ù§Ô∏è', 'üíÄ', 'üî•', '‚ú®'];

        // DEFAULT THEME: "stylessApp" (Coincide con tu estructura de carpetas)
        const DEFAULT_THEME = {
            id: 'default',
            name: 'stylessApp',
            author: 'System (Default)',
            colors: {
                bg: '#ffffff',
                text: '#37352f',
                sidebar: '#F7F7F5'
            }
        };

        const INITIAL_STATE = {
            workspaces: [{ id: 'ws-demo', name: 'Fixius Workspace', initial: 'F', color: 'from-indigo-500 to-purple-500', email: 'user@example.com', pages: [] }],
            profile: { name: "Usuario Fixius", email: "usuario@ejemplo.com", bio: "Productivity enthusiast.", avatar: null },
            themes: [DEFAULT_THEME],
            fonts: []
        };

        const utils = {
            generateId: () => Math.random().toString(36).substr(2, 9),
            getRandomColor: () => {
                const colors = ['from-indigo-500 to-purple-500', 'from-pink-500 to-rose-500', 'from-emerald-500 to-teal-500', 'from-blue-500 to-cyan-500', 'from-orange-500 to-amber-500'];
                return colors[Math.floor(Math.random() * colors.length)];
            },
            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms))
        };

        // ==========================================
        // 1. FANCY COMPONENTS
        // ==========================================
        function SpotlightCard({ children, className = "", onClick }) {
            const mouseX = useMotionValue(0);
            const mouseY = useMotionValue(0);
            function handleMouseMove({ currentTarget, clientX, clientY }) {
                const { left, top } = currentTarget.getBoundingClientRect();
                mouseX.set(clientX - left);
                mouseY.set(clientY - top);
            }
            return (
                <div className={clsx("group relative border border-zinc-200 bg-white overflow-hidden rounded-xl", className)} onMouseMove={handleMouseMove} onClick={onClick}>
                    <motion.div className="pointer-events-none absolute -inset-px rounded-xl opacity-0 transition duration-300 group-hover:opacity-100" style={{ background: useMotionTemplate`radial-gradient(650px circle at ${mouseX}px ${mouseY}px, rgba(79, 70, 229, 0.1), transparent 80%)` }} />
                    <div className="relative h-full">{children}</div>
                </div>
            );
        }

        const FancyText = ({ text, className }) => {
            const words = text.split(" ");
            return (
                <div className={className}>
                    {words.map((word, i) => (<motion.span key={i} initial={{ opacity: 0, y: 10, filter: "blur(5px)" }} animate={{ opacity: 1, y: 0, filter: "blur(0px)" }} transition={{ duration: 0.4, delay: i * 0.1 }} className="inline-block mr-2">{word}</motion.span>))}
                </div>
            );
        };

        const FancyTabs = ({ tabs, activeTab, onTabChange }) => (
            <div className="flex space-x-1 border-b border-zinc-200 px-6 pt-2">
                {tabs.map((tab) => (
                    <button key={tab.id} onClick={() => onTabChange(tab.id)} className={clsx("relative px-4 py-2 text-sm font-medium transition-colors outline-none", activeTab === tab.id ? "text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>
                        {activeTab === tab.id && <motion.div layoutId="active-pill" className="absolute inset-0 border-b-2 border-zinc-900" transition={{ type: "spring", bounce: 0.2, duration: 0.6 }} />}
                        <span className="relative z-10">{tab.label}</span>
                    </button>
                ))}
            </div>
        );

        // ==========================================
        // 2. PAGE COMPONENTS
        // ==========================================
        const PageHeaderControls = ({ page, onUpdate, onToggleComments, onOpenIconPicker, onOpenCoverPicker }) => {
            return (
                <div className="flex items-center gap-1 text-xs text-zinc-400 font-medium mb-4 select-none animate-in fade-in duration-300">
                    {!page.icon && <button onClick={onOpenIconPicker} className="flex items-center gap-1.5 hover:bg-zinc-100 px-2 py-1 rounded transition-colors hover:text-zinc-600"><Smile size={14} /> Agregar icono</button>}
                    {!page.cover && <button onClick={onOpenCoverPicker} className="flex items-center gap-1.5 hover:bg-zinc-100 px-2 py-1 rounded transition-colors hover:text-zinc-600"><ImagePlus size={14} /> Agregar portada</button>}
                    <button onClick={onToggleComments} className="flex items-center gap-1.5 hover:bg-zinc-100 px-2 py-1 rounded transition-colors hover:text-zinc-600"><MessageSquare size={14} /> {page.comments?.length > 0 ? `Comentarios (${page.comments.length})` : 'Agregar comentario'}</button>
                </div>
            );
        };

        const CommentSection = ({ comments, onAddComment, userAvatar }) => {
            const [text, setText] = useState("");
            const handleSubmit = (e) => { if (e.key === 'Enter' && !e.shiftKey && text.trim()) { e.preventDefault(); onAddComment(text); setText(""); } };
            return (
                <div className="mb-8 border-t border-zinc-100 pt-4 animate-in slide-in-from-top-2 fade-in">
                    {comments && comments.length > 0 && (<div className="space-y-4 mb-4">{comments.map(c => (<div key={c.id} className="flex gap-3 text-sm group"><div className="w-8 h-8 rounded-full bg-zinc-100 flex-shrink-0 overflow-hidden">{c.avatar ? <img src={c.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-xs font-bold text-zinc-400">{c.author ? c.author[0] : 'U'}</div>}</div><div className="flex-1"><div className="flex items-center gap-2 mb-0.5"><span className="font-semibold text-zinc-800">{c.author}</span><span className="text-xs text-zinc-400">{c.createdAt ? formatDistanceToNow(new Date(c.createdAt)) : 'just now'} ago</span></div><div className="text-zinc-700">{c.text}</div></div></div>))}</div>)}
                    <div className="flex gap-3 items-center"><div className="w-6 h-6 rounded-full bg-zinc-100 flex-shrink-0 overflow-hidden">{userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <User size={14} className="m-1 text-zinc-400" />}</div><div className="flex-1 relative"><input value={text} onChange={e => setText(e.target.value)} onKeyDown={handleSubmit} placeholder="A√±adir un comentario..." className="w-full bg-transparent text-sm placeholder:text-zinc-400 outline-none py-1" /></div></div>
                </div>
            );
        };

        // ==========================================
        // 3. BASE COMPONENTS
        // ==========================================
        const Modal = ({ isOpen, onClose, children, title, size = "max-w-2xl", transparent = false }) => (
            <AnimatePresence>
                {isOpen && (
                    <>
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose} className="fixed inset-0 modal-backdrop z-[60]" />
                        <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} transition={{ type: "spring", bounce: 0.3, duration: 0.5 }} className={clsx("fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] overflow-hidden flex flex-col text-zinc-800 rounded-xl shadow-modal bg-white border border-zinc-200", size, transparent ? '!bg-transparent !shadow-none !border-none' : '')}>
                            {title !== null && !transparent && (<div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0 bg-white"><h2 className="text-sm font-semibold text-zinc-700">{title}</h2><button onClick={onClose} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18} /></button></div>)}
                            <div className={clsx("flex-1 overflow-y-auto", !transparent && "bg-white/50")}>{children}</div>
                        </motion.div>
                    </>
                )}
            </AnimatePresence>
        );

        const Notification = ({ message, isVisible, onClose }) => (
            <AnimatePresence>
                {isVisible && (<motion.div initial={{ opacity: 0, y: 20, scale: 0.9 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: 20, scale: 0.9 }} className="fixed bottom-6 right-6 bg-zinc-900 text-white py-3 px-4 rounded-lg shadow-2xl flex items-center gap-3 z-[100] max-w-xs md:max-w-sm cursor-pointer border border-white/10 hover:bg-black transition-all" onClick={onClose}><div className="bg-green-500/20 p-1 rounded-full text-green-400"><Check size={14} /></div><div className="flex-1 text-sm font-medium">{message}</div></motion.div>)}
            </AnimatePresence>
        );

        const FancyEditable = ({ tagName: Tag, html, className, onChange, onKeyDown, placeholder, disabled, autoFocus }) => {
            const contentEditableRef = useRef(null);
            useEffect(() => { if (autoFocus && contentEditableRef.current) contentEditableRef.current.focus(); }, [autoFocus]);
            useLayoutEffect(() => { if (contentEditableRef.current && contentEditableRef.current.innerText !== html) contentEditableRef.current.innerText = html; }, [html]);
            return <Tag ref={contentEditableRef} className={clsx(className, "empty:before:content-[attr(placeholder)] empty:before:text-zinc-300 outline-none")} contentEditable={!disabled} suppressContentEditableWarning onInput={(e) => onChange && onChange(e.currentTarget.innerText)} onKeyDown={onKeyDown} placeholder={placeholder} />;
        };

        const SlashMenu = ({ query, onSelect, onClose }) => {
            const items = [
                { id: 'p', label: 'Texto', icon: <FileText size={16} />, desc: 'Empieza a escribir' },
                { id: 'h1', label: 'Encabezado 1', icon: <Type size={18} />, desc: 'T√≠tulo grande' },
                { id: 'h2', label: 'Encabezado 2', icon: <Type size={16} />, desc: 'T√≠tulo mediano' },
                { id: 'h3', label: 'Encabezado 3', icon: <Type size={14} />, desc: 'T√≠tulo peque√±o' },
                { id: 'bullet', label: 'Lista con vi√±etas', icon: <List size={16} />, desc: 'Lista simple' },
                { id: 'todo', label: 'Lista de tareas', icon: <CheckSquare size={16} />, desc: 'Tareas pendientes' },
                { id: 'quote', label: 'Cita', icon: <Quote size={16} />, desc: 'Captura una cita' },
                { id: 'divider', label: 'Divisor', icon: <Minus size={16} />, desc: 'Separa visualmente' },
                { id: 'callout', label: 'Destacado', icon: <Info size={16} />, desc: 'Resalta informaci√≥n' },
            ];

            const filtered = items.filter(i => i.label.toLowerCase().includes(query.toLowerCase()));
            const [selectedIndex, setSelectedIndex] = useState(0);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowDown') { e.preventDefault(); setSelectedIndex(prev => (prev + 1) % filtered.length); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); setSelectedIndex(prev => (prev - 1 + filtered.length) % filtered.length); }
                    else if (e.key === 'Enter') { e.preventDefault(); onSelect(filtered[selectedIndex].id); }
                    else if (e.key === 'Escape') { onClose(); }
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [filtered, selectedIndex, onSelect, onClose]);

            if (filtered.length === 0) return null;

            return (
                <motion.div initial={{ opacity: 0, y: 10, scale: 0.95 }} animate={{ opacity: 1, y: 0, scale: 1 }} className="absolute top-full left-0 z-50 w-72 bg-white rounded-lg shadow-xl border border-zinc-200 overflow-hidden mt-2 max-h-80 overflow-y-auto">
                    <div className="p-1.5 space-y-0.5">
                        <div className="text-xs font-bold text-zinc-400 px-2 py-1 uppercase">Bloques b√°sicos</div>
                        {filtered.map((item, i) => (
                            <div key={item.id} onClick={() => onSelect(item.id)} className={clsx("flex items-center gap-3 px-2 py-1.5 rounded cursor-pointer transition-colors", i === selectedIndex ? "bg-zinc-100" : "hover:bg-zinc-50")}>
                                <div className="w-10 h-10 rounded border border-zinc-200 bg-white flex items-center justify-center text-zinc-600 shrink-0 shadow-sm">{item.icon}</div>
                                <div>
                                    <div className="text-sm font-medium text-zinc-800">{item.label}</div>
                                    <div className="text-xs text-zinc-400">{item.desc}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </motion.div>
            );
        };

        const EditorBlock = ({ block, index, actions }) => {
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (['bullet', 'todo'].includes(block.type)) {
                        if (!block.content) {
                            if ((block.level || 0) > 0) {
                                actions.updateBlock(block.id, { level: (block.level || 0) - 1 });
                            } else {
                                actions.updateBlock(block.id, { type: 'p' });
                            }
                        } else {
                            actions.addBlock(index + 1, { type: block.type, level: block.level || 0 });
                        }
                    } else {
                        actions.addBlock(index + 1);
                    }
                } else if (e.key === 'Backspace' && (!block.content)) {
                    e.preventDefault();
                    if ((block.level || 0) > 0) {
                        actions.updateBlock(block.id, { level: (block.level || 0) - 1 });
                    } else {
                        actions.deleteBlock(index);
                    }
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    const currentLevel = block.level || 0;
                    if (e.shiftKey) {
                        actions.updateBlock(block.id, { level: Math.max(0, currentLevel - 1) });
                    } else {
                        actions.updateBlock(block.id, { level: Math.min(3, currentLevel + 1) });
                    }
                }
            };

            const handleChange = (val) => {
                if (block.type === 'p') {
                    const shortcuts = { '# ': 'h1', '## ': 'h2', '### ': 'h3', '- ': 'bullet', '[] ': 'todo' };
                    if (shortcuts[val]) { actions.updateBlock(block.id, { type: shortcuts[val], content: '' }); return; }
                }
                actions.updateBlock(block.id, { content: val });
            };

            const showSlashMenu = block.type === 'p' && block.content.startsWith('/');
            const slashQuery = showSlashMenu ? block.content.substring(1) : '';

            return (
                <motion.div layout initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} className="group relative flex items-start pl-2 md:pl-6 mb-1 py-0.5">
                    <div className="absolute left-0 top-1.5 p-0.5 text-zinc-300 opacity-0 group-hover:opacity-100 cursor-grab active:cursor-grabbing hover:text-zinc-500 transition-opacity touch-none"><GripVertical size={16} /></div>
                    <div className="w-full relative">
                        {showSlashMenu && (
                            <SlashMenu
                                query={slashQuery}
                                onSelect={(type) => actions.updateBlock(block.id, { type, content: '' })}
                                onClose={() => { }}
                            />
                        )}
                        {block.type === 'h1' && <FancyEditable tagName="h1" html={block.content} className="text-3xl font-bold text-zinc-800 mb-2 mt-6" placeholder="Encabezado 1" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h2' && <FancyEditable tagName="h2" html={block.content} className="text-2xl font-semibold text-zinc-800 mb-1 mt-4" placeholder="Encabezado 2" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h3' && <FancyEditable tagName="h3" html={block.content} className="text-xl font-semibold text-zinc-800 mb-1 mt-3" placeholder="Encabezado 3" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'p' && <FancyEditable tagName="p" html={block.content} className="text-base text-zinc-700 leading-relaxed min-h-[1.5rem]" placeholder='Escribe "/" para comandos...' onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'bullet' && (
                            <div className="flex items-start gap-2" style={{ marginLeft: (block.level || 0) * 24 + 'px' }}>
                                <div className={clsx("mt-2.5 shrink-0 transition-all",
                                    (block.level || 0) % 3 === 0 ? "w-1.5 h-1.5 rounded-full bg-zinc-800" :
                                        (block.level || 0) % 3 === 1 ? "w-1.5 h-1.5 rounded-full border border-zinc-800 bg-transparent" :
                                            "w-1.5 h-1.5 bg-zinc-800"
                                )} />
                                <FancyEditable tagName="p" html={block.content} className="flex-1 text-base text-zinc-700 leading-relaxed" placeholder="Lista" onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus />
                            </div>
                        )}
                        {block.type === 'todo' && (
                            <div className="flex items-start gap-3" style={{ marginLeft: (block.level || 0) * 24 + 'px' }}>
                                <div onClick={() => actions.updateBlock(block.id, { checked: !block.checked })} className={clsx("mt-1 w-4 h-4 rounded-[3px] border cursor-pointer flex items-center justify-center transition-colors", block.checked ? 'bg-[#2EAADC] border-[#2EAADC]' : 'border-zinc-400 hover:bg-zinc-100')}>{block.checked && <Check size={12} className="text-white" />}</div>
                                <FancyEditable tagName="p" html={block.content} className={clsx("flex-1 text-base min-h-[1.5rem] transition-opacity", block.checked ? 'line-through text-zinc-400 opacity-50' : 'text-zinc-700')} placeholder="Tarea por hacer" onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus />
                            </div>
                        )}
                        {block.type === 'quote' && (<div className="flex items-start gap-3 pl-4 border-l-4 border-zinc-900 my-2"><FancyEditable tagName="p" html={block.content} className="text-lg italic text-zinc-700" placeholder="Cita..." onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus /></div>)}
                        {block.type === 'divider' && (<div className="py-4"><div className="h-px bg-zinc-200 w-full" /></div>)}
                        {block.type === 'callout' && (<div className="p-4 bg-zinc-50 rounded-lg flex gap-3 border border-zinc-200 my-2"><Info size={20} className="text-zinc-500 shrink-0" /><FancyEditable tagName="p" html={block.content} className="text-base text-zinc-800" placeholder="Destacado..." onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus /></div>)}
                    </div>
                </motion.div>
            );
        };

        // ==========================================
        // 4. STORE & LOGIC
        // ==========================================
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => { try { return JSON.parse(window.localStorage.getItem(key)) || initialValue; } catch { return initialValue; } });
            const setValue = (value) => { const valueToStore = value instanceof Function ? value(storedValue) : value; setStoredValue(valueToStore); window.localStorage.setItem(key, JSON.stringify(valueToStore)); };
            return [storedValue, setValue];
        };

        const useAppStore = () => {
            const [workspaces, setWorkspaces] = useLocalStorage('notion_v78_ws', INITIAL_STATE.workspaces);
            const [userProfile, setUserProfile] = useLocalStorage('notion_v78_profile', INITIAL_STATE.profile);
            const [themes, setThemes] = useLocalStorage('notion_v78_themes', INITIAL_STATE.themes);
            const [fonts, setFonts] = useLocalStorage('notion_v78_fonts', INITIAL_STATE.fonts);
            const [activeWorkspaceId, setActiveWorkspaceId] = useLocalStorage('notion_v78_active_id', 'ws-demo');
            const [activePageId, setActivePageId] = useState(null);
            const [activeThemeId, setActiveThemeId] = useLocalStorage('notion_v78_active_theme', 'default');

            const activeWorkspace = useMemo(() => workspaces.find(w => w.id === activeWorkspaceId) || workspaces[0], [workspaces, activeWorkspaceId]);
            const activePage = useMemo(() => activeWorkspace?.pages.find(p => p.id === activePageId), [activeWorkspace, activePageId]);

            const activeTheme = useMemo(() => {
                const found = themes.find(t => t.id === activeThemeId);
                return found || DEFAULT_THEME;
            }, [themes, activeThemeId]);

            const actions = {
                setActiveWorkspaceId, setActivePageId, setUserProfile, setActiveThemeId,
                addWorkspace: (name) => { const newWs = { id: utils.generateId(), name, initial: name[0].toUpperCase(), color: utils.getRandomColor(), email: userProfile.email, pages: [] }; setWorkspaces(p => [...p, newWs]); setActiveWorkspaceId(newWs.id); },

                addPage: (data = {}) => {
                    const id = utils.generateId();
                    const newPage = {
                        id,
                        title: '',
                        icon: null,
                        cover: null,
                        comments: [],
                        inInbox: data.inInbox || false,
                        isDeleted: false,
                        deletedAt: null,
                        updatedAt: new Date().toISOString(),
                        blocks: [{ id: utils.generateId(), type: 'p', content: '' }],
                        ...data
                    };
                    setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: [...w.pages, newPage] } : w));
                    setActivePageId(id);
                    return id;
                },

                updatePage: (pid, u) => setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.map(pg => pg.id === pid ? { ...pg, ...u } : pg) } : w)),
                deletePage: (pid) => {
                    setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.map(pg => pg.id === pid ? { ...pg, isDeleted: true, deletedAt: new Date().toISOString() } : pg) } : w));
                    if (activePageId === pid) setActivePageId(null);
                },
                restorePage: (pid) => {
                    setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.map(pg => pg.id === pid ? { ...pg, isDeleted: false, deletedAt: null } : pg) } : w));
                },
                permanentDeletePage: (pid) => {
                    setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.filter(pg => pg.id !== pid) } : w));
                },
                updateBlock: (bid, u) => activePage && actions.updatePage(activePageId, { blocks: activePage.blocks.map(b => b.id === bid ? { ...b, ...u } : b) }),
                addBlock: (idx, initialData = {}) => activePage && actions.updatePage(activePageId, { blocks: [...activePage.blocks.slice(0, idx), { id: utils.generateId(), type: 'p', content: '', ...initialData }, ...activePage.blocks.slice(idx)] }),
                deleteBlock: (idx) => activePage && actions.updatePage(activePageId, { blocks: [...activePage.blocks.slice(0, idx), ...activePage.blocks.slice(idx + 1)] }),

                addTheme: (t) => {
                    if (!t.name) return;
                    setThemes(p => { const exists = p.find(ex => ex.id === t.id); if (exists) return p.map(ex => ex.id === t.id ? t : ex); return [...p, t]; });
                },
                removeTheme: (themeId) => {
                    if (themeId === 'default') return;
                    setThemes(p => p.filter(t => t.id !== themeId));
                    if (activeThemeId === themeId) setActiveThemeId('default');
                },
                addFont: (f) => { if (!f.name) return; setFonts(p => { const exists = p.find(ex => ex.id === f.id); if (exists) return p; return [...p, f]; }); },
                removeFont: (fontId) => { setFonts(p => p.filter(f => f.id !== fontId)); },

                addComment: (text) => {
                    if (!activePage) return;
                    const newComment = { id: utils.generateId(), author: userProfile.name, avatar: userProfile.avatar, text, createdAt: new Date().toISOString() };
                    const currentComments = activePage.comments || [];
                    actions.updatePage(activePageId, { comments: [...currentComments, newComment] });
                }
            };

            return { workspaces, userProfile, activeWorkspace, activeWorkspaceId, activePage, activePageId, themes, activeTheme, activeThemeId, fonts, actions, utils };
        };

        // ==========================================
        // 5. MAIN APP COMPONENT
        // ==========================================
        const App = () => {
            const { workspaces, userProfile, activeWorkspace, activeWorkspaceId, activePage, activePageId, themes, activeTheme, activeThemeId, fonts, actions, utils } = useAppStore();
            const [ui, setUi] = useState({
                currentView: 'home', // home, page, settings, trash
                sidebarCollapsed: false,
                settingsSection: 'account',
                marketTab: 'gallery',
                marketSubTab: 'store',
                modals: { search: false, ai: false, market: false, createWorkspace: false, iconPicker: false }
            });
            const [searchQuery, setSearchQuery] = useState("");
            const [aiPrompt, setAiPrompt] = useState("");
            const [isAiGenerating, setIsAiGenerating] = useState(false);
            const [showComments, setShowComments] = useState(false);
            const [newWorkspaceName, setNewWorkspaceName] = useState("");
            const [marketData, setMarketData] = useState({ covers: [], styles: [], fonts: [] });
            const [loadingMarket, setLoadingMarket] = useState(false);

            // Derived state
            const filteredPages = useMemo(() => {
                if (!activeWorkspace) return [];
                if (!searchQuery) return activeWorkspace.pages.filter(p => !p.isDeleted);
                return activeWorkspace.pages.filter(p => !p.isDeleted && p.title.toLowerCase().includes(searchQuery.toLowerCase()));
            }, [activeWorkspace, searchQuery]);

            const trashPages = useMemo(() => activeWorkspace ? activeWorkspace.pages.filter(p => p.isDeleted) : [], [activeWorkspace]);

            // Effects
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); toggleModal('search', true); }
                    if ((e.metaKey || e.ctrlKey) && e.key === '\\') { e.preventDefault(); setUi(p => ({ ...p, sidebarCollapsed: !p.sidebarCollapsed })); }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            useEffect(() => {
                // Apply theme
                const root = document.documentElement;
                if (activeTheme.colors) {
                    root.style.setProperty('--bg-color', activeTheme.colors.bg);
                    root.style.setProperty('--text-color', activeTheme.colors.text);
                    root.style.setProperty('--sidebar-bg', activeTheme.colors.sidebar);
                }
                // Apply font
                // (Simplified for this demo)
            }, [activeTheme]);

            const toggleModal = (name, value) => setUi(p => ({ ...p, modals: { ...p.modals, [name]: value } }));

            const handleCreateWorkspace = () => {
                if (!newWorkspaceName.trim()) return;
                actions.addWorkspace(newWorkspaceName);
                setNewWorkspaceName("");
                toggleModal('createWorkspace', false);
            };

            const generatePageWithAI = async () => {
                if (!aiPrompt.trim()) return;
                setIsAiGenerating(true);
                await utils.delay(1500); // Mock delay
                const id = actions.addPage({
                    title: "Plan Generado por AI",
                    icon: "ü§ñ",
                    blocks: [
                        { id: utils.generateId(), type: 'h1', content: 'Plan Personalizado' },
                        { id: utils.generateId(), type: 'p', content: `Aqu√≠ tienes una propuesta basada en: "${aiPrompt}"` },
                        { id: utils.generateId(), type: 'bullet', content: 'Paso 1: An√°lisis inicial' },
                        { id: utils.generateId(), type: 'bullet', content: 'Paso 2: Ejecuci√≥n estrat√©gica' },
                        { id: utils.generateId(), type: 'todo', content: 'Revisar resultados' }
                    ]
                });
                setIsAiGenerating(false);
                setAiPrompt("");
                toggleModal('ai', false);
                actions.setActivePageId(id);
                setUi(p => ({ ...p, currentView: 'page' }));
            };

            const triggerUpload = (type) => {
                // Mock upload
                showNotify("Simulando subida de archivo...");
                setTimeout(() => showNotify("Archivo subido con √©xito"), 1000);
            };

            const [notification, setNotification] = useState({ show: false, message: '' });
            const showNotify = (msg) => {
                setNotification({ show: true, message: msg });
                setTimeout(() => setNotification({ show: false, message: '' }), 3000);
            };

            return (
                <div className={clsx("flex h-screen text-[var(--text-color)] bg-[var(--bg-color)] transition-colors duration-300 font-sans selection:bg-notion-select selection:text-notion-text", activeTheme.id === 'dark' ? 'dark' : '')}>
                    <Notification message={notification.message} isVisible={notification.show} onClose={() => setNotification({ ...notification, show: false })} />

                    {/* SIDEBAR */}
                    <motion.aside
                        initial={false}
                        animate={{ width: ui.sidebarCollapsed ? 0 : 240, opacity: ui.sidebarCollapsed ? 0 : 1 }}
                        className="flex-shrink-0 bg-[var(--sidebar-bg)] border-r border-zinc-200 flex flex-col overflow-hidden relative group/sidebar"
                    >
                        <div className="p-3 flex items-center gap-2 hover:bg-zinc-200/50 m-2 rounded-md cursor-pointer transition-colors" onClick={() => toggleModal('createWorkspace', true)}>
                            <div className={clsx("w-5 h-5 rounded flex items-center justify-center text-xs font-bold text-white shadow-sm", `bg-gradient-to-br ${activeWorkspace.color}`)}>
                                {activeWorkspace.initial}
                            </div>
                            <div className="font-medium text-sm truncate flex-1">{activeWorkspace.name}</div>
                            <ChevronsLeft size={14} className="text-zinc-400 opacity-0 group-hover/sidebar:opacity-100 cursor-pointer hover:text-zinc-600" onClick={(e) => { e.stopPropagation(); setUi(p => ({ ...p, sidebarCollapsed: true })); }} />
                        </div>

                        <div className="flex-1 overflow-y-auto px-2 space-y-0.5">
                            <div onClick={() => setUi(p => ({ ...p, currentView: 'home' }))} className={clsx("flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer", ui.currentView === 'home' ? "bg-zinc-200/50 font-medium text-zinc-900" : "text-zinc-600 hover:bg-zinc-100")}>
                                <LayoutGrid size={16} /> <span>Inicio</span>
                            </div>
                            <div onClick={() => toggleModal('search', true)} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer text-zinc-600 hover:bg-zinc-100">
                                <Search size={16} /> <span>Buscar</span>
                            </div>
                            <div onClick={() => toggleModal('ai', true)} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer text-zinc-600 hover:bg-zinc-100 group">
                                <Sparkles size={16} className="text-indigo-500 group-hover:animate-pulse" /> <span>Notion AI</span>
                            </div>
                            <div onClick={() => setUi(p => ({ ...p, currentView: 'settings' }))} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer text-zinc-600 hover:bg-zinc-100">
                                <Settings size={16} /> <span>Configuraci√≥n</span>
                            </div>

                            <div className="mt-6 mb-2 px-3 text-xs font-bold text-zinc-400 uppercase flex justify-between group">
                                <span>Privado</span>
                                <Plus size={14} className="cursor-pointer hover:text-zinc-600 opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => { const id = actions.addPage(); actions.setActivePageId(id); setUi(p => ({ ...p, currentView: 'page' })); }} />
                            </div>
                            {activeWorkspace.pages.filter(p => !p.isDeleted && !p.inInbox).map(page => (
                                <div key={page.id} onClick={() => { actions.setActivePageId(page.id); setUi(p => ({ ...p, currentView: 'page' })); }} className={clsx("group flex items-center gap-2 px-3 py-1 rounded-md text-sm cursor-pointer min-h-[28px]", activePageId === page.id && ui.currentView === 'page' ? "bg-zinc-200/50 font-medium text-zinc-900" : "text-zinc-600 hover:bg-zinc-100")}>
                                    <span className="text-lg leading-none">{page.icon || <FileText size={16} />}</span>
                                    <span className="truncate flex-1">{page.title || "Sin t√≠tulo"}</span>
                                    <div className="opacity-0 group-hover:opacity-100 flex items-center gap-1">
                                        <button onClick={(e) => { e.stopPropagation(); actions.deletePage(page.id); }} className="p-0.5 hover:bg-zinc-300 rounded text-zinc-500"><Trash size={12} /></button>
                                    </div>
                                </div>
                            ))}

                            <div className="mt-6 mb-2 px-3 text-xs font-bold text-zinc-400 uppercase">Herramientas</div>
                            <div onClick={() => setUi(p => ({ ...p, currentView: 'trash' }))} className={clsx("flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer", ui.currentView === 'trash' ? "bg-zinc-200/50 font-medium text-zinc-900" : "text-zinc-600 hover:bg-zinc-100")}>
                                <Trash size={16} /> <span>Papelera</span>
                            </div>
                        </div>
                    </motion.aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 h-full overflow-y-auto relative bg-white">
                        {!ui.sidebarCollapsed && (
                            <div className="absolute top-4 left-4 z-20 md:hidden">
                                <button onClick={() => setUi(p => ({ ...p, sidebarCollapsed: true }))}><ChevronsLeft size={20} /></button>
                            </div>
                        )}
                        {ui.sidebarCollapsed && (
                            <div className="absolute top-4 left-4 z-20">
                                <button onClick={() => setUi(p => ({ ...p, sidebarCollapsed: false }))} className="p-1 hover:bg-zinc-100 rounded"><SidebarIcon size={20} className="text-zinc-400" /></button>
                            </div>
                        )}

                        <div className="max-w-full mx-auto min-h-full">
                            {ui.currentView === 'home' && (
                                <div className="max-w-5xl mx-auto py-12 px-6">
                                    <div className="mb-8 flex items-center gap-4">
                                        <div className="w-16 h-16 rounded-full overflow-hidden border border-zinc-200 shadow-sm bg-zinc-100">
                                            {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-2xl font-bold text-zinc-300">{activeWorkspace.initial}</div>}
                                        </div>
                                        <div>
                                            <h1 className="text-3xl font-bold text-zinc-800">Hola, {userProfile.name}</h1>
                                            <p className="text-zinc-500">Bienvenido a {activeWorkspace.name}</p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {activeWorkspace.pages.filter(p => !p.isDeleted).map(page => (
                                            <div key={page.id} onClick={() => { actions.setActivePageId(page.id); setUi(p => ({ ...p, currentView: 'page' })); }} className="group relative bg-white border border-zinc-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer h-48 flex flex-col">
                                                {page.cover ? (
                                                    <div className="h-24 w-full relative shrink-0">
                                                        <img src={page.cover} className="w-full h-full object-cover" />
                                                        {page.icon && <div className="absolute -bottom-4 left-4 text-3xl drop-shadow-sm">{page.icon}</div>}
                                                    </div>
                                                ) : (
                                                    <div className="h-12 w-full bg-zinc-50 shrink-0 relative">
                                                        {page.icon && <div className="absolute -bottom-4 left-4 text-3xl">{page.icon}</div>}
                                                    </div>
                                                )}

                                                <div className={clsx("p-4 flex-1 flex flex-col", page.cover ? "pt-6" : "pt-6")}>
                                                    <h3 className="font-bold text-zinc-800 truncate mb-1">{page.title || 'Sin t√≠tulo'}</h3>
                                                    <p className="text-xs text-zinc-400">Editado {formatDistanceToNow(new Date(page.updatedAt))} ago</p>
                                                </div>
                                            </div>
                                        ))}
                                        <div onClick={() => { const id = actions.addPage(); actions.setActivePageId(id); setUi(p => ({ ...p, currentView: 'page' })); }} className="border-2 border-dashed border-zinc-200 rounded-xl flex flex-col items-center justify-center text-zinc-400 hover:text-zinc-600 hover:border-zinc-300 hover:bg-zinc-50 transition-all cursor-pointer h-48">
                                            <Plus size={32} className="mb-2" />
                                            <span className="font-medium">Nueva p√°gina</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {ui.currentView === 'trash' && (
                                <div className="max-w-3xl mx-auto py-12 px-6">
                                    <h1 className="text-2xl font-bold mb-8 text-current flex items-center gap-2"><Trash size={24} /> Papelera</h1>
                                    <p className="text-sm opacity-60 mb-6">Las p√°ginas aqu√≠ pueden ser restauradas o eliminadas para siempre.</p>
                                    {trashPages.length === 0 ? <div className="text-center py-12 opacity-50"><div className="mb-2 text-4xl">üóëÔ∏è</div>Papelera vac√≠a.</div> : (
                                        <div className="grid gap-3">{trashPages.map(page => (<div key={page.id} className="p-3 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm"><div className="flex items-center gap-3 opacity-60"><div className="text-lg">{page.icon || <FileText size={16} />}</div><div><div className="font-medium text-sm text-zinc-900">{page.title || 'Sin t√≠tulo'}</div><div className="text-xs text-zinc-500">Borrado {formatDistanceToNow(new Date(page.deletedAt))} ago</div></div></div><div className="flex gap-2"><button onClick={() => { actions.restorePage(page.id); showNotify("P√°gina restaurada"); }} className="flex items-center gap-1 bg-zinc-100 text-zinc-700 text-xs px-3 py-1.5 rounded hover:bg-zinc-200"><Undo2 size={12} /> Restaurar</button><button onClick={() => { if (confirm("¬øBorrar definitivamente?")) actions.permanentDeletePage(page.id); }} className="p-1.5 text-red-400 hover:bg-red-50 rounded"><Trash size={14} /></button></div></div>))}</div>
                                    )}
                                </div>
                            )}

                            {ui.currentView === 'settings' && (
                                <div className="flex h-full">
                                    <div className="w-48 bg-[var(--sidebar-bg)] border-r border-[rgba(0,0,0,0.05)] pt-8 px-2 space-y-1"><div className="px-3 py-2 text-xs font-bold opacity-50 uppercase mb-2">Cuenta</div><button onClick={() => setUi(p => ({ ...p, settingsSection: 'account' }))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'account' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Mi Perfil</button><button onClick={() => setUi(p => ({ ...p, settingsSection: 'themes' }))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'themes' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Temas & Apariencia</button></div>
                                    <div className="flex-1 overflow-y-auto px-12 py-12">
                                        {ui.settingsSection === 'account' && (<div className="max-w-2xl animate-in fade-in duration-300"><h1 className="text-xl font-bold mb-6 pb-2 border-b border-[rgba(0,0,0,0.1)]">Mi Perfil</h1><div className="flex items-start gap-6 mb-8"><div onClick={() => triggerUpload('avatar')} className="w-24 h-24 bg-zinc-100 rounded-full flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity overflow-hidden border border-zinc-200 shrink-0">{userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : <Camera size={32} className="text-zinc-300" />}</div><div className="flex-1 space-y-4"><div><label className="text-xs font-bold opacity-50 uppercase block mb-1">Nombre preferido</label><input value={userProfile.name} onChange={e => actions.setUserProfile(p => ({ ...p, name: e.target.value }))} className="w-full p-2 border border-zinc-200 rounded text-sm outline-none focus:border-zinc-400 bg-transparent transition-colors" /></div><div><label className="text-xs font-bold opacity-50 uppercase block mb-1">Correo electr√≥nico</label><input value={userProfile.email} disabled className="w-full p-2 border border-zinc-200 rounded text-sm bg-[rgba(0,0,0,0.02)] opacity-60 cursor-not-allowed" /></div></div></div></div>)}
                                        {ui.settingsSection === 'themes' && (
                                            <div className="max-w-2xl animate-in fade-in duration-300">
                                                <h1 className="text-xl font-bold mb-6 pb-2 border-b border-[rgba(0,0,0,0.1)]">Apariencia</h1>
                                                <div className="space-y-3">
                                                    <div className="p-4 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm"><div className="flex items-center gap-3"><div className="w-12 h-12 bg-white border border-zinc-200 rounded-md flex items-center justify-center text-lg font-serif">Aa</div><div><div className="font-bold text-sm text-zinc-900">stylessApp (Default)</div><div className="text-xs text-zinc-500">Tema original (Claro)</div></div></div><button onClick={() => actions.setActiveThemeId('default')} disabled={activeThemeId === 'default'} className={clsx("px-3 py-1.5 rounded text-xs transition-colors", activeThemeId === 'default' ? "bg-green-100 text-green-700 cursor-default font-medium" : "bg-zinc-900 text-white hover:bg-black")}>{activeThemeId === 'default' ? "Activo" : "Aplicar"}</button></div>
                                                    {themes.filter(t => t.id !== 'default').map(t => (<div key={t.id} className="p-4 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm"><div className="flex items-center gap-3"><div className="w-12 h-12 rounded-md flex items-center justify-center text-lg font-bold text-white shadow-inner" style={{ backgroundColor: t.colors?.bg || '#333', color: t.colors?.text || '#fff' }}>Aa</div><div><div className="font-bold text-sm text-zinc-900">{t.name}</div><div className="text-xs text-zinc-500">Por {t.author}</div></div></div><div className="flex gap-2"><button onClick={() => { actions.removeTheme(t.id); showNotify("Tema eliminado"); }} className="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash size={14} /></button><button onClick={() => actions.setActiveThemeId(t.id)} disabled={activeThemeId === t.id} className={clsx("px-3 py-1.5 rounded text-xs transition-colors", activeThemeId === t.id ? "bg-green-100 text-green-700 cursor-default font-medium" : "bg-zinc-900 text-white hover:bg-black")}>{activeThemeId === t.id ? "Activo" : "Aplicar"}</button></div></div>))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {ui.currentView === 'page' && activePage && (
                                <motion.div key={activePage.id} initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="max-w-3xl mx-auto pb-48">
                                    <div className={clsx("group/cover relative w-full border-b border-zinc-100 transition-all", activePage.cover ? "h-48 md:h-72" : "h-0")}>
                                        {activePage.cover && <img src={activePage.cover} className="w-full h-full object-cover" />}
                                        {activePage.cover && <button onClick={() => toggleModal('market', true)} className="absolute bottom-4 right-4 bg-white/80 hover:bg-white text-xs px-2 py-1 rounded shadow-sm text-zinc-600 border border-zinc-200 opacity-0 group-hover/cover:opacity-100 transition-opacity">Cambiar portada</button>}
                                    </div>
                                    <div className="px-8 md:px-24 pt-8">
                                        {activePage.icon && (<div className="relative -mt-16 mb-4 z-10 group/icon"><div onClick={() => toggleModal('iconPicker', !ui.modals.iconPicker)} className="text-7xl cursor-pointer hover:scale-105 transition-transform inline-block relative drop-shadow-sm">{activePage.icon}</div>{ui.modals.iconPicker && (<div className="absolute top-full left-0 z-50 bg-white border border-zinc-200 p-3 rounded-xl shadow-xl w-64 grid grid-cols-6 gap-2 h-48 overflow-y-auto mt-2">{ICONS_LIST.map(icon => (<div key={icon} onClick={() => { actions.updatePage(activePageId, { icon }); toggleModal('iconPicker', false); }} className="text-xl p-1 hover:bg-zinc-100 rounded cursor-pointer text-center">{icon}</div>))}</div>)}</div>)}
                                        <PageHeaderControls page={activePage} onUpdate={(u) => actions.updatePage(activePageId, u)} onToggleComments={() => setShowComments(!showComments)} onOpenIconPicker={() => toggleModal('iconPicker', true)} onOpenCoverPicker={() => toggleModal('market', true)} />
                                        {showComments && (<CommentSection comments={activePage.comments} onAddComment={(text) => actions.addComment(text)} userAvatar={userProfile.avatar} userName={userProfile.name} />)}
                                        <input value={activePage.title} onChange={(e) => actions.updatePage(activePage.id, { title: e.target.value })} placeholder="T√≠tulo de la p√°gina" className="w-full text-4xl font-bold placeholder:opacity-50 border-none outline-none bg-transparent mb-8 text-current" />
                                        <div className="space-y-0.5 min-h-[300px]">{activePage.blocks.map((block, index) => (<EditorBlock key={block.id} block={block} index={index} actions={actions} />))}</div>
                                        <div className="h-32 -mx-4 cursor-text mt-4 opacity-0 hover:opacity-100 transition-opacity flex items-start pt-2 px-4 text-zinc-300 text-sm" onClick={() => actions.addBlock(activePage.blocks.length)}>Haz clic para escribir...</div>
                                    </div>
                                </motion.div>
                            )}
                        </div>
                    </main>

                    {/* MODALS */}
                    <Modal isOpen={ui.modals.search} onClose={() => toggleModal('search', false)} title={null}><div className="p-4 border-b border-zinc-100 bg-[#FBFBFA]"><div className="flex items-center gap-3 bg-white px-3 py-3 rounded-lg border border-zinc-200 shadow-sm"><Search className="text-zinc-400" size={18} /><input autoFocus value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Busca en tus p√°ginas..." className="bg-transparent w-full outline-none text-base placeholder:text-zinc-400 text-zinc-700" /></div></div><div className="p-2 min-h-[300px]">{filteredPages.length > 0 ? filteredPages.map(p => (<div key={p.id} onClick={() => { actions.setActivePageId(p.id); setUi(prev => ({ ...prev, currentView: 'page', modals: { ...prev.modals, search: false } })); }} className="flex items-center gap-3 p-2 hover:bg-zinc-100 rounded cursor-pointer group"><div className="text-xl">{p.icon || 'üìÑ'}</div><div className="flex-1"><div className="text-sm font-medium text-zinc-800">{p.title || 'Sin t√≠tulo'}</div><div className="text-xs text-zinc-400">En {activeWorkspace.name}</div></div><ArrowRight size={14} className="text-zinc-300 opacity-0 group-hover:opacity-100" /></div>)) : <div className="text-center text-zinc-400 mt-12 text-sm">No se encontraron resultados</div>}</div></Modal>
                    <Modal isOpen={ui.modals.ai} onClose={() => toggleModal('ai', false)} title={null} transparent={true}><div className="flex items-center justify-center h-full p-4"><motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-zinc-200"><div className="p-6 bg-gradient-to-br from-indigo-50 to-white"><h2 className="text-lg font-bold text-zinc-800 mb-2 flex items-center gap-2"><Sparkles size={18} className="text-indigo-500" /> Notion AI</h2><p className="text-sm text-zinc-500 mb-4">Describe lo que necesitas. La p√°gina se generar√° en segundo plano.</p><textarea autoFocus value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Ej: Rutina de gimnasio para 3 d√≠as..." className="w-full bg-white border border-zinc-200 rounded-xl p-4 h-32 resize-none no-ring focus:border-zinc-400 transition-colors mb-4 text-zinc-700 text-sm" /><div className="flex justify-end gap-2"><button onClick={() => toggleModal('ai', false)} className="px-4 py-2 rounded-lg text-zinc-500 hover:bg-zinc-100 text-sm font-medium">Cancelar</button><button onClick={generatePageWithAI} disabled={isAiGenerating} className="px-4 py-2 rounded-lg bg-zinc-900 text-white font-medium text-sm hover:bg-black transition-colors disabled:opacity-50 flex items-center gap-2">{isAiGenerating ? <Loader2 className="animate-spin" size={16} /> : <Wand2 size={16} />} Generar</button></div></div></motion.div></div></Modal>

                    <Modal isOpen={ui.modals.market} onClose={() => toggleModal('market', false)} title="Marketplace" size="max-w-6xl">
                        <FancyTabs tabs={[{ id: 'gallery', label: 'Galer√≠a' }, { id: 'styles', label: 'Estilos & Temas' }, { id: 'fonts', label: 'Fuentes' }]} activeTab={ui.marketTab} onTabChange={(id) => setUi(p => ({ ...p, marketTab: id }))} />
                        <div className="p-6 min-h-[400px]">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex gap-2 bg-zinc-100 p-1 rounded-lg">
                                    <button onClick={() => setUi(p => ({ ...p, marketSubTab: 'store' }))} className={clsx("px-3 py-1.5 text-xs font-medium rounded-md transition-colors", ui.marketSubTab === 'store' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>Explorar</button>
                                    <button onClick={() => setUi(p => ({ ...p, marketSubTab: 'library' }))} className={clsx("px-3 py-1.5 text-xs font-medium rounded-md transition-colors", ui.marketSubTab === 'library' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>Mis Instalados</button>
                                </div>
                                <div className="flex gap-2">
                                    {ui.marketTab === 'gallery' && <button onClick={() => triggerUpload('cover')} className="text-xs flex items-center gap-1 bg-zinc-100 hover:bg-zinc-200 px-3 py-1.5 rounded text-zinc-600 font-medium"><UploadCloud size={12} /> Subir Propia</button>}
                                    {ui.marketTab === 'styles' && <button onClick={() => triggerUpload('style-json')} className="flex items-center gap-2 text-xs bg-zinc-100 hover:bg-zinc-200 px-3 py-1.5 rounded-md font-medium text-zinc-700"><FileJson size={14} /> Cargar JSON</button>}
                                    {ui.marketTab === 'fonts' && <button onClick={() => triggerUpload('font')} className="text-xs flex items-center gap-1 bg-zinc-100 hover:bg-zinc-200 px-3 py-1.5 rounded text-zinc-600 font-medium"><UploadCloud size={12} /> Subir Fuente</button>}
                                </div>
                            </div>

                            {loadingMarket ? <div className="flex items-center justify-center h-48"><Loader2 className="animate-spin text-zinc-400" /></div> : (
                                <>
                                    {/* --- GALER√çA (COVERS) --- */}
                                    {ui.marketTab === 'gallery' && (
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {ui.marketSubTab === 'store' ? (
                                                (marketData.covers.length > 0 ? marketData.covers : ["https://images.unsplash.com/photo-1497436072909-60f360e1d4b0?w=600", "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=600"]).map((url, i) => (<SpotlightCard key={i} onClick={() => { actions.updatePage(activePageId, { cover: url }); toggleModal('market', false); }} className="h-32 cursor-pointer"><img src={url} className="w-full h-full object-cover" /><div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-xs font-bold">Usar</div></SpotlightCard>))
                                            ) : (
                                                <div className="col-span-full text-center py-12 text-zinc-400">No tienes portadas guardadas localmente.</div>
                                            )}
                                        </div>
                                    )}

                                    {/* --- ESTILOS & TEMAS --- */}
                                    {ui.marketTab === 'styles' && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {ui.marketSubTab === 'store' ? (
                                                marketData.styles.length === 0 ? <div className="col-span-full text-center py-12 text-zinc-400">No hay temas disponibles en el servidor.</div> :
                                                    marketData.styles.map(style => {
                                                        const isInstalled = themes.some(t => t.id === style.id || t.name === style.name);
                                                        return (
                                                            <SpotlightCard key={style.id} className="p-4 flex flex-col justify-between bg-white h-full">
                                                                <div className="flex items-center gap-3 mb-3"><div className="w-10 h-10 rounded bg-gradient-to-br from-zinc-100 to-zinc-200 flex items-center justify-center font-serif font-bold text-zinc-400">Aa</div><div><div className="font-bold text-sm text-zinc-800">{style.name}</div><div className="text-xs text-zinc-500">Remoto</div></div></div>
                                                                {isInstalled ? <button onClick={() => { actions.removeTheme(style.id); showNotify("Tema desinstalado"); }} className="w-full flex justify-center items-center gap-1 bg-red-50 text-red-500 text-xs px-3 py-2 rounded hover:bg-red-100 font-medium transition-colors"><Trash size={12} /> Desinstalar</button> : <button onClick={() => { actions.addTheme({ ...style }); showNotify("Tema instalado"); }} className="w-full flex justify-center items-center gap-1 bg-zinc-900 text-white text-xs px-3 py-2 rounded hover:bg-black font-medium transition-colors"><Download size={12} /> Instalar</button>}
                                                            </SpotlightCard>
                                                        );
                                                    })
                                            ) : (
                                                themes.filter(t => t.id !== 'default').length === 0 ? <div className="col-span-full text-center py-12 text-zinc-400">No tienes temas instalados.</div> :
                                                    themes.filter(t => t.id !== 'default').map(t => (
                                                        <SpotlightCard key={t.id} className="p-4 flex flex-col justify-between bg-white h-full">
                                                            <div className="flex items-center gap-3 mb-3"><div className="w-10 h-10 rounded bg-gradient-to-br from-zinc-100 to-zinc-200 flex items-center justify-center font-serif font-bold text-zinc-400">Aa</div><div><div className="font-bold text-sm text-zinc-800">{t.name}</div><div className="text-xs text-zinc-500">Local</div></div></div>
                                                            <button onClick={() => { actions.removeTheme(t.id); showNotify("Tema eliminado"); }} className="w-full flex justify-center items-center gap-1 bg-red-50 text-red-500 text-xs px-3 py-2 rounded hover:bg-red-100 font-medium transition-colors"><Trash size={12} /> Eliminar</button>
                                                        </SpotlightCard>
                                                    ))
                                            )}
                                        </div>
                                    )}

                                    {/* --- FUENTES --- */}
                                    {ui.marketTab === 'fonts' && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {ui.marketSubTab === 'store' ? (
                                                marketData.fonts.map(f => {
                                                    const isInstalled = fonts.some(font => font.id === f.id);
                                                    return (
                                                        <div key={f.id} className="flex flex-col justify-between p-4 bg-white border border-zinc-200 rounded-lg h-32 hover:shadow-md transition-shadow">
                                                            <div><div className="font-bold text-zinc-800 text-lg">{f.name}</div><div className="text-xs text-zinc-400">Open Source</div></div>
                                                            {isInstalled ? <button onClick={() => { actions.removeFont(f.id); showNotify("Fuente eliminada"); }} className="text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded w-fit">Desinstalar</button> : <button onClick={() => { actions.addFont(f); showNotify("Fuente instalada"); }} className="text-xs font-bold bg-zinc-900 text-white px-3 py-1.5 rounded w-fit hover:bg-black">Instalar</button>}
                                                        </div>
                                                    )
                                                })
                                            ) : (
                                                fonts.length === 0 ? <div className="col-span-full text-center py-12 text-zinc-400">No hay fuentes instaladas.</div> :
                                                    fonts.map(f => (
                                                        <div key={f.id} className="flex flex-col justify-between p-4 bg-white border border-zinc-200 rounded-lg h-32 hover:shadow-md transition-shadow">
                                                            <div><div className="font-bold text-zinc-800 text-lg">{f.name}</div><div className="text-xs text-zinc-400">Local</div></div>
                                                            <button onClick={() => { actions.removeFont(f.id); showNotify("Fuente eliminada"); }} className="text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded w-fit">Eliminar</button>
                                                        </div>
                                                    ))
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </Modal>

                    <Modal isOpen={ui.modals.createWorkspace} onClose={() => toggleModal('createWorkspace', false)} title="Crear Espacio" size="max-w-sm">
                        <div className="p-6 flex flex-col gap-4">
                            <label className="text-sm font-bold text-zinc-600 uppercase">Nombre del Espacio</label>
                            <input
                                autoFocus
                                value={newWorkspaceName}
                                onChange={(e) => setNewWorkspaceName(e.target.value)}
                                placeholder="Ej: Proyecto Personal"
                                className="w-full p-3 border border-zinc-200 rounded-lg outline-none focus:border-zinc-400 transition-colors"
                            />
                            <button onClick={handleCreateWorkspace} className="w-full bg-zinc-900 text-white font-medium py-2.5 rounded-lg hover:bg-black transition-colors flex items-center justify-center gap-2">
                                <Plus size={18} /> Crear y Acceder
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }

    </script>
</body>

</html>