<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notion Clone V82 - Optimized</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        zinc: { 850: '#1f1f22', 900: '#18181b', 950: '#09090b' },
                        notion: { hover: '#EFEFEE', select: '#E8F3FF', text: '#37352f', dim: '#9B9A97' }
                    },
                    boxShadow: {
                        'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0,0,0,0.05)',
                        'popover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --sidebar-width: 15rem;
            --sidebar-collapsed: 3.5rem;
            --bg-color: #ffffff;
            --text-color: #37352f;
            --sidebar-bg: #F7F7F5;
            --item-hover: rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 48rem) {
            :root {
                --sidebar-width: 100%;
            }
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .fancy-scroll::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }

        .fancy-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .fancy-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0.25rem;
        }

        .fancy-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }
    </style>

    <!-- Import Maps -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
            "clsx": "https://esm.sh/clsx@2.0.0",
            "date-fns": "https://esm.sh/date-fns@2.30.0",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.0"
        }
    }
    </script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef, useLayoutEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence, useMotionTemplate, useMotionValue } from 'framer-motion';
        import { createClient } from '@supabase/supabase-js';
        import {
            List, Plus, Trash, Image as ImageIcon, FileText,
            MoreHorizontal, Search, Settings, GripVertical,
            ArrowRight, CheckSquare, Sparkles, Sidebar as SidebarIcon,
            X, Github, Palette, Type, Globe, Lock, ChevronDown, Check,
            Users, Inbox, ArrowLeft, SlidersHorizontal, User, Briefcase, Plane, Music,
            Wand2, Loader2, LayoutTemplate, Bell, ChevronsLeft, CreditCard, LogOut,
            ChevronRight, UploadCloud, Command, FolderOpen, Camera, PlusCircle, Download, FileJson,
            Smile, MessageSquare, ImagePlus, Archive, RefreshCcw, CornerDownLeft, Clock,
            LayoutGrid, Package, Undo2, Filter, Quote, Minus, Info, ListOrdered, Menu,
            Star as StarIcon, Link as LinkIcon, Copy as CopyIcon, Edit2 as EditIcon
        } from 'lucide-react';
        import { clsx } from 'clsx';
        import { formatDistanceToNow } from 'date-fns';

        // ==========================================
        // 0. SUPABASE CONFIGURATION & AUTH SERVICE
        // ==========================================

        const supabaseUrl = import.meta.env?.VITE_SUPABASE_URL || window.VITE_SUPABASE_URL || '';
        const supabaseAnonKey = import.meta.env?.VITE_SUPABASE_ANON_KEY || window.VITE_SUPABASE_ANON_KEY || '';

        let supabase = null;
        if (supabaseUrl && supabaseAnonKey) {
            supabase = createClient(supabaseUrl, supabaseAnonKey);
        } else {
            console.warn("Supabase credentials missing. Auth will act as Mock.");
        }

        const AuthService = {
            login: async () => {
                if (supabase) {
                    const { data, error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.origin
                        }
                    });
                    if (error) throw error;
                    return data;
                } else {
                    // Fallback Mock
                    await utils.delay(1000);
                    const mockUser = {
                        id: "user-mock",
                        email: "demo@ejemplo.com",
                        user_metadata: {
                            full_name: "Usuario Demo",
                            avatar_url: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"
                        }
                    };
                    localStorage.setItem('notion_mock_user', JSON.stringify(mockUser));
                    return { user: mockUser };
                }
            },
            logout: async () => {
                if (supabase) {
                    await supabase.auth.signOut();
                } else {
                    localStorage.removeItem('notion_mock_user');
                }
                return true;
            }
        };

        // ==========================================
        // 0.1 BACKUP & DATA SERVICE
        // ==========================================

        const BackupService = {
            // Keys to persist
            STORAGE_KEYS: [
                'notion_v82_ws',
                'notion_v82_profile',
                'notion_v82_themes',
                'notion_v82_fonts',
                'notion_v82_active_id',
                'notion_v82_active_theme'
            ],

            saveBackup: (userId) => {
                if (!userId) return;
                const backup = {};
                BackupService.STORAGE_KEYS.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) backup[key] = JSON.parse(data);
                });
                // Simulate saving to "backups/" folder by using a prefixed localStorage key
                // In a real app with fs access, this would write to c:\Users\Roberto\...\backups\backup_${userId}.json
                const backupKey = `notion_backup_${userId}`;
                localStorage.setItem(backupKey, JSON.stringify(backup));
                console.log(`[Backup] Saved data for ${userId} to ${backupKey}`);
            },

            restoreBackup: (userId) => {
                if (!userId) return false;
                const backupKey = `notion_backup_${userId}`;
                const backupData = localStorage.getItem(backupKey);

                if (backupData) {
                    const backup = JSON.parse(backupData);
                    Object.keys(backup).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(backup[key]));
                    });
                    console.log(`[Backup] Restored data for ${userId}`);
                    return true;
                }
                return false;
            },

            clearLocalData: () => {
                BackupService.STORAGE_KEYS.forEach(key => localStorage.removeItem(key));
                console.log("[Backup] Local data cleared");
            }
        };

        // ==========================================
        // 0. GLOBAL CONSTANTS & UTILS
        // ==========================================

        const USE_MOCK_API = true;
        const API_ENDPOINTS = { MARKET: "/api/market", AI: "/api/generar-pagina", UPLOAD: "/api/upload" };
        const ICONS_LIST = ['üìÑ', 'üéµ', 'üöÄ', 'üíº', 'üí°', 'üé®', 'üèà', 'ü™ê', 'üçé', 'üçï', '‚öΩ', 'üöó', 'üê∂', 'üê±', 'üéâ', 'üìö', 'üí∏', 'üè†', '‚ù§Ô∏è', 'üíÄ', 'üî•', '‚ú®', 'üåü', 'üë®‚Äçüíª', 'üéØ', 'üì±', 'üíª', 'üé¨', 'üéÆ', '‚òï', 'üåç', 'üö¥', 'üèÉ', '‚úàÔ∏è', 'üé∏', 'üì∑', 'üñºÔ∏è', 'üé≠', 'üé™', 'üé®', 'üéØ', 'üèÜ', 'üéì'];
        const COVER_COLORS = [
            { id: 'red', name: 'Rojo', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
            { id: 'orange', name: 'Naranja', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
            { id: 'blue', name: 'Azul', color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
            { id: 'beige', name: 'Beige', color: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
            { id: 'teal', name: 'Verde azulado', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
            { id: 'pink', name: 'Rosa', color: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' },
            { id: 'orange-red', name: 'Naranja rojizo', color: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
            { id: 'purple', name: 'Morado', color: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
        ];
        const COVER_IMAGES = [
            'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800',
            'https://images.unsplash.com/photo-1497493292307-31c376b6e479?w=800',
            'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800',
            'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=800',
        ];

        const DEFAULT_THEME = { id: 'default', name: 'stylessApp', author: 'System', colors: { bg: '#ffffff', text: '#37352f', sidebar: '#F7F7F5' } };
        const INITIAL_STATE = {
            workspaces: [{ id: 'ws-demo', name: 'Fixius Workspace', initial: 'F', color: 'from-indigo-500 to-purple-500', email: 'user@example.com', pages: [] }],
            profile: { name: "Usuario Fixius", email: "usuario@ejemplo.com", bio: "Productivity enthusiast.", avatar: null },
            themes: [DEFAULT_THEME],
            fonts: []
        };

        const utils = {
            generateId: () => Math.random().toString(36).substr(2, 9),
            getRandomColor: () => ['from-indigo-500 to-purple-500', 'from-pink-500 to-rose-500', 'from-emerald-500 to-teal-500', 'from-blue-500 to-cyan-500', 'from-orange-500 to-amber-500'][Math.floor(Math.random() * 5)],
            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms))
        };

        // ==========================================
        // 1. COMPONENTS
        // ==========================================

        function SpotlightCard({ children, className = "", onClick }) {
            const mouseX = useMotionValue(0);
            const mouseY = useMotionValue(0);
            function handleMouseMove({ currentTarget, clientX, clientY }) {
                const { left, top } = currentTarget.getBoundingClientRect();
                mouseX.set(clientX - left);
                mouseY.set(clientY - top);
            }
            return (
                <div className={clsx("group relative border border-zinc-200 bg-white overflow-hidden rounded-xl", className)} onMouseMove={handleMouseMove} onClick={onClick}>
                    <motion.div className="pointer-events-none absolute -inset-px rounded-xl opacity-0 transition duration-300 group-hover:opacity-100" style={{ background: useMotionTemplate`radial-gradient(650px circle at ${mouseX}px ${mouseY}px, rgba(79, 70, 229, 0.1), transparent 80%)` }} />
                    <div className="relative h-full">{children}</div>
                </div>
            );
        }

        const FancyText = ({ text, className }) => {
            const words = text.split(" ");
            return (
                <div className={className}>
                    {words.map((word, i) => (<motion.span key={i} initial={{ opacity: 0, y: 10, filter: "blur(5px)" }} animate={{ opacity: 1, y: 0, filter: "blur(0px)" }} transition={{ duration: 0.4, delay: i * 0.1 }} className="inline-block mr-2">{word}</motion.span>))}
                </div>
            );
        };

        const FancyTabs = ({ tabs, activeTab, onTabChange }) => (
            <div className="flex space-x-1 border-b border-zinc-200 px-6 pt-2 overflow-x-auto no-scrollbar">
                {tabs.map((tab) => (
                    <button key={tab.id} onClick={() => onTabChange(tab.id)} className={clsx("relative px-4 py-2 text-sm font-medium transition-colors outline-none whitespace-nowrap", activeTab === tab.id ? "text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>
                        {activeTab === tab.id && <motion.div layoutId="active-pill" className="absolute inset-0 border-b-2 border-zinc-900" transition={{ type: "spring", bounce: 0.2, duration: 0.6 }} />}
                        <span className="relative z-10">{tab.label}</span>
                    </button>
                ))}
            </div>
        );

        // ==========================================
        // 2. EDITOR
        // ==========================================

        const SlashMenu = ({ query, onSelect, onClose }) => {
            const [activeCategory, setActiveCategory] = useState('basicos');

            const categories = {
                basicos: {
                    label: 'B√°sicos',
                    items: [
                        { id: 'h1', label: 'Encabezado 1', icon: <Type size={18} />, desc: 'T√≠tulo grande' },
                        { id: 'h2', label: 'Encabezado 2', icon: <Type size={16} />, desc: 'T√≠tulo mediano' },
                        { id: 'h3', label: 'Encabezado 3', icon: <Type size={14} />, desc: 'T√≠tulo peque√±o' },
                        { id: 'bullet', label: 'Lista', icon: <List size={16} />, desc: 'Lista simple' },
                        { id: 'todo', label: 'Tareas', icon: <CheckSquare size={16} />, desc: 'Tareas pendientes' },
                    ]
                },
                avanzados: {
                    label: 'Avanzados',
                    items: [
                        { id: 'quote', label: 'Cita', icon: <Quote size={16} />, desc: 'Captura una cita' },
                        { id: 'callout', label: 'Destacado', icon: <Info size={16} />, desc: 'Resalta informaci√≥n' },
                        { id: 'divider', label: 'Divisor', icon: <Minus size={16} />, desc: 'Separa visualmente' },
                    ]
                }
            };

            const allItems = Object.values(categories).flatMap(cat => cat.items);
            const filtered = query ? allItems.filter(i => i.label.toLowerCase().includes(query.toLowerCase())) : categories[activeCategory].items;

            const [selectedIndex, setSelectedIndex] = useState(0);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowDown') { e.preventDefault(); setSelectedIndex(prev => (prev + 1) % filtered.length); }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); setSelectedIndex(prev => (prev - 1 + filtered.length) % filtered.length); }
                    else if (e.key === 'Enter') { e.preventDefault(); onSelect(filtered[selectedIndex].id); }
                    else if (e.key === 'Escape') { onClose(); }
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [filtered, selectedIndex, onSelect, onClose]);

            if (filtered.length === 0) return null;

            return (
                <motion.div initial={{ opacity: 0, y: 10, scale: 0.95 }} animate={{ opacity: 1, y: 0, scale: 1 }} className="absolute top-full left-0 z-50 w-80 bg-white rounded-lg shadow-popover border border-zinc-200 overflow-hidden mt-2 max-h-96">
                    {!query && (
                        <div className="border-b border-zinc-100 bg-zinc-50/50">
                            <div className="flex gap-1 px-2 py-1.5">
                                {Object.entries(categories).map(([key, cat]) => (
                                    <button
                                        key={key}
                                        onClick={() => setActiveCategory(key)}
                                        className={clsx(
                                            "px-3 py-1.5 text-xs font-medium rounded-md transition-all",
                                            activeCategory === key
                                                ? "bg-white shadow-sm text-zinc-900 border border-zinc-200"
                                                : "text-zinc-500 hover:text-zinc-700 hover:bg-zinc-100"
                                        )}
                                    >
                                        {cat.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                    <div className="p-1.5 space-y-0.5 max-h-80 overflow-y-auto">
                        {query && <div className="text-xs font-bold text-zinc-400 px-2 py-1 uppercase">Resultados</div>}
                        {filtered.map((item, i) => (
                            <div key={item.id} onClick={() => onSelect(item.id)} className={clsx("flex items-center gap-3 px-2 py-1.5 rounded cursor-pointer transition-colors", i === selectedIndex ? "bg-zinc-100" : "hover:bg-zinc-50")}>
                                <div className="w-10 h-10 rounded border border-zinc-200 bg-white flex items-center justify-center text-zinc-600 shrink-0 shadow-sm">{item.icon}</div>
                                <div><div className="text-sm font-medium text-zinc-800">{item.label}</div><div className="text-xs text-zinc-400">{item.desc}</div></div>
                            </div>
                        ))}
                    </div>
                </motion.div>
            );
        };

        const FancyEditable = ({ tagName: Tag, html, className, onChange, onKeyDown, placeholder, disabled, autoFocus }) => {
            const contentEditableRef = useRef(null);
            useEffect(() => { if (autoFocus && contentEditableRef.current) contentEditableRef.current.focus(); }, [autoFocus]);
            useLayoutEffect(() => { if (contentEditableRef.current && contentEditableRef.current.innerText !== html) contentEditableRef.current.innerText = html; }, [html]);
            return <Tag ref={contentEditableRef} className={clsx(className, "empty:before:content-[attr(placeholder)] empty:before:text-zinc-300 outline-none")} contentEditable={!disabled} suppressContentEditableWarning onInput={(e) => onChange && onChange(e.currentTarget.innerText)} onKeyDown={onKeyDown} placeholder={placeholder} />;
        };

        const EditorBlock = ({ block, index, actions }) => {
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (['bullet', 'todo'].includes(block.type)) {
                        if (!block.content) {
                            if ((block.level || 0) > 0) actions.updateBlock(block.id, { level: (block.level || 0) - 1 });
                            else actions.updateBlock(block.id, { type: 'p' });
                        } else actions.addBlock(index + 1, { type: block.type, level: block.level || 0 });
                    } else actions.addBlock(index + 1);
                } else if (e.key === 'Backspace' && (!block.content)) {
                    e.preventDefault();
                    if ((block.level || 0) > 0) actions.updateBlock(block.id, { level: (block.level || 0) - 1 });
                    else actions.deleteBlock(index);
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    const currentLevel = block.level || 0;
                    actions.updateBlock(block.id, { level: e.shiftKey ? Math.max(0, currentLevel - 1) : Math.min(3, currentLevel + 1) });
                }
            };

            const handleChange = (val) => {
                if (block.type === 'p') {
                    const shortcuts = { '# ': 'h1', '## ': 'h2', '### ': 'h3', '- ': 'bullet', '[] ': 'todo', '> ': 'quote', '---': 'divider' };
                    if (shortcuts[val]) { actions.updateBlock(block.id, { type: shortcuts[val], content: '' }); return; }
                }
                actions.updateBlock(block.id, { content: val });
            };

            const showSlashMenu = block.type === 'p' && block.content.startsWith('/');
            const slashQuery = showSlashMenu ? block.content.substring(1) : '';

            return (
                <motion.div layout initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} className="group relative flex items-start pl-2 md:pl-6 mb-1 py-0.5">
                    <div className="absolute left-0 top-1.5 p-0.5 text-zinc-300 opacity-0 group-hover:opacity-100 cursor-grab active:cursor-grabbing hover:text-zinc-500 transition-opacity touch-none hidden md:block"><GripVertical size={16} /></div>
                    <div className="w-full relative">
                        {showSlashMenu && <SlashMenu query={slashQuery} onSelect={(type) => actions.updateBlock(block.id, { type, content: '' })} onClose={() => { }} />}
                        {block.type === 'h1' && <FancyEditable tagName="h1" html={block.content} className="text-3xl font-bold text-zinc-800 mb-2 mt-6" placeholder="Encabezado 1" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h2' && <FancyEditable tagName="h2" html={block.content} className="text-2xl font-semibold text-zinc-800 mb-1 mt-4" placeholder="Encabezado 2" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'h3' && <FancyEditable tagName="h3" html={block.content} className="text-xl font-semibold text-zinc-800 mb-1 mt-3" placeholder="Encabezado 3" onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'p' && <FancyEditable tagName="p" html={block.content} className="text-base text-zinc-700 leading-relaxed min-h-[1.5rem]" placeholder='Escribe "/" para comandos...' onKeyDown={handleKeyDown} onChange={handleChange} autoFocus />}
                        {block.type === 'bullet' && (
                            <div className="flex items-start gap-2" style={{ marginLeft: (block.level || 0) * 1.5 + 'rem' }}>
                                <div className={clsx("mt-2.5 shrink-0 transition-all", (block.level || 0) % 3 === 0 ? "w-1.5 h-1.5 rounded-full bg-zinc-800" : (block.level || 0) % 3 === 1 ? "w-1.5 h-1.5 rounded-full border border-zinc-800 bg-transparent" : "w-1.5 h-1.5 bg-zinc-800")} />
                                <FancyEditable tagName="p" html={block.content} className="flex-1 text-base text-zinc-700 leading-relaxed" placeholder="Lista" onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus />
                            </div>
                        )}
                        {block.type === 'todo' && (
                            <div className="flex items-start gap-3" style={{ marginLeft: (block.level || 0) * 1.5 + 'rem' }}>
                                <div onClick={() => actions.updateBlock(block.id, { checked: !block.checked })} className={clsx("mt-1 w-4 h-4 rounded-[3px] border cursor-pointer flex items-center justify-center transition-colors", block.checked ? 'bg-[#2EAADC] border-[#2EAADC]' : 'border-zinc-400 hover:bg-zinc-100')}>{block.checked && <Check size={12} className="text-white" />}</div>
                                <FancyEditable tagName="p" html={block.content} className={clsx("flex-1 text-base min-h-[1.5rem] transition-opacity", block.checked ? 'line-through text-zinc-400 opacity-50' : 'text-zinc-700')} placeholder="Tarea por hacer" onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus />
                            </div>
                        )}
                        {block.type === 'quote' && <div className="flex items-start gap-3 pl-4 border-l-4 border-zinc-900 my-2"><FancyEditable tagName="p" html={block.content} className="text-lg italic text-zinc-700" placeholder="Cita..." onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus /></div>}
                        {block.type === 'divider' && <div className="py-4"><div className="h-px bg-zinc-200 w-full" /></div>}
                        {block.type === 'callout' && <div className="p-4 bg-zinc-50 rounded-lg flex gap-3 border border-zinc-200 my-2"><Info size={20} className="text-zinc-500 shrink-0" /><FancyEditable tagName="p" html={block.content} className="text-base text-zinc-800" placeholder="Destacado..." onKeyDown={handleKeyDown} onChange={(val) => actions.updateBlock(block.id, { content: val })} autoFocus /></div>}
                    </div>
                </motion.div>
            );
        };

        // ==========================================
        // 3. STORE & STATE MANAGEMENT
        // ==========================================

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => { try { return JSON.parse(window.localStorage.getItem(key)) || initialValue; } catch { return initialValue; } });
            const setValue = (value) => { const valueToStore = value instanceof Function ? value(storedValue) : value; setStoredValue(valueToStore); window.localStorage.setItem(key, JSON.stringify(valueToStore)); };
            return [storedValue, setValue];
        };

        // Helper Components
        const Modal = ({ isOpen, onClose, title, children, transparent = false }) => {
            if (!isOpen) return null;
            return (
                <AnimatePresence>
                    {isOpen && (
                        <>
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose} className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[60]" />
                            <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} className={clsx("fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col", transparent ? "bg-transparent shadow-none" : "bg-white border border-zinc-200")}>
                                {title && <div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0 bg-white"><h2 className="text-sm font-semibold text-zinc-700">{title}</h2><button onClick={onClose} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18} /></button></div>}
                                <div className="flex-1 overflow-y-auto">
                                    {children}
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>
            );
        };

        const SidebarItem = ({ page, depth = 0, actions, ui, setUi, activePageId, allPages, onContextMenu }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            const hasChildren = allPages.some(p => p.parentId === page.id && !p.isDeleted && !p.inInbox);
            const children = allPages.filter(p => p.parentId === page.id && !p.isDeleted && !p.inInbox);

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const draggedId = e.dataTransfer.getData("text/plain");
                if (draggedId !== page.id) {
                    actions.movePage(draggedId, page.id);
                }
            };

            return (
                <>
                    <div
                        className={clsx("group flex items-center gap-1 p-1 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[1.75rem] relative select-none", activePageId === page.id ? 'bg-[rgba(0,0,0,0.05)] font-medium' : 'opacity-80')}
                        style={{ paddingLeft: `${depth * 0.75 + 0.5}rem` }}
                        onClick={() => { actions.setActivePageId(page.id); setUi(p => ({ ...p, currentView: 'page' })); if (ui.isMobile) setUi(p => ({ ...p, sidebarOpen: false })); }}
                        draggable
                        onDragStart={(e) => e.dataTransfer.setData("text/plain", page.id)}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={handleDrop}
                    >
                        <div className="flex items-center justify-center w-4 h-4 shrink-0 hover:bg-zinc-200 rounded transition-colors" onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}>
                            {hasChildren && <ChevronRight size={12} className={clsx("transition-transform", isExpanded && "rotate-90")} />}
                        </div>
                        <span className="text-lg leading-none w-4 text-center shrink-0 flex items-center justify-center">{page.isGenerating ? <Loader2 className="animate-spin text-indigo-500" size={14} /> : (page.icon || <FileText size={16} />)}</span>
                        <span className={clsx("text-sm truncate flex-1", page.isGenerating && "italic text-zinc-400")}>{page.title || 'Sin t√≠tulo'}</span>

                        {/* Hover Actions */}
                        <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity absolute right-1 bg-[var(--sidebar-bg)] shadow-sm rounded">
                            <button onClick={(e) => { e.stopPropagation(); onContextMenu(page.id, e); }} className="p-0.5 hover:bg-zinc-200 rounded text-zinc-500"><MoreHorizontal size={14} /></button>
                            <button onClick={(e) => { e.stopPropagation(); actions.addPage({ parentId: page.id }); setIsExpanded(true); }} className="p-0.5 hover:bg-zinc-200 rounded text-zinc-500"><Plus size={14} /></button>
                        </div>
                    </div>
                    {isExpanded && children.map(child => (
                        <SidebarItem key={child.id} page={child} depth={depth + 1} actions={actions} ui={ui} setUi={setUi} activePageId={activePageId} allPages={allPages} onContextMenu={onContextMenu} />
                    ))}
                </>
            );
        };

        const useAppStore = () => {
            const [workspaces, setWorkspaces] = useLocalStorage('notion_v82_ws', INITIAL_STATE.workspaces);
            const [userProfile, setUserProfile] = useLocalStorage('notion_v82_profile', INITIAL_STATE.profile);
            const [themes, setThemes] = useLocalStorage('notion_v82_themes', INITIAL_STATE.themes);
            const [fonts, setFonts] = useLocalStorage('notion_v82_fonts', INITIAL_STATE.fonts);
            const [activeWorkspaceId, setActiveWorkspaceId] = useLocalStorage('notion_v82_active_id', 'ws-demo');
            const [activePageId, setActivePageId] = useState(null);
            const [activeThemeId, setActiveThemeId] = useLocalStorage('notion_v82_active_theme', 'default');

            const activeWorkspace = useMemo(() => {
                const found = workspaces.find(w => w.id === activeWorkspaceId);
                if (found) return found;
                if (workspaces.length > 0) { setActiveWorkspaceId(workspaces[0].id); return workspaces[0]; }
                return null;
            }, [workspaces, activeWorkspaceId]);

            const activePage = useMemo(() => activeWorkspace?.pages.find(p => p.id === activePageId), [activeWorkspace, activePageId]);
            const activeTheme = useMemo(() => themes.find(t => t.id === activeThemeId) || DEFAULT_THEME, [themes, activeThemeId]);

            // Centralized State Exposure
            useEffect(() => {
                window.appState = { workspaces, userProfile, themes, fonts, activeWorkspaceId, activePageId, activeThemeId };
            }, [workspaces, userProfile, themes, fonts, activeWorkspaceId, activePageId, activeThemeId]);

            // CSS Theme Injection Logic
            useEffect(() => {
                const themeLink = document.getElementById('theme-stylesheet');
                if (activeTheme && activeTheme.type === 'css' && activeTheme.url) {
                    if (themeLink) {
                        themeLink.href = activeTheme.url;
                    } else {
                        const link = document.createElement('link');
                        link.id = 'theme-stylesheet';
                        link.rel = 'stylesheet';
                        link.href = activeTheme.url;
                        document.head.appendChild(link);
                    }
                } else {
                    if (themeLink) themeLink.remove();
                }
            }, [activeTheme]);

            const actions = {
                setActiveWorkspaceId, setActivePageId, setUserProfile, setActiveThemeId,
                addWorkspace: (name) => {
                    const newWs = {
                        id: utils.generateId(),
                        name,
                        initial: name[0].toUpperCase(),
                        color: utils.getRandomColor(),
                        email: userProfile.email,
                        pages: [
                            { id: utils.generateId(), title: 'Bienvenida', icon: 'üëã', cover: null, comments: [], inInbox: false, isDeleted: false, isGenerating: false, parentId: null, updatedAt: new Date().toISOString(), blocks: [{ id: utils.generateId(), type: 'h1', content: 'Bienvenida' }, { id: utils.generateId(), type: 'p', content: 'Este es tu nuevo espacio de trabajo.' }] },
                            { id: utils.generateId(), title: 'Tareas', icon: '‚úÖ', cover: null, comments: [], inInbox: false, isDeleted: false, isGenerating: false, parentId: null, updatedAt: new Date().toISOString(), blocks: [{ id: utils.generateId(), type: 'h1', content: 'Lista de Tareas' }, { id: utils.generateId(), type: 'todo', content: 'Revisar documentaci√≥n', checked: false }, { id: utils.generateId(), type: 'todo', content: 'Configurar perfil', checked: false }] }
                        ]
                    };
                    setWorkspaces(p => [...p, newWs]);
                    setActiveWorkspaceId(newWs.id);
                },
                removeWorkspace: (id) => { if (workspaces.length <= 1) return false; const newWorkspaces = workspaces.filter(w => w.id !== id); setWorkspaces(newWorkspaces); if (activeWorkspaceId === id) setActiveWorkspaceId(newWorkspaces[0].id); return true; },
                addPage: (overrides = {}) => {
                    if (!activeWorkspace) return;
                    const newPage = {
                        id: utils.generateId(),
                        title: '',
                        icon: null,
                        cover: null,
                        comments: [],
                        inInbox: false,
                        isDeleted: false,
                        isGenerating: false,
                        parentId: null,
                        updatedAt: new Date().toISOString(),
                        blocks: [],
                        ...overrides
                    };
                    const updatedWs = { ...activeWorkspace, pages: [...activeWorkspace.pages, newPage] };
                    setWorkspaces(workspaces.map(w => w.id === activeWorkspaceId ? updatedWs : w));
                    return newPage.id;
                },
                movePage: (pageId, targetParentId) => {
                    if (!activeWorkspace) return;
                    // Prevent circular dependency (moving parent into child)
                    // Simple check: if targetParentId is the page itself, ignore.
                    // Deep check omitted for brevity but recommended in prod.
                    if (pageId === targetParentId) return;

                    const updatedPages = activeWorkspace.pages.map(p => p.id === pageId ? { ...p, parentId: targetParentId } : p);
                    setWorkspaces(workspaces.map(w => w.id === activeWorkspaceId ? { ...activeWorkspace, pages: updatedPages } : w));
                },
                duplicatePage: (pageId) => {
                    if (!activeWorkspace) return;
                    const pageToDup = activeWorkspace.pages.find(p => p.id === pageId);
                    if (!pageToDup) return;
                    const newPage = { ...pageToDup, id: utils.generateId(), title: `${pageToDup.title} (Copia)`, updatedAt: new Date().toISOString(), blocks: pageToDup.blocks.map(b => ({ ...b, id: utils.generateId() })) };
                    const updatedWs = { ...activeWorkspace, pages: [...activeWorkspace.pages, newPage] };
                    setWorkspaces(workspaces.map(w => w.id === activeWorkspaceId ? updatedWs : w));
                    showNotify("P√°gina duplicada");
                },
                updatePage: (pid, u) => setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.map(pg => pg.id === pid ? { ...pg, ...u } : pg) } : w)),
                deletePage: (pid) => {
                    setWorkspaces(p => p.map(w => {
                        if (w.id !== activeWorkspaceId) return w;

                        // Helper function to get all descendant pages
                        const getAllDescendants = (pageId, pages) => {
                            const children = pages.filter(pg => pg.parentId === pageId);
                            let allDescendants = [...children];
                            children.forEach(child => {
                                allDescendants = [...allDescendants, ...getAllDescendants(child.id, pages)];
                            });
                            return allDescendants;
                        };

                        // Get all pages to delete (target + all descendants)
                        const descendantsToDelete = getAllDescendants(pid, w.pages);
                        const allIdsToDelete = [pid, ...descendantsToDelete.map(p => p.id)];

                        // Mark all as deleted
                        const updatedPages = w.pages.map(pg =>
                            allIdsToDelete.includes(pg.id)
                                ? { ...pg, isDeleted: true, deletedAt: new Date().toISOString() }
                                : pg
                        );

                        return { ...w, pages: updatedPages };
                    }));

                    if (activePageId === pid) setActivePageId(null);
                },
                restorePage: (pid) => { setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.map(pg => pg.id === pid ? { ...pg, isDeleted: false, deletedAt: null } : pg) } : w)); },
                permanentDeletePage: (pid) => { setWorkspaces(p => p.map(w => w.id === activeWorkspaceId ? { ...w, pages: w.pages.filter(pg => pg.id !== pid) } : w)); },
                updateBlock: (bid, u) => activePage && actions.updatePage(activePageId, { blocks: activePage.blocks.map(b => b.id === bid ? { ...b, ...u } : b) }),
                addBlock: (idx, data) => activePage && actions.updatePage(activePageId, { blocks: [...activePage.blocks.slice(0, idx), { id: utils.generateId(), type: 'p', content: '', ...data }, ...activePage.blocks.slice(idx)] }),
                deleteBlock: (idx) => activePage && actions.updatePage(activePageId, { blocks: [...activePage.blocks.slice(0, idx), ...activePage.blocks.slice(idx + 1)] }),
                addTheme: (t) => { if (!t.name) return; setThemes(p => { const exists = p.find(ex => ex.id === t.id); if (exists) return p.map(ex => ex.id === t.id ? t : ex); return [...p, t]; }); },
                removeTheme: (themeId) => { if (themeId === 'default') return; setThemes(p => p.filter(t => t.id !== themeId)); if (activeThemeId === themeId) setActiveThemeId('default'); },
                addFont: (f) => { if (!f.name) return; setFonts(p => { const exists = p.find(ex => ex.id === f.id); if (exists) return p; return [...p, f]; }); },
                removeFont: (fontId) => { setFonts(p => p.filter(f => f.id !== fontId)); },
                addComment: (text) => { if (!activePage) return; const newComment = { id: utils.generateId(), author: userProfile.name, avatar: userProfile.avatar, text, createdAt: new Date().toISOString() }; const currentComments = activePage.comments || []; actions.updatePage(activePageId, { comments: [...currentComments, newComment] }); },
                // Internal setters for restoration
                setWorkspaces, setUserProfile, setThemes, setFonts, setActiveWorkspaceId, setActiveThemeId
            };

            return { workspaces, userProfile, activeWorkspace, activeWorkspaceId, activePage, activePageId, themes, activeTheme, activeThemeId, fonts, actions, utils };
        };

        // ==========================================
        // 4. MAIN APP
        // ==========================================

        function App() {
            const { workspaces, userProfile, activeWorkspace, activeWorkspaceId, activePage, activePageId, themes, activeTheme, activeThemeId, fonts, actions, utils } = useAppStore();
            const [ui, setUi] = useState({ sidebarOpen: true, currentView: 'home', settingsSection: 'account', modals: { search: false, market: false, ai: false, workspaceMenu: false, iconPicker: false, iconPickerModal: false, coverGallery: false, pageOptions: false, createWorkspace: false, googleLogin: false }, marketTab: 'gallery', marketSubTab: 'store', iconPickerTab: 'emoji', notification: { show: false, message: '' }, isAuthenticated: true });
            const [showComments, setShowComments] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchFilters, setSearchFilters] = useState({ scope: 'current', sort: 'newest' });
            const [aiPrompt, setAiPrompt] = useState("");
            const [isAiGenerating, setIsAiGenerating] = useState(false);
            const [marketData, setMarketData] = useState({ styles: [], fonts: [], covers: [] });
            const [loadingMarket, setLoadingMarket] = useState(false);
            const fileInputRef = useRef(null);
            const [uploadContext, setUploadContext] = useState(null);
            const [newWorkspaceName, setNewWorkspaceName] = useState("");
            const [contextMenu, setContextMenu] = useState({ isOpen: false, pageId: null, x: 0, y: 0 });

            // Mobile check
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            useEffect(() => {
                const handleResize = () => {
                    const mobile = window.innerWidth < 768;
                    setIsMobile(mobile);
                    if (mobile && ui.sidebarOpen) setUi(p => ({ ...p, sidebarOpen: false }));
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Auth Session Handler
            const handleSession = useCallback((session) => {
                if (session) {
                    // 1. Restore Data if exists for this user
                    const userId = session.user.email;
                    const restored = BackupService.restoreBackup(userId);

                    // 2. Update UI State
                    setUi(p => ({ ...p.modals, googleLogin: false }, { isAuthenticated: true }));

                    // 3. Update Profile
                    actions.setUserProfile(prev => ({
                        ...prev,
                        name: session.user.user_metadata.full_name || session.user.email,
                        email: session.user.email,
                        avatar: session.user.user_metadata.avatar_url
                    }));

                    // 4. Sync State with Restored Data
                    if (restored) {
                        const ws = JSON.parse(localStorage.getItem('notion_v82_ws'));
                        const themes = JSON.parse(localStorage.getItem('notion_v82_themes'));
                        const fonts = JSON.parse(localStorage.getItem('notion_v82_fonts'));
                        const activeId = JSON.parse(localStorage.getItem('notion_v82_active_id'));
                        const activeTheme = JSON.parse(localStorage.getItem('notion_v82_active_theme'));

                        if (ws) actions.setWorkspaces(ws);
                        if (themes) actions.setThemes(themes);
                        if (fonts) actions.setFonts(fonts);
                        if (activeId) actions.setActiveWorkspaceId(activeId);
                        if (activeTheme) actions.setActiveThemeId(activeTheme);

                        showNotify("Sesi√≥n restaurada correctamente");
                    }
                } else {
                    setUi(p => ({ ...p.modals, googleLogin: true }, { isAuthenticated: false }));
                }
            }, [actions]);

            // Check authentication on load
            useEffect(() => {
                const initAuth = async () => {
                    if (supabase) {
                        const { data: { session } } = await supabase.auth.getSession();
                        handleSession(session);

                        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                            handleSession(session);
                        });

                        return () => subscription.unsubscribe();
                    } else {
                        const hasAuth = localStorage.getItem('notion_mock_user');
                        if (hasAuth) {
                            handleSession({ user: JSON.parse(hasAuth) });
                        } else {
                            handleSession(null);
                        }
                    }
                };
                initAuth();
            }, [handleSession]);

            // Expose setters for restoration
            useEffect(() => {
                if (actions.internalSetters) {
                    window.internalSetters = actions.internalSetters;
                }
            }, [actions]);

            // Search Logic
            const filteredPages = useMemo(() => {
                let pagesToSearch = [];
                if (searchFilters.scope === 'all') workspaces.forEach(ws => ws.pages.forEach(p => { if (!p.isDeleted) pagesToSearch.push({ ...p, workspaceName: ws.name, workspaceId: ws.id }); }));
                else if (activeWorkspace) activeWorkspace.pages.forEach(p => { if (!p.isDeleted) pagesToSearch.push({ ...p, workspaceName: activeWorkspace.name, workspaceId: activeWorkspace.id }); });
                let results = pagesToSearch;
                if (searchQuery.trim()) results = results.filter(p => p.title.toLowerCase().includes(searchQuery.toLowerCase()));
                results.sort((a, b) => searchFilters.sort === 'newest' ? new Date(b.updatedAt) - new Date(a.updatedAt) : searchFilters.sort === 'oldest' ? new Date(a.updatedAt) - new Date(b.updatedAt) : a.title.localeCompare(b.title));
                return results;
            }, [searchQuery, activeWorkspace, workspaces, searchFilters]);

            const inboxPages = useMemo(() => activeWorkspace?.pages.filter(p => p.inInbox === true && !p.isDeleted) || [], [activeWorkspace]);
            const trashPages = useMemo(() => activeWorkspace?.pages.filter(p => p.isDeleted === true) || [], [activeWorkspace]);

            const showNotify = (msg, type = 'success') => {
                // Show toast
                setUi(p => ({ ...p, notification: { show: true, message: msg } }));
                setTimeout(() => setUi(p => ({ ...p, notification: { show: false, message: '' } })), 3000);

                // Create notification in inbox
                const icons = { success: '‚úÖ', error: '‚ùå', info: 'üîî', warning: '‚ö†Ô∏è', ai: '‚ú®', copy: 'üìã', delete: 'üóëÔ∏è', theme: 'üé®', upload: '‚¨ÜÔ∏è' };
                const notificationId = actions.addPage({
                    title: msg,
                    icon: icons[type] || icons.info,
                    inInbox: true,
                    blocks: [{ id: utils.generateId(), type: 'p', content: `Notificaci√≥n: ${msg}` }],
                    notificationType: type
                });
            };
            const toggleModal = (n, v) => { setUi(p => ({ ...p, modals: { ...p.modals, [n]: v } })); if (n === 'market' && v && marketData.styles.length === 0) fetchMarketData(); };
            const handleContextMenu = (pageId, event) => {
                const rect = event.currentTarget.getBoundingClientRect();
                setContextMenu({ isOpen: true, pageId, x: rect.right + 8, y: rect.top });
            };

            const handleCreateWorkspace = () => {
                if (!newWorkspaceName.trim()) { showNotify("El nombre es obligatorio"); return; }
                actions.addWorkspace(newWorkspaceName);
                setNewWorkspaceName("");
                toggleModal('createWorkspace', false);
                toggleModal('workspaceMenu', false);
                setUi(p => ({ ...p, currentView: 'home' }));
                showNotify("Espacio de trabajo creado");
            };

            const generatePageWithAI = async () => {
                if (!aiPrompt.trim()) return;
                setIsAiGenerating(true);

                // 1. Create the Real Page (Sidebar)
                const pageId = actions.addPage({
                    title: "Generando...",
                    icon: <Loader2 className="animate-spin" size={14} />,
                    isGenerating: true,
                    inInbox: false // Explicitly in Sidebar
                });

                // 2. Add Notification to Inbox (Temporary)
                const notificationId = actions.addPage({
                    title: `Notificaci√≥n: Generando "${aiPrompt}"`,
                    icon: 'üîî',
                    inInbox: true, // In Inbox
                    blocks: [{ id: utils.generateId(), type: 'p', content: 'La IA est√° generando tu p√°gina. Te avisaremos cuando termine.' }]
                });

                toggleModal('ai', false);
                try {
                    let data;
                    if (USE_MOCK_API) {
                        await utils.delay(3000);
                        const rawResponse = `\`\`\`json
{
  "title": "${aiPrompt}",
  "icon": "ü§ñ",
  "cover": "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=900",
  "blocks": [
    { "type": "h1", "content": "Resultados para: ${aiPrompt}" },
    { "type": "p", "content": "Contenido generado por Gemini 1.5 Pro basado en tu solicitud." },
    { "type": "callout", "content": "Nota: Este contenido es generado por IA." }
  ]
}
\`\`\``;
                        const cleanJson = rawResponse.replace(/```json|```/g, '').trim();
                        data = JSON.parse(cleanJson);
                    }

                    // Update Real Page
                    actions.updatePage(pageId, { title: data.title, icon: data.icon, cover: data.cover, blocks: data.blocks?.map(b => ({ ...b, id: utils.generateId() })) || [], isGenerating: false });

                    // Update Notification in Inbox
                    actions.updatePage(notificationId, { title: `Completado: ${data.title}`, icon: '‚úÖ', blocks: [{ id: utils.generateId(), type: 'p', content: `La p√°gina "${data.title}" se ha generado correctamente en tu espacio de trabajo.` }] });

                    showNotify("P√°gina generada con Gemini ‚ú®");
                } catch (e) {
                    actions.deletePage(pageId);
                    actions.updatePage(notificationId, { title: `Error: ${aiPrompt}`, icon: '‚ùå', blocks: [{ id: utils.generateId(), type: 'p', content: 'Hubo un error al generar la p√°gina.' }] });
                    showNotify("Error generando p√°gina");
                    console.error(e);
                } finally { setIsAiGenerating(false); setAiPrompt(""); }
            };

            const fetchMarketData = async () => {
                setLoadingMarket(true);
                try {
                    // Simulate dynamic API call to Vercel/GitHub Proxy
                    // In a real scenario: const res = await fetch('/api/market'); const data = await res.json();

                    // We simulate the response structure that the backend would return
                    // This is "dynamic" in the sense that it's not a hardcoded list of components, but a data structure representing files
                    const mockApiResponse = [
                        { name: 'medieval-theme.css', url: 'stylessApp/medieval-theme.css', type: 'css' },
                        { name: 'gaming-theme.css', url: 'stylessApp/gaming-theme.css', type: 'css' },
                        { name: 'rock-metal-theme.css', url: 'stylessApp/rock-metal-theme.css', type: 'css' },
                        { name: 'default-theme.css', url: 'stylessApp/default-theme.css', type: 'css' }
                    ];

                    // Simulate network latency
                    await utils.delay(800);

                    const styles = mockApiResponse.map(f => {
                        const id = f.name.replace('.css', '');
                        return {
                            id: id,
                            name: id.charAt(0).toUpperCase() + id.slice(1).replace('-theme', '').replace('-', ' '),
                            author: 'Fixius50',
                            type: 'css',
                            url: f.url,
                            colors: id.includes('medieval') ? { bg: '#f3e8c8', text: '#1a0f08', sidebar: '#26160c' } :
                                id.includes('gaming') ? { bg: '#09090b', text: '#ffffff', sidebar: '#000000' } :
                                    id.includes('rock') ? { bg: '#1c1c1c', text: '#e0e0e0', sidebar: '#111111' } :
                                        { bg: '#ffffff', text: '#000000', sidebar: '#f0f0f0' }
                        };
                    });

                    setMarketData({
                        styles: styles,
                        fonts: [],
                        covers: ["https://images.unsplash.com/photo-1497436072909-60f360e1d4b0?w=600"]
                    });
                } catch { setMarketData({ styles: [], fonts: [], covers: [] }); } finally { setLoadingMarket(false); }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Simulate Vercel Blob Upload
                // In a real app, this would POST to /api/upload
                showNotify("Subiendo a Vercel Blob...");
                await utils.delay(1500); // Simulate network delay

                // Mock public URL returned by Vercel Blob
                const url = URL.createObjectURL(file); // Still use local URL for demo, but logic mimics async upload

                if (uploadContext === 'cover') { actions.updatePage(activePageId, { cover: url }); toggleModal('market', false); }
                else if (uploadContext === 'avatar') actions.setUserProfile(p => ({ ...p, avatar: url }));

                showNotify("Subida completada (Simulada)");
                setUploadContext(null);
            };
            const triggerUpload = (ctx) => { setUploadContext(ctx); if (fileInputRef.current) { fileInputRef.current.value = ''; fileInputRef.current.click(); } };

            const activeThemeStyle = activeTheme ? { '--bg-color': activeTheme.colors?.bg || '#ffffff', '--text-color': activeTheme.colors?.text || '#37352f', '--sidebar-bg': activeTheme.colors?.sidebar || '#F7F7F5' } : {};

            if (!activeWorkspace) return null;

            return (
                <div className="flex h-screen w-full font-sans selection:bg-[#cce9ff] relative overflow-hidden transition-colors duration-300" style={activeThemeStyle}>
                    {/* Notification */}
                    <AnimatePresence>
                        {ui.notification.show && (<motion.div initial={{ opacity: 0, y: 20, scale: 0.9 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: 20, scale: 0.9 }} className="fixed bottom-6 right-6 bg-zinc-900 text-white py-3 px-4 rounded-lg shadow-2xl flex items-center gap-3 z-[100] max-w-xs md:max-w-sm cursor-pointer border border-white/10 hover:bg-black transition-all" onClick={() => setUi(p => ({ ...p, notification: { show: false } }))}><div className="bg-green-500/20 p-1 rounded-full text-green-400"><Check size={14} /></div><div className="flex-1 text-sm font-medium">{ui.notification.message}</div></motion.div>)}
                    </AnimatePresence>

                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept="image/*" />

                    {/* SIDEBAR */}
                    <motion.aside initial={false} animate={{ width: ui.sidebarOpen ? (isMobile ? '100%' : 'var(--sidebar-width)') : (isMobile ? '0rem' : '3.5rem') }} style={{ backgroundColor: 'var(--sidebar-bg)' }} className="h-full flex flex-col z-20 relative border-r border-[#E9E9E8] transition-all duration-300 group/sidebar overflow-hidden absolute md:relative">
                        {/* RESIZE HANDLE */}
                        {ui.sidebarOpen && !isMobile && (
                            <div
                                className="absolute right-0 top-0 w-1 h-full cursor-col-resize hover:bg-indigo-500/50 z-50 transition-colors delay-100"
                                onMouseDown={(e) => {
                                    e.preventDefault();
                                    const startX = e.clientX;
                                    const startWidth = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width')) * 16; // approx rem to px
                                    const handleMouseMove = (moveEvent) => {
                                        const newWidth = startWidth + (moveEvent.clientX - startX);
                                        if (newWidth > 9.375 * 16 && newWidth < 25 * 16) {
                                            document.documentElement.style.setProperty('--sidebar-width', `${newWidth / 16}rem`);
                                        }
                                    };
                                    const handleMouseUp = () => {
                                        document.removeEventListener('mousemove', handleMouseMove);
                                        document.removeEventListener('mouseup', handleMouseUp);
                                    };
                                    document.addEventListener('mousemove', handleMouseMove);
                                    document.addEventListener('mouseup', handleMouseUp);
                                }}
                            />
                        )}
                        <div className="p-3 relative shrink-0">
                            <div onClick={() => toggleModal('workspaceMenu', !ui.modals.workspaceMenu)} className={clsx("flex items-center gap-2 p-1.5 rounded-md hover:bg-[var(--item-hover)] transition-colors cursor-pointer relative z-20 min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}>
                                <div className={`w-5 h-5 rounded-[3px] bg-gradient-to-br ${activeWorkspace.color} flex items-center justify-center text-white text-[10px] font-bold shadow-sm shrink-0`}>{activeWorkspace.initial}</div>
                                {ui.sidebarOpen && <><div className="flex-1 overflow-hidden text-sm font-medium truncate opacity-90">{activeWorkspace.name}</div><ChevronDown size={12} className="opacity-50" /></>}
                            </div>
                            <AnimatePresence>
                                {ui.modals.workspaceMenu && ui.sidebarOpen && (
                                    <>
                                        <div className="fixed inset-0 z-10" onClick={() => toggleModal('workspaceMenu', false)} />
                                        <motion.div initial={{ opacity: 0, y: -10, scale: 0.95 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: -10, scale: 0.95 }} transition={{ duration: 0.15 }} className="absolute top-12 left-2 right-2 bg-white border border-zinc-200 rounded-lg shadow-xl z-50 overflow-hidden text-zinc-800 origin-top">
                                            <div className="p-2 border-b border-zinc-100 bg-zinc-50/50"><span className="text-[10px] font-bold text-zinc-400 uppercase px-2">Espacios</span></div>
                                            <div className="max-h-48 overflow-y-auto">
                                                {workspaces.map(ws => (
                                                    <div key={ws.id} onClick={() => { actions.setActiveWorkspaceId(ws.id); toggleModal('workspaceMenu', false); setUi(p => ({ ...p, currentView: 'home' })); }} className="flex items-center gap-2 p-2 hover:bg-zinc-100 cursor-pointer text-sm group/ws">
                                                        <div className={`w-5 h-5 rounded-[3px] bg-gradient-to-br ${ws.color} text-white flex items-center justify-center text-[10px]`}>{ws.initial}</div>
                                                        <span className={`flex-1 truncate ${ws.id === activeWorkspaceId ? 'font-medium' : ''}`}>{ws.name}</span>
                                                        {ws.id === activeWorkspaceId && <Check size={14} className="text-indigo-600" />}
                                                    </div>
                                                ))}
                                            </div>
                                            <div onClick={() => toggleModal('createWorkspace', true)} className="p-2 border-t border-zinc-100 hover:bg-zinc-50 cursor-pointer flex items-center gap-2 text-sm text-zinc-600"><PlusCircle size={14} /> <span>Crear Nuevo</span></div>
                                        </motion.div>
                                    </>
                                )}
                            </AnimatePresence>
                        </div>
                        <div className="flex-1 overflow-y-auto px-2 space-y-0.5 fancy-scroll">
                            {[{ icon: Search, label: 'Buscar', action: () => toggleModal('search', true) }, { icon: SidebarIcon, label: 'Inicio', action: () => { setUi(p => ({ ...p, currentView: 'home' })); actions.setActivePageId(null); if (isMobile) setUi(p => ({ ...p, sidebarOpen: false })); } }, { icon: Inbox, label: 'Bandeja', action: () => { setUi(p => ({ ...p, currentView: 'inbox' })); actions.setActivePageId(null); if (isMobile) setUi(p => ({ ...p, sidebarOpen: false })); } }, { icon: Sparkles, label: 'IA Notion', action: () => toggleModal('ai', true), color: 'text-yellow-600' }].map((item, i) => (
                                <div key={i} onClick={item.action} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}>
                                    <item.icon size={18} className={clsx("shrink-0 opacity-70", item.color)} />
                                    {ui.sidebarOpen && <span className="text-sm font-medium opacity-80">{item.label}</span>}
                                    {item.label === 'Bandeja' && inboxPages.length > 0 && ui.sidebarOpen && (<div className="bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full ml-auto">{inboxPages.length}</div>)}
                                </div>
                            ))}
                            <div className="mt-6 mb-1 px-2 flex justify-between items-center group/header">{ui.sidebarOpen && <span className="text-xs font-semibold opacity-50">P√ÅGINAS</span>}{ui.sidebarOpen && <button onClick={(e) => { e.stopPropagation(); const id = actions.addPage(); setUi(p => ({ ...p, currentView: 'page' })); actions.setActivePageId(id); if (isMobile) setUi(p => ({ ...p, sidebarOpen: false })); }} className="opacity-0 group-hover/header:opacity-100 transition-opacity p-1 hover:bg-[rgba(0,0,0,0.05)] rounded"><Plus size={14} /></button>}</div>
                            {activeWorkspace.pages.filter(p => !p.inInbox && !p.isDeleted && !p.parentId).map(page => (
                                <SidebarItem key={page.id} page={page} actions={actions} ui={ui} setUi={setUi} activePageId={activePageId} allPages={activeWorkspace.pages} onContextMenu={handleContextMenu} />
                            ))}
                        </div>
                        <div className="p-2 border-t border-[#E9E9E8] space-y-0.5">
                            <div onClick={() => toggleModal('market', true)} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><Palette size={18} className="shrink-0 opacity-70" /> {ui.sidebarOpen && <span className="text-sm opacity-80">Marketplace</span>}</div>
                            <div onClick={() => setUi(p => ({ ...p, currentView: 'settings' }))} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><Settings size={18} className="shrink-0 opacity-70" /> {ui.sidebarOpen && <span className="text-sm opacity-80">Configuraci√≥n</span>}</div>
                            <div onClick={() => { setUi(p => ({ ...p, currentView: 'trash' })); actions.setActivePageId(null); }} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><Trash size={18} className="shrink-0 opacity-70" /> {ui.sidebarOpen && <span className="text-sm opacity-80">Papelera</span>}</div>
                            <div onClick={() => setUi(p => ({ ...p, sidebarOpen: !p.sidebarOpen }))} className={clsx("flex items-center gap-3 p-1.5 rounded-md hover:bg-[rgba(0,0,0,0.05)] cursor-pointer mt-2 min-h-[2rem]", !ui.sidebarOpen && 'justify-start pl-1')}><ChevronsLeft size={18} className={`shrink-0 transition-transform opacity-50 ${!ui.sidebarOpen ? "rotate-180" : ""}`} /> {ui.sidebarOpen && <span className="text-sm opacity-60">Cerrar barra</span>}</div>
                        </div>
                    </motion.aside>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 h-full overflow-hidden relative flex flex-col transition-colors duration-300" style={{ backgroundColor: 'var(--bg-color)', color: 'var(--text-color)' }}>
                        <header className="h-12 flex items-center justify-between px-4 shrink-0 transition-colors z-10 sticky top-0 backdrop-blur-sm" style={{ backgroundColor: 'rgba(255,255,255,0.0)' }}>
                            <div className="flex items-center gap-2 text-sm opacity-60 overflow-hidden w-full">
                                {!ui.sidebarOpen && <button onClick={() => setUi(p => ({ ...p, sidebarOpen: true }))} className="p-1 hover:bg-[rgba(0,0,0,0.05)] rounded mr-2"><Menu size={18} /></button>}
                                {ui.currentView === 'home' && <div className="flex items-center gap-2"><Briefcase size={16} /><span>Inicio</span></div>}
                                {ui.currentView === 'inbox' && <div className="flex items-center gap-2"><Inbox size={16} /><span>Bandeja de Entrada</span></div>}
                                {ui.currentView === 'trash' && <div className="flex items-center gap-2"><Trash size={16} /><span>Papelera</span></div>}
                                {ui.currentView === 'settings' && <div className="flex items-center gap-2"><Settings size={16} /><span>Configuraci√≥n</span></div>}
                                {ui.currentView === 'page' && <div className="flex items-center gap-2 overflow-hidden w-full"><span className="text-lg">{activePage?.icon || <FileText size={16} />}</span><span className="truncate font-medium">{activePage?.title || 'Sin t√≠tulo'}</span></div>}
                            </div>
                            {ui.currentView === 'page' && (
                                <div className="relative ml-2"><button onClick={() => toggleModal('pageOptions', !ui.modals.pageOptions)} className="p-1 opacity-60 hover:opacity-100 hover:bg-[rgba(0,0,0,0.05)] rounded transition-colors"><MoreHorizontal size={20} /></button><AnimatePresence>{ui.modals.pageOptions && <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }} className="absolute right-0 top-8 w-56 bg-white border border-zinc-200 rounded-lg shadow-xl z-50 overflow-hidden py-1"><button onClick={() => { actions.deletePage(activePageId); toggleModal('pageOptions', false); setUi(p => ({ ...p, currentView: 'home' })); showNotify("P√°gina movida a papelera"); }} className="w-full text-left flex items-center gap-2 px-3 py-1.5 text-red-600 hover:bg-red-50 cursor-pointer text-sm"><Trash size={14} /> Eliminar</button></motion.div>}</AnimatePresence></div>
                            )}
                        </header>

                        <div className="flex-1 overflow-y-auto p-0 relative fancy-scroll">
                            {ui.currentView === 'home' && (() => {
                                const visiblePages = activeWorkspace.pages.filter(p => !p.isDeleted && !p.inInbox);
                                return visiblePages.length === 0 ? (
                                    <div className="max-w-2xl mx-auto h-full flex flex-col items-center justify-center p-8">
                                        <motion.div
                                            initial={{ scale: 0.8, opacity: 0, y: 20 }}
                                            animate={{ scale: 1, opacity: 1, y: 0 }}
                                            transition={{ type: "spring", duration: 0.8 }}
                                            className="text-center"
                                        >
                                            <motion.div
                                                animate={{ y: [0, -10, 0] }}
                                                transition={{ repeat: Infinity, duration: 2, ease: "easeInOut" }}
                                                className="text-6xl mb-6"
                                            >
                                                ‚ú®
                                            </motion.div>
                                            <h2 className="text-3xl font-bold mb-3 text-current">Empecemos a crear una p√°gina</h2>
                                            <p className="text-zinc-500 mb-8 max-w-md">Crea tu primera p√°gina y comienza a organizar tus ideas, proyectos y notas.</p>
                                            <motion.button
                                                onClick={() => { const id = actions.addPage(); actions.setActivePageId(id); setUi(p => ({ ...p, currentView: 'page' })); }}
                                                whileHover={{ scale: 1.05 }}
                                                whileTap={{ scale: 0.95 }}
                                                className="bg-zinc-900 text-white px-6 py-3 rounded-lg font-medium hover:bg-black transition-colors flex items-center gap-2 mx-auto shadow-lg"
                                            >
                                                <Plus size={18} />
                                                Crear primera p√°gina
                                            </motion.button>
                                        </motion.div>
                                    </div>
                                ) : (
                                    <div className="max-w-6xl mx-auto py-12 px-6">
                                        <div className="mb-8">
                                            <h1 className="text-2xl font-bold mb-2 text-current">Hola, {userProfile.name}</h1>
                                            <p className="text-zinc-500">Contin√∫a donde lo dejaste</p>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {visiblePages.slice(0, 12).map(page => (
                                                <motion.div
                                                    key={page.id}
                                                    initial={{ opacity: 0, y: 20 }}
                                                    animate={{ opacity: 1, y: 0 }}
                                                    whileHover={{ y: -4, scale: 1.02 }}
                                                    onClick={() => { actions.setActivePageId(page.id); setUi(p => ({ ...p, currentView: 'page' })); }}
                                                    className="bg-white border border-zinc-200 rounded-lg overflow-hidden cursor-pointer shadow-sm hover:shadow-md transition-all"
                                                >
                                                    <div className="h-32 relative" style={{ background: page.cover?.includes('http') ? 'transparent' : (page.cover || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)') }}>
                                                        {page.cover?.includes('http') && <img src={page.cover} className="w-full h-full object-cover" />}
                                                    </div>
                                                    <div className="p-4">
                                                        <div className="flex items-start gap-3">
                                                            <div className="text-3xl shrink-0">{page.icon || 'üìÑ'}</div>
                                                            <div className="flex-1 min-w-0">
                                                                <h3 className="font-semibold text-zinc-900 truncate mb-1">{page.title || 'Sin t√≠tulo'}</h3>
                                                                <p className="text-xs text-zinc-400">Editado {formatDistanceToNow(new Date(page.updatedAt))} ago</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </motion.div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}
                            {ui.currentView === 'inbox' && (
                                <div className="max-w-3xl mx-auto py-12 px-6">
                                    <h1 className="text-2xl font-bold mb-8 text-current flex items-center gap-2"><Inbox size={24} /> Bandeja de Entrada</h1>
                                    {inboxPages.length === 0 ? <div className="text-center py-12 opacity-50"><div className="mb-2 text-4xl">üì¨</div>No tienes notificaciones.</div> : (<div className="grid gap-4">{inboxPages.map(page => (<SpotlightCard key={page.id} className="p-4 flex items-center justify-between cursor-pointer" onClick={() => { actions.updatePage(page.id, { inInbox: false }); }}><div className="flex items-center gap-4"><div className="text-2xl">{page.icon}</div><div><div className="font-bold text-zinc-800">{page.title}</div><div className="text-xs text-zinc-500">{formatDistanceToNow(new Date(page.updatedAt))} ago</div></div></div><div className="flex items-center gap-2"><button onClick={(e) => { e.stopPropagation(); actions.deletePage(page.id); }} className="p-2 hover:bg-zinc-100 rounded-full text-zinc-400 hover:text-zinc-600" title="Eliminar"><X size={16} /></button></div></SpotlightCard>))}</div>)}
                                </div>
                            )}
                            {ui.currentView === 'trash' && (
                                <div className="max-w-3xl mx-auto py-12 px-6">
                                    <h1 className="text-2xl font-bold mb-8 text-current flex items-center gap-2"><Trash size={24} /> Papelera</h1>
                                    <p className="text-sm opacity-60 mb-6">Las p√°ginas aqu√≠ pueden ser restauradas o eliminadas para siempre.</p>
                                    {trashPages.length === 0 ? <div className="text-center py-12 opacity-50"><div className="mb-2 text-4xl">üóëÔ∏è</div>Papelera vac√≠a.</div> : (
                                        <div className="grid gap-3">{trashPages.map(page => (<div key={page.id} className="p-3 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm"><div className="flex items-center gap-3 opacity-60"><div className="text-lg">{page.icon || <FileText size={16} />}</div><div><div className="font-medium text-sm text-zinc-900">{page.title || 'Sin t√≠tulo'}</div><div className="text-xs text-zinc-500">Borrado {formatDistanceToNow(new Date(page.deletedAt || new Date()))} ago</div></div></div><div className="flex gap-2"><button onClick={() => { actions.restorePage(page.id); showNotify("P√°gina restaurada"); }} className="flex items-center gap-1 bg-zinc-100 text-zinc-700 text-xs px-3 py-1.5 rounded hover:bg-zinc-200"><Undo2 size={12} /> Restaurar</button><button onClick={() => { if (confirm("¬øBorrar definitivamente?")) actions.permanentDeletePage(page.id); }} className="p-1.5 text-red-400 hover:bg-red-50 rounded"><Trash size={14} /></button></div></div>))}</div>
                                    )}
                                </div>
                            )}
                            {ui.currentView === 'settings' && (
                                <div className="flex h-full">
                                    <div className="w-48 bg-[var(--sidebar-bg)] border-r border-[rgba(0,0,0,0.05)] pt-8 px-2 space-y-1"><div className="px-3 py-2 text-xs font-bold opacity-50 uppercase mb-2">Cuenta</div><button onClick={() => setUi(p => ({ ...p, settingsSection: 'account' }))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'account' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Mi Perfil</button><button onClick={() => setUi(p => ({ ...p, settingsSection: 'themes' }))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'themes' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Temas & Apariencia</button><button onClick={() => setUi(p => ({ ...p, settingsSection: 'marketplace' }))} className={clsx("w-full text-left px-3 py-1.5 rounded-md text-sm transition-colors", ui.settingsSection === 'marketplace' ? "bg-[rgba(0,0,0,0.05)] font-medium" : "opacity-70 hover:opacity-100 hover:bg-[rgba(0,0,0,0.02)]")}>Marketplace</button></div>
                                    <div className="flex-1 overflow-y-auto px-12 py-12">
                                        {ui.settingsSection === 'account' && (<div className="max-w-2xl animate-in fade-in duration-300"><h1 className="text-xl font-bold mb-6 pb-2 border-b border-[rgba(0,0,0,0.1)]">Mi Perfil</h1><div className="flex items-start gap-6 mb-8"><div onClick={() => triggerUpload('avatar')} className="w-24 h-24 bg-zinc-100 rounded-full flex items-center justify-center cursor-pointer hover:opacity-80 transition-opacity overflow-hidden border border-zinc-200 shrink-0">{userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : <Camera size={32} className="text-zinc-300" />}</div><div className="flex-1 space-y-4"><div><label className="text-xs font-bold opacity-50 uppercase block mb-1">Nombre preferido</label><input value={userProfile.name} onChange={e => actions.setUserProfile(p => ({ ...p, name: e.target.value }))} className="w-full p-2 border border-zinc-200 rounded text-sm outline-none focus:border-zinc-400 bg-transparent transition-colors" /></div><div><label className="text-xs font-bold opacity-50 uppercase block mb-1">Correo electr√≥nico</label><input value={userProfile.email} disabled className="w-full p-2 border border-zinc-200 rounded text-sm bg-[rgba(0,0,0,0.02)] opacity-60 cursor-not-allowed" /></div></div></div><button onClick={async () => {
                                            // 1. Backup Data
                                            BackupService.saveBackup(userProfile.email);
                                            // 2. Logout
                                            await AuthService.logout();
                                            // 3. Clear Local Data
                                            BackupService.clearLocalData();
                                            // 4. Reload to reset state and show login
                                            window.location.reload();
                                        }} className="text-red-600 border border-red-200 px-4 py-2 rounded hover:bg-red-50 text-sm font-medium flex items-center gap-2"><LogOut size={16} /> Cerrar Sesi√≥n</button></div>)}
                                        {ui.settingsSection === 'themes' && (
                                            <div className="max-w-2xl animate-in fade-in duration-300">
                                                <h1 className="text-xl font-bold mb-6 pb-2 border-b border-[rgba(0,0,0,0.1)]">Apariencia</h1>
                                                <div className="space-y-3">
                                                    <div className="p-4 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm"><div className="flex items-center gap-3"><div className="w-12 h-12 bg-white border border-zinc-200 rounded-md flex items-center justify-center text-lg font-serif">Aa</div><div><div className="font-bold text-sm text-zinc-900">stylessApp (Default)</div><div className="text-xs text-zinc-500">Tema original (Claro)</div></div></div><button onClick={() => actions.setActiveThemeId('default')} disabled={activeThemeId === 'default'} className={clsx("px-3 py-1.5 rounded text-xs transition-colors", activeThemeId === 'default' ? "bg-green-100 text-green-700 cursor-default font-medium" : "bg-zinc-900 text-white hover:bg-black")}>{activeThemeId === 'default' ? "Activo" : "Aplicar"}</button></div>
                                                    {themes.filter(t => t.id !== 'default').map(t => (<div key={t.id} className="p-4 border border-zinc-200 rounded-lg flex justify-between items-center bg-white shadow-sm"><div className="flex items-center gap-3"><div className="w-12 h-12 rounded-md flex items-center justify-center text-lg font-bold text-white shadow-inner" style={{ backgroundColor: t.colors?.bg || '#333', color: t.colors?.text || '#fff' }}>Aa</div><div><div className="font-bold text-sm text-zinc-900">{t.name}</div><div className="text-xs text-zinc-500">Por {t.author}</div></div></div><div className="flex gap-2"><button onClick={() => { actions.removeTheme(t.id); showNotify("Tema eliminado"); }} className="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash size={14} /></button><button onClick={() => actions.setActiveThemeId(t.id)} disabled={activeThemeId === t.id} className={clsx("px-3 py-1.5 rounded text-xs transition-colors", activeThemeId === t.id ? "bg-green-100 text-green-700 cursor-default font-medium" : "bg-zinc-900 text-white hover:bg-black")}>{activeThemeId === t.id ? "Activo" : "Aplicar"}</button></div></div>))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            {ui.currentView === 'page' && activePage && (
                                <motion.div key={activePage.id} initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="max-w-3xl mx-auto pb-48">
                                    <div className={clsx("group/cover relative w-full transition-all", activePage.cover ? "h-48 md:h-72" : "h-0")}>
                                        {activePage.cover && <img src={activePage.cover} className="w-full h-full object-cover" />}
                                        {activePage.cover && <button onClick={() => toggleModal('coverGallery', true)} className="absolute bottom-4 right-4 bg-white/90 hover:bg-white text-xs px-3 py-1.5 rounded shadow-sm text-zinc-600 border border-zinc-200 opacity-0 group-hover/cover:opacity-100 transition-opacity font-medium">Cambiar portada</button>}
                                    </div>
                                    <div className="px-8 md:px-24 pt-8">
                                        {/* Action Buttons (when no icon/cover) */}
                                        {!activePage.icon && !activePage.cover && (
                                            <div className="flex gap-2 mb-4 opacity-0 hover:opacity-100 transition-opacity">
                                                <button onClick={() => toggleModal('iconPickerModal', true)} className="flex items-center gap-1.5 px-3 py-1.5 text-xs text-zinc-600 hover:bg-zinc-100 rounded transition-colors">
                                                    <Smile size={14} />
                                                    A√±adir √≠cono
                                                </button>
                                                <button onClick={() => toggleModal('coverGallery', true)} className="flex items-center gap-1.5 px-3 py-1.5 text-xs text-zinc-600 hover:bg-zinc-100 rounded transition-colors">
                                                    <ImageIcon size={14} />
                                                    A√±adir portada
                                                </button>
                                            </div>
                                        )}
                                        {activePage.icon && (
                                            <div className="relative -mt-16 mb-4 z-10 group/icon">
                                                <div onClick={() => toggleModal('iconPickerModal', true)} className="text-7xl cursor-pointer hover:scale-105 transition-transform inline-block relative drop-shadow-sm">{activePage.icon}</div>
                                            </div>
                                        )}
                                        <input value={activePage.title} onChange={(e) => actions.updatePage(activePage.id, { title: e.target.value })} placeholder="T√≠tulo de la p√°gina" className="w-full text-4xl font-bold placeholder:opacity-50 border-none outline-none bg-transparent mb-8 text-current" />
                                        <div className="space-y-0.5 min-h-[300px]">{activePage.blocks.map((block, index) => (<EditorBlock key={block.id} block={block} index={index} actions={actions} />))}</div>
                                        <div className="h-32 -mx-4 cursor-text mt-4 opacity-0 hover:opacity-100 transition-opacity flex items-start pt-2 px-4 text-zinc-300 text-sm" onClick={() => actions.addBlock(activePage.blocks.length)}>Haz clic para escribir...</div>
                                    </div>
                                </motion.div>
                            )}
                        </div>
                    </main>

                    {/* MODALS */}
                    <AnimatePresence>
                        {ui.modals.search && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={() => toggleModal('search', false)} className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[60]" />
                                <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} className="fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden border border-zinc-200 flex flex-col">
                                    <div className="p-4 border-b border-zinc-100 bg-[#FBFBFA]">
                                        <div className="flex items-center gap-3 bg-white px-3 py-3 rounded-lg border border-zinc-200 shadow-sm mb-3"><Search className="text-zinc-400" size={18} />
                                            <input
                                                autoFocus
                                                value={searchQuery}
                                                onChange={e => setSearchQuery(e.target.value)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'ArrowDown') {
                                                        e.preventDefault();
                                                        document.getElementById('search-result-0')?.focus();
                                                    }
                                                }}
                                                placeholder="Busca en tus p√°ginas..."
                                                className="bg-transparent w-full outline-none text-base placeholder:text-zinc-400 text-zinc-700"
                                            />
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
                                                <span className="text-[10px] font-bold text-zinc-400 uppercase shrink-0">Alcance</span>
                                                <div className="flex bg-zinc-100 p-0.5 rounded-lg shrink-0">
                                                    <button onClick={() => setSearchFilters(p => ({ ...p, scope: 'current' }))} className={clsx("px-2 py-1 text-xs font-medium rounded-md transition-all", searchFilters.scope === 'current' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>Este espacio</button>
                                                    <button onClick={() => setSearchFilters(p => ({ ...p, scope: 'all' }))} className={clsx("px-2 py-1 text-xs font-medium rounded-md transition-all", searchFilters.scope === 'all' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>Todos</button>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
                                                <span className="text-[10px] font-bold text-zinc-400 uppercase shrink-0">Orden</span>
                                                <div className="flex bg-zinc-100 p-0.5 rounded-lg shrink-0">
                                                    <button onClick={() => setSearchFilters(p => ({ ...p, sort: 'newest' }))} className={clsx("px-2 py-1 text-xs font-medium rounded-md transition-all", searchFilters.sort === 'newest' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>Recientes</button>
                                                    <button onClick={() => setSearchFilters(p => ({ ...p, sort: 'oldest' }))} className={clsx("px-2 py-1 text-xs font-medium rounded-md transition-all", searchFilters.sort === 'oldest' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>Antiguos</button>
                                                    <button onClick={() => setSearchFilters(p => ({ ...p, sort: 'az' }))} className={clsx("px-2 py-1 text-xs font-medium rounded-md transition-all", searchFilters.sort === 'az' ? "bg-white shadow text-zinc-900" : "text-zinc-500 hover:text-zinc-700")}>A-Z</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-2 min-h-[300px] overflow-y-auto">
                                        {filteredPages.length > 0 ? filteredPages.map((p, idx) => (
                                            <div
                                                key={p.id}
                                                id={`search-result-${idx}`}
                                                tabIndex={0}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'ArrowDown') {
                                                        e.preventDefault();
                                                        document.getElementById(`search-result-${idx + 1}`)?.focus();
                                                    } else if (e.key === 'ArrowUp') {
                                                        e.preventDefault();
                                                        if (idx === 0) toggleModal('search', true); // focus back to input? actually just focus input
                                                        else document.getElementById(`search-result-${idx - 1}`)?.focus();
                                                    } else if (e.key === 'Enter') {
                                                        if (p.workspaceId && p.workspaceId !== activeWorkspaceId) actions.setActiveWorkspaceId(p.workspaceId);
                                                        actions.setActivePageId(p.id);
                                                        setUi(prev => ({ ...prev, currentView: 'page', modals: { ...prev.modals, search: false } }));
                                                    }
                                                }}
                                                onClick={() => { if (p.workspaceId && p.workspaceId !== activeWorkspaceId) actions.setActiveWorkspaceId(p.workspaceId); actions.setActivePageId(p.id); setUi(prev => ({ ...prev, currentView: 'page', modals: { ...prev.modals, search: false } })); }}
                                                className="flex items-center gap-3 p-2 hover:bg-zinc-100 focus:bg-zinc-100 rounded cursor-pointer group outline-none"
                                            >
                                                <div className="text-xl">{p.icon || 'üìÑ'}</div>
                                                <div className="flex-1">
                                                    <div className="text-sm font-medium text-zinc-800">{p.title || 'Sin t√≠tulo'}</div>
                                                    <div className="text-xs text-zinc-400 flex items-center gap-1"><span className="opacity-70">{p.workspaceName || activeWorkspace.name}</span><span className="opacity-40">/</span><span>{p.title}</span></div>
                                                </div>
                                            </div>
                                        )) : <div className="text-center text-zinc-400 mt-12 text-sm">No se encontraron resultados</div>}
                                    </div>
                                </motion.div>
                            </>
                        )}
                        {ui.modals.ai && (
                            <Modal isOpen={true} onClose={() => toggleModal('ai', false)} title={null} transparent={true}>
                                <div className="flex items-center justify-center h-full p-4">
                                    <motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-zinc-200">
                                        <div className="p-6 bg-gradient-to-br from-indigo-50 to-white">
                                            <h2 className="text-lg font-bold text-zinc-800 mb-2 flex items-center gap-2"><Sparkles size={18} className="text-indigo-500" /> Notion AI</h2>
                                            <p className="text-sm text-zinc-500 mb-4">Describe lo que necesitas. La p√°gina se generar√° en segundo plano.</p>
                                            <textarea autoFocus value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Ej: Rutina de gimnasio para 3 d√≠as..." className="w-full bg-white border border-zinc-200 rounded-xl p-4 h-32 resize-none no-ring focus:border-zinc-400 transition-colors mb-4 text-zinc-700 text-sm" />
                                            <div className="flex justify-end gap-2">
                                                <button onClick={() => toggleModal('ai', false)} className="px-4 py-2 rounded-lg text-zinc-500 hover:bg-zinc-100 text-sm font-medium">Cancelar</button>
                                                <button onClick={generatePageWithAI} disabled={isAiGenerating} className="px-4 py-2 rounded-lg bg-zinc-900 text-white font-medium text-sm hover:bg-black transition-colors disabled:opacity-50 flex items-center gap-2">{isAiGenerating ? <Loader2 className="animate-spin" size={16} /> : <Wand2 size={16} />} Generar</button>
                                            </div>
                                        </div>
                                    </motion.div>
                                </div>
                            </Modal>
                        )}
                        {ui.modals.market && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={() => toggleModal('market', false)} className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[60]" />
                                <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} className="fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden border border-zinc-200 flex flex-col">
                                    <div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0 bg-white"><h2 className="text-sm font-semibold text-zinc-700">Marketplace</h2><button onClick={() => toggleModal('market', false)} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18} /></button></div>
                                    <div className="flex-1 overflow-y-auto p-6">
                                        <FancyTabs tabs={[{ id: 'gallery', label: 'Galer√≠a' }, { id: 'styles', label: 'Estilos & Temas' }, { id: 'fonts', label: 'Fuentes' }]} activeTab={ui.marketTab} onTabChange={(id) => setUi(p => ({ ...p, marketTab: id }))} />
                                        <div className="mt-6">
                                            {ui.marketTab === 'gallery' && (<div className="grid grid-cols-2 md:grid-cols-4 gap-4">{marketData.covers.map((url, i) => (<SpotlightCard key={i} onClick={() => { actions.updatePage(activePageId, { cover: url }); toggleModal('market', false); }} className="h-32 cursor-pointer"><img src={url} className="w-full h-full object-cover" /></SpotlightCard>))}</div>)}
                                            {ui.marketTab === 'styles' && (<div className="grid grid-cols-1 md:grid-cols-3 gap-4">{marketData.styles.length === 0 ? <div className="col-span-full text-center py-12 text-zinc-400">No hay temas disponibles.</div> : marketData.styles.map(style => { const isInstalled = themes.some(t => t.id === style.id || t.name === style.name); return (<SpotlightCard key={style.id} className="p-4 flex flex-col justify-between bg-white h-full"><div className="flex items-center gap-3 mb-3"><div className="w-10 h-10 rounded bg-gradient-to-br from-zinc-100 to-zinc-200 flex items-center justify-center font-serif font-bold text-zinc-400">Aa</div><div><div className="font-bold text-sm text-zinc-800">{style.name}</div><div className="text-xs text-zinc-500">Remoto</div></div></div>{isInstalled ? <button onClick={() => { actions.removeTheme(style.id); showNotify("Tema desinstalado"); }} className="w-full flex justify-center items-center gap-1 bg-red-50 text-red-500 text-xs px-3 py-2 rounded hover:bg-red-100 font-medium transition-colors"><Trash size={12} /> Desinstalar</button> : <button onClick={() => { actions.addTheme({ ...style }); showNotify("Tema instalado"); }} className="w-full flex justify-center items-center gap-1 bg-zinc-900 text-white text-xs px-3 py-2 rounded hover:bg-black font-medium transition-colors"><Download size={12} /> Instalar</button>}</SpotlightCard>); })}</div>)}
                                            {ui.marketTab === 'fonts' && (<div className="grid grid-cols-1 md:grid-cols-3 gap-4">{marketData.fonts.length === 0 ? <div className="col-span-full text-center py-12 text-zinc-400">No hay fuentes instaladas.</div> : marketData.fonts.map(f => (<div key={f.id} className="flex flex-col justify-between p-4 bg-white border border-zinc-200 rounded-lg h-32 hover:shadow-md transition-shadow"><div><div className="font-bold text-zinc-800 text-lg">{f.name}</div><div className="text-xs text-zinc-400">Local</div></div><button onClick={() => { actions.removeFont(f.id); showNotify("Fuente eliminada"); }} className="text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded w-fit">Eliminar</button></div>))}</div>)}
                                        </div>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>

                    {/* Context Menu (Global) */}
                    <AnimatePresence>
                        {contextMenu.isOpen && (
                            <>
                                <div className="fixed inset-0 z-[80]" onClick={() => setContextMenu({ isOpen: false, pageId: null, x: 0, y: 0 })} />
                                <motion.div
                                    initial={{ opacity: 0, scale: 0.95 }}
                                    animate={{ opacity: 1, scale: 1 }}
                                    exit={{ opacity: 0, scale: 0.95 }}
                                    style={{ left: `${contextMenu.x}px`, top: `${contextMenu.y}px` }}
                                    className="fixed w-48 bg-[#2F2F2F] border border-[#3F3F3F] rounded-lg shadow-xl z-[90] overflow-hidden text-[#D4D4D4] text-sm py-1"
                                >
                                    <div className="px-3 py-2 text-xs font-bold opacity-50 uppercase">P√°gina</div>
                                    <button onClick={() => { setContextMenu({ isOpen: false, pageId: null, x: 0, y: 0 }); }} className="w-full text-left px-3 py-1.5 hover:bg-[#3F3F3F] flex items-center gap-2"><StarIcon size={14} /> A√±adir a favoritos</button>
                                    <button onClick={() => { navigator.clipboard.writeText(window.location.href); setContextMenu({ isOpen: false, pageId: null, x: 0, y: 0 }); showNotify("Enlace copiado"); }} className="w-full text-left px-3 py-1.5 hover:bg-[#3F3F3F] flex items-center gap-2"><LinkIcon size={14} /> Copiar enlace</button>
                                    <button onClick={() => { actions.duplicatePage(contextMenu.pageId); setContextMenu({ isOpen: false, pageId: null, x: 0, y: 0 }); }} className="w-full text-left px-3 py-1.5 hover:bg-[#3F3F3F] flex items-center gap-2"><CopyIcon size={14} /> Duplicar <span className="ml-auto text-xs opacity-50">Ctrl+D</span></button>
                                    <button onClick={() => { setContextMenu({ isOpen: false, pageId: null, x: 0, y: 0 }); }} className="w-full text-left px-3 py-1.5 hover:bg-[#3F3F3F] flex items-center gap-2"><EditIcon size={14} /> Renombrar <span className="ml-auto text-xs opacity-50">Ctrl+R</span></button>
                                    <div className="h-px bg-[#3F3F3F] my-1" />
                                    <button onClick={() => { actions.deletePage(contextMenu.pageId); setContextMenu({ isOpen: false, pageId: null, x: 0, y: 0 }); }} className="w-full text-left px-3 py-1.5 hover:bg-[#3F3F3F] flex items-center gap-2 text-red-400"><Trash size={14} /> Mover a la Papelera</button>
                                </motion.div>
                            </>
                        )}

                        {/* Google OAuth Login Modal */}
                        {ui.modals.googleLogin && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100]" />
                                <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }} className="fixed inset-0 m-auto h-fit z-[110] w-full max-w-md">
                                    <div className="bg-white rounded-2xl shadow-2xl overflow-hidden border border-zinc-200">
                                        <div className="p-8 text-center">
                                            <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                                <FileText size={32} className="text-white" />
                                            </div>
                                            <h2 className="text-2xl font-bold mb-2 text-zinc-900">Bienvenido a Notion Clone</h2>
                                            <p className="text-zinc-500 mb-8">Inicia sesi√≥n para empezar a organizar tu vida</p>
                                            <button
                                                onClick={async () => {
                                                    try {
                                                        await AuthService.login();
                                                    } catch (e) {
                                                        console.error(e);
                                                        showNotify("Error al iniciar sesi√≥n", "error");
                                                    }
                                                }}
                                                className="w-full bg-white border-2 border-zinc-200 hover:border-zinc-300 text-zinc-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition-all hover:shadow-md group"
                                            >
                                                <svg className="w-5 h-5" viewBox="0 0 24 24">
                                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                                </svg>
                                                Continuar con Google
                                            </button>
                                            <p className="text-xs text-zinc-400 mt-4">Al continuar, aceptas nuestros t√©rminos y condiciones</p>
                                        </div>
                                    </div>
                                </motion.div>
                            </>
                        )}

                        {/* Icon Picker Modal */}
                        {ui.modals.iconPickerModal && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={() => toggleModal('iconPickerModal', false)} className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[60]" />
                                <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} className="fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden border border-zinc-200 flex flex-col">
                                    <div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0 bg-white"><h2 className="text-sm font-semibold text-zinc-700">Selecciona un √≠cono</h2><button onClick={() => toggleModal('iconPickerModal', false)} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18} /></button></div>
                                    <div className="border-b border-zinc-100 bg-zinc-50/50">
                                        <div className="flex gap-1 px-3 py-2">
                                            <button onClick={() => setUi(p => ({ ...p, iconPickerTab: 'emoji' }))} className={clsx("px-3 py-1.5 text-xs font-medium rounded-md transition-all", ui.iconPickerTab === 'emoji' ? "bg-white shadow-sm text-zinc-900 border border-zinc-200" : "text-zinc-500 hover:text-zinc-700 hover:bg-zinc-100")}>Emoji</button>
                                            <button onClick={() => setUi(p => ({ ...p, iconPickerTab: 'upload' }))} className={clsx("px-3 py-1.5 text-xs font-medium rounded-md transition-all", ui.iconPickerTab === 'upload' ? "bg-white shadow-sm text-zinc-900 border border-zinc-200" : "text-zinc-500 hover:text-zinc-700 hover:bg-zinc-100")}>Subir</button>
                                        </div>
                                    </div>
                                    <div className="p-4 overflow-y-auto max-h-96">
                                        {ui.iconPickerTab === 'emoji' && (
                                            <div className="grid grid-cols-8 gap-2">
                                                {ICONS_LIST.map(icon => (
                                                    <div key={icon} onClick={() => { actions.updatePage(activePageId, { icon }); toggleModal('iconPickerModal', false); }} className="text-3xl p-2 hover:bg-zinc-100 rounded cursor-pointer text-center transition-colors">{icon}</div>
                                                ))}
                                            </div>
                                        )}
                                        {ui.iconPickerTab === 'upload' && (
                                            <div className="flex flex-col items-center justify-center py-12">
                                                <div className="w-16 h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-3"><UploadCloud size={24} className="text-zinc-400" /></div>
                                                <button onClick={() => { triggerUpload('icon'); toggleModal('iconPickerModal', false); }} className="px-4 py-2 bg-zinc-900 text-white text-sm rounded-lg hover:bg-black transition-colors font-medium">Subir imagen</button>
                                                <p className="text-xs text-zinc-400 mt-2">Tama√±o recomendado: 280√ó280px</p>
                                            </div>
                                        )}
                                    </div>
                                </motion.div>
                            </>
                        )}

                        {/* Cover Gallery Modal */}
                        {ui.modals.coverGallery && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={() => toggleModal('coverGallery', false)} className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[60]" />
                                <motion.div initial={{ opacity: 0, scale: 0.95, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95, y: 20 }} className="fixed inset-0 m-auto h-fit max-h-[85vh] z-[70] w-full max-w-3xl bg-white rounded-xl shadow-2xl overflow-hidden border border-zinc-200 flex flex-col">
                                    <div className="flex justify-between items-center p-4 border-b border-zinc-100 shrink-0 bg-white"><h2 className="text-sm font-semibold text-zinc-700">Galer√≠a</h2><button onClick={() => toggleModal('coverGallery', false)} className="p-1 hover:bg-zinc-100 rounded text-zinc-400 hover:text-zinc-600 transition-colors"><X size={18} /></button></div>
                                    <div className="p-6 overflow-y-auto">
                                        <div className="mb-6">
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="text-sm font-semibold text-zinc-700">Abstractos y degradados</h3>
                                                <button onClick={() => { triggerUpload('cover'); toggleModal('coverGallery', false); }} className="flex items-center gap-1.5 text-xs text-zinc-600 hover:bg-zinc-100 px-2 py-1 rounded transition-colors"><UploadCloud size={12} /> Subir</button>
                                            </div>
                                            <div className="grid grid-cols-4 gap-3">
                                                {COVER_COLORS.map(colorObj => (
                                                    <div key={colorObj.id} onClick={() => { actions.updatePage(activePageId, { cover: colorObj.color }); toggleModal('coverGallery', false); }} className="h-24 rounded-lg cursor-pointer hover:scale-105 transition-transform shadow-sm" style={{ background: colorObj.color }}></div>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 className="text-sm font-semibold text-zinc-700 mb-3">Telescopio James Webb</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                {COVER_IMAGES.map((url, i) => (
                                                    <div key={i} onClick={() => { actions.updatePage(activePageId, { cover: url }); toggleModal('coverGallery', false); }} className="h-32 rounded-lg overflow-hidden cursor-pointer hover:scale-105 transition-transform shadow-sm"><img src={url} className="w-full h-full object-cover" /></div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>
                </div>
            );
        }

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>

</html>