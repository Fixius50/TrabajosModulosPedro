<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Pomodoro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Teko:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* Estilos base y variables de color */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e4e6eb;
            --card-bg: #2c2c2c;
            --table-green: #2a623d;
            --gold-color: #f7d060;
            --shadow: 0 0.375rem 1.25rem rgba(0, 0, 0, 0.4);
            --primary-color: #2a65ea;
            --primary-hover: #1d4baf;
            --red-color: #c93a3a;
            --black-color: #333;
            --green-color: var(--table-green);
            --disabled-color: #555;
            --input-border: #444;
            --roulette-red: #c0392b;
            --roulette-black: #2c3e50;
            --roulette-green: #27ae60;
            --card-front: #fff;
            --card-back: #a12a2a;
        }

        body[data-theme="light"] {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --card-bg: #ffffff;
            --input-border: #ccc;
            --black-color: #e0e0e0;
        }

        body[data-theme="light"] .public-room-item .info span:first-child {
            color: var(--table-green);
        }

        body[data-theme="green"] {
            --bg-color: #1e4620;
            --text-color: #f0f0f0;
            --card-bg: #2a623d;
            --input-border: #4a8c5d;
        }


        body {
            font-family: 'Teko', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            background-size: cover;
            background-position: center;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            margin-top: 0;
            font-family: 'Roboto Condensed', sans-serif;
            color: var(--gold-color);
            text-shadow: 0.0625rem 0.0625rem 0.1875rem rgba(0,0,0,0.5);
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.2rem; }

        /* --- Estructura de Tarjetas y Layout --- */
        .card {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            border: 0.0625rem solid var(--input-border);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s;
        }
        .card:last-child {
            margin-bottom: 0;
        }

        #setup-container {
            max-width: 55rem; /* ANCHURA AMPLIADA */
        }

        .pomodoro-container {
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 2rem;
            box-sizing: border-box;
        }

        #pomodoro-layout {
            display: flex;
            gap: 1.5rem;
            width: 100%;
            max-width: 75rem;
            align-items: flex-start;
        }

        #main-column {
            flex: 2;
            display: flex;
            flex-direction: column;
        }

        #lobby-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* --- Sistema de Pesta√±as Superiores --- */
        #setup-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: stretch;
        }

        #top-tabs-container {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            justify-content: center;
        }

        .top-tab-card {
            background-color: #3a3a3a;
            padding: 0.75rem 2rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
            border-bottom: 4px solid transparent;
        }

        .top-tab-card h4 {
            margin: 0;
            color: #aaa;
            transition: color 0.2s;
        }

        .top-tab-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .top-tab-card.active {
            background-color: var(--card-bg);
            border-bottom-color: var(--gold-color);
        }

        .top-tab-card.active h4 {
            color: var(--gold-color);
        }
        
        #form-content-wrapper {
            flex: 1;
            padding-top: 1.5rem;
            border-top: 2px solid var(--input-border);
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 0.8rem;
            font-size: 1rem;
            border-radius: 0.375rem;
            border: 0.0625rem solid var(--input-border);
            background-color: var(--bg-color);
            color: var(--text-color);
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        .form-row .form-group {
            flex: 1;
        }

        /* --- Componentes espec√≠ficos --- */
        #resume-session-container p {
            font-size: 1.3rem;
        }
        #resume-session-container hr {
            margin: 1.5rem 0;
            border: 0;
            border-top: 0.0625rem solid var(--input-border);
        }

        #timer-display {
            font-size: 5rem;
            font-weight: 400;
            margin: 1rem 0;
            letter-spacing: 0.1875rem;
        }

        #chips-display {
            font-size: 2rem;
            color: var(--gold-color);
            margin-bottom: 2rem;
        }
        #chips-display span {
            font-weight: bold;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .session-controls {
            display: flex;
            flex-direction: row; /* Cambiado de columna a fila */
            flex-wrap: wrap; /* A√±adido para que se ajuste en pantallas peque√±as */
            justify-content: center; /* Centra los botones */
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .button-row {
            display: flex;
            justify-content: center;
            gap: 1rem;
            width: 100%;
        }

        .btn {
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Roboto Condensed', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            text-transform: uppercase;
            box-shadow: 0 0.125rem 0.3125rem rgba(0,0,0,0.2);
        }
        
        .btn:active { 
            transform: scale(0.98); 
            box-shadow: none;
        }
        .btn-primary { 
            background-color: var(--gold-color);
            color: var(--bg-color);
        }
        .btn-primary:hover { background-color: #e0b84a; }
        .btn-danger { 
            background-color: #a12a2a;
            color: var(--text-color);
        }
        .btn-danger:hover { background-color: #801f1f; }
        .btn-secondary { 
            background-color: #4a4a4a;
            color: var(--text-color);
        }
        .btn-secondary:hover { background-color: #5f5f5f; }

        .btn:disabled {
            background-color: var(--disabled-color);
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* NUEVOS ESTILOS PARA BOTONES DE HERRAMIENTAS */
        .session-controls .btn {
            border: 2px solid;
            color: #e4e6eb; /* Asegura que el texto sea legible */
        }
        #toggle-notes-btn {
            background-color: #6f5d3e; /* Dorado amarronado */
            border-color: #c9ab6f;
        }
        #toggle-notes-btn:hover {
            background-color: #8c764e;
            border-color: #d9bc7f;
        }
        #back-to-main-btn {
            background-color: #555c47; /* Verde oliva */
            border-color: #a4b18c;
        }
        #back-to-main-btn:hover {
            background-color: #697357;
            border-color: #b4c19c;
        }
        #reset-pomodoro-btn.btn-danger {
            border-color: #e06c6c;
        }
        #reset-pomodoro-btn.btn-danger:hover {
            border-color: #f78c8c;
        }
        
        /* --- Lobby & Teams --- */
        .lobby-section {
            margin-bottom: 2rem;
            border-bottom: 0.0625rem solid var(--input-border);
            padding-bottom: 1rem;
        }
        .lobby-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        #room-code {
            background-color: var(--bg-color);
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.5rem;
            letter-spacing: 0.125rem;
        }
        
        #player-cards-container {
            margin-top: 1rem;
        }
        .player-card {
            background-color: #383838;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 0.3125rem solid var(--primary-color);
            text-align: left;
        }
        .player-card.leader h4 {
            font-size: 1.7rem;
            color: var(--gold-color);
        }
        .player-card.leader h4::after {
            content: ' üëë';
            font-size: 1.2rem;
        }
        .player-card h4 {
            margin: 0 0 0.5rem;
            font-size: 1.4rem;
            color: var(--text-color);
        }
        .player-card p {
            margin: 0;
            font-size: 1.1rem;
        }
        .player-team-name {
            font-style: italic;
            color: var(--gold-color);
            font-size: 0.9rem;
        }
        .player-card .actions {
            margin-top: 0.75rem;
        }
        
        .team-management input {
            width: calc(100% - 6.25rem);
        }
        .team-management button {
            width: 5.625rem;
        }
        #team-list, #join-requests-list, #invitations-list {
            list-style: none; padding: 0;
        }
        .team-item, .request-item, .invitation-item, .public-room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: #3a3a3a;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .team-item button, .request-item button, .invitation-item button, .public-room-item button {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }
        .request-item .actions button, .invitation-item .actions button { margin-left: 0.5rem; }

        #bank-display {
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        #team-stats-card { text-align: left; }
        #team-stats-card ul {
            list-style-type: none;
            padding-left: 0;
        }
        #team-stats-card li {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        #public-rooms-list {
            max-height: 10rem;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            border: 1px solid var(--input-border);
            padding: 0.5rem;
            border-radius: 0.375rem;
        }

        .public-room-item .info {
            text-align: left;
        }
        .public-room-item .info span {
            display: block;
        }
         .public-room-item .info span:last-child {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        /* --- General Modal Styles --- */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .game-modal {
            background-color: var(--table-green);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            border: 0.1875rem solid var(--gold-color);
            width: 90%;
            text-align: center;
            position: relative;
        }
        .close-game-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            color: var(--gold-color);
            font-size: 2rem;
            cursor: pointer;
        }

        /* --- Ruleta --- */
        #roulette-modal { max-width: 28.125rem; }

        #roulette-wheel-container {
            position: relative;
            width: 18.75rem;
            height: 18.75rem;
            margin: 1.5rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #roulette-pointer {
            width: 0;
            height: 0;
            border-left: 1.25rem solid transparent;
            border-right: 1.25rem solid transparent;
            border-top: 1.875rem solid var(--gold-color);
            position: absolute;
            top: -1.25rem;
            z-index: 3;
        }
        #roulette-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #333;
            border: 0.5rem solid #634808;
            position: relative;
            overflow: hidden;
        }
        .roulette-number {
            position: absolute;
            width: 50%;
            height: 50%;
            color: white;
            top: 25%;
            left: 50%;
            transform-origin: 0% 50%;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.625rem;
            box-sizing: border-box;
        }
        
        .betting-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .betting-controls input {
            width: 5rem;
            text-align: center;
            font-size: 1.5rem;
        }
        .betting-options button {
            margin: 0 0.5rem;
            width: 5rem;
        }
        .btn-red { background-color: var(--roulette-red); color: white; }
        .btn-black { background-color: var(--roulette-black); border: 0.0625rem solid #555; color: white;}
        .btn-green { background-color: var(--roulette-green); color: white; }
        
        #roulette-result {
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            height: 1.875rem;
        }
        
        #gambling-card p {
            font-size: 1.2rem;
            margin: 1rem 0 1.5rem;
        }

        /* --- Poker Styles --- */
        #poker-modal { max-width: 43.75rem; }
        #poker-table {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        #poker-hand {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .playing-card {
            width: 5rem;
            height: 7.5rem;
            border-radius: 0.5rem;
            background-color: var(--card-front);
            border: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            font-size: 1.8rem;
            font-family: 'Times New Roman', serif;
            box-shadow: 0.125rem 0.125rem 0.3125rem rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .playing-card.red { color: var(--roulette-red); }
        .playing-card.black { color: var(--roulette-black); }
        .playing-card.selected {
            transform: translateY(-1rem);
            box-shadow: 0 0.5rem 0.9375rem var(--gold-color);
        }
        .card-rank-top, .card-rank-bottom {
            width: 100%;
            text-align: left;
        }
        .card-rank-bottom { transform: rotate(180deg); }
        .card-suit { font-size: 2.5rem; }

        #poker-controls { display: flex; gap: 1rem; }
        #poker-payouts { text-align: left; margin-top: 1rem; font-size: 1rem; color: #ccc;}
        #poker-payouts strong { color: var(--gold-color); }
        #poker-result {
            font-size: 1.5rem;
            font-weight: bold;
            height: 1.875rem;
        }

        /* --- Cuaderno de Apuntes y Gemini API --- */
        #notes-container {
            background-color: #e0e0e0;
            border-color: var(--gold-color);
            text-align: left;
        }
        body[data-theme="light"] #notes-container {
            background-color: #f9f9f9;
        }
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        #notes-container h3 {
            color: #333; /* Dark text for light background */
            text-shadow: none;
            margin: 0;
        }
        #notes-textarea {
            width: 100%;
            height: 9.375rem;
            font-family: 'Arial', sans-serif;
            font-size: 1rem;
            padding: 0.8rem;
            border-radius: 0.375rem;
            border: 0.0625rem solid #ccc;
            background-color: #f9f9f9;
            color: #333;
            box-sizing: border-box;
            resize: vertical;
        }
        #custom-alert {
            position: fixed;
            top: 1.25rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--red-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 1002;
            box-shadow: var(--shadow);
            font-size: 1.2rem;
            font-family: 'Roboto Condensed', sans-serif;
        }
        
        /* --- Settings Panel --- */
        #settings-toggle-btn {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: none;
            background-color: var(--card-bg);
            color: var(--gold-color);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1005;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }
        #settings-toggle-btn:hover {
            transform: scale(1.1) rotate(45deg);
        }

        #settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 18.75rem;
            background-color: var(--card-bg);
            z-index: 1004;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding: 2rem;
            box-sizing: border-box;
            border-left: 1px solid var(--input-border);
            display: flex;
            flex-direction: column;
        }
        #settings-panel.open {
            transform: translateX(0);
        }
        #settings-panel h3 {
            margin-bottom: 1.5rem;
        }
        .theme-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .theme-btn {
            width: 100%;
        }

        /* --- NUEVOS ESTILOS PARA LA TIENDA --- */
        #shop-modal {
            max-width: 31.25rem;
        }

        #shop-modal .form-group {
            margin-bottom: 1rem;
        }

        #shop-modal p {
            font-size: 1.2rem;
            margin: 1rem 0;
        }

        #real-money-display {
            font-size: 2rem;
            color: var(--gold-color);
            font-weight: bold;
            margin: 1rem 0;
        }

        .disclaimer {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 1.5rem;
        }

        /* --- NUEVOS ESTILOS PARA ESTAD√çSTICAS DEL CONTADOR --- */
        #timer-card-layout {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        #timer-main-content {
            flex: 3; /* Give more space to the main content */
        }

        #timer-stats-column {
            flex: 1; /* Give less space to the stats */
            text-align: left;
            padding-left: 1.5rem;
            border-left: 2px solid var(--input-border);
            align-self: stretch; /* Make it take the full height of the card */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #timer-stats-column h3 {
            margin-bottom: 1rem;
            text-align: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .stat-item span {
            font-size: 1rem;
            color: #aaa;
        }

        .stat-item strong {
            font-size: 1.3rem;
            color: var(--text-color);
        }

        /* --- NUEVOS ESTILOS PARA GIFS --- */
        .corner-gif {
            position: fixed;
            width: 60px;
            height: 60px;
            z-index: 1000; /* CORREGIDO: Por debajo de los botones */
            opacity: 0.7;
            pointer-events: none; /* Evita que los gifs bloqueen clics */
        }

        .top-left-gif {
            top: 1rem;
            left: 1rem;
        }

        .top-right-gif {
            top: 1rem;
            right: 1rem;
        }
        
        .bottom-left-gif {
            bottom: 1rem;
            left: 1rem;
        }

        .bottom-right-gif {
            bottom: 1rem;
            right: 1rem;
        }

        /* Helper class should have high precedence */
        .hidden {
            display: none !important;
        }

        /* --- MEDIA QUERIES PARA RESPONSIVE DESIGN --- */
        @media (max-width: 992px) { /* Breakpoint para tablets */
            #pomodoro-layout {
                flex-direction: column;
            }
        }
        @media (max-width: 768px) { /* Breakpoint para m√≥viles */
            #timer-card-layout {
                flex-direction: column;
                gap: 1.5rem;
            }

            #timer-stats-column {
                border-left: none;
                border-top: 2px solid var(--input-border);
                padding-left: 0;
                padding-top: 1.5rem;
                width: 100%;
                align-self: center;
            }
            .corner-gif {
                display: none;
            }
        }
    </style>
</head>
<body>
    <img src="https://i.gifer.com/origin/85/85ea721e355c6e83141f12253a633364_w200.gif" class="corner-gif top-left-gif" alt="Spinning coin">
    <img src="https://i.gifer.com/origin/85/85ea721e355c6e83141f12253a633364_w200.gif" class="corner-gif top-right-gif" alt="Spinning coin">
    <img src="https://i.gifer.com/origin/85/85ea721e355c6e83141f12253a633364_w200.gif" class="corner-gif bottom-left-gif" alt="Spinning coin">
    <img src="https://i.gifer.com/origin/85/85ea721e355c6e83141f12253a633364_w200.gif" class="corner-gif bottom-right-gif" alt="Spinning coin">


    <div id="custom-alert" class="hidden"></div>

    <button id="settings-toggle-btn">‚öôÔ∏è</button>
    <div id="settings-panel">
        <h3>üé® Temas</h3>
        <div class="theme-options">
            <button class="theme-btn btn btn-secondary" data-theme="dark">Cl√°sico Oscuro</button>
            <button class="theme-btn btn btn-secondary" data-theme="light">Claro Elegante</button>
            <button class="theme-btn btn btn-secondary" data-theme="green">Mesa de Juego</button>
        </div>
        <h3 style="margin-top: 2rem;">‚úíÔ∏è Color de Fuente</h3>
        <div class="form-group" style="margin-bottom: 0;">
            <input type="color" id="font-color-picker" class="form-control" style="padding: 0.2rem; height: 3rem;">
        </div>
        <!-- NUEVO BOT√ìN PARA LA TIENDA -->
        <h3 style="margin-top: 2rem;">üí∞ Tienda</h3>
        <button id="open-shop-btn" class="btn btn-secondary" style="width: 100%;">Canjear Fichas</button>
    </div>


    <!-- Pantalla de Configuraci√≥n Inicial -->
    <div id="setup-container" class="card hidden">
        <div id="resume-session-container"></div>
        <h2>Bienvenido al Casino Pomodoro</h2>
        
        <div id="setup-layout">
            <div id="top-tabs-container">
                <div id="create-tab-btn" class="top-tab-card active">
                    <h4>Crear Sala</h4>
                </div>
                <div id="join-tab-btn" class="top-tab-card">
                    <h4>Unirse a Sala</h4>
                </div>
            </div>
            
            <div id="form-content-wrapper">
                <div id="create-content" class="tab-pane active">
                    <form id="create-form">
                        <div class="form-group">
                            <label for="player-name-create">Nombre del Jugador</label>
                            <input type="text" id="player-name-create" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="session-title">Nombre de la Sesi√≥n</label>
                            <input type="text" id="session-title" class="form-control" required>
                        </div>
                         <div class="form-row">
                            <div class="form-group">
                                <label for="pomodoro-speed">Velocidad</label>
                                <input type="number" id="pomodoro-speed" class="form-control" min="0.1" step="0.1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="game-selection">Juego</label>
                                <select id="game-selection" class="form-control">
                                    <option value="roulette">Ruleta</option>
                                    <option value="poker">P√≥ker</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="chips-per-interval">Fichas Ganadas por Intervalo</label>
                                <input type="number" id="chips-per-interval" class="form-control" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="chip-interval">Tiempo del Intervalo (segundos)</label>
                                <input type="number" id="chip-interval" class="form-control" min="1" value="60" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Crear Sala</button>
                    </form>
                </div>
                
                <div id="join-content" class="tab-pane">
                    <div class="form-group">
                        <label for="player-name-join">Tu Nombre de Jugador</label>
                        <input type="text" id="player-name-join" class="form-control" required>
                    </div>
                    <h4>Salas P√∫blicas</h4>
                    <div id="public-rooms-list"></div>
                    <hr>
                     <form id="join-form">
                         <p>O √∫nete con un c√≥digo:</p>
                        <div class="form-group">
                            <label for="room-code-join">C√≥digo de la Sala</label>
                            <input type="text" id="room-code-join" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Unirse con C√≥digo</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla Principal del Pomodoro -->
    <div id="pomodoro-container" class="pomodoro-container hidden">
      <div id="pomodoro-layout">
        <div id="main-column">
            
            <div class="card" id="timer-card-layout">
                <div id="timer-main-content">
                    <h1 id="main-title">Casino Pomodoro</h1>
                    <h2 id="chips-display">TUS FICHAS: <span id="chips-count">0</span></h2>
                    <div id="timer-display">00:00:00</div>
                    <div class="controls">
                        <button id="start-pause-btn" class="btn btn-primary">Iniciar</button>
                        <button id="reset-btn" class="btn btn-danger" disabled>Reiniciar</button>
                    </div>
                </div>
                <div id="timer-stats-column">
                    <h3>Estad√≠sticas</h3>
                    <div class="stat-item">
                        <span>Tiempo de Foco</span>
                        <strong>00:00:00</strong>
                    </div>
                    <div class="stat-item">
                        <span>Fichas Ganadas</span>
                        <strong>0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Racha Actual</span>
                        <strong>0 D√≠as</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Herramientas</h3>
                <div class="session-controls">
                    <button id="toggle-notes-btn" class="btn">Apuntes</button>
                    <button id="back-to-main-btn" class="btn">Volver al Inicio</button>
                    <button id="reset-pomodoro-btn" class="btn btn-danger">Salir de Sesi√≥n</button>
                </div>
            </div>
            
            <div id="gambling-card" class="card hidden">
                <h3>¬°Hagan sus apuestas!</h3>
                <p>El temporizador est√° en pausa y tienes fichas. ¬øTe sientes con suerte?</p>
                <button id="play-game-btn" class="btn btn-primary">Jugar</button>
            </div>

            <div id="team-stats-card" class="card hidden">
                <h3 id="team-stats-name">Estad√≠sticas del Equipo</h3>
                <ul>
                    <li><strong>Tiempo Total:</strong> <span id="team-stats-time"></span></li>
                    <li><strong>Fichas Totales:</strong> <span id="team-stats-chips"></span></li>
                    <li><strong>Miembros:</strong> <span id="team-stats-members"></span></li>
                </ul>
            </div>
            
            <div id="notes-container" class="card hidden">
                <div class="notes-header">
                    <h3>Cuaderno de Apuntes</h3>
                </div>
                <textarea id="notes-textarea" placeholder="Escribe tus notas aqu√≠..."></textarea>
            </div>

        </div>
        <div id="lobby-column">
            <div class="card">
                <div class="lobby-section">
                    <h3>Sala de Juego</h3>
                    <div id="room-code"></div>
                </div>

                <div class="lobby-section">
                    <h3>Equipos</h3>
                     <div id="invitations-container" class="hidden">
                        <h4>Invitaciones</h4>
                        <ul id="invitations-list"></ul>
                    </div>
                     <div class="team-management form-group">
                        <input type="text" id="team-name-input" class="form-control" placeholder="Nombre del equipo...">
                        <button id="create-team-btn" class="btn btn-secondary">Crear</button>
                    </div>
                    <ul id="team-list"></ul>
                    <div id="join-requests-container" class="hidden">
                        <h4>Solicitudes Pendientes</h4>
                        <ul id="join-requests-list"></ul>
                    </div>
                    <div id="bank-display">Banca: <span>0</span></div>
                </div>
                
                <div class="lobby-section">
                    <h3>Jugadores</h3>
                    <div id="player-cards-container"></div>
                    <button id="simulate-join-btn" class="btn btn-secondary" style="width:100%; margin-top: 1rem;">A√±adir Jugador (Sim)</button>
                </div>
            </div>
        </div>
      </div>
    </div>
    
    <!-- Modal de la Ruleta -->
    <div id="roulette-overlay" class="game-overlay hidden">
        <div id="roulette-modal" class="game-modal">
            <button id="close-roulette-btn" class="close-game-btn">&times;</button>
            <h3>¬°Hagan sus apuestas!</h3>
            <div id="roulette-wheel-container">
                 <div id="roulette-pointer"></div>
                 <div id="roulette-wheel"></div>
            </div>
            <div id="roulette-result"></div>
            <div class="betting-controls">
                <label for="bet-amount-roulette" style="font-size:1.5rem;">Apuesta:</label>
                <input type="number" id="bet-amount-roulette" class="form-control" min="1" value="1">
            </div>
            <div class="betting-options">
                <button class="btn btn-red" onclick="playRoulette('red')">Rojo</button>
                <button class="btn btn-black" onclick="playRoulette('black')">Negro</button>
                <button class="btn btn-green" onclick="playRoulette('green')">Verde</button>
            </div>
        </div>
    </div>
    
    <!-- Modal del P√≥ker -->
    <div id="poker-overlay" class="game-overlay hidden">
        <div id="poker-modal" class="game-modal">
            <button id="close-poker-btn" class="close-game-btn">&times;</button>
            <h3>P√≥ker de Cinco Cartas</h3>
            <div id="poker-table">
                <div id="poker-result"></div>
                <div id="poker-hand"></div>
                <div class="betting-controls">
                     <label for="bet-amount-poker" style="font-size:1.5rem;">Apuesta:</label>
                     <input type="number" id="bet-amount-poker" class="form-control" min="1" value="1">
                </div>
                <div id="poker-controls">
                    <button id="poker-deal-btn" class="btn btn-primary">Apostar y Repartir</button>
                    <button id="poker-draw-btn" class="btn btn-secondary" disabled>Descartar</button>
                </div>
                <div id="poker-payouts">
                    <strong>Tabla de Pagos:</strong> Jacks or Better (x1), Dos Pares (x2), Tr√≠o (x3), Escalera (x4), Color (x6), Full (x9), P√≥ker (x25), Escalera de Color (x50)
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVO MODAL PARA LA TIENDA -->
    <div id="shop-overlay" class="game-overlay hidden">
        <div id="shop-modal" class="game-modal">
            <button id="close-shop-btn" class="close-game-btn">&times;</button>
            <h3>Tienda de Fichas</h3>
            <p id="exchange-rate">Tasa de cambio: 100 Fichas = 1‚Ç¨ (Simulado)</p>
            <p>Tus Fichas: <span id="shop-chips-count">0</span></p>

            <div class="form-group">
                <label for="chips-to-redeem">Fichas a Canjear</label>
                <input type="number" id="chips-to-redeem" class="form-control" min="1" value="100">
            </div>

            <p>Recibir√°s (aprox):</p>
            <div id="real-money-display">1.00 ‚Ç¨</div>

            <div class="form-group">
                <label for="bank-account">N√∫mero de Cuenta (Simulado)</label>
                <input type="text" id="bank-account" class="form-control" placeholder="ES00 0000 0000 0000 0000 0000">
            </div>
            
            <button id="redeem-chips-btn" class="btn btn-primary">Canjear Fichas</button>

            <p class="disclaimer">Esto es solo una simulaci√≥n. No se realizar√°n transferencias de dinero real.</p>
        </div>
    </div>


    <script>
        // Referencias a los elementos del DOM
        const setupContainer = document.getElementById('setup-container');
        const pomodoroContainer = document.getElementById('pomodoro-container');
        const createForm = document.getElementById('create-form');
        const joinForm = document.getElementById('join-form');
        const timerDisplay = document.getElementById('timer-display');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const mainTitle = document.getElementById('main-title');
        const resetPomodoroBtn = document.getElementById('reset-pomodoro-btn');
        const chipsCountSpan = document.getElementById('chips-count');
        const gamblingCard = document.getElementById('gambling-card');
        const playGameBtn = document.getElementById('play-game-btn');

        
        // Ruleta
        const rouletteOverlay = document.getElementById('roulette-overlay');
        const rouletteWheel = document.getElementById('roulette-wheel');
        const rouletteResult = document.getElementById('roulette-result');
        const betAmountRoulette = document.getElementById('bet-amount-roulette');
        const closeRouletteBtn = document.getElementById('close-roulette-btn');
        
        // P√≥ker
        const pokerOverlay = document.getElementById('poker-overlay');
        const pokerHandEl = document.getElementById('poker-hand');
        const pokerResultEl = document.getElementById('poker-result');
        const pokerDealBtn = document.getElementById('poker-deal-btn');
        const pokerDrawBtn = document.getElementById('poker-draw-btn');
        const betAmountPoker = document.getElementById('bet-amount-poker');
        const closePokerBtn = document.getElementById('close-poker-btn');

        // Tienda (NUEVAS REFERENCIAS)
        const openShopBtn = document.getElementById('open-shop-btn');
        const shopOverlay = document.getElementById('shop-overlay');
        const closeShopBtn = document.getElementById('close-shop-btn');
        const shopChipsCount = document.getElementById('shop-chips-count');
        const chipsToRedeemInput = document.getElementById('chips-to-redeem');
        const realMoneyDisplay = document.getElementById('real-money-display');
        const bankAccountInput = document.getElementById('bank-account');
        const redeemChipsBtn = document.getElementById('redeem-chips-btn');


        const roomCodeEl = document.getElementById('room-code');
        const playerCardsContainer = document.getElementById('player-cards-container');
        const simulateJoinBtn = document.getElementById('simulate-join-btn');
        
        // Pesta√±as
        const createTabBtn = document.getElementById('create-tab-btn');
        const joinTabBtn = document.getElementById('join-tab-btn');
        const createContent = document.getElementById('create-content');
        const joinContent = document.getElementById('join-content');
        const publicRoomsList = document.getElementById('public-rooms-list');


        // Herramientas y Apuntes
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const toggleNotesBtn = document.getElementById('toggle-notes-btn');
        const notesContainer = document.getElementById('notes-container');
        const notesTextarea = document.getElementById('notes-textarea');
        const resumeSessionContainer = document.getElementById('resume-session-container');

        // Equipos
        const createTeamBtn = document.getElementById('create-team-btn');
        const teamNameInput = document.getElementById('team-name-input');
        const teamListEl = document.getElementById('team-list');
        const bankDisplaySpan = document.querySelector('#bank-display span');
        const joinRequestsContainer = document.getElementById('join-requests-container');
        const joinRequestsList = document.getElementById('join-requests-list');
        const invitationsContainer = document.getElementById('invitations-container');
        const invitationsList = document.getElementById('invitations-list');

        // Settings
        const settingsToggleBtn = document.getElementById('settings-toggle-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const themeBtns = document.querySelectorAll('.theme-btn');
        const fontColorPicker = document.getElementById('font-color-picker');


        // Team Stats Card
        const teamStatsCard = document.getElementById('team-stats-card');
        const teamStatsName = document.getElementById('team-stats-name');
        const teamStatsTime = document.getElementById('team-stats-time');
        const teamStatsChips = document.getElementById('team-stats-chips');
        const teamStatsMembers = document.getElementById('team-stats-members');
        
        // --- Gemini API Elements ---
        const customAlert = document.getElementById('custom-alert');

        // Variables de estado
        let timerInterval = null;
        let isRunning = false;
        let settings = {};
        let roomData = {
            players: [],
            teams: {}, // { teamId: { name, totalSeconds, isRunning } }
            requests: [], // { playerName, teamId }
            invitations: [], // { targetPlayerName, teamId, teamName }
            bankChips: 0,
            roomCode: '',
            chipsPerInterval: 1,
            chipInterval: 60,
            game: 'roulette'
        };
        // Estado del P√≥ker
        let pokerDeck = [];
        let playerHand = [];

        // --- MANEJO DE PESTA√ëAS ---
        createTabBtn.addEventListener('click', () => {
            createTabBtn.classList.add('active');
            joinTabBtn.classList.remove('active');
            createContent.classList.add('active');
            joinContent.classList.remove('active');
        });
        joinTabBtn.addEventListener('click', () => {
            joinTabBtn.classList.add('active');
            createTabBtn.classList.remove('active');
            joinContent.classList.add('active');
            createContent.classList.remove('active');
            renderPublicRooms();
        });

        // --- L√ìGICA DEL TEMPORIZADOR Y FICHAS ---
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return [hours, minutes, secs].map(v => v < 10 ? "0" + v : v).join(":");
        }
        
        function distributeChips() {
            roomData.bankChips = 0;
            const playersInTeams = new Set();

            for (const teamId in roomData.teams) {
                const team = roomData.teams[teamId];
                const teamPlayers = roomData.players.filter(p => p.teamId === teamId);
                if (teamPlayers.length === 0) continue;

                teamPlayers.forEach(p => playersInTeams.add(p.name));

                const intervalsPassed = Math.floor(team.totalSeconds / roomData.chipInterval);
                const totalGeneratedChips = intervalsPassed * roomData.chipsPerInterval;
                const chipsPerPlayer = Math.floor(totalGeneratedChips / teamPlayers.length);
                const remainder = totalGeneratedChips % teamPlayers.length;
                roomData.bankChips += remainder;

                teamPlayers.forEach(player => {
                    player.chips = chipsPerPlayer;
                });
            }

            roomData.players.forEach(player => {
                if (!playersInTeams.has(player.name)) {
                    const intervalsPassed = Math.floor((player.totalSeconds || 0) / roomData.chipInterval);
                    const generatedChips = intervalsPassed * roomData.chipsPerInterval;
                    player.chips = generatedChips;
                }
            });
            
            updateUI();
        }

        function updateUI() {
            const me = getMyPlayerData();
            if (!me) return;

            const myTeamId = me.teamId;
            let currentSeconds = me.totalSeconds || 0;
            
            if (myTeamId && roomData.teams[myTeamId]) {
                currentSeconds = roomData.teams[myTeamId].totalSeconds;
            }

            timerDisplay.textContent = formatTime(currentSeconds);
            chipsCountSpan.textContent = me.chips || 0;
            bankDisplaySpan.textContent = roomData.bankChips;
            renderPlayers();
            renderTeams();
            renderJoinRequests();
            renderInvitations();
            updateTeamStatsCard();

            // Control visibility of the gambling card
            if (!isRunning && me.chips > 0) {
                gamblingCard.classList.remove('hidden');
                playGameBtn.textContent = `Jugar a ${roomData.game === 'roulette' ? 'la Ruleta' : 'P√≥ker'}`;
            } else {
                gamblingCard.classList.add('hidden');
            }
        }

        function toggleTimer() {
            const me = getMyPlayerData();
            const myTeamId = me.teamId;

            if (myTeamId) {
                const team = roomData.teams[myTeamId];
                isRunning = !team.isRunning;
                team.isRunning = isRunning;
            } else { // Solo logic
                isRunning = !me.isRunning;
                me.isRunning = isRunning;
            }

            if(isRunning) {
                startPauseBtn.textContent = 'Pausar';
                resetBtn.disabled = true;
            } else {
                startPauseBtn.textContent = 'Continuar';
                resetBtn.disabled = false;
            }
            updateUI();
        }

        function mainTick() {
            let hasActiveTimer = false;
            for (const teamId in roomData.teams) {
                if (roomData.teams[teamId].isRunning) {
                    roomData.teams[teamId].totalSeconds++;
                    hasActiveTimer = true;
                }
            }
            roomData.players.forEach(p => {
                if (!p.teamId && p.isRunning) {
                    p.totalSeconds = (p.totalSeconds || 0) + 1;
                    hasActiveTimer = true;
                }
            });

            if(hasActiveTimer) {
                distributeChips();
            }
        }
        
        function resetTimer() {
             const me = getMyPlayerData();
             if (!me) return;
             const myTeamId = me.teamId;

             if (myTeamId && roomData.teams[myTeamId] && !roomData.teams[myTeamId].isRunning) {
                  roomData.teams[myTeamId].totalSeconds = 0;
             } else if (!myTeamId && !me.isRunning) {
                  me.totalSeconds = 0;
             }
             distributeChips();
             startPauseBtn.textContent = 'Iniciar';
             resetBtn.disabled = true;
        }
        
        // --- L√ìGICA DE LA RULETA ---
        const numbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
        const colors = {
            red: [32, 19, 21, 25, 34, 27, 36, 30, 23, 5, 16, 1, 14, 9, 18, 7, 12, 3],
            black: [15, 4, 2, 17, 6, 13, 11, 8, 10, 24, 33, 20, 31, 22, 29, 28, 35, 26],
            green: [0]
        };

        function buildRouletteWheel() {
            const segmentAngle = 360 / numbers.length;
            let gradientParts = [];
            
            rouletteWheel.innerHTML = ''; // Clear previous numbers

            numbers.forEach((num, index) => {
                let color;
                if (colors.red.includes(num)) color = 'var(--roulette-red)';
                else if (colors.black.includes(num)) color = 'var(--roulette-black)';
                else color = 'var(--roulette-green)';

                gradientParts.push(`${color} ${index * segmentAngle}deg`);
                gradientParts.push(`${color} ${(index + 1) * segmentAngle}deg`);
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'roulette-number';
                numberDiv.textContent = num;
                numberDiv.style.transform = `rotate(${index * segmentAngle + segmentAngle / 2}deg)`;
                rouletteWheel.appendChild(numberDiv);
            });
            
            rouletteWheel.style.background = `conic-gradient(${gradientParts.join(', ')})`;
        }

        function playRoulette(betColor) {
            const me = getMyPlayerData();
            const betAmount = parseInt(betAmountRoulette.value, 10);
            if (isNaN(betAmount) || betAmount <= 0) { showAlert("Apuesta inv√°lida."); return; }
            if (betAmount > me.chips) { showAlert("No tienes suficientes fichas."); return; }
            
            me.chips -= betAmount;
            rouletteResult.textContent = "La bola est√° girando...";
            document.querySelectorAll('#roulette-modal .betting-options button').forEach(b => b.disabled = true);

            const randomIndex = Math.floor(Math.random() * numbers.length);
            const winningNumber = numbers[randomIndex];
            let resultColor;
            if (colors.red.includes(winningNumber)) resultColor = 'red';
            else if (colors.black.includes(winningNumber)) resultColor = 'black';
            else resultColor = 'green';
            
            const segmentAngle = 360 / numbers.length;
            const targetAngle = -(randomIndex * segmentAngle + (segmentAngle / 2));
            const randomSpins = Math.floor(Math.random() * 4) + 5; // 5 to 8 spins
            const finalAngle = targetAngle + 360 * randomSpins;

            rouletteWheel.style.transition = 'transform 5s ease-out';
            rouletteWheel.style.transform = `rotate(${finalAngle}deg)`;
            
            setTimeout(() => {
                let winnings = 0;
                if (betColor === resultColor) {
                    winnings = (resultColor === 'green') ? betAmount * 14 : betAmount * 2;
                    rouletteResult.textContent = `¬°GANASTE! Sali√≥ ${winningNumber} ${resultColor}. Recibes ${winnings} fichas.`;
                    me.chips += winnings;
                } else {
                    rouletteResult.textContent = `Perdiste. Sali√≥ ${winningNumber} ${resultColor}.`;
                }
                updateUI();
                saveState();
                document.querySelectorAll('#roulette-modal .betting-options button').forEach(b => b.disabled = false);
            }, 5100);
        }
        
        // --- L√ìGICA DEL P√ìKER ---
        function createDeck() {
            const suits = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'];
            const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const values = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];
            pokerDeck = [];
            for (let i = 0; i < suits.length; i++) {
                for (let j = 0; j < ranks.length; j++) {
                    pokerDeck.push({ suit: suits[i], rank: ranks[j], value: values[j] });
                }
            }
        }

        function shuffleDeck() {
            for (let i = pokerDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pokerDeck[i], pokerDeck[j]] = [pokerDeck[j], pokerDeck[i]];
            }
        }

        function renderHand() {
            pokerHandEl.innerHTML = '';
            playerHand.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'playing-card';
                cardEl.classList.add((card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'red' : 'black');
                cardEl.dataset.index = index;
                cardEl.innerHTML = `
                    <span class="card-rank-top">${card.rank}</span>
                    <span class="card-suit">${card.suit}</span>
                    <span class="card-rank-bottom">${card.rank}</span>
                `;
                cardEl.addEventListener('click', () => {
                    if (pokerDrawBtn.disabled === false) {
                        cardEl.classList.toggle('selected');
                    }
                });
                pokerHandEl.appendChild(cardEl);
            });
        }
        
        function evaluateHand(hand) {
             const payouts = {
                 'Royal Flush': 250, 'Straight Flush': 50, 'Four of a Kind': 25, 'Full House': 9, 'Flush': 6,
                 'Straight': 4, 'Three of a Kind': 3, 'Two Pair': 2, 'Jacks or Better': 1, 'Nothing': 0
             };
             const ranks = hand.map(c => c.value).sort((a,b) => a-b);
             const suits = hand.map(c => c.suit);
             const rankCounts = ranks.reduce((acc, rank) => { acc[rank] = (acc[rank] || 0) + 1; return acc; }, {});
             const counts = Object.values(rankCounts).sort((a,b) => b-a);
             
             const isFlush = new Set(suits).size === 1;
             const isStraight = ranks.every((rank, i) => i === 0 || rank === ranks[i-1] + 1) || JSON.stringify(ranks) === JSON.stringify([2,3,4,5,14]); // Ace-low straight
             
             if (isStraight && isFlush && ranks[4] === 14) return { hand: 'Royal Flush', payout: payouts['Royal Flush']};
             if (isStraight && isFlush) return { hand: 'Straight Flush', payout: payouts['Straight Flush'] };
             if (counts[0] === 4) return { hand: 'Four of a Kind', payout: payouts['Four of a Kind'] };
             if (counts[0] === 3 && counts[1] === 2) return { hand: 'Full House', payout: payouts['Full House'] };
             if (isFlush) return { hand: 'Flush', payout: payouts['Flush'] };
             if (isStraight) return { hand: 'Straight', payout: payouts['Straight'] };
             if (counts[0] === 3) return { hand: 'Three of a Kind', payout: payouts['Three of a Kind'] };
             if (counts[0] === 2 && counts[1] === 2) return { hand: 'Two Pair', payout: payouts['Two Pair'] };
             if (counts[0] === 2 && parseInt(Object.keys(rankCounts).find(key => rankCounts[key] === 2)) >= 11) {
                 return { hand: 'Jacks or Better', payout: payouts['Jacks or Better']};
             }
             return { hand: 'Nothing', payout: 0 };
        }

        pokerDealBtn.addEventListener('click', () => {
            const me = getMyPlayerData();
            const betAmount = parseInt(betAmountPoker.value, 10);

            if (pokerDealBtn.textContent.includes('Nueva')) { // Reset for new hand
                 pokerResultEl.textContent = '';
                 pokerDealBtn.textContent = 'Apostar y Repartir';
                 pokerDrawBtn.disabled = true;
                 pokerHandEl.innerHTML = '';
                 betAmountPoker.disabled = false;
                 return;
            }

            if (isNaN(betAmount) || betAmount <= 0) { showAlert("Apuesta inv√°lida."); return; }
            if (betAmount > me.chips) { showAlert("No tienes suficientes fichas."); return; }
            
            me.chips -= betAmount;
            updateUI();
            saveState();

            createDeck();
            shuffleDeck();
            playerHand = pokerDeck.splice(0, 5);
            renderHand();

            pokerResultEl.textContent = "Selecciona cartas para descartar";
            pokerDealBtn.disabled = true;
            pokerDrawBtn.disabled = false;
            betAmountPoker.disabled = true;
        });
        
        pokerDrawBtn.addEventListener('click', () => {
            const selectedCards = document.querySelectorAll('.playing-card.selected');
            selectedCards.forEach(cardEl => {
                const index = parseInt(cardEl.dataset.index);
                playerHand[index] = pokerDeck.pop();
            });
            
            renderHand();
            
            const betAmount = parseInt(betAmountPoker.value, 10);
            const result = evaluateHand(playerHand);
            const winnings = result.payout * betAmount;

            if (winnings > 0) {
                pokerResultEl.textContent = `${result.hand}! Ganas ${winnings} fichas.`;
                const me = getMyPlayerData();
                me.chips += winnings;
                updateUI();
                saveState();
            } else {
                 pokerResultEl.textContent = `Nada. Int√©ntalo de nuevo.`;
            }
            
            pokerDrawBtn.disabled = true;
            pokerDealBtn.disabled = false;
            pokerDealBtn.textContent = 'Nueva Mano';
        });

        // --- GESTI√ìN DE ESTADO ---
        function saveState() {
              settings.roomData = roomData;
              localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
        }

        function getMyPlayerData() {
            return roomData.players.find(p => p.name === settings.playerName);
        }

        // --- L√ìGICA DEL LOBBY Y EQUIPOS ---
        function renderPlayers() {
            playerCardsContainer.innerHTML = ''; 
            const me = getMyPlayerData();
            
            roomData.players.forEach(player => {
                const teamName = player.teamId ? roomData.teams[player.teamId].name : 'Sin equipo';
                const card = document.createElement('div');
                card.className = 'player-card';
                card.classList.toggle('leader', player.isLeader);
                
                let actionsHTML = '';
                if (me.isLeader && me.teamId && !player.teamId && player.name !== me.name) {
                     const alreadyInvited = roomData.invitations.some(inv => inv.targetPlayerName === player.name && inv.teamId === me.teamId);
                    if (!alreadyInvited) {
                        actionsHTML = `
                            <div class="actions">
                                <button class="btn btn-secondary" onclick="invitePlayer('${player.name}')">Invitar</button>
                            </div>
                        `;
                    }
                }

                card.innerHTML = `
                    <h4>${player.name}</h4>
                    <p>Fichas: ${player.chips}</p>
                    <p class="player-team-name">${teamName}</p>
                    ${actionsHTML}
                `;
                playerCardsContainer.appendChild(card);
            });
        }
        
        function renderTeams() {
            teamListEl.innerHTML = '';
            for (const teamId in roomData.teams) {
                const team = roomData.teams[teamId];
                const li = document.createElement('li');
                li.className = 'team-item';
                li.innerHTML = `<span>${team.name}</span>`;
                
                const me = getMyPlayerData();
                const hasRequested = roomData.requests.some(req => req.playerName === me.name && req.teamId === teamId);
                if (!me.teamId && !hasRequested) {
                    const requestBtn = document.createElement('button');
                    requestBtn.textContent = 'Solicitar';
                    requestBtn.className = 'btn btn-secondary';
                    requestBtn.onclick = () => requestToJoinTeam(teamId);
                    li.appendChild(requestBtn);
                }
                teamListEl.appendChild(li);
            }
        }

        function renderJoinRequests() {
            const me = getMyPlayerData();
            if (!me || !me.isLeader) {
                joinRequestsContainer.classList.add('hidden');
                return;
            }
            
            const myTeamRequests = roomData.requests.filter(req => req.teamId === me.teamId);

            if(myTeamRequests.length === 0) {
                 joinRequestsContainer.classList.add('hidden');
                 return;
            }

            joinRequestsContainer.classList.remove('hidden');
            joinRequestsList.innerHTML = '';
            myTeamRequests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'request-item';
                li.innerHTML = `<span>${req.playerName}</span>`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'actions';
                
                const acceptBtn = document.createElement('button');
                acceptBtn.textContent = 'Aceptar';
                acceptBtn.className = 'btn btn-secondary';
                acceptBtn.onclick = () => acceptRequest(req.playerName);
                
                const declineBtn = document.createElement('button');
                declineBtn.textContent = 'Rechazar';
                declineBtn.className = 'btn btn-danger';
                declineBtn.onclick = () => declineRequest(req.playerName);

                actionsDiv.appendChild(acceptBtn);
                actionsDiv.appendChild(declineBtn);
                li.appendChild(actionsDiv);
                joinRequestsList.appendChild(li);
            });
        }
        
        function renderInvitations() {
            const me = getMyPlayerData();
            const myInvitations = roomData.invitations.filter(inv => inv.targetPlayerName === me.name);

            if(myInvitations.length === 0) {
                invitationsContainer.classList.add('hidden');
                return;
            }
            
            invitationsContainer.classList.remove('hidden');
            invitationsList.innerHTML = '';

            myInvitations.forEach(inv => {
                 const li = document.createElement('li');
                li.className = 'invitation-item';
                li.innerHTML = `<span>${inv.teamName} te invita</span>`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'actions';
                
                const acceptBtn = document.createElement('button');
                acceptBtn.textContent = 'Aceptar';
                acceptBtn.className = 'btn btn-secondary';
                acceptBtn.onclick = () => acceptInvitation(inv.teamId);
                
                const declineBtn = document.createElement('button');
                declineBtn.textContent = 'Rechazar';
                declineBtn.className = 'btn btn-danger';
                declineBtn.onclick = () => declineInvitation(inv.teamId);

                actionsDiv.appendChild(acceptBtn);
                actionsDiv.appendChild(declineBtn);
                li.appendChild(actionsDiv);
                invitationsList.appendChild(li);
            });
        }

        function updateTeamStatsCard() {
            const me = getMyPlayerData();
            if (!me || !me.teamId) {
                teamStatsCard.classList.add('hidden');
                return;
            }
            
            const team = roomData.teams[me.teamId];
            const teamPlayers = roomData.players.filter(p => p.teamId === me.teamId);
            const intervalsPassed = Math.floor(team.totalSeconds / roomData.chipInterval);
            const totalTeamChips = intervalsPassed * roomData.chipsPerInterval;

            teamStatsName.textContent = `Estad√≠sticas de ${team.name}`;
            teamStatsTime.textContent = formatTime(team.totalSeconds);
            teamStatsChips.textContent = totalTeamChips;
            teamStatsMembers.textContent = teamPlayers.map(p => p.name).join(', ');
            
            teamStatsCard.classList.remove('hidden');
        }
        
        function createTeam() {
            const name = teamNameInput.value.trim();
            if (!name) { showAlert("El nombre del equipo no puede estar vac√≠o."); return; }
            const me = getMyPlayerData();
            if (me.teamId) { showAlert("Ya est√°s en un equipo."); return; }

            const teamId = 'team_' + Date.now();
            roomData.teams[teamId] = { name: name, totalSeconds: 0, isRunning: false };
            me.teamId = teamId; // Automatically join the team you create
            teamNameInput.value = '';
            distributeChips();
            saveState();
        }

        function requestToJoinTeam(teamId) {
            const me = getMyPlayerData();
            if (me.teamId) { showAlert("Ya est√°s en un equipo."); return; }
            roomData.requests.push({ playerName: me.name, teamId: teamId });
            updateUI(); 
            saveState();
        }
        
        function invitePlayer(playerName) {
            const me = getMyPlayerData();
            if (!me.isLeader || !me.teamId) return;
            
            roomData.invitations.push({ targetPlayerName: playerName, teamId: me.teamId, teamName: roomData.teams[me.teamId].name });
            showAlert(`Invitaci√≥n enviada a ${playerName}.`);
            saveState();
            updateUI();
        }

        function acceptInvitation(teamId) {
            const me = getMyPlayerData();
            me.teamId = teamId;
            roomData.invitations = roomData.invitations.filter(inv => inv.targetPlayerName !== me.name); // Clear all invitations on accept
            distributeChips();
            saveState();
        }

        function declineInvitation(teamId) {
            const me = getMyPlayerData();
            roomData.invitations = roomData.invitations.filter(inv => !(inv.targetPlayerName === me.name && inv.teamId === teamId));
            saveState();
            updateUI();
        }


        function acceptRequest(playerName) {
            const me = getMyPlayerData();
            if (!me.isLeader || !me.teamId) return;

            const playerToJoin = roomData.players.find(p => p.name === playerName);
            if (playerToJoin) {
                playerToJoin.teamId = me.teamId;
            }
            roomData.requests = roomData.requests.filter(req => req.playerName !== playerName);
            distributeChips();
            saveState();
        }

        function declineRequest(playerName) {
            roomData.requests = roomData.requests.filter(req => req.playerName !== playerName);
            updateUI();
            saveState();
        }
        
        function simulatePlayerJoin() {
            const randomNames = ['Vito', 'Sonny', 'Luca', 'Clemenza', 'Tessio'];
            const newPlayer = {
                name: randomNames[Math.floor(Math.random() * randomNames.length)] + roomData.players.length,
                chips: 0,
                teamId: null, 
                totalSeconds: 0, 
                isLeader: false
            };
            roomData.players.push(newPlayer);
            renderPlayers();
        }
        
        function renderPublicRooms() {
            // This is a simulation. In a real app, this data would come from a server.
            const mockPublicRooms = [
                { title: "Estudio para Examen Final", players: 3, code: "EXAM25" },
                { title: "Proyecto de Dise√±o UX/UI", players: 2, code: "DESIGNUX" },
                { title: "Marat√≥n de C√≥digo", players: 5, code: "CODEFEST" },
            ];

            publicRoomsList.innerHTML = '';
            mockPublicRooms.forEach(room => {
                const roomEl = document.createElement('div');
                roomEl.className = 'public-room-item';
                roomEl.innerHTML = `
                    <div class="info">
                        <span>${room.title}</span>
                        <span>${room.players} jugadores</span>
                    </div>
                    <button class="btn btn-secondary join-public-btn">Unirse</button>
                `;
                const joinBtn = roomEl.querySelector('.join-public-btn');
                joinBtn.addEventListener('click', () => {
                     const playerName = document.getElementById('player-name-join').value;
                     if (!playerName.trim()) {
                         showAlert("Por favor, introduce tu nombre de jugador para unirte.");
                         return;
                     }
                    // Simulate joining by creating a new session with the public room's data
                    settings = { playerName, sessionTitle: room.title, speed: 1, chipsPerInterval: 1, chipInterval: 60, game: 'roulette', roomData: null };
                    // For simulation, we create a new room, but in a real app, we'd fetch the room data.
                    startSession();
                });
                publicRoomsList.appendChild(roomEl);
            });
        }

        // --- L√ìGICA DE INICIO Y FORMULARIO ---
        function startSession() {
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
            mainTitle.textContent = settings.sessionTitle;
            
            if (!settings.roomData) {
                roomData.roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                roomData.chipsPerInterval = settings.chipsPerInterval || 1;
                roomData.chipInterval = settings.chipInterval || 60;
                roomData.game = settings.game || 'roulette';
                
                const hostPlayer = { 
                    name: settings.playerName, 
                    chips: 0, 
                    teamId: null, 
                    totalSeconds: 0, 
                    isLeader: true 
                };
                roomData.players = [hostPlayer];
                roomData.teams = {};
                roomData.requests = [];
                roomData.invitations = [];
                roomData.bankChips = 0;
                
                // Randomly pre-create teams
                if (Math.random() < 0.5) { // 50% chance
                    showAlert("¬°Han aparecido equipos aleatorios!");
                    const mockTeams = [
                        { id: 'team_alpha', name: 'Los Alfas' },
                        { id: 'team_beta', name: 'Equipo Beta' },
                        { id: 'team_gamma', name: 'Gamma Force' }
                    ];
                    mockTeams.forEach(team => {
                        roomData.teams[team.id] = { name: team.name, totalSeconds: 0, isRunning: false };
                    });
                }

            } else {
                roomData = settings.roomData;
            }
            
            roomCodeEl.textContent = roomData.roomCode;
            
            pomodoroContainer.classList.remove('hidden');
            setupContainer.classList.add('hidden');
            
            clearInterval(timerInterval);
            timerInterval = setInterval(mainTick, 1000 / (settings.speed || 1));
            
            updateUI();
        }

        function checkAndShowResumeOption() {
            const savedSettingsJSON = localStorage.getItem('pomodoroSettings');
            if (savedSettingsJSON) {
                settings = JSON.parse(savedSettingsJSON);
                resumeSessionContainer.innerHTML = `
                    <p>¬°Tienes una sesi√≥n en curso: <strong>${settings.sessionTitle}</strong>!</p>
                    <button id="resume-btn" class="btn btn-primary">Reanudar Sesi√≥n</button>
                    <hr>
                `;
                document.getElementById('resume-btn').addEventListener('click', startSession);
            } else {
                 resumeSessionContainer.innerHTML = '';
                 settings = {}; 
            }
        }
        
        function applyTheme(theme) {
            document.body.dataset.theme = theme;
            localStorage.setItem('appTheme', theme);
        }

        function applyFontColor(color) {
            document.body.style.setProperty('--text-color', color); // CORREGIDO
            localStorage.setItem('appFontColor', color);
        }


        window.addEventListener('load', () => {
            setupContainer.classList.remove('hidden');
            pomodoroContainer.classList.add('hidden');
            checkAndShowResumeOption();
            buildRouletteWheel();

            const savedTheme = localStorage.getItem('appTheme') || 'dark';
            applyTheme(savedTheme);
            
            const savedFontColor = localStorage.getItem('appFontColor');
            if(savedFontColor){
                fontColorPicker.value = savedFontColor;
                applyFontColor(savedFontColor);
            }
        });

        createForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const playerName = document.getElementById('player-name-create').value;
            const sessionTitle = document.getElementById('session-title').value;
            const speed = parseFloat(document.getElementById('pomodoro-speed').value);
            const chipsPerInterval = parseInt(document.getElementById('chips-per-interval').value, 10);
            const chipInterval = parseInt(document.getElementById('chip-interval').value, 10);
            const game = document.getElementById('game-selection').value;
            
            settings = { playerName, sessionTitle, speed, chipsPerInterval, chipInterval, game, roomData: null };
            startSession();
        });

        joinForm.addEventListener('submit', (e) => {
            e.preventDefault();
              const playerName = document.getElementById('player-name-join').value;
              const roomCode = document.getElementById('room-code-join').value;
              // Basic simulation: just start a new session with this title/code
              settings = { playerName, sessionTitle: `Sala ${roomCode}`, speed: 1, chipsPerInterval: 1, chipInterval: 60, game: 'roulette', roomData: null };
              startSession();
        });
        
        // --- BOTONES DE ACCI√ìN ---
        startPauseBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', resetTimer);
        createTeamBtn.addEventListener('click', createTeam);

        playGameBtn.addEventListener('click', () => {
            if (roomData.game === 'roulette') {
                rouletteOverlay.classList.remove('hidden');
            } else if (roomData.game === 'poker') {
                pokerOverlay.classList.remove('hidden');
                // Reset poker game state
                pokerDealBtn.textContent = 'Apostar y Repartir';
                pokerDealBtn.disabled = false;
                pokerDrawBtn.disabled = true;
                betAmountPoker.disabled = false;
                pokerResultEl.textContent = '';
                pokerHandEl.innerHTML = '';
            }
        });

        closeRouletteBtn.addEventListener('click', () => rouletteOverlay.classList.add('hidden'));
        closePokerBtn.addEventListener('click', () => pokerOverlay.classList.add('hidden'));


        resetPomodoroBtn.addEventListener('click', () => {
            saveState(); // Guarda el estado de la sesi√≥n actual antes de salir
            clearInterval(timerInterval);
            window.location.reload(); // Recarga la p√°gina para volver al inicio
        });

        backToMainBtn.addEventListener('click', () => {
            saveState();
            clearInterval(timerInterval);
            pomodoroContainer.classList.add('hidden');
            setupContainer.classList.remove('hidden');
            checkAndShowResumeOption();
        });

        toggleNotesBtn.addEventListener('click', () => notesContainer.classList.toggle('hidden'));
        notesTextarea.addEventListener('input', () => { /* Logic to save notes can be added here */ });
        simulateJoinBtn.addEventListener('click', simulatePlayerJoin);
        
        // --- SETTINGS PANEL ---
        settingsToggleBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('open');
        });

        themeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                applyTheme(theme);
            });
        });
        
        fontColorPicker.addEventListener('input', (e) => {
            applyFontColor(e.target.value);
        });

        // --- L√ìGICA DE LA TIENDA (NUEVA) ---
        const EXCHANGE_RATE = 100; // 100 fichas = 1‚Ç¨

        function updateRealMoneyDisplay() {
            const chipsToRedeem = parseInt(chipsToRedeemInput.value, 10);
            if (isNaN(chipsToRedeem) || chipsToRedeem < 0) {
                realMoneyDisplay.textContent = "0.00 ‚Ç¨";
                return;
            }
            const money = (chipsToRedeem / EXCHANGE_RATE).toFixed(2);
            realMoneyDisplay.textContent = `${money} ‚Ç¨`;
        }

        openShopBtn.addEventListener('click', () => {
            const me = getMyPlayerData();
            if(me) {
                 shopChipsCount.textContent = me.chips;
                 chipsToRedeemInput.max = me.chips;
                 updateRealMoneyDisplay();
                 shopOverlay.classList.remove('hidden');
            }
        });

        closeShopBtn.addEventListener('click', () => {
            shopOverlay.classList.add('hidden');
        });

        chipsToRedeemInput.addEventListener('input', updateRealMoneyDisplay);

        redeemChipsBtn.addEventListener('click', () => {
            const me = getMyPlayerData();
            const chipsToRedeem = parseInt(chipsToRedeemInput.value, 10);
            const bankAccount = bankAccountInput.value.trim();

            if (isNaN(chipsToRedeem) || chipsToRedeem <= 0) {
                showAlert("Por favor, introduce una cantidad v√°lida de fichas.");
                return;
            }
            if (chipsToRedeem > me.chips) {
                showAlert("No tienes suficientes fichas para canjear.");
                return;
            }
            if (bankAccount === "") {
                showAlert("Por favor, introduce un n√∫mero de cuenta (simulado).");
                return;
            }

            // Simulaci√≥n de la transacci√≥n
            me.chips -= chipsToRedeem;
            const moneyRedeemed = (chipsToRedeem / EXCHANGE_RATE).toFixed(2);

            updateUI();
            saveState();
            
            showAlert(`¬°Transferencia simulada de ${moneyRedeemed}‚Ç¨ realizada con √©xito!`);
            shopOverlay.classList.add('hidden');
        });


        // --- FUNCIONALIDAD DE ALERTA ---
        function showAlert(message) {
            customAlert.textContent = message;
            customAlert.classList.remove('hidden');
            setTimeout(() => customAlert.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
